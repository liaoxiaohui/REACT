// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["./Credential","../core/domUtils","../core/lang","../core/Error","../core/urlUtils","dijit/Dialog","dijit/registry","dojo/Deferred","dojo/_base/kernel","dojo/dom-attr","dojo/i18n!./nls/identity","dojo/io-query","dojo/sniff","dijit/form/Button","dojo/query"],function(e,t,o,i,r,n,s,a,d,l,u,h,c){return{_oAuthDfd:null,_oAuthIntervalId:0,_oAuthDialogContent:"<div class='dijitDialogPaneContentArea'><div style='padding-bottom: 5px; word-wrap: break-word;'>{oAuthInfo}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><div class='esriErrorMsg' style='display: none; color: white; background-color: #D46464; text-align: center; padding-top: 3px; padding-bottom: 3px;'>{invalidUser}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><div class='dijitDialogPaneActionBar'><button data-dojo-type='dijit.form.Button' data-dojo-props='type:\"button\", \"class\":\"esriIdSubmit\"'>{lblOk}</button><button data-dojo-type='dijit.form.Button' data-dojo-props='type:\"button\", \"class\":\"esriIdCancel\"'>{lblCancel}</button></div>",setOAuthRedirectionHandler:function(e){this._oAuthRedirectFunc=e},oAuthSignIn:function(e,o,i,r){var n=this._oAuthDfd=new a;n.resUrl_=e,n.sinfo_=o,n.oinfo_=i;var s=!r||!1!==r.oAuthPopupConfirmation;if(!i.popup||!s)return this._doOAuthSignIn(e,o,i),n.promise;this._nls||(this._nls=u),this.oAuthDialog||(this.oAuthDialog=this._createOAuthDialog());var d=this.oAuthDialog,h=r&&r.error,c=r&&r.token;return t.hide(d.errMsg_),h&&h.details&&403==h.details.httpStatus&&c&&(l.set(d.errMsg_,"innerHTML",this._nls.forbidden),t.show(d.errMsg_)),d.show(),n.promise},setOAuthResponseHash:function(t){var o=this._oAuthDfd;if(this._oAuthDfd=null,o&&t){clearInterval(this._oAuthIntervalId),"#"===t.charAt(0)&&(t=t.substring(1));var r=h.queryToObject(t);if(r.error){var n="access_denied"===r.error,s=new i(n?"identity-manager:user-aborted":"identity-manager:authentication-failed",n?"ABORTED":"OAuth: "+r.error+" - "+r.error_description);o.reject(s)}else{var a=o.sinfo_,d=o.oinfo_,l=d._oAuthCred,u=new e({userId:r.username,server:a.server,token:r.access_token,expires:(new Date).getTime()+1e3*Number(r.expires_in),ssl:"true"===r.ssl,_oAuthCred:l});l.storage=r.persist?window.localStorage:window.sessionStorage,l.token=u.token,l.expires=u.expires,l.userId=u.userId,l.ssl=u.ssl,l.save(),o.resolve(u)}}},_createOAuthDialog:function(){var e=this._nls,r=o.substitute(e,this._oAuthDialogContent),a=new n({title:e.title,content:r,class:"esri-widget esriOAuthSignInDialog esriIdentityDialog",style:"min-width: 18em;",esriIdMgr_:this,execute_:function(){var e=a.esriIdMgr_._oAuthDfd;a.hide_(),a.esriIdMgr_._doOAuthSignIn(e.resUrl_,e.sinfo_,e.oinfo_)},cancel_:function(){var e=a.esriIdMgr_._oAuthDfd;a.esriIdMgr_._oAuthDfd=null,a.hide_();var t=new i("identity-manager:user-aborted","ABORTED");e.reject(t)},hide_:function(){t.hide(a.errMsg_),a.hide(),n._DialogLevelManager.hide(a)}}),l=a.domNode;return a.btnSubmit_=s.byNode(d.query(".esriIdSubmit",l)[0]),a.btnCancel_=s.byNode(d.query(".esriIdCancel",l)[0]),a.errMsg_=d.query(".esriErrorMsg",l)[0],a.connect(a.btnSubmit_,"onClick",a.execute_),a.connect(a.btnCancel_,"onClick",a.onCancel),a.connect(a,"onCancel",a.cancel_),a},_doOAuthSignIn:function(e,t,o){var n=this,s={client_id:o.appId,response_type:"token",state:JSON.stringify({portalUrl:o.portalUrl}),expiration:o.expiration,locale:o.locale,redirect_uri:o.popup?r.makeAbsolute(o.popupCallbackUrl):window.location.href.replace(/#.*$/,"")};o.forceLogin&&(s.force_login=!0);var a=o.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",d=a+"?"+h.objectToQuery(s);if(o.popup){var l;if(7===c("ie")?(l=window.open(o.popupCallbackUrl,"esriJSAPIOAuth",o.popupWindowFeatures),l.location=d):l=window.open(d,"esriJSAPIOAuth",o.popupWindowFeatures),l)l.focus(),this._oAuthDfd.oAuthWin_=l,this._oAuthIntervalId=setInterval(function(){if(l.closed){clearInterval(n._oAuthIntervalId);var e=n._oAuthDfd;if(e){var t=new i("identity-manager:user-aborted","ABORTED");e.reject(t)}}},500);else{var u=new i("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(u)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:s,authorizeUrl:a,resourceUrl:e,serverInfo:t,oAuthInfo:o}):window.location=d}}});