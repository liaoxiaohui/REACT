// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/assignHelper","dojo/i18n!dojo/cldr/nls/number","../../Graphic","../../core/date","../../core/Error","../../core/Handles","../../core/lang","../../core/Logger","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../support/arcadeUtils","./support/featureUtils","./support/RelatedFeatures","../support/widget"],function(e,t,r,i,o,a,n,s,l,u,p,c,f,d,h,m,y,g,v){function _(e,t){var r=t[e];if("string"==typeof r){var i=/\'/g,o=encodeURIComponent(r).replace(i,"&apos;");t[e]=o}}function F(e,t){return e&&"feature"===e.type?e.getField(t):null}function b(e){return(""+e).trim()}function I(e,t,r,i){return t=b(t),p.substitute(t&&"{"===t[0]?r:i,e)}function A(e){return e.replace(/[\u00A0-\u99999<>\&]/gim,function(e){return"&#"+e.charCodeAt(0)+";"})}var x=c.getLogger("esri.widgets.FeatureViewModel"),w=/^\s*expression\//i,E=new RegExp(""+a.group,"g"),N=new l("cancelled-query","cancelled feature query"),C=s.getFormat("short-date-short-time"),L="DateFormat"+C;return function(e){function t(t){var r=e.call(this)||this;return r._handles=new u,r._featurePromise=void 0,r._layerDateFields=null,r._expressionAttributes=null,r.content=null,r.contentEnabled=!0,r.formattedAttributes=null,r.title="",r.view=null,r}return r(t,e),t.prototype.destroy=function(){this._clear(),this._handles.destroy(),this._handles=null,this.view=null,this.graphic=null,this._layerDateFields=null,this._expressionAttributes=null},Object.defineProperty(t.prototype,"graphic",{get:function(){return this._get("graphic")||null},set:function(e){if(e){var t=y.getSourceLayer(e);this._layerDateFields=t?this._getDateFields(t):[]}this._set("graphic",e),this._graphicChanged(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"waitingForContent",{get:function(){return!!this._featurePromise},enumerable:!0,configurable:!0}),t.prototype._clear=function(){this._cancelFeatureQuery(),this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},t.prototype._graphicChanged=function(e){var t=this,r=this._handles;if(r){if(r.remove("graphic"),this._clear(),e){r.add(d.watch(this,["graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.fieldInfos","contentEnabled"],function(){t._graphicChanged(t.graphic)}),"graphic");var i=!1,o=this._queryFeature().catch(function(e){e!==N&&x.error("error","error loading template",e)}).then(function(){i=!0,t._featurePromise=null,t.notifyChange("waitingForContent")});i||(this._featurePromise=o,this.notifyChange("waitingForContent"))}}},t.prototype._cancelFeatureQuery=function(){var e=this._featurePromise;e&&"function"==typeof e.cancel&&e.cancel(N),this._featurePromise=null,this.notifyChange("waitingForContent")},t.prototype._compileContent=function(e,t){var r=this;return e&&(e.nodeName||e&&v.isWidgetBase(e)||v.isWidget(e))?e:"string"==typeof e?this._compileText({type:"text",text:e}).text:Array.isArray(e)?e.map(function(e,i){var o=t&&t[i],a=o&&o.value,n=e.type;return"attachments"===n?r._compileAttachments(e,a):"fields"===n?r._compileFields(e):"media"===n?r._compileMedia(e):"text"===n?r._compileText(e):void 0}):void(e&&x.warn("invalid content type."))},t.prototype._compileFields=function(e){var t=this,r=this.graphic,i=p.clone(e),o=r.getEffectivePopupTemplate(),a=o&&o.expressionInfos,n=i.fieldInfos?void 0:o&&o.fieldInfos,s=i.fieldInfos||p.clone(n),l=[];return s&&s.forEach(function(e){var r=e.fieldName.toLowerCase();if(!e.hasOwnProperty("visible")||e.visible){var i=t._isExpressionField(r)?t._getExpressionInfo(a,r):null;e.label=i?i.title:e.label,l.push(e)}}),i.fieldInfos=l,i},t.prototype._setImageValue=function(e){var t=e.value,r=e.formattedAttributes,i=e.layer,o=t.linkURL,a=t.sourceURL;a&&(t.sourceURL=p.substitute(r,this._fixTokens(a,i))),o&&(t.linkURL=b(p.substitute(r,this._fixTokens(o,i))))},t.prototype._compileMedia=function(e){var t=this,r=this,i=r._expressionAttributes,a=r._layerDateFields,n=r.graphic,s=p.clone(e),l=s.mediaInfos||[],u=o({},n.attributes,i),c=y.getSourceLayer(n),f=this.formattedAttributes.global,d={dateFormat:{properties:a,formatter:L}};return s.mediaInfos=l.map(function(e){var r=p.clone(e);if(r){var i=r.value,o=r.type,a=r.title?t._processFieldsInLinks(t._fixTokens(r.title,c),u):"",n=r.caption?t._processFieldsInLinks(t._fixTokens(r.caption,c),u):"";return r.title=a?b(p.substitute(f,a,d)):"",r.caption=n?b(p.substitute(f,n,d)):"","image"===o?(t._setImageValue({value:i,formattedAttributes:f,layer:c}),r.value.sourceURL?r:void 0):"pie-chart"===o||"line-chart"===o||"column-chart"===o||"bar-chart"===o?(t._setChartValue({value:i,attributes:u,formattedAttributes:f,layer:c}),r):void 0}}).filter(Boolean),s},t.prototype._compileText=function(e){var t=this,r=t._expressionAttributes,i=t._layerDateFields,a=t.graphic,n=p.clone(e);if(n&&n.text){var s=y.getSourceLayer(a),l=o({},a.attributes,r),u=this.formattedAttributes.global,c={dateFormat:{properties:i,formatter:L}},f=this._processFieldsInLinks(this._fixTokens(n.text,s),l);n.text=b(p.substitute(u,f,c))}return n},t.prototype._compileTitle=function(){var e=this,t=e._expressionAttributes,r=e._layerDateFields,i=e.graphic,a=i.getEffectivePopupTemplate(),n=a&&a.title,s=o({},i.attributes,t),l=y.getSourceLayer(i),u={dateFormat:{properties:r,formatter:L}},c=this.formattedAttributes.global;if("function"==typeof n)return n.call(null,{graphic:i});if("string"==typeof n&&n){var f=this._processFieldsInLinks(this._fixTokens(n,l),s);return b(p.substitute(c,f,u))}return""},t.prototype._getExpressionInfo=function(e,t){if(this._isExpressionField(t)){var r,i=t.replace(w,"").toLowerCase();return e.some(function(e){if(e.name.toLowerCase()===i)return r=e,!0}),r}},t.prototype._fixTokens=function(e,t){var r=/(\{([^\{\r\n]+)\})/g;return e.replace(r,function(e,r,i){var o=F(t,i);return o?"{"+o.name+"}":r})},t.prototype._encodeAttributes=function(e){var t=e?p.clone(e):{};return Object.keys(t).forEach(function(e){return _(e,t)}),t},t.prototype._formatAttributesToFieldInfos=function(e,t,r){var i=this,o=p.clone(this._layerDateFields);e.forEach(function(a){var n=i._getFixedFieldName(a.fieldName,t);if(a.fieldName=n,r[n]=i._formatValue(r[n],{fieldInfos:e,fieldName:n,layer:t}),o&&a.format&&a.format.dateFormat){var s=o.indexOf(n);s>-1&&o.splice(s,1)}})},t.prototype._getArcadeViewingMode=function(e){return e&&"local"===e.viewingMode?"localScene":"globalScene"},t.prototype._getViewInfo=function(){var e=this.view;if(e){var t="3d"===e.type?this._getArcadeViewingMode(e):"map",r=e.scale,i=e.spatialReference;return m.getViewInfo({viewingMode:t,scale:r,spatialReference:i})}},t.prototype._formatAttributes=function(e){var t=this,r=this,i=r._expressionAttributes,a=r.graphic,n=a.attributes,s=y.getSourceLayer(a),l=n?p.clone(n):{},u=o({},l,i);if(this.addRelatedFeatureAttributes(u),e&&this._formatAttributesToFieldInfos(e,s,u),s){var c=s.typeIdField;n&&Object.keys(n).forEach(function(e){if(!t.isRelatedField(e)){var r=n[e];if(p.isDefined(r)){var i=t._getDomainName(e,r);if(p.isDefined(i))return void(u[e]=i);if(e===c){var o=t._getTypeName();p.isDefined(o)&&(u[e]=o)}}}})}return u},t.prototype._formatValue=function(e,t){var r=this._layerDateFields,i={dateFormat:{properties:r,formatter:L}},o=t.fieldInfos,n=t.fieldName,l=this._getFieldInfo(o,n),u=p.clone(l),c=t.preventPlacesFormatting,f=t.layer,d=F(f,n);if(d&&"date"===d.type){var h=u.format||{};h.dateFormat=h.dateFormat||"short-date-short-time",u.format=h}var m=u&&u.format;if(!p.isDefined(e)||!u||!p.isDefined(m))return e;var y=[],g=m.hasOwnProperty("places")||m.hasOwnProperty("digitSeparator"),v=!m.hasOwnProperty("digitSeparator")||m.digitSeparator,_=p.isDefined(m.places)&&(!c||m.places>0);g&&_&&y.push("places: "+Number(m.places));var b=g?_?"NumberFormat("+y.join(",")+")":"NumberFormat":m.dateFormat?"DateFormat"+(s.getFormat(m.dateFormat)||C):void 0;if(!b)return e;var I=p.substitute({myKey:e},"{myKey:"+b+"}",i)||"";return g&&!v&&a.group?I.replace(E,""):I},t.prototype._getDomainName=function(e,t){var r=this.graphic,i=y.getSourceLayer(r);if(!i||"feature"!==i.type)return null;var o=i.getFieldDomain(e,{feature:r});return o&&"coded-value"===o.type?o.getName(t):null},t.prototype._getFieldInfo=function(e,t){if(e&&e.length&&t){var r=t.toLowerCase(),i=void 0;return e.some(function(e){if(e.fieldName&&e.fieldName.toLowerCase()===r)return i=e,!0}),i}},t.prototype._getTypeName=function(){var e=this.graphic,t=y.getSourceLayer(e);if(t&&"feature"===t.type){var r=t.getFeatureType(e);if(r)return r.name}},t.prototype._processFieldsInLinks=function(e,t){var r=this._encodeAttributes(t),i=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi;return e?e.replace(i,function(e,i,o){return I(e,i||o,t,r)}):e},t.prototype._compileAttachments=function(e,t){var r=p.clone(e);return t?(r.attachmentInfos=t,r):r},t.prototype._queryAttachments=function(){var e=this.graphic,t=y.getSourceLayer(e);if(!t)return f.resolve([]);var r="scene"===t.type&&t.associatedLayer?t.associatedLayer:t;return r&&"feature"===r.type?r.queryFeatureAttachments(e):f.resolve([])},t.prototype._queryContentElements=function(e){var t=this;if(!Array.isArray(e))return f.resolve();var r={};return e.forEach(function(e,i){if("attachments"===e.type){var o=t._queryAttachments();o&&(r[i]=o)}}),Object.keys(r).length?f.eachAlways(r):f.resolve()},t.prototype._getContent=function(){var e=this,t=e.contentEnabled,r=e.graphic;if(!t)return f.resolve();var i=r.getEffectivePopupTemplate(),o=i&&i.content,a="function"==typeof o?o.call(null,{graphic:r}):o;return f.isThenable(a)?a:f.resolve(a)},t.prototype._queryFeature=function(){var e=this;return this._getContent().then(function(t){return e._checkForRelatedFeatures(t).then(function(){return e._expressionAttributes=e._createFormattedExpressions(),e._set("formattedAttributes",e._createFormattedAttributes(t)),e._set("title",e._compileTitle()),e._queryContentElements(t).then(function(r){var i=e._compileContent(t,r);return e._set("content",i||null),i})})})},t.prototype._isExpressionField=function(e){return w.test(e)},t.prototype._createCompiledExpressionDictionary=function(e){var t=new Map;return e?(e.forEach(function(e){return t.set(e.name,m.createFunction(e.expression))}),t):t},t.prototype._getDateFields=function(e){var t=e.fields;return t?t.filter(function(e){return"date"===e.type}).map(function(e){return e.name}):[]},t.prototype._createFormattedExpressions=function(){var e=this,t=this.graphic,r=t.getEffectivePopupTemplate(),i=r&&r.expressionInfos,o=this._createCompiledExpressionDictionary(i),a={};return i&&i.forEach(function(r){var i="expression/"+r.name,n=o.get(r.name),s=e._getViewInfo(),l=m.executeFunction(n,m.createExecContext(t,s));a[i]="string"==typeof l?A(l):l}),a},t.prototype._createFormattedAttributes=function(e){var t=this,r=this.graphic,i=r.getEffectivePopupTemplate(),o=i&&i.fieldInfos,a={global:this._formatAttributes(o),content:[]};return Array.isArray(e)&&e.forEach(function(e,r){"fields"===e.type&&e.fieldInfos&&(a.content[r]=t._formatAttributes(e.fieldInfos))}),a},t.prototype._getAllFieldInfos=function(e){var t=this.graphic,r=[],i=t.getEffectivePopupTemplate(),o=i&&i.fieldInfos;return o&&r.push.apply(r,o),e&&Array.isArray(e)?(e.forEach(function(e){var t=e&&e.fieldInfos;r.push.apply(r,t)}),r):r},t.prototype._checkForRelatedFeatures=function(e){var t=this.graphic,r=this._getAllFieldInfos(e);return this.queryRelatedInfos(t,r)},t.prototype._getChartOption=function(e){var t=e.value,r=e.attributes,i=e.formattedAttributes,o=e.fieldName,n=e.relatedFieldName,s=e.fieldInfos,l=this.graphic,u=y.getSourceLayer(l),p=t.normalizeField,c=t.tooltipField,f=p?this.isRelatedField(p)?r[this.getRelatedFieldInfo(p).fieldName]:r[p]:null,d=n&&void 0!==r[n]?r[n]:void 0!==r[o]?r[o]:i[o],h="string"==typeof d&&a.group?parseFloat(d.replace(E,"")):d,m=void 0===h?null:h&&f?h/f:h,g={y:m};if(this.isRelatedField(o)){var v=this.getRelatedFieldInfo(o),_=this.getRelatedFieldInfo(c),F=_?_.fieldName:null,b=this._formatValue(m,{fieldInfos:s,fieldName:n,layer:u,preventPlacesFormatting:!!f}),I=v?v.label||v.fieldName:n,A=F&&void 0!==r[F]?r[F]:I;return g.tooltip=A+": "+b,g}var x=this._getFieldInfo(s,o),w=this._getFixedFieldName(o,u),N=x?x.label||x.fieldName:o,C=c&&void 0!==i[c]?i[c]:N,L=i[w];return g.tooltip=C+": "+L,g},t.prototype._getFixedFieldName=function(e,t){var r=F(t,e);return r?r.name:e},t.prototype._getFixedFieldNames=function(e,t){var r=this;return e&&e.map(function(e){return r._getFixedFieldName(e,t)})},t.prototype._setChartValue=function(e){var t=this,r=e.value,i=e.attributes,o=e.formattedAttributes,a=e.layer,n=this,s=n.graphic,l=n.relatedInfoCount,u=r.fields,c=r.normalizeField;if(r.fields=this._getFixedFieldNames(u,a),c&&(r.normalizeField=this._getFixedFieldName(c,a)),u.some(function(e){return!!(p.isDefined(o[e])||t.isRelatedField(e)&&l)})){var f=s.getEffectivePopupTemplate(),d=f&&f.fieldInfos;r.chartOptions=r.chartOptions||[],u.forEach(function(e){if(t.isRelatedField(e))return void(r.chartOptions=r.chartOptions.concat(t._getRelatedChartInfos({fieldInfos:d,fieldName:e,formattedAttributes:o,value:r})));var a=t._getChartOption({value:r,attributes:i,formattedAttributes:o,fieldName:e,fieldInfos:d});r.chartOptions.push(a)})}},t.prototype._getRelatedChartInfos=function(e){var t=this,r=e.fieldInfos,i=e.fieldName,o=e.formattedAttributes,a=e.value,n=[],s=this.getRelatedFieldInfo(i),l=s.layerId,u=s.fieldName,p=this.getRelatedInfo(l);if(!p)return n;var c=p.relatedFeatures,f=p.relation;if(!f||!c)return n;var d=f.cardinality;return c.forEach(function(e){var s=e.attributes;s&&Object.keys(s).forEach(function(e){e===u&&n.push(t._getChartOption({value:a,attributes:s,formattedAttributes:o,fieldName:i,relatedFieldName:e,fieldInfos:r}))})}),"one-to-many"===d||"many-to-many"===d?n:[n[0]]},i([h.property({readOnly:!0})],t.prototype,"content",void 0),i([h.property()],t.prototype,"contentEnabled",void 0),i([h.property({readOnly:!0})],t.prototype,"formattedAttributes",void 0),i([h.property({type:n})],t.prototype,"graphic",null),i([h.property({readOnly:!0})],t.prototype,"title",void 0),i([h.property()],t.prototype,"view",void 0),i([h.property({readOnly:!0})],t.prototype,"waitingForContent",null),t=i([h.subclass("esri.widgets.FeatureViewModel")],t)}(h.declared(g))});