// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../geometry","../../Graphic","../../core/Accessor","../../core/Evented","../../core/Handles","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/GraphicsLayer","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../views/2d/draw/Draw","../../views/2d/draw/support/Box","../../views/2d/draw/support/GraphicMover","../../views/2d/draw/support/Reshape","./support/sketchUtils"],function(e,t,r,i,o,n,a,c,s,p,l,h,y,u,g,m,v,w,d,f){var _=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),i([l.property()],t.prototype,"reset",void 0),t=i([l.subclass()],t)}(l.declared(a,c)),S=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=null,t}return r(t,e),i([l.property()],t.prototype,"type",void 0),i([l.property()],t.prototype,"complete",void 0),i([l.property()],t.prototype,"cancel",void 0),t=i([l.subclass()],t)}(l.declared(a,c)),G={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Shift",cancelKey:"Escape"},x=function(){function e(e){this.tool=e,this.type="create-init"}return e}(),b=function(){function e(e,t){this.tool=e,this.geometry=t,this.type="create-start"}return e}(),P=function(){function e(e,t){this.tool=e,this.geometry=t,this.type="create"}return e}(),k=function(){function e(e){this.tool=e,this.type="create-cancel"}return e}(),O=function(){function e(e,t){this.tool=e,this.geometry=t,this.type="create-complete"}return e}(),C=function(){function e(e,t){this.geometry=e,this.graphic=t,this.type="update-init"}return e}(),K=function(){function e(e,t){this.geometry=e,this.graphic=t,this.type="update-cancel"}return e}(),E=function(){function e(e,t){this.geometry=e,this.graphic=t,this.type="update-complete"}return e}(),R=function(){function e(){this.type="reset"}return e}(),T=function(){function e(e,t,r){this.geometry=e,this.angle=t,this.graphic=r,this.type="rotate-start"}return e}(),M=function(){function e(e,t,r){this.geometry=e,this.angle=t,this.graphic=r,this.type="rotate"}return e}(),L=function(){function e(e,t,r){this.geometry=e,this.angle=t,this.graphic=r,this.type="rotate-complete"}return e}(),H=function(){function e(e,t,r,i){this.geometry=e,this.xScale=t,this.yScale=r,this.graphic=i,this.type="scale-start"}return e}(),A=function(){function e(e,t,r,i){this.geometry=e,this.xScale=t,this.yScale=r,this.graphic=i,this.type="scale"}return e}(),V=function(){function e(e,t,r,i){this.geometry=e,this.xScale=t,this.yScale=r,this.graphic=i,this.type="scale-complete"}return e}(),z=function(){function e(e,t,r,i){this.geometry=e,this.dx=t,this.dy=r,this.graphic=i,this.type="move-start"}return e}(),F=function(){function e(e,t,r,i){this.geometry=e,this.dx=t,this.dy=r,this.graphic=i,this.type="move"}return e}(),U=function(){function e(e,t,r,i){this.geometry=e,this.dx=t,this.dy=r,this.graphic=i,this.type="move-complete"}return e}(),j=function(){function e(e,t){this.geometry=e,this.graphic=t,this.type="reshape-start"}return e}(),q=function(){function e(e,t){this.geometry=e,this.graphic=t,this.type="reshape"}return e}(),B=function(){function e(e,t){this.geometry=e,this.graphic=t,this.type="reshape-complete"}return e}();return function(e){function t(t){var r=e.call(this,t)||this;return r._activeLineGraphic=null,r._centerGraphic=null,r._centerSymbol=new g({type:"simple-marker",style:"circle",size:3,color:[255,255,255],outline:{color:[100,100,100]}}),r._defaultGraphicsLayer=new h({listMode:"hide"}),r._defaultSegmentOffset=48,r._handles=new s,r._layer=null,r._lineGraphic=null,r._operationHandle=null,r._targetGraphic=null,r._updatePolygonBoxSymbol=new y({type:"simple-fill",color:[0,200,255,.5],outline:{join:"round",color:[0,12,255],width:2}}),r._vertexGraphics=[],r.activeFillSymbol=new y({type:"simple-fill",style:"solid",color:[150,150,150,.2],outline:{color:[0,0,0,0]}}),r.activeLineSymbol=new u({type:"simple-line",color:[12,207,255,1],width:2,style:"dash"}),r.activePointSymbol=new g({type:"simple-marker",style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),r.draw=null,r.graphic=null,r.hoverVertexSymbol=new g({type:"simple-marker",style:"circle",size:8,color:[33,205,255],outline:{color:[0,12,255],width:1}}),r.layer=null,r.pointSymbol=new g({type:"simple-marker",style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),r.polygonSymbol=new y({type:"simple-fill",color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),r.polylineSymbol=new u({type:"simple-line",color:[130,130,130],width:2}),r.selectedVertexSymbol=new g({type:"simple-marker",style:"circle",size:8,color:[255,255,255],outline:{color:[0,12,255],width:1}}),r.updatePointSymbol=new g({type:"simple-marker",size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),r.updatePolygonSymbol=new y({type:"simple-fill",color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),r.updatePolylineSymbol=new u({type:"simple-line",color:[12,207,255],width:2}),r.vertexSymbol=new g({type:"simple-marker",style:"circle",size:6,color:[33,205,255],outline:{color:[0,12,255],width:1}}),r.view=null,r}return r(t,e),t.prototype.initialize=function(){var e=this;this._handles.add([p.whenOnce(this,"view.ready",function(){e._set("draw",new m({view:e.view}))}),p.when(this,"layer",function(){e.view&&e.view.map.remove(e._defaultGraphicsLayer),e._layer=e.layer}),p.whenNot(this,"layer",function(){e.view&&e.view.map.add(e._defaultGraphicsLayer),e._layer=e._defaultGraphicsLayer})])},t.prototype.destroy=function(){this.reset(),this._handles.removeAll(),this._handles=null,this.view&&this.view.map.remove(this._defaultGraphicsLayer),this._defaultGraphicsLayer.destroy(),this._defaultGraphicsLayer=null,this._layer=null,this.draw&&this.draw.destroy(),this._set("draw",null),this._set("view",null),this.emit("destroy")},Object.defineProperty(t.prototype,"state",{get:function(){var e=!!this.get("view.ready"),t=this._operationHandle;return e&&t?"create"===t.type?"creating":"updating":e?"ready":"disabled"},enumerable:!0,configurable:!0}),t.prototype.complete=function(){this._operationHandle&&this._operationHandle.complete(),this.draw.reset()},t.prototype.create=function(e,t){var r=this;this._operationHandle&&this._operationHandle.cancel(),this._operationHandle=null;var i;switch(e){case"point":i=this._createPointOperation(t);break;case"polygon":i=this._createPolygonOperation(t);break;case"polyline":i=this._createPolylineOperation(t);break;case"multipoint":i=this._createMultipointOperation(t);break;case"rectangle":i=this._createRectangleOperation(t);break;case"circle":i=this._createCircleOperation(t);break;case"ellipse":i=this._createEllipseOperation(t);break;case"triangle":i=this._createTriangleOperation(t)}if(i)return i.on("complete",function(){i===r._operationHandle&&(r._operationHandle=null,r.emit("create-complete",new O(e,r.graphic.geometry.clone())))}),i.on("cancel",function(){i===r._operationHandle&&(r._operationHandle=null,r.emit("create-cancel",new k(e)))}),this._operationHandle=i,this.emit("create-init",new x(e)),i},t.prototype.reset=function(){this._clearGraphics(),this._operationHandle&&this._operationHandle.cancel(),this._operationHandle=null,this.view.container.style.cursor="default",this.graphic&&this._layer.remove(this.graphic),this._set("graphic",null),this.draw.reset(),this.emit("reset",new R)},t.prototype.update=function(e,t){var r=this;if(this._operationHandle&&this._operationHandle.cancel(),this._operationHandle=null,e&&e.geometry){var i;switch(e.geometry.type){case"point":i=this._updatePointOperation(e,t);break;case"polyline":i=this._updatePolylineOperation(e,t);break;case"polygon":i=this._updatePolygonOperation(e,t)}if(i)return i.on("complete",function(){i===r._operationHandle&&(r._operationHandle=null,r.emit("update-complete",new E(r.graphic.geometry,e)))}),i.on("cancel",function(){i===r._operationHandle&&(r._operationHandle=null,r.emit("update-cancel",new K(r.graphic.geometry,e)))}),this._operationHandle=i,this.emit("update-init",new C(this.graphic.geometry,e)),i}},t.prototype._createPointOperation=function(e){var t=this,r=this.draw.create("point",e),i=null,a=[r.on("cursor-update",function(e){i=t._displayCrosshairCursor()}),r.on("draw-complete",function(e){t._layer.remove(t.graphic);var r=e.coordinates,i=r[0],a=r[1];t._set("graphic",new n(new o.Point({x:i,y:a,spatialReference:t.view.spatialReference}),t.pointSymbol)),c&&c.complete()})],c=new S({type:"create",complete:function(){t._layer.remove(t.graphic),i&&i.reset(),a.forEach(function(e){return e.remove()}),t.draw.reset(),c.emit("complete")},cancel:function(){t._layer.remove(t.graphic),i&&i.reset(),a.forEach(function(e){return e.remove()}),t.draw.reset(),c.emit("cancel")}});return c},t.prototype._createPolygonOperation=function(e){var t=this,r="polygon",i=this.draw.create(r,e),a=new o.Point,c=null,s=null,p=!1,l=[i.on("vertex-add",function(e){var i=e.vertices;s=e,p&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,!1),1===i.length?t.emit("create-start",new b(r,t.graphic.geometry)):t.emit("create",new P(r,t.graphic.geometry))}),i.on("vertex-remove",function(e){var i=e.vertices;s=e,p&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,!1),t.emit("create",new P(r,t.graphic.geometry))}),i.on("vertex-update",function(e){var r=e.vertices;s=e,p&&t._snapLastVertexToAxis(r),t._showPolygonGraphic(r,!1),t.emit("create",new P("polyline",t.graphic.geometry))}),i.on("cursor-update",function(e){var r=e.vertices,i=e.native;s=e,t.view.toMap(i.x,i.y,a),p&&t._snapLastVertexToAxis(r),t._showPolygonGraphic(r,!0)}),i.on("draw-complete",function(e){t._layer.remove(t.graphic),t._set("graphic",new n(f.createPolygon([e.vertices],t.view),t.polygonSymbol)),h&&h.complete()}),i.on("undo",function(e){var r=e.vertices,i=s&&"cursor-update"===s.type;if(!r.length)return void t._clearGraphics();p&&t._snapLastVertexToAxis(r),t._showPolygonGraphic(r,i)}),i.on("redo",function(e){var r=e.vertices,i=s&&"cursor-update"===s.type;p&&t._snapLastVertexToAxis(r),t._showPolygonGraphic(r,i)}),this.view.on("key-down",function(e){var r=i.vertices.slice(0),o=s&&"cursor-update"===s.type;e.key!==G.constraintKey||p?e.key===G.undoKey?(e.stopPropagation(),i.canUndo()&&i.undo()):e.key===G.redoKey?(e.stopPropagation(),i.canRedo()&&i.redo()):e.key===G.cancelKey&&h&&h.cancel():(p=!0,o&&t._snapLastVertexToAxis(r),t._showPolygonGraphic(r,o))}),this.view.on("key-up",function(e){var r=i.vertices.slice(0),o=s&&"cursor-update"===s.type;e.key===G.constraintKey&&(p=!1,r.pop(),r.push([a.x,a.y]),t._showPolygonGraphic(r,o))}),this.view.on("pointer-down",function(e){t.view.hitTest(e).then(function(r){var i=r.results;if(i.length&&i[0].graphic){var o=i[0].graphic;0===t._vertexGraphics.indexOf(o)&&e.stopPropagation()}})}),this.view.on("click",function(e){t.view.hitTest(e).then(function(r){var o=r.results;if(o.length&&o[0].graphic){var n=o[0].graphic;0===t._vertexGraphics.indexOf(n)&&t._vertexGraphics.length>2&&(e.stopPropagation(),s&&"cursor-update"===s.type&&i.vertices.pop(),i.complete())}})}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){c=t._displayCrosshairCursor()})})],h=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),c&&c.reset(),l.forEach(function(e){return e.remove()}),t.draw.reset(),h.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),c&&c.reset(),l.forEach(function(e){return e.remove()}),t.draw.reset(),h.emit("cancel")}});return h},t.prototype._createPolylineOperation=function(e){var t=this,r="polyline",i=this.draw.create(r,e),a=new o.Point,c=null,s=null,p=!1,l=[i.on("vertex-add",function(e){var i=e.vertices;c=e,p&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,!1),1===i.length?t.emit("create-start",new b(r,t.graphic.geometry)):t.emit("create",new P(r,t.graphic.geometry))}),i.on("vertex-remove",function(e){var i=e.vertices;c=e,p&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,!1),t.emit("create",new P(r,t.graphic.geometry))}),i.on("vertex-update",function(e){var i=e.vertices;c=e,p&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,!1),t.emit("create",new P(r,t.graphic.geometry))}),i.on("cursor-update",function(e){var r=e.vertices,i=e.native;c=e,t.view.toMap(i.x,i.y,a),p&&t._snapLastVertexToAxis(r),t._showPolylineGraphic(r,!0)}),i.on("draw-complete",function(e){t._layer.remove(t.graphic),t._set("graphic",new n(f.createPolyline([e.vertices],t.view),t.polylineSymbol)),h&&h.complete()}),i.on("undo",function(e){var r=e.vertices,i=c&&"cursor-update"===c.type;if(!r.length)return void t._clearGraphics();p&&t._snapLastVertexToAxis(r),t._showPolylineGraphic(r,i)}),i.on("redo",function(e){var r=e.vertices,i=c&&"cursor-update"===c.type;p&&t._snapLastVertexToAxis(r),t._showPolylineGraphic(r,i)}),this.view.on("key-down",function(e){var r=i.vertices.slice(0),o=c&&"cursor-update"===c.type;e.key!==G.constraintKey||p?e.key===G.undoKey?(e.stopPropagation(),i.canUndo()&&i.undo()):e.key===G.redoKey?(e.stopPropagation(),i.canRedo()&&i.redo()):e.key===G.cancelKey&&h&&h.cancel():(p=!0,o&&t._snapLastVertexToAxis(r),t._showPolylineGraphic(r,o))}),this.view.on("key-up",function(e){var r=i.vertices.slice(0),o=c&&"cursor-update"===c.type;e.key===G.constraintKey&&(p=!1,r.pop(),r.push([a.x,a.y]),t._showPolylineGraphic(r,o))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){s=t._displayCrosshairCursor()})})],h=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),s&&s.reset(),l.forEach(function(e){return e.remove()}),t.draw.reset(),h.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),s&&s.reset(),l.forEach(function(e){return e.remove()}),t.draw.reset(),h.emit("cancel")}});return h},t.prototype._createRectangleOperation=function(e){var t=this,r="rectangle",i=this.draw.create(r,e),o=null,a=!1,c=!1,s=[i.on("vertex-add",function(e){var i=e.vertices;t._showRectangleGraphic(i,c,a),1===i.length?t.emit("create-start",new b(r,t.graphic.geometry)):t.emit("create",new P(r,t.graphic.geometry))}),i.on("cursor-update",function(e){t._showRectangleGraphic(e.vertices,c,a)}),i.on("draw-complete",function(e){t._layer.remove(t.graphic);var r=e.vertices.slice(0);if(1===r.length){a=!1,c=!1;var i=t.view.toScreen(r[0][0],r[0][1],null),o=t.view.toMap(i.x-t._defaultSegmentOffset,i.y+t._defaultSegmentOffset),s=t.view.toMap(i.x+t._defaultSegmentOffset,i.y-t._defaultSegmentOffset);r=[[o.x,o.y],[s.x,s.y]]}var l=a?f.createSquare(r,t.view,c):f.createRectangle(r,t.view,c);t._set("graphic",new n(l,t.polygonSymbol)),p&&p.complete()}),this.view.on("key-down",function(e){e.key!==G.constraintKey||a?e.key!==G.centerKey||c?e.key===G.cancelKey&&p&&p.cancel():(c=!0,t._showRectangleGraphic(i.vertices,c,a)):(a=!0,t._showRectangleGraphic(i.vertices,c,a))}),this.view.on("key-up",function(e){e.key===G.constraintKey?(a=!1,t._showRectangleGraphic(i.vertices,c,a)):e.key===G.centerKey&&(c=!1,t._showRectangleGraphic(i.vertices,c,a))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){o=t._displayCrosshairCursor()})})],p=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),o&&o.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),o&&o.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("cancel")}});return p},t.prototype._createMultipointOperation=function(e){var t=this,r="multipoint",i=this.draw.create(r,e),o=null,a=[i.on("vertex-add",function(e){var i=e.vertices;t._showMultipointGraphic(i),1===i.length?t.emit("create-start",new b(r,t.graphic.geometry)):t.emit("create",new P(r,t.graphic.geometry))}),i.on("vertex-remove",function(e){t._showMultipointGraphic(e.vertices),t.emit("create",new P(r,t.graphic.geometry))}),i.on("vertex-update",function(e){t._showMultipointGraphic(e.vertices),t.emit("create",new P(r,t.graphic.geometry))}),i.on("cursor-update",function(e){t._showMultipointGraphic(e.vertices)}),i.on("draw-complete",function(e){t._layer.remove(t.graphic),t._set("graphic",new n(f.createMultipoint(e.vertices,t.view),t.pointSymbol)),c&&c.complete()}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){o=t._displayCrosshairCursor()})}),this.view.on("key-down",function(e){e.key===G.cancelKey&&c&&c.cancel()})],c=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),o&&o.reset(),a.forEach(function(e){return e.remove()}),t.draw.reset(),c.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),o&&o.reset(),a.forEach(function(e){return e.remove()}),t.draw.reset(),c.emit("cancel")}});return c},t.prototype._createCircleOperation=function(e){var t=this,r=this.draw.create("circle",e),i=null,a=!1,c=!1,s=[r.on("vertex-add",function(e){var r=e.vertices;t._showCircleGraphic(r,c,a),1===r.length?t.emit("create-start",new b("circle",t.graphic.geometry)):t.emit("create",new P("circle",t.graphic.geometry))}),r.on("cursor-update",function(e){t._showCircleGraphic(e.vertices,c,a)}),r.on("draw-complete",function(e){t._layer.remove(t.graphic);var i=e.vertices.slice(0);if(1===i.length){a=!1,c=!0;var s=t.view.toScreen(i[0][0],i[0][1],null),l=new o.ScreenPoint({x:s.x+t._defaultSegmentOffset,y:s.y});i.push(r.getCoordsFromScreenPoint(l))}var h=a?f.createEllipse(i,t.view,c):f.createCircle(i,t.view,c);t._set("graphic",new n(h,t.polygonSymbol)),p&&p.complete()}),this.view.on("key-down",function(e){e.key!==G.constraintKey||a?e.key!==G.centerKey||c?e.key===G.cancelKey&&p&&p.cancel():(c=!0,t._showCircleGraphic(r.vertices,c,a)):(a=!0,t._showCircleGraphic(r.vertices,c,a))}),this.view.on("key-up",function(e){e.key===G.constraintKey?(a=!1,t._showCircleGraphic(r.vertices,c,a)):e.key===G.centerKey&&(c=!1,t._showCircleGraphic(r.vertices,c,a))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){i=t._displayCrosshairCursor()})})],p=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),i&&i.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),i&&i.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("cancel")}});return p},t.prototype._createEllipseOperation=function(e){var t=this,r=this.draw.create("ellipse",e),i=null,a=!1,c=!1,s=[r.on("vertex-add",function(e){var r=e.vertices;t._showEllipseGraphic(e.vertices,c,a),1===r.length?t.emit("create-start",new b("ellipse",t.graphic.geometry)):t.emit("create",new P("ellipse",t.graphic.geometry))}),r.on("cursor-update",function(e){t._showEllipseGraphic(e.vertices,c,a)}),r.on("draw-complete",function(e){t._layer.remove(t.graphic);var i=e.vertices.slice(0);if(1===i.length){a=!0,c=!0;var s=t.view.toScreen(i[0][0],i[0][1],null),l=new o.ScreenPoint({x:s.x+t._defaultSegmentOffset,y:s.y});i.push(r.getCoordsFromScreenPoint(l))}var h=a?f.createCircle(i,t.view,c):f.createEllipse(i,t.view,c);t._set("graphic",new n(h,t.polygonSymbol)),p&&p.complete()}),this.view.on("key-down",function(e){e.key!==G.constraintKey||a?"Alt"!==e.key||c?e.key===G.cancelKey&&p&&p.cancel():(c=!0,t._showEllipseGraphic(r.vertices,c,a)):(a=!0,t._showEllipseGraphic(r.vertices,c,a))}),this.view.on("key-up",function(e){e.key===G.constraintKey?(a=!1,t._showEllipseGraphic(r.vertices,c,a)):e.key===G.centerKey&&(c=!1,t._showEllipseGraphic(r.vertices,c,a))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){i=t._displayCrosshairCursor()})})],p=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),i&&i.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),i&&i.reset(),s.forEach(function(e){return e.remove()}),t.draw.reset(),p.emit("cancel")}});return p},t.prototype._createTriangleOperation=function(e){var t=this,r="triangle",i=this.draw.create(r,e),a=null,c=!1,s=!1,p=[i.on("vertex-add",function(e){var i=e.vertices;t._showTriangleGraphic(e.vertices,s,c),1===i.length?t.emit("create-start",new b(r,t.graphic.geometry)):t.emit("create",new P(r,t.graphic.geometry))}),i.on("cursor-update",function(e){t._showTriangleGraphic(e.vertices,s,c)}),i.on("draw-complete",function(e){t._layer.remove(t.graphic);var r=e.vertices.slice(0);if(1===r.length){c=!0,s=!0;var a=t.view.toScreen(r[0][0],r[0][1],null),p=new o.ScreenPoint({x:a.x+t._defaultSegmentOffset,y:a.y});r.push(i.getCoordsFromScreenPoint(p))}t._set("graphic",new n(f.createTriangle(r,t.view,s,c),t.polygonSymbol)),l&&l.complete()}),this.view.on("key-down",function(e){e.key!==G.constraintKey||c?e.key!==G.centerKey||s?e.key===G.cancelKey&&l&&l.cancel():(s=!0,t._showTriangleGraphic(i.vertices,s,c)):(c=!0,t._showTriangleGraphic(i.vertices,s,c))}),this.view.on("key-up",function(e){e.key===G.constraintKey?(c=!1,t._showTriangleGraphic(i.vertices,s,c)):e.key===G.centerKey&&(s=!1,t._showTriangleGraphic(i.vertices,s,c))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){a=t._displayCrosshairCursor()})})],l=new S({type:"create",complete:function(){t._clearGraphics(),t._layer.remove(t.graphic),a&&a.reset(),p.forEach(function(e){return e.remove()}),t.draw.reset(),l.emit("complete")},cancel:function(){t._clearGraphics(),t._layer.remove(t.graphic),a&&a.reset(),p.forEach(function(e){return e.remove()}),t.draw.reset(),l.emit("cancel")}});return l},t.prototype._updatePointOperation=function(e,t){var r=this,i=null,o=new n(e.geometry,this.updatePointSymbol);this._layer.add(o),this._set("graphic",o.clone());var a=[this.view.on("click",function(t){r.view.hitTest(t).then(function(t){var r=t.results;r.length&&r[0].graphic&&r[0].graphic===o||(o.geometry!==e.geometry?s&&s.complete():s&&s.cancel())})}),this.view.on("key-down",function(t){t.key===G.cancelKey&&(r.graphic.geometry!==e.geometry?s&&s.complete():s&&s.cancel())})],c=new w({graphics:[o],view:this.view,callbacks:{onGraphicMoveStart:function(t){r.emit("move-start",new z(r.graphic.geometry,t.dx,t.dy,e))},onGraphicMove:function(t){r._set("graphic",t.graphic),r.emit("move",new F(r.graphic.geometry,t.dx,t.dy,e))},onGraphicMoveStop:function(t){r._set("graphic",t.graphic),r.emit("move-complete",new U(r.graphic.geometry,t.dx,t.dy,e))},onGraphicPointerOver:function(e){i=r._displayPointerCursor()},onGraphicPointerOut:function(e){i&&i.reset(),i=null}}}),s=new S({type:"update",complete:function(){c.destroy(),r._layer.remove(o),a.forEach(function(e){return e.remove()}),i&&i.reset(),r.draw.reset(),r.graphic.set("geometry",o.geometry),s.emit("complete")},cancel:function(){c.destroy(),r._layer.remove(o),a.forEach(function(e){return e.remove()}),i&&i.reset(),r.draw.reset(),r.graphic.set("geometry",o.geometry),s.emit("cancel")}});return s},t.prototype._updatePolygonOperation=function(e,t){var r=this;this._set("graphic",new n(e.geometry,this.updatePolygonSymbol)),this._layer.add(this.graphic);var i=new v({graphic:this.graphic,view:this.view,callbacks:{onMoveStart:function(t){r.emit("move-start",new z(r.graphic.geometry,t.dx,t.dy,e))},onMove:function(t){r._set("graphic",t.graphic),r.emit("move",new F(r.graphic.geometry,t.dx,t.dy,e))},onMoveStop:function(t){r._set("graphic",t.graphic),r.emit("move-complete",new U(r.graphic.geometry,t.dx,t.dy,e))},onScaleStart:function(t){r.emit("scale-start",new H(r.graphic.geometry,t.xScale,t.yScale,e))},onScale:function(t){r._set("graphic",t.graphic),r.emit("scale",new A(r.graphic.geometry,t.xScale,t.yScale,e))},onScaleStop:function(t){r._set("graphic",t.graphic),r.emit("scale-complete",new V(r.graphic.geometry,t.xScale,t.yScale,e))},onRotateStart:function(t){r.emit("rotate-start",new T(r.graphic.geometry,t.angle,e))},onRotate:function(t){r._set("graphic",t.graphic),r.emit("rotate",new M(r.graphic.geometry,t.angle,e))},onRotateStop:function(t){r._set("graphic",t.graphic),r.emit("rotate-complete",new L(r.graphic.geometry,t.angle,e))}}}),o=new d({graphic:null,view:this.view,callbacks:{onReshapeStart:function(t){r._set("graphic",t.graphic),r.emit("reshape-start",new j(r.graphic.geometry,e))},onReshape:function(t){r._set("graphic",t.graphic),r.emit("reshape",new q(r.graphic.geometry,e))},onReshapeStop:function(t){r._set("graphic",t.graphic),r.emit("reshape-complete",new B(r.graphic.geometry,e))},onMoveStart:function(t){r.emit("move-start",new z(r.graphic.geometry,t.dx,t.dy,e))},onMove:function(t){r._set("graphic",t.graphic),r.emit("move",new F(r.graphic.geometry,t.dx,t.dy,e))},onMoveStop:function(t){r._set("graphic",t.graphic),r.emit("move-complete",new U(r.graphic.geometry,t.dx,t.dy,e))}}}),a=[this.view.on("click",function(t){r.view.hitTest(t).then(function(t){if(t.results.length&&t.results[0].graphic){var n=t.results[0].graphic;if(i&&(i.handleGraphics.indexOf(n)>-1||n===i.rotateGraphic))return;if(o&&o.handleGraphics.indexOf(n)>-1)return;if(n===i.boxGraphic)return r.graphic.set("symbol",r._updatePolygonBoxSymbol),i.graphic=null,void(o.graphic=r.graphic);if(n===r.graphic)return r.graphic.set("symbol",r.updatePolygonSymbol),o.graphic=null,void(i.graphic=r.graphic)}r.graphic.geometry!==e.geometry?c&&c.complete():c&&c.cancel()})}),this.view.on("key-down",function(t){t.key===G.cancelKey?r.graphic.geometry!==e.geometry?c&&c.complete():c&&c.cancel():t.key===G.constraintKey&&i&&!t.repeat&&i.set("uniformScaling",!0)}),this.view.on("key-up",function(e){e.key===G.constraintKey&&i&&i.set("uniformScaling",!1)})],c=new S({type:"update",complete:function(){i&&i.destroy(),o&&o.destroy(),r._layer.remove(r.graphic),a.forEach(function(e){return e.remove()});var e=f.createPolygon(r.graphic.geometry.rings,r.view);r.graphic.set("geometry",e),c.emit("complete")},cancel:function(){i&&i.destroy(),o&&o.destroy(),r._layer.remove(r.graphic),a.forEach(function(e){return e.remove()}),c.emit("cancel")}});return c},t.prototype._updatePolylineOperation=function(e,t){var r=this;this._set("graphic",new n(e.geometry,this.updatePolylineSymbol)),this._layer.add(this.graphic);var i=new v({graphic:this.graphic,view:this.view,callbacks:{onMoveStart:function(t){r.emit("move-start",new z(r.graphic.geometry,t.dx,t.dy,e))},onMove:function(t){r._set("graphic",t.graphic),r.emit("move",new F(r.graphic.geometry,t.dx,t.dy,e))},onMoveStop:function(t){r._set("graphic",t.graphic),r.emit("move-complete",new U(r.graphic.geometry,t.dx,t.dy,e))},onScaleStart:function(t){r.emit("scale-start",new H(r.graphic.geometry,t.xScale,t.yScale,e))},onScale:function(t){r._set("graphic",t.graphic),r.emit("scale",new A(r.graphic.geometry,t.xScale,t.yScale,e))},onScaleStop:function(t){r._set("graphic",t.graphic),r.emit("scale-complete",new V(r.graphic.geometry,t.xScale,t.yScale,e))},onRotateStart:function(t){r.emit("rotate-start",new T(r.graphic.geometry,t.angle,e))},onRotate:function(t){r._set("graphic",t.graphic),r.emit("rotate",new M(r.graphic.geometry,t.angle,e))},onRotateStop:function(t){r._set("graphic",t.graphic),r.emit("rotate-complete",new L(r.graphic.geometry,t.angle,e))}}}),o=new d({graphic:null,view:this.view,callbacks:{onReshapeStart:function(t){r._set("graphic",t.graphic),r.emit("reshape-start",new j(r.graphic.geometry,e))},onReshape:function(t){r._set("graphic",t.graphic),r.emit("reshape",new q(r.graphic.geometry,e))},onReshapeStop:function(t){r._set("graphic",t.graphic),r.emit("reshape-complete",new B(r.graphic.geometry,e))},onMoveStart:function(t){r.emit("move-start",new z(r.graphic.geometry,t.dx,t.dy,e))},onMove:function(t){r._set("graphic",t.graphic),r.emit("move",new F(r.graphic.geometry,t.dx,t.dy,e))},onMoveStop:function(t){r._set("graphic",t.graphic),r.emit("move-complete",new U(r.graphic.geometry,t.dx,t.dy,e))}}}),a=[this.view.on("click",function(t){r.view.hitTest(t).then(function(t){if(t.results.length&&t.results[0].graphic){var n=t.results[0].graphic;if(i&&(i.handleGraphics.indexOf(n)>-1||n===i.rotateGraphic))return;if(o&&o.handleGraphics.indexOf(n)>-1)return;if(n===i.boxGraphic)return r.graphic.set("symbol",r.updatePolylineSymbol),i.graphic=null,void(o.graphic=r.graphic);if(n===r.graphic)return r.graphic.set("symbol",r.updatePolylineSymbol),o.graphic=null,void(i.graphic=r.graphic)}r.graphic.geometry!==e.geometry?c&&c.complete():c&&c.cancel()})}),this.view.on("key-down",function(t){t.key===G.cancelKey?r.graphic.geometry!==e.geometry?c&&c.complete():c&&c.cancel():t.key===G.constraintKey&&i&&!t.repeat&&i.set("uniformScaling",!0)}),this.view.on("key-up",function(e){e.key===G.constraintKey&&i&&i.set("uniformScaling",!1)})],c=new S({type:"update",complete:function(){i&&i.destroy(),o&&o.destroy(),r._layer.remove(r.graphic),a.forEach(function(e){return e.remove()}),c.emit("complete")},cancel:function(){i&&i.destroy(),o&&o.destroy(),r._layer.remove(r.graphic),a.forEach(function(e){return e.remove()}),c.emit("cancel")}});return c},t.prototype._showPolygonGraphic=function(e,t){var r=this;if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var i=e[0],a=i[0],c=i[1],s=new n(new o.Point(a,c,this.view.spatialReference),this.activePointSymbol);return t||(this._vertexGraphics.push(s),this._layer.add(s)),void this._set("graphic",s)}var p,l;if(2===e.length?(p=f.createPolyline([e],this.view),l=this.polylineSymbol):(p=f.createPolygon([e],this.view),l=this.polygonSymbol,this._targetGraphic=new n(p,this.activeFillSymbol),this._layer.add(this._targetGraphic)),this._set("graphic",new n(p,l)),t){var h=e.map(function(e){return Array.apply([],e)}),y=h.pop(),u=[h[h.length-1],y];this._lineGraphic=new n(f.createPolyline([h],this.view),this.polylineSymbol),this._layer.add(this._lineGraphic),this._activeLineGraphic=new n(f.createPolyline(u,this.view),this.activeLineSymbol),this._layer.add(this._activeLineGraphic),h.forEach(function(e,t){var i=t===h.length-1?r.activePointSymbol:r.pointSymbol,a=new n({geometry:new o.Point({x:e[0],y:e[1],spatialReference:r.view.spatialReference}),symbol:i});r._vertexGraphics.push(a),r._layer.add(a)})}else this._lineGraphic=new n(f.createPolyline([e],this.view),this.polylineSymbol),this._layer.add(this._lineGraphic),e.forEach(function(t,i){var a=i===e.length-1?r.activePointSymbol:r.pointSymbol,c=new n({geometry:new o.Point({x:t[0],y:t[1],spatialReference:r.view.spatialReference}),symbol:a});r._vertexGraphics.push(c),r._layer.add(c)})},t.prototype._showPolylineGraphic=function(e,t){var r=this;if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var i=e[0],a=i[0],c=i[1];return void this._set("graphic",new n(new o.Point(a,c,this.view.spatialReference),this.pointSymbol))}if(this._set("graphic",new n(f.createPolyline([e],this.view),this.polylineSymbol)),t){var s=e.map(function(e){return Array.apply([],e)}),p=s.pop(),l=[s[s.length-1],p];this._lineGraphic=new n(f.createPolyline(s,this.view),this.polylineSymbol),this._layer.add(this._lineGraphic),this._activeLineGraphic=new n(f.createPolyline(l,this.view),this.activeLineSymbol),this._layer.add(this._activeLineGraphic),s.forEach(function(e,t){var i=t===s.length-1?r.activePointSymbol:r.pointSymbol,a=new n({geometry:new o.Point({x:e[0],y:e[1],spatialReference:r.view.spatialReference}),symbol:i});r._vertexGraphics.push(a),r._layer.add(a)})}else this._lineGraphic=new n(f.createPolyline([e],this.view),this.polylineSymbol),this._layer.add(this._lineGraphic),e.forEach(function(t,i){var a=i===e.length-1?r.activePointSymbol:r.pointSymbol,c=new n({geometry:new o.Point({x:t[0],y:t[1],spatialReference:r.view.spatialReference}),symbol:a});r._vertexGraphics.push(c),r._layer.add(c)})},t.prototype._showRectangleGraphic=function(e,t,r){if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var i=e[0],a=i[0],c=i[1];return void this._set("graphic",new n(new o.Point(a,c,this.view.spatialReference),this.pointSymbol))}var s=r?f.createSquare(e,this.view,t):f.createRectangle(e,this.view,t);this._toggleCenterGraphic(s),this._set("graphic",new n(s,this.polygonSymbol)),
this._layer.add(this.graphic)},t.prototype._showMultipointGraphic=function(e){this._layer.remove(this.graphic),this._set("graphic",new n(f.createMultipoint(e,this.view),this.pointSymbol)),this._layer.add(this.graphic)},t.prototype._showCircleGraphic=function(e,t,r){if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var i=e[0],a=i[0],c=i[1];return void this._set("graphic",new n(new o.Point(a,c,this.view.spatialReference),this.pointSymbol))}var s=r?f.createEllipse(e,this.view,t):f.createCircle(e,this.view,t);this._toggleCenterGraphic(s),this._set("graphic",new n(s,this.polygonSymbol)),this._layer.add(this.graphic)},t.prototype._showEllipseGraphic=function(e,t,r){if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var i=e[0],a=i[0],c=i[1];return void this._set("graphic",new n(new o.Point(a,c,this.view.spatialReference),this.pointSymbol))}var s=r?f.createCircle(e,this.view,t):f.createEllipse(e,this.view,t);this._toggleCenterGraphic(s),this._set("graphic",new n(s,this.polygonSymbol)),this._layer.add(this.graphic)},t.prototype._showTriangleGraphic=function(e,t,r){if(this._layer.remove(this.graphic),this._clearGraphics(),1===e.length){var i=e[0],a=i[0],c=i[1];return void this._set("graphic",new n(new o.Point(a,c,this.view.spatialReference),this.pointSymbol))}var s=f.createTriangle(e,this.view,t,r);this._toggleCenterGraphic(s),this._set("graphic",new n(s,this.polygonSymbol)),this._layer.add(this.graphic)},t.prototype._toggleCenterGraphic=function(e){this._layer.remove(this._centerGraphic),this._centerGraphic=null,e&&e.extent&&e.extent.center&&(this._centerGraphic=new n(e.extent.center,this._centerSymbol),this._layer.add(this._centerGraphic))},t.prototype._clearGraphics=function(){this._toggleCenterGraphic(),this._layer.remove(this._targetGraphic),this._targetGraphic=null,this._layer.remove(this._lineGraphic),this._lineGraphic=null,this._layer.remove(this._activeLineGraphic),this._activeLineGraphic=null,this._layer.removeMany(this._vertexGraphics),this._vertexGraphics=[]},t.prototype._snapLastVertexToAxis=function(e){if(!(e.length<2)){var t=e.pop(),r=e[e.length-1],i=this.view.toScreen(t[0],t[1],null),o=this.view.toScreen(r[0],r[1],null),n=Math.abs(i.x-o.x),a=Math.abs(i.y-o.y),c=this.view.toMap(n>a?i.x:o.x,n>a?o.y:i.y);e.push([c.x,c.y])}},t.prototype._displayCrosshairCursor=function(){var e=this;return"crosshair"!==this.view.container.style.cursor&&(this.view.container.style.cursor="crosshair"),new _({reset:function(){"default"!==e.view.container.style.cursor&&(e.view.container.style.cursor="default")}})},t.prototype._displayPointerCursor=function(){var e=this;return"pointer"!==this.view.container.style.cursor&&(this.view.container.style.cursor="pointer"),new _({reset:function(){"default"!==e.view.container.style.cursor&&(e.view.container.style.cursor="default")}})},i([l.property()],t.prototype,"_operationHandle",void 0),i([l.property()],t.prototype,"activeFillSymbol",void 0),i([l.property()],t.prototype,"activeLineSymbol",void 0),i([l.property()],t.prototype,"activePointSymbol",void 0),i([l.property({readOnly:!0})],t.prototype,"draw",void 0),i([l.property({readOnly:!0})],t.prototype,"graphic",void 0),i([l.property()],t.prototype,"hoverVertexSymbol",void 0),i([l.property()],t.prototype,"layer",void 0),i([l.property()],t.prototype,"pointSymbol",void 0),i([l.property()],t.prototype,"polygonSymbol",void 0),i([l.property()],t.prototype,"polylineSymbol",void 0),i([l.property()],t.prototype,"selectedVertexSymbol",void 0),i([l.property({dependsOn:["view.ready","_operationHandle"],readOnly:!0})],t.prototype,"state",null),i([l.property()],t.prototype,"view",void 0),t=i([l.subclass("esri.widgets.Sketch.SketchViewModel")],t)}(l.declared(a,c))});