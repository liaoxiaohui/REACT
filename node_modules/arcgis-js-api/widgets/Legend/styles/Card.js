// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/i18n!../../../nls/common","dojo/i18n!../../Legend/nls/Legend","dojox/gfx","../../../core/lang","../../../core/accessorSupport/decorators","../../Widget","./common","../../Legend/support/styleUtils","../../support/colorUtils","../../support/widget"],function(e,t,r,s,a,i,l,o,n,c,d,h,y,p){var m={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card esri-widget",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",hidden:"esri-hidden",header:"esri-widget__header"},g="esri-legend--card__";return function(e){function t(t){var r=e.call(this)||this;return r._hasIndicators=!1,r._selectedSectionName=null,r._sectionNames=[],r._sectionMap=new Map,r.activeLayerInfos=null,r.view=null,r}return r(t,e),t.prototype.render=function(){var e=this;this._sectionNames.length=0,this._hasIndicators=this.view.container.clientWidth<=768;var t=this.activeLayerInfos,r=t&&t.toArray().map(function(t){return e._renderLegendForLayer(t)}).filter(function(e){return!!e});this._hasIndicators?this._selectedSectionName&&-1!==this._sectionNames.indexOf(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;var s=this._sectionNames.length,l=this._sectionNames.map(function(t,r){var i,l=o.substitute({index:r+1,total:s},a.pagination.pageText);return p.tsx("div",{key:t,"aria-label":l,title:l,tabIndex:0,onclick:e._selectSection,onkeydown:e._selectSection,bind:e,class:e.classes(m.indicator,(i={},i[m.activated]=e._selectedSectionName===t,i)),"data-section-name":t})}),n=this._hasIndicators?p.tsx("div",{class:m.indicatorContainer,key:"carousel-navigation"},l):null,c=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):r&&r.length?r:null;return p.tsx("div",{class:m.base},n,c||p.tsx("div",{class:m.message},i.noLegend))},t.prototype._selectSection=function(e){var t=e.target,r=t.getAttribute("data-section-name");r&&(this._selectedSectionName=r)},t.prototype._renderLegendForLayer=function(e){var t,r=this;if(!e.ready)return null;var s=!!e.children.length,a=""+g+e.layer.uid+"-version-"+e.version;if(s){var i=e.children.map(function(e){return r._renderLegendForLayer(e)}).toArray();return this._sectionNames.push(a),p.tsx("div",{key:e.layer.uid,class:this.classes(m.service,m.groupLayer)},p.tsx("div",{class:m.serviceCaptionContainer},e.title),i)}var l=e.legendElements;if(l&&!l.length)return null;var o=l.some(function(e){return"relationship-ramp"===e.type}),n=l.map(function(t){return r._renderLegendForElement(t,e.layer,o)}).filter(function(e){return!!e});if(!n.length)return null;var c=(t={},t[m.groupLayerChild]=!!e.parent,t);return p.tsx("div",{key:e.layer.uid,class:this.classes(m.service,c)},p.tsx("div",{class:m.serviceCaptionContainer},p.tsx("div",{class:m.serviceCaptionText},e.title)),p.tsx("div",{class:m.serviceContent},n))},t.prototype._renderLegendForElement=function(e,t,r){var s=this;void 0===r&&(r=!1);var a,i="color-ramp"===e.type,l="opacity-ramp"===e.type,o="size-ramp"===e.type,n=e.title,c=null;if("string"==typeof n)c=n;else if(n){var y=h.getTitle(n,i||l);c=n.title?n.title+" ("+y+")":y}var u=""+g+t.uid+"-type-"+e.type,v=this._hasIndicators?p.tsx("div",null,p.tsx("h3",{class:this.classes(m.header,m.carouselTitle)},t.title),p.tsx("h4",{class:this.classes(m.header,m.layerCaption)},c)):c?p.tsx("h4",{class:this.classes(m.header,m.layerCaption)},c):null,_=null;if("symbol-table"===e.type){var b=e.infos.map(function(r){return s._renderLegendForElementInfo(r,t,e.legendType)}).filter(function(e){return!!e});if(b.length){var x=b[0].properties.classes&&b[0].properties.classes[m.symbolRow],w=(a={},a[m.labelContainer]=!x&&!r,a[m.relationshipLabelContainer]=r,a);_=p.tsx("div",{key:u,class:m.section},v,p.tsx("div",{class:this.classes(w)},b))}}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?_=p.tsx("div",{key:u,class:m.section},v,this._renderLegendForRamp(e)):o?_=p.tsx("div",{key:u,class:m.section},v,this._renderSizeRamps(e.infos)):"relationship-ramp"===e.type&&(_=p.tsx("div",{key:u,class:this.classes(m.section,m.relationshipSection)},v,d.renderRelationshipRamp(e,this.id)));return _?(this._sectionNames.push(u),this._sectionMap.set(u,_),_):null},t.prototype._renderLegendForElementInfo=function(e,t,r){var s,a,i;if(e.type)return this._renderLegendForElement(e,t);var l=h.isImageryStretchedLegend(t,r);if(e.symbol&&e.preview){if(-1===e.symbol.type.indexOf("simple-fill")){if(!e.label)return p.tsx("div",{bind:e.preview,afterCreate:h.attachToNode});var o=(s={},s[m.symbolCell]=this._hasIndicators,s);return p.tsx("div",{class:this.classes(m.layerRow,(a={},a[m.symbolRow]=this._hasIndicators,a))},p.tsx("div",{class:this.classes(o),bind:e.preview,afterCreate:h.attachToNode}),p.tsx("div",{class:this.classes(m.imageLabel,(i={},i[m.labelCell]=this._hasIndicators,i))},h.getTitle(e.label,!1)||""))}var n=255,c=255,d=255,g=0,u=255,v=255,_=255,b=0,x=e.symbol.color&&e.symbol.color.a,w=e.symbol.outline&&e.symbol.outline.color.a;x&&(n=e.symbol.color.r,c=e.symbol.color.g,d=e.symbol.color.b,g=e.symbol.color.a),w&&(u=e.symbol.outline.color.r,v=e.symbol.outline.color.g,_=e.symbol.outline.color.b,b=e.symbol.outline.color.a);var f=y.isBright(e.symbol.color),L=f?"black":"white",S=f?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",C={background:x?"rgba("+n+", "+c+", "+d+", "+g+")":"none",color:L,textShadow:"-1px -1px 0 "+S+",\n                                              1px -1px 0 "+S+",\n                                              -1px 1px 0 "+S+",\n                                              1px 1px 0 "+S,border:w?"1px solid rgba("+u+", "+v+", "+_+", "+b+")":"none"};return p.tsx("div",{class:m.layerRow},p.tsx("div",{key:e.label,class:m.labelElement,styles:C}," ",e.label," "))}if(e.src){var k=this._renderImage(e,t,l);return p.tsx("div",{class:m.layerRow},k,p.tsx("div",{class:m.imageLabel},e.label||""))}},t.prototype._renderImage=function(e,t,r){var s,a=e.label,i=e.src,l=e.opacity,o=(s={},s[m.imageryLayerStretchedImage]=r,s[m.symbol]=!r,s),n={opacity:""+(null!=l?l:t.opacity)};return p.tsx("img",{alt:a,src:i,border:0,width:e.width,height:e.height,class:this.classes(o),styles:n})},t.prototype._renderSizeRamps=function(e){var t,r,s,a,i=document.createElement("div"),o=e[e.length-1].symbol.color,n=e[0].label,c=e[e.length-1].label,d=e[0].symbol.style&&"circle"===e[0].symbol.style;try{if(this._hasIndicators)if(a=100,d){var y=e[0].symbol.size/2,g=e[e.length-1].symbol.size/2;s=2*y;var u=a-y-g,v=Math.sqrt(Math.pow(u,2)-Math.pow(y-g,2)),_=y*v/u,b=y+_,x=y+Math.sqrt(Math.pow(y,2)-Math.pow(_,2)),w=g*_/y,f=y+w,L=a-(g-Math.sqrt(Math.pow(g,2)-Math.pow(w,2))),S=y-_,C=y-w;r=l.createSurface(i,s,a),r.createCircle({cx:y,cy:y,r:y}).setFill(o).setStroke({color:"#ddd",width:1}),r.createCircle({cx:y,cy:a-g,r:g}).setFill(o).setStroke({color:"#ddd",width:1}),r.createLine({x1:b,y1:x,x2:f,y2:L}).setStroke({color:"#ddd",width:1}),r.createLine({x1:S,y1:x,x2:C,y2:L}).setStroke({color:"#ddd",width:1})}else{var k=Math.max(e[0].symbol.height,e[0].symbol.width),M=Math.max(e[e.length-1].symbol.height,e[e.length-1].symbol.width);s=k,r=l.createSurface(i,s,a),r.createRect({x:0,y:0,height:k,width:k}).setStroke({color:"#ddd",width:1}),r.createRect({x:k/2-M/2,y:a-M,height:M,width:M}).setStroke({color:"#ddd",width:1}),r.createImage({src:e[0].symbol.url,height:k,width:k}),r.createImage({src:e[e.length-1].symbol.url,height:M,width:M,y:a-M,x:k/2-M/2}),r.createLine({x1:0,y1:k,x2:k/2-M/2,y2:a-M}).setStroke({color:"#ddd",width:1}),r.createLine({x1:s,y1:k,x2:k/2+M/2,y2:a-M}).setStroke({color:"#ddd",width:1})}else{if(s=180,d){var y=e[0].symbol.size/2,g=e[e.length-1].symbol.size/2;a=2*y;var u=s-y-g,v=Math.sqrt(Math.pow(u,2)-Math.pow(y-g,2)),_=y*v/u,I=y-_,R=s-(y+Math.sqrt(Math.pow(y,2)-Math.pow(_,2))),w=g*_/y,N=y-w,F=g-Math.sqrt(Math.pow(g,2)-Math.pow(w,2)),z=y+_,E=y+w;r=l.createSurface(i,s,a),r.createCircle({cx:s-y,cy:y,r:y}).setFill(o).setStroke({color:"#ddd",width:1}),r.createCircle({cx:g,cy:y,r:g}).setFill(o).setStroke({color:"#ddd",width:1}),r.createLine({x1:R,y1:I,x2:F,y2:N}).setStroke({color:"#ddd",width:1}),r.createLine({x1:R,y1:z,x2:F,y2:E}).setStroke({color:"#ddd",width:1})}else{var k=Math.max(e[0].symbol.height,e[0].symbol.width),M=Math.max(e[e.length-1].symbol.height,e[e.length-1].symbol.width);a=k,r=l.createSurface(i,s,a),r.createRect({x:0,y:k/2-M/2,height:M,width:M}).setStroke({color:"#ddd",width:1}),r.createRect({x:s-k,y:0,height:k,width:k}).setStroke({color:"#ddd",width:1}),r.createImage({src:e[e.length-1].symbol.url,height:M,width:M,y:k/2-M/2}),r.createImage({src:e[0].symbol.url,height:k,width:k,x:s-k}),r.createLine({x1:M,y1:k/2-M/2,x2:s-k,y2:0}).setStroke({color:"#ddd",width:1}),r.createLine({x1:M,y1:k/2+M/2,x2:s-k,y2:k}).setStroke({color:"#ddd",width:1})}var T=n;n=c,c=T}}catch(e){r.clear(),r.destroy()}return r?p.tsx("div",{class:this.classes(m.layerRow,(t={},t[m.sizeRampRow]=this._hasIndicators,t))},p.tsx("div",{class:m.rampLabel},n),p.tsx("div",{class:m.sizeRampContainer},p.tsx("div",{bind:i,afterCreate:h.attachToNode})),p.tsx("div",{class:m.rampLabel},c)):null},t.prototype._renderLegendForRamp=function(e){var t=e.infos,r="heatmap-ramp"===e.type,s=t.length-1,a=s>2&&!r?25*s:100,o=a+20,n=document.createElement("div");n.style.width=o+"px";var c=l.createSurface(n,o,25),d=t.slice(0).reverse();try{d.forEach(function(e,t){e.offset=r?e.ratio:t/s}),r||c.createPath("M0 12.5 L10 0 L10 25 Z").setFill(d[0].color).setStroke(null),c.createRect({x:10,y:0,width:a,height:25}).setFill({type:"linear",x1:10,y1:0,x2:a+10,y2:0,colors:d}).setStroke(null),r||c.createPath("M"+(a+10)+" 0 L"+o+" 12.5 L"+(a+10)+" 25 Z").setFill(d[d.length-1].color).setStroke(null)}catch(e){c.clear(),c.destroy()}if(!c)return null;var y=d.filter(function(e,t){return!!e.label&&0!==t&&t!==d.length-1}).map(function(e){return p.tsx("div",{class:m.intervalSeparatorsContainer},p.tsx("div",{class:m.intervalSeparator},"|"),p.tsx("div",{class:m.rampLabel},e.label))}),g=t[t.length-1].label,u=t[0].label;return p.tsx("div",{class:m.layerRow},p.tsx("div",{class:m.rampLabel},r?i[g]:g),p.tsx("div",{class:m.symbolContainer},p.tsx("div",{bind:n,afterCreate:h.attachToNode}),y),p.tsx("div",{class:m.rampLabel},r?i[u]:u))},s([p.renderable(),n.property()],t.prototype,"activeLayerInfos",void 0),s([n.property()],t.prototype,"view",void 0),s([p.accessibleHandler()],t.prototype,"_selectSection",null),t=s([n.subclass("esri.widgets.Legend.styles.Card")],t)}(n.declared(c))});