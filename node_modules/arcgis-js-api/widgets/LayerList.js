// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!../nls/common","dojo/i18n!./LayerList/nls/LayerList","../core/Handles","../core/watchUtils","../core/accessorSupport/decorators","./Widget","./LayerList/LayerListViewModel","./support/widget"],function(e,i,t,n,s,r,l,o,a,c,d,u){function p(e){var i=e.actionsOpen,t=e.children;i&&(e.actionsOpen=!1),t.forEach(function(e){return p(e)})}var g={base:"esri-layer-list esri-widget esri-widget--panel",noItems:"esri-layer-list__no-items",list:"esri-layer-list__list",listRoot:"esri-layer-list__list--root",listExclusive:"esri-layer-list__list--exclusive",listInherited:"esri-layer-list__list--inherited",listIndependent:"esri-layer-list__list--independent",item:"esri-layer-list__item",itemContent:"esri-layer-list__item-content",itemError:"esri-layer-list__item--error",itemInvisibleAtScale:"esri-layer-list__item--invisible-at-scale",itemUpdating:"esri-layer-list__item--updating",itemChildren:"esri-layer-list__item--has-children",itemContainer:"esri-layer-list__item-container",actionsMenu:"esri-layer-list__item-actions-menu",actionsMenuItem:"esri-layer-list__item-actions-menu-item",actionsMenuItemActive:"esri-layer-list__item-actions-menu-item--active",actions:"esri-layer-list__item-actions",actionsList:"esri-layer-list__item-actions-list",action:"esri-layer-list__item-action",actionIcon:"esri-layer-list__item-action-icon",actionImage:"esri-layer-list__item-action-image",actionTitle:"esri-layer-list__item-action-title",actionToggle:"esri-layer-list__action-toggle",actionToggleOn:"esri-layer-list__action-toggle--on",label:"esri-layer-list__item-label",errorMessage:"esri-layer-list__item-error-message",title:"esri-layer-list__item-title",toggleVisible:"esri-layer-list__item-toggle",toggleVisibleIcon:"esri-layer-list__item-toggle-icon",childToggle:"esri-layer-list__child-toggle",childToggleOpen:"esri-layer-list__child-toggle--open",childOpened:"esri-layer-list__child-toggle-icon--opened",childClosed:"esri-layer-list__child-toggle-icon--closed",childClosed_RTL:"esri-layer-list__child-toggle-icon--closed-rtl",disabled:"esri-disabled",disabledElement:"esri-disabled-element",hidden:"esri-hidden",rotating:"esri-rotating",iconEllipses:"esri-icon-handle-horizontal",iconVisible:"esri-icon-visible",iconInvisible:"esri-icon-non-visible",iconRadioSelected:"esri-icon-radio-checked",iconRadioUnselected:"esri-icon-radio-unchecked",iconNoticeTriangle:"esri-icon-notice-triangle",iconChildrenOpen:"esri-icon-down-arrow",iconDownArrow:"esri-icon-down-arrow",iconRightArrow:"esri-icon-right-triangle-arrow",iconLeftArrow:"esri-icon-left-triangle-arrow",iconLoading:"esri-icon-loading-indicator",widgetIcon:"esri-icon-layers"},h={actions:"actions",actionSection:"action-section",items:"items"},_={exclusive:"exclusive",inherited:"inherited",independent:"independent"},y=e.toUrl("./LayerList/images/default-action.svg");return function(e){function i(){var i=e.call(this)||this;return i._handles=new l,i.iconClass=g.widgetIcon,i.statusIndicatorsVisible=!0,i.label=r.widgetLabel,i.listItemCreatedFunction=null,i.operationalItems=null,i.view=null,i.viewModel=new d,i}return t(i,e),i.prototype.postInitialize=function(){var e=this,i=this.operationalItems;this.own(o.on(this,"operationalItems","change",function(){return e._itemsChanged(i)}))},i.prototype.destroy=function(){this._handles.destroy(),this._handles=null},i.prototype.triggerAction=function(e,i){},i.prototype.render=function(){var e,i=this,t=this._getItems(),n=this.get("viewModel.state"),s=0===t.length?u.tsx("div",{class:g.noItems},r.noItemsToDisplay):u.tsx("ul",{class:this.classes(g.list,g.listRoot,g.listIndependent)},t.map(function(e,t){return i._renderItem(e,null)})),l=(e={},e[g.hidden]="loading"===n,e[g.disabled]="disabled"===n,e);return u.tsx("div",{class:this.classes(g.base,l)},s)},i.prototype._getItems=function(){var e=this;return this.operationalItems.toArray().filter(function(i){return e.errorsVisible||!i.error})},i.prototype._renderItem=function(e,i){var t,n,l,o,a=this,c=this.id,d=c+"_"+e.uid,p=d+"_actions",h=d+"__list",y=d+"__title",m=e.children.length,v=!!m,b=!!e.error,f=b?r.layerError:"",I=e.visibilityMode,x=e.children&&e.children.toArray(),A=_.exclusive,w=_.inherited,C=(t={},t[g.listExclusive]=I===A,t[g.listInherited]=I===w,t[g.listIndependent]=I!==w&&I!==A,t),k=(n={},n[g.itemChildren]=v,n[g.itemError]=!!f,n[g.itemUpdating]=e.updating&&!i&&this.statusIndicatorsVisible,n[g.itemInvisibleAtScale]=!e.visibleAtCurrentScale,n),O=this._countActions(e.actionsSections),S=e.panel,L=S&&S.open?S.render():null,M=S&&S.visible?this._renderPanelButton(S):null,T=(l={},l[g.actionsMenuItemActive]=e.actionsOpen,l),E=e.actionsOpen?s.close:s.open,R=O?u.tsx("div",{key:"esri-layer-list__actions-menu-toggle","data-item":e,bind:this,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,class:this.classes(g.actionsMenuItem,T),tabindex:"0",role:"button","aria-controls":p,"aria-label":E,title:E},u.tsx("span",{"aria-hidden":"true",class:g.iconEllipses})):null,V=O||M?u.tsx("div",{key:"esri-layer-list__actions-menu",class:g.actionsMenu},M,R):null,N=O?this._renderActionsSections(e,e.actionsSections,p):null,H=v?u.tsx("ul",{key:"esri-layer-list__list-items",id:h,class:this.classes(g.list,C),"aria-expanded":e.open?"true":"false",role:I===A?"radiogroup":"group",hidden:!e.open||null},x.map(function(i,t){return a._renderItem(i,e)})):null,P=(o={},o[g.childToggleOpen]=e.open,o),U=e.open?s.collapse:s.expand,D=v?u.tsx("span",{onclick:this._toggleChildrenClick,onkeydown:this._toggleChildrenClick,"data-item":e,key:"esri-layer-list__toggle-children",class:this.classes(g.childToggle,P),tabindex:"0",role:"button","aria-controls":h,"aria-label":U,title:U},u.tsx("span",{"aria-hidden":"true",class:this.classes(g.childClosed,g.iconRightArrow)}),u.tsx("span",{"aria-hidden":"true",class:this.classes(g.childOpened,g.iconDownArrow)}),u.tsx("span",{"aria-hidden":"true",class:this.classes(g.childClosed_RTL,g.iconLeftArrow)})):null,F=this._createLabelNode(e,i,y),j=b?u.tsx("div",{key:"esri-layer-list__error",class:g.errorMessage,role:"alert"},u.tsx("span",{"aria-hidden":"true",class:g.iconNoticeTriangle}),u.tsx("span",null,f)):null;return u.tsx("li",{key:e,class:this.classes(g.item,k),"aria-labelledby":y},u.tsx("div",{key:"esri-layer-list__list-item-container",class:g.itemContainer},D,F,V),j,N,L,H)},i.prototype._createLabelNode=function(e,i,t){var n,s=_.exclusive,l=_.inherited,o=i&&i.visibilityMode,a=(n={},n[g.iconRadioSelected]=o===s&&e.visible,n[g.iconRadioUnselected]=o===s&&!e.visible,n[g.iconVisible]=o!==s&&e.visible,n[g.iconInvisible]=o!==s&&!e.visible,n),c=o===s?"radio":"checkbox",d=e.title||r.untitledLayer,p=e.visibleAtCurrentScale?d:d+" ("+r.layerInvisibleAtScale+")",h=u.tsx("span",{id:t,title:p,"aria-label":p,class:g.title},d);return o===l?u.tsx("div",{key:e,class:g.label},h):u.tsx("div",{key:e,onclick:this._labelClick,onkeydown:this._labelClick,"data-item":e,"data-parent-visibility":o,tabindex:"0","aria-checked":e.visible?"true":"false",role:c,"aria-labelledby":t,class:g.label},u.tsx("span",{class:g.toggleVisible},u.tsx("span",{class:this.classes(g.toggleVisibleIcon,a),"aria-hidden":"true"})),h)},i.prototype._renderPanelButton=function(e){var i,t,n=e.className,s=e.open,r=e.title,l=this._getIconImageStyles(e),o=(i={},i[g.actionsMenuItemActive]=s,i),a=(t={},t[n]=!!n,t[g.actionImage]=!!l["background-image"],t);return u.tsx("div",{key:e,bind:this,"data-panel":e,onclick:this._triggerPanel,onkeydown:this._triggerPanel,class:this.classes(g.actionsMenuItem,o),role:"button",tabindex:"0",title:r,"aria-label":r},u.tsx("span",{class:this.classes(a),styles:l}))},i.prototype._watchActionSectionChanges=function(e,i){var t=this,n=h.actionSection+i;this._handles.add(e.on("change",this.scheduleRender.bind(this)),n),e.forEach(function(e){return t._renderOnActionChanges(e,i)})},i.prototype._renderOnActionChanges=function(e,i){var t=this,n=h.actions+i;return"toggle"===e.type?void this._handles.add([o.init(e,["className","image","id","title","visible","value"],function(){return t.scheduleRender()})],n):"slider"===e.type?void this._handles.add([o.init(e,["className","id","title","visible","value","displayValueEnabled","max","min","step"],function(){return t.scheduleRender()})],n):void this._handles.add([o.init(e,["className","image","id","title","visible"],function(){return t.scheduleRender()})],n)},i.prototype._renderOnItemChanges=function(e){var i=this,t=e.uid,n=h.items+t;this._handles.add([o.init(e,["actionsOpen","visible","open","updating","title","visibleAtCurrentScale","error","visibilityMode","panel","panel.title","panel.content","panel.className"],function(){return i.scheduleRender()}),e.actionsSections.on("change",function(){return i.scheduleRender()}),e.children.on("change",function(){return i.scheduleRender()})],n),e.children.forEach(function(e){return i._renderOnItemChanges(e)}),e.actionsSections.forEach(function(e){return i._watchActionSectionChanges(e,t)})},i.prototype._itemsChanged=function(e){var i=this;this._handles.removeAll(),e.forEach(function(e){return i._renderOnItemChanges(e)}),this.scheduleRender()},i.prototype._renderActionsSections=function(e,i,t){var n=this,s=i.toArray(),r=s.map(function(i){return u.tsx("ul",{key:i,class:g.actionsList},n._renderActionSection(e,i))});return u.tsx("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"esri-layer-list__actions-section",id:t,class:g.actions,hidden:!e.actionsOpen||null},r)},i.prototype._renderActionSection=function(e,i){var t=this;return(i&&i.toArray()).map(function(i){return t._renderAction(e,i)})},i.prototype._renderAction=function(e,i){var t,n,s=this._getIconImageStyles(i),r=i.active,l=i.className,o=i.disabled,a=i.title,c=(t={},t[g.action]="toggle"!==i.type,t[g.actionToggle]="toggle"===i.type,t[g.actionToggleOn]="toggle"===i.type&&i.value,t[g.disabledElement]=o,t),d=(n={},n[g.actionImage]=!r&&!!s["background-image"],n[g.iconLoading]=r,n[g.rotating]=r,n);return l&&(d[l]=!0),u.tsx("li",{bind:this,"data-item":e,"data-action":i,key:i,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:c,tabindex:"0",role:"button",title:a,"aria-label":a},u.tsx("span",{"aria-hidden":"true",class:this.classes(g.actionIcon,d),styles:s}),u.tsx("span",{class:g.actionTitle},a))},i.prototype._countActions=function(e){return e.reduce(function(e,i){return e+i.length},0)},i.prototype._getIconImageStyles=function(e){var i=e.declaredClass=e.image;return e.className||i||(i=y),{"background-image":i?'url("'+i+'")':null}},i.prototype._toggleActionsOpen=function(e){var i=e.currentTarget,t=i["data-item"],n=t.actionsOpen,s=!n;s&&this.operationalItems.forEach(function(e){return p(e)}),t.actionsOpen=s},i.prototype._triggerPanel=function(e){var i=e.currentTarget,t=i["data-panel"];t&&(t.open=!t.open)},i.prototype._triggerAction=function(e){var i=e.currentTarget,t=i["data-action"],n=i["data-item"];"toggle"===t.type&&(t.value=!t.value),this.triggerAction(t,n)},i.prototype._labelClick=function(e){var i=e.currentTarget,t=i.getAttribute("data-parent-visibility"),n=i["data-item"];t===_.exclusive&&n.visible||(n.visible=!n.visible)},i.prototype._toggleChildrenClick=function(e){var i=e.currentTarget,t=i["data-item"];t.open=!t.open},n([a.property()],i.prototype,"iconClass",void 0),n([a.property(),u.renderable()],i.prototype,"statusIndicatorsVisible",void 0),n([a.property(),u.renderable()],i.prototype,"errorsVisible",void 0),n([a.property()],i.prototype,"label",void 0),n([a.aliasOf("viewModel.listItemCreatedFunction"),u.renderable()],i.prototype,"listItemCreatedFunction",void 0),n([a.aliasOf("viewModel.operationalItems"),u.renderable()],i.prototype,"operationalItems",void 0),n([a.aliasOf("viewModel.view"),u.renderable()],i.prototype,"view",void 0),n([u.vmEvent("trigger-action"),a.property({type:d}),u.renderable("viewModel.state")],i.prototype,"viewModel",void 0),n([a.aliasOf("viewModel.triggerAction")],i.prototype,"triggerAction",null),n([u.accessibleHandler()],i.prototype,"_toggleActionsOpen",null),n([u.accessibleHandler()],i.prototype,"_triggerPanel",null),n([u.accessibleHandler()],i.prototype,"_triggerAction",null),n([u.accessibleHandler()],i.prototype,"_labelClick",null),n([u.accessibleHandler()],i.prototype,"_toggleChildrenClick",null),i=n([a.subclass("esri.widgets.LayerList")],i)}(a.declared(c))});