// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","dojo/Deferred","dojo/dom-construct","dojo/i18n!../nls/SymbolStyler","dojo/on","../../../core/promiseUtils","../../../core/screenUtils","../../../symbols/support/Symbol3DOutline","../../../symbols/support/symbolLayerUtils"],function(e,t,r,i,n,o,u,l,c,s,f){function a(e,t){e[t]||(e[t]={})}function d(e,t){return e.indexOf(t)>-1}function h(e){return k(e)}function p(e){return e&&"icon"===e.type}function m(e){return e&&"object"===e.type}function y(e){return e&&"line"===e.type}function b(e){return e&&"path"===e.type}function v(e){return e&&"extrude"===e.type}function g(e){return e&&"fill"===e.type}function w(e){return e&&"text"===e.type}function x(e){return D(e,"simple-line","2d")}function z(e){return D(e,"simple-marker","2d")}function S(e){return D(e,"simple-fill","2d")}function O(e){return D(e,"picture-marker","2d")}function j(e){return D(e,"fill","2d")}function k(e){return d(e.type,"3d")}function L(e){return e.symbolLayers.getItemAt(0)}function P(e,t){return D(e,"marker",t)||D(e,"point",t)}function C(e){return h(e)&&v(L(e))}function M(e){return h(e)&&w(L(e))}function D(e,t,r){var i=e&&e.type,n=d(i,t);return r?n&&("3d"===r?k(e):!k(e)):n}function F(e,t){return D(e,"line",t)}function U(e,t){return D(e,"fill",t)}function N(e){return e&&"string"==typeof e.style}function T(e){return!h(e)&&(N(e)&&d(Ne,e.style))}function A(e){return h(e)?I(e):q(e)}function I(e){var t=L(e);return g(t)&&t.outline||p(t)&&xe(t)?{color:t.outline.color,size:c.pt2px(t.outline.size)}:y(t)||b(t)?{color:t.material&&t.material.color,size:c.pt2px(t.size)}:null}function q(e){return x(e)?{color:e.color,size:e.width}:j(e)||z(e)?{color:e.get("outline.color"),size:e.get("outline.width")}:null}function R(e,t){!isNaN(t)&&e&&(h(e)?_(e,t):B(e,t))}function _(e,t){var r=L(e);p(r)||g(r)?(a(r,"outline"),r.outline.size=c.px2pt(t)):y(r)?(a(r,"size"),r.size=c.px2pt(t)):b(r)&&(a(r,"size"),r.size=t)}function B(e,t){x(e)?e.width=t:ae(e)&&(e.outline.width=t)}function E(e,t){t&&e&&!k(e)&&(t=A(e).color?t:"none",x(e)?e.style=t:ae(e)&&(e.outline.style=t))}function H(e,t){e&&!isNaN(t)&&(h(e)?V(e,t):G(e,t))}function V(e,t){var r=L(e);p(r)||w(r)?r.size=c.px2pt(t):m(r)?W(r,t):v(r)&&(r.size=t)}function W(e,t){var r=e.width,i=e.height,n=e.depth,o=Math.max(r,i,n),u=t/o;e.set({width:r*u,height:i*u,depth:n*u})}function G(e,t){var r=e.width,i=t;if(r!==i)if(O(e)){var n=e.url,o=ee({dimensions:e,targetDimension:"width",targetSize:i});if(e.height=o.height,e.width=o.width,!n||"http://"===n||!d(n,"http://")&&!d(n,"data:"))return;if(e.xoffset||e.yoffset){var u=e.width/r;e.xoffset=Math.round(e.xoffset*u),e.yoffset=Math.round(e.yoffset*u)}}else e.size=i}function J(e){if(!h(e))return z(e)?e.size:O(e)?K(e):void 0;var t=L(e);return p(t)||w(t)?c.pt2px(t.size):m(t)?K(t):v(t)?t.size:void 0}function K(e){return Math.max(e.width,e.height,e.depth)}function Q(e,t){h(e)?pe(e,{color:t}):e.color=t}function X(e){return h(e)?Y(e):Z(e)}function Y(e){return L(e).get("material.color")}function Z(e){return e.color}function $(e,t){if(h(e)){var r=L(e);return y(r)||b(r)?void pe(e,{color:t}):(a(r,"outline"),void(r.outline.color=t))}A(e).color=t}function ee(e){var t=e.dimensions,r="height"===e.targetDimension?"height":"width",i=e.targetSize;return"height"===r?{height:i,width:t.width/t.height*i}:{height:t.height/t.width*i,width:i}}function te(e){var t=new i,r=n.create("img"),o=u(r,"load",function(){if(0===r.width&&0===r.height)return void t.reject("image has both width and height of 0");t.resolve({width:r.width,height:r.height})}),l=u(r,"error",function(e){t.reject("error ocurred while loading image",e)});return r.src=e,t.promise.always(function(){o.remove(),l.remove(),n.destroy(r)}),t.promise}function re(e){h(e.symbol)?ie(e):ne(e)}function ie(e){H(e.symbol,e.size)}function ne(e){H(e.symbol,e.size)}function oe(e){h(e.symbol)?ue(e):le(e)}function ue(e){Q(e.symbol,e.color)}function le(e){Q(e.symbol,e.color)}function ce(e){h(e.symbol)?se(e):fe(e)}function se(e){$(e.symbol,e.color),R(e.symbol,e.size)}function fe(e){$(e.symbol,e.color),E(e.symbol,e.pattern),R(e.symbol,e.size)}function ae(e){return e&&e.outline}function de(e){if(h(e))return!1;var t=void 0;return t=ae(e)?e.outline.color:e.color,he(t)}function he(e){return e&&e.r>246&&e.g>246&&e.b>246}function pe(e,t){var i=L(e);if(t.color)return void(i.material=r({},i.material,t));i.material=void 0}function me(e){S(e)&&"solid"!==e.style&&"none"!==e.style&&(e.style="solid")}function ye(e,t){return void 0===t&&(t=[]),h(e)?ge(e,t):ve(e,t)}function be(e){return d(["circle","square","diamond"],e.style)}function ve(e,t){var r=e.type,i=["simple-marker","picture-marker"],n=["simple-marker","simple-fill"],o=["simple-marker","simple-line","simple-fill"],u=F(e),l=U(e);return{shape:{state:d(t,"shape")||u||l?"excluded":d(i,r)?"enabled":"disabled"},fill:{state:d(t,"fill")||u?"excluded":n[0]===r&&be(e)||n[1]===r?"enabled":"disabled"},outline:{state:d(t,"outline")?"excluded":d(o,r)?"enabled":"disabled"}}}function ge(e,t){var r=L(e),i=r.type,n=["icon","object"],o=["icon","object","fill","extrude","text"],u=["icon","fill","line","path"];return{shape:{state:d(t,"shape")||!d(n,i)?"excluded":"enabled"},fill:{state:d(t,"fill")||!d(o,i)?"excluded":we(r)?"disabled":"enabled"},outline:{state:d(t,"outline")||!d(u,i)?"excluded":!p(r)||xe(r)||we(r)?"enabled":"disabled"}}}function we(e){return p(e)&&d(Ne,e.get("resource.primitive"))}function xe(e){return!!p(e)&&(e.outline&&!e.get("resource.href"))}function ze(e){if(h(e)){var t=L(e).type;if("extrude"===t||"object"===t)return"meters"}return"pixels"}function Se(e){if(h(e)){if("path"===L(e).type)return"meters"}return"pixels"}function Oe(e){if(h(e)){if(P(e)){var t=L(e);return m(t)?"web-style:volumetric":p(t)?"web-style:flat":"web-style"}return"web-style"}return"symbol-set"}function je(e){var t=L(e).type;return"object"===t||"path"===t||"extrude"===t?"volumetric":"flat"}function ke(e){if(h(e)){var t=L(e);if(p(t)&&(t.outline||(t.outline=new s.Symbol3DOutline({color:void 0,size:0})),void 0===t.size))return f.computeLayerSize(t).then(function(r){return t.size=r[0],e});if(m(t)&&void 0===t.width&&void 0===t.height&&void 0===t.depth)return f.computeLayerSize(t).then(function(r){return t.set({width:r[0],height:r[1],depth:r[2]}),e})}return l.resolve(e)}function Le(e,t){if(h(e)&&h(t)){var r=L(e),i=L(t);return p(r)&&m(i)&&!!r.resource.href&&!i.resource.href&&!!i.resource.primitive}return O(e)&&z(t)}function Pe(e,t){if(h(e)&&h(t)){var r=L(e),i=L(t);return p(r)&&p(i)&&!r.resource.href&&!i.resource.href&&!d(Ne,r.resource.primitive)&&d(Ne,i.resource.primitive)}return Me(e,t)}function Ce(e,t){return h(e)&&h(t)?Pe(t,e):Me(t,e)}function Me(e,t){return z(e)&&z(t)&&!T(e)&&T(t)}function De(e){if(!h(e))return"";var t=L(e);if(!p(t)&&!m(t))return"";if(e.styleOrigin)return e.styleOrigin.name;if(!Ue(t))return"";var r=t.get("resource.primitive");if(p(t))return o[r];if(m(t)){return{sphere:o.sphere,cylinder:o.cylinder,"tall-cylinder":o.tallCylinder,cube:o.cube,"tall-cube":o.tallCube,cone:o.cone,"tall-cone":o.tallCone,"inverted-cone":o.invertedCone,diamond:o.diamond,tetrahedron:o.tetrahedron}[Fe(t)?"tall-"+r:r]}}function Fe(e){var t=e.depth,r=e.height,i=e.width;return i&&t&&r&&i===t&&i<r}function Ue(e){return!e.get("resource.href")&&!!e.get("resource.primitive")}Object.defineProperty(t,"__esModule",{value:!0});var Ne=["x","cross"];t.is3d=k,t.getSymbolLayer=L,t.isPoint=P,t.hasExtrudeSymbolLayer=C,t.hasTextSymbolLayer=M,t.isLine=F,t.isPolygon=U,t.hasPureOutlineStyle=T,t.getOutline=A,t.setOutlineWidth=R,t.setOutlineStyle=E,t.setSize=H,t.getMarkerLength=J,t.setFillColor=Q,t.getFillColor=X,t.setOutlineColor=$,t.preserveAspectRatio=ee,t.testImageUrl=te,t.updateShape=re,t.updateFill=oe,t.updateOutline=ce,t.blendsIntoBackground=de,t.updateMaterial=pe,t.ensureSupportedSimpleFillSymbolStyle=me,t.getApplicableTabs=ye,t.getSizeUnit=ze,t.getOutlineUnit=Se,t.getSymbolSource=Oe,t.getDimensionality=je,t.ensureProps=ke,t.switchedFromRasterToVectorSymbol=Le,t.switchedToPureOutline=Pe,t.switchedFromPureOutline=Ce,t.switchedSmsStyleToPureOutline=Me,t.getSymbolName=De});