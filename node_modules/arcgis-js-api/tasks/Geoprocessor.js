// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["dojo/Deferred","dojo/io-query","../request","../core/lang","../geometry/support/normalizeUtils","../geometry/SpatialReference","../layers/MapImageLayer","../layers/support/MapImage","./Task","./support/DataFile","./support/Date","./support/FeatureSet","./support/GPMessage","./support/JobInfo","./support/LinearUnit","./support/ParameterValue","./support/RasterData"],function(e,t,a,s,r,n,i,o,l,u,c,p,h,d,f,m,b){return l.createSubclass({declaredClass:"esri.tasks.Geoprocessor",constructor:function(){this._updateTimers=[],this._handleExecuteResponse=this._handleExecuteResponse.bind(this),this._handleGetResultImageResponse=this._handleGetResultImageResponse.bind(this),this._handleGetResultDataResponse=this._handleGetResultDataResponse.bind(this)},properties:{outSpatialReference:{value:null,type:n},processSpatialReference:{value:null,type:n},updateDelay:{value:1e3,type:Number},url:{}},cancelJob:function(e,t){var r={query:s.mixin({},this.parsedUrl.query,{f:"json"}),callbackParamName:"callback"};return(this.requestOptions||t)&&(r=s.mixin({},this.requestOptions,t,r)),a(this.parsedUrl.path+"/jobs/"+e+"/cancel",r).then(function(e){return e.data})},cancelJobStatusUpdates:function(e){clearTimeout(this._updateTimers[e]),this._updateTimers[e]=null},checkJobStatus:function(e,t){var r={query:s.mixin({},this.parsedUrl.query,{f:"json"}),callbackParamName:"callback"};return(this.requestOptions||t)&&(r=s.mixin({},this.requestOptions,t,r)),a(this.parsedUrl.path+"/jobs/"+e,r).then(this._handleCheckJobStatusResponse)},getResultImage:function(e,t,r,n){var i=this._gpEncode(s.mixin({},this.parsedUrl.query,{f:"json"},r.toJSON())),o={query:i,callbackParamName:"callback"};return(this.requestOptions||n)&&(o=s.mixin({},this.requestOptions,n,o)),a(this.parsedUrl.path+"/jobs/"+e+"/results/"+t,o).then(this._handleGetResultImageResponse)},getResultData:function(e,t,r){var n={query:s.mixin({},this.parsedUrl.query,{f:"json",returnType:"data"}),callbackParamName:"callback"};return(this.requestOptions||r)&&(n=s.mixin({},this.requestOptions,r,n)),a(this.parsedUrl.path+"/jobs/"+e+"/results/"+t,n).then(this._handleGetResultDataResponse)},getResultMapImageLayer:function(e){var a,s,r=this.parsedUrl;return s=r.path.indexOf("/GPServer/"),a=r.path.substring(0,s)+"/MapServer/jobs/"+e,r.query&&(a+="?"+t.objectToQuery(r.query)),new i(a)},execute:function(e,t){var n={},i={},o=[];return this._collectGeometries(e,o,n),r.normalizeCentralMeridian(o).then(function(r){for(var o in n){var l=this.outSpatialReference,u=n[o];i[o]=r.slice(u[0],u[1])}var c=this._gpEncode(s.mixin({},this.parsedUrl.query,{f:"json","env:outSR":l?l.wkid||JSON.stringify(l.toJSON()):null,"env:processSR":this.processSpatialReference?this.processSpatialReference.wkid||JSON.stringify(this.processSpatialReference.toJSON()):null},e),null,i),p={query:c,callbackParamName:"callback"};return(this.requestOptions||t)&&(p=s.mixin({},this.requestOptions,t,p)),a(this.parsedUrl.path+"/execute",p)}.bind(this)).then(this._handleExecuteResponse)},submitJob:function(t,n){var i={},o={},l=[],u=new e;return this._collectGeometries(t,l,i),r.normalizeCentralMeridian(l).then(function(e){for(var r in i){var l=this.outSpatialReference,u=i[r];o[r]=e.slice(u[0],u[1])}var c=this._gpEncode(s.mixin({},this.parsedUrl.query,{f:"json","env:outSR":l?l.wkid||JSON.stringify(l.toJSON()):null,"env:processSR":this.processSpatialReference?this.processSpatialReference.wkid||JSON.stringify(this.processSpatialReference.toJSON()):null},t),null,o),p={query:c,callbackParamName:"callback"};return(this.requestOptions||n)&&(p=s.mixin({},this.requestOptions,n,p)),a(this.parsedUrl.path+"/submitJob",p)}.bind(this)).then(function(e){u.origJobId=e.data.jobId,this._jobUpdateHandler(e.data,u)}.bind(this)).then(null,function(e){u.reject(e)}),u.promise},_collectGeometries:function(e,t,a){for(var s in e){var r=e[s];if("object"==typeof r&&null!=r){var n;if(Array.isArray(r)&&r.length)n=r[0]&&r[0].declaredClass,n&&n.indexOf("Graphic")>-1?(a[s]=[t.length,t.length+r.length],r.forEach(function(e){t.push(e.geometry)})):n&&n.indexOf("esri.geometry.")>-1&&(a[s]=[t.length,t.length+r.length],r.forEach(function(e){t.push(e)}));else if((n=r.declaredClass)&&n.indexOf("FeatureSet")>-1){var i=r.features;a[s]=[t.length,t.length+i.length],i.forEach(function(e){t.push(e.geometry)})}}}},_gpEncode:function(e,t,a){var s;for(s in e){var r=e[s];Array.isArray(r)?e[s]=JSON.stringify(r.map(function(e){return this._gpEncode({item:e},!0).item},this)):r instanceof Date&&(e[s]=r.getTime())}return this._encode(e,t,a)},_decode:function(e){var t,a=e.dataType,s=m.fromJSON(e);if(-1!==["GPBoolean","GPDouble","GPLong","GPString"].indexOf(a))return s;if("GPLinearUnit"===a)s.value=f.fromJSON(s.value);else if("GPFeatureRecordSetLayer"===a||"GPRecordSet"===a)s.value=p.fromJSON(s.value);else if("GPDataFile"===a)s.value=u.fromJSON(s.value);else if("GPDate"===a)t=s.value,s.value="string"==typeof t?c.fromJSON({date:t}):Date.fromJSON(t);else if("GPRasterData"===a||"GPRasterDataLayer"===a){var r=e.value.mapImage;s.value=r?o.fromJSON(r):b.fromJSON(s.value)}else if(-1!==a.indexOf("GPMultiValue:")){var n=a.split(":")[1];t=s.value,s.value=t.map(function(e){return this._decode({paramName:"_name",dataType:n,value:e}).value},this)}else console.log(this.declaredClass+" : GP Data type not handled. : "+s.dataType),s=null;return s},_jobUpdateHandler:function(e,t){var a,r,n=t.origJobId||e.jobId,i=d.fromJSON(e);switch(clearTimeout(this._updateTimers[n]),this._updateTimers[n]=null,t.progress(i),i.jobStatus){case"job-submitted":case"job-executing":case"job-waiting":case"job-new":a=this._getJobStatus.bind(this),r=this._jobUpdateHandler.bind(this),this._updateTimers[n]=setTimeout(function(){a(n).then(function(e){r(e,t)})},this.updateDelay);break;default:t.resolve(s.mixin(i,{jobId:t.origJobId||n}))}},_getJobStatus:function(e){return a(this.parsedUrl.path+"/jobs/"+e,{query:s.mixin({},this.parsedUrl.query,{f:"json"}),callbackParamName:"callback"}).then(function(e){return e.data})},_handleGetResultDataResponse:function(e){return this._decode(e.data)},_handleCheckJobStatusResponse:function(e){return d.fromJSON(e.data)},_handleExecuteResponse:function(e){var t=e.data,a=t.results||[],s=t.messages||[];return{results:a.map(this._decode,this),messages:s.map(h.fromJSON)}},_handleGetResultImageResponse:function(e){return this._decode(e.data)}})});