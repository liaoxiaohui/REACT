// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","./tsSupport/assignHelper","dojo/io-query","dojo/_base/url","../config","./Error","./global","./lang","./Logger","./sniff"],function(e,r,t,n,i,a,o,l,s,u,c){function f(e){var r={path:null,query:null},t=new i(e),a=e.indexOf("?");return null===t.query?r.path=e:(r.path=e.substring(0,a),r.query=n.queryToObject(t.query)),t.fragment&&(r.hash=t.fragment,null===t.query&&(r.path=r.path.substring(0,r.path.length-(t.fragment.length+1)))),r}function p(e,r){void 0===e&&(e=!1),void 0===r&&(r=!0);var t,n=ce.proxyUrl;if("string"==typeof e){t=H(e);var i=y(e);i&&(n=i.proxyUrl)}else t=!!e;if(!n)throw ue.warn(fe),new o("urlutils:proxy-not-set",fe);var a;if(t&&r&&W()){var l=_(n);b(l)&&(n=l,a=1)}var s=f(n);return s._xo=a,s}function h(e){var r,i,a=y(e);if(a){var o=v(a.proxyUrl);r=o.path,i=o.query?n.queryToObject(o.query):null}else if(ce.forceProxy){var o=p();r=o.path,i=o.query}if(r){var l=f(e);e=r+"?"+l.path;var s=n.objectToQuery(t({},i,l.query));s&&(e=e+"?"+s)}return e}function v(e){var r=e.indexOf("?");return-1!==r?(me.path=e.slice(0,r),me.query=e.slice(r+1)):(me.path=e,me.query=null),me}function g(e){return e=v(e).path,e=V(e),e=M(e,!0),e=e.toLowerCase()}function d(e){for(var r={proxyUrl:e.proxyUrl,urlPrefix:g(e.urlPrefix)},t=ce.proxyRules,n=r.urlPrefix,i=t.length,a=0;a<t.length;a++){var o=t[a].urlPrefix;if(0===n.indexOf(o)){if(n.length===o.length)return-1;i=a;break}0===o.indexOf(n)&&(i=a+1)}return t.splice(i,0,r),i}function y(e){for(var r=ce.proxyRules,t=g(e),n=0;n<r.length;n++)if(0===t.indexOf(r[n].urlPrefix))return r[n]}function m(e,r){return e=U(e),r=U(r),M(e)===M(r)}function U(e){e=R(e);var r=e.indexOf("/sharing");return r>0?e.substring(0,r):e.replace(/\/+$/,"")}function x(e){var r=function(r){return null==r||r instanceof RegExp&&r.test(e)||"string"==typeof r&&s.startsWith(e,r)},t=ce.interceptors;if(t)for(var n=0,i=t;n<i.length;n++){var a=i[n];if(Array.isArray(a.urls)){var o=a.urls.some(r);if(o)return a}else if(r(a.urls))return a}return null}function O(e,r,t){void 0===t&&(t=!1);var n=re(e),i=re(r);return!(!t&&n.scheme!==i.scheme)&&(n.host.toLowerCase()===i.host.toLowerCase()&&n.port===i.port)}function b(e){return!!c("esri-phonegap")||!!c("esri-cors")&&null!=w(e)}function w(e,t){void 0===t&&(t=!1),"string"==typeof e&&(e=j(e)?re(e):r.appUrl);for(var n=ce.corsEnabledServers||[],i=0;i<n.length;i++){var a=n[i],o=void 0,l=void 0;if(a instanceof RegExp?l=a:"string"==typeof a?o=P(a):a.host?a.host instanceof RegExp?l=a.host:o=P(a.host):o=[],l){if(l.test(e.uri))return t?i:a}else for(var s=0;s<o.length;s++)if(O(e,o[s]))return t?i:a}return t?-1:null}function P(e){return r.corsServersUrlCache[e]||(E(e)||I(e)?r.corsServersUrlCache[e]=[new i(q(e))]:r.corsServersUrlCache[e]=[new i("http://"+e),new i("https://"+e)]),r.corsServersUrlCache[e]}function q(e,t,n){return void 0===t&&(t=r.appBaseUrl),I(e)?n&&n.preserveProtocolRelative?e:"http"===r.appUrl.scheme&&r.appUrl.authority===L(e).slice(2)?"http:"+e:"https:"+e:E(e)?e:S("/"===e[0]?F(t):t,e)}function C(e,t,n){if(void 0===t&&(t=r.appBaseUrl),!j(e))return e;var i=R(e),a=i.toLowerCase(),o=R(t).toLowerCase().replace(/\/+$/,""),l=n?R(n).toLowerCase().replace(/\/+$/,""):null;if(l&&0!==o.indexOf(l))return e;for(var s=function(e,r,t){return t=e.indexOf(r,t),-1===t?e.length:t},u=s(a,"/",a.indexOf("//")+2),c=-1;a.slice(0,u+1)===o.slice(0,u)+"/"&&(c=u+1,u!==a.length);)u=s(a,"/",u+1);if(-1===c)return e;if(l&&c<l.length)return e;e=i.slice(c);var f=o.slice(c-1).replace(/[^\/]+/g,"").length;if(f>0)for(var p=0;p<f;p++)e="../"+e;else e="./"+e;return e}function R(e){return e=e.trim(),e=q(e),e=J(e),e=N(e),e=Y(e),e=Z(e)}function S(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];if(e&&e.length){var t=[];if(j(e[0])){var n=e[0],i=n.indexOf("//");t.push(n.slice(0,i+1)),D(e[0])&&(t[0]+="/"),e[0]=n.slice(i+2)}else"/"===e[0][0]&&t.push("");for(var a=e.reduce(function(e,r){return r?e.concat(r.split("/")):e},[]),o=0;o<a.length;o++){var l=a[o];".."===l&&t.length>0?t.pop():!l||"."===l&&0!==t.length||t.push(l)}return t.join("/")}}function L(e){if(B(e)||T(e))return null;var r=e.indexOf("://");if(-1===r&&I(e))r=2;else{if(-1===r)return null;r+=3}var t=e.indexOf("/",r);return-1===t?e:e.slice(0,t)}function j(e){return I(e)||E(e)}function B(e){return"blob:"===e.slice(0,5)}function T(e){return"data:"===e.slice(0,5)}function $(e){var r=e.match(Ue);return r?{mediaType:r[1],isBase64:!!r[2],data:r[3]}:null}function k(e){return e.isBase64?"data:"+e.mediaType+";base64,"+e.data:"data:"+e.mediaType+","+e.data}function I(e){return e&&"/"===e[0]&&"/"===e[1]}function E(e){return pe.test(e)}function H(e){return ve.test(e)||"https"===r.appUrl.scheme&&I(e)}function A(e){return he.test(e)||"http"===r.appUrl.scheme&&I(e)}function D(e){return ge.test(e)}function K(e){return I(e)?"http:"+e:e.replace(ve,"http:")}function _(e){return I(e)?"https:"+e:e.replace(he,"https:")}function z(){return"http"===r.appUrl.scheme}function Q(){return"https"===r.appUrl.scheme}function W(){return c("esri-secure-context")}function M(e,r){return void 0===r&&(r=!1),I(e)?e.slice(2):(e=e.replace(pe,""),r&&e.length>1&&"/"===e[0]&&"/"===e[1]&&(e=e.slice(2)),e)}function F(e){var r=e.indexOf("//"),t=e.indexOf("/",r+2);return-1===t?e:e.slice(0,t)}function G(e){var r=0;if(j(e)){var t=e.indexOf("//");-1!==t&&(r=t+2)}var n=e.lastIndexOf("/");return n<r?e:e.slice(0,n+1)}function V(e){return e&&"/"===e[e.length-1]?e:e+"/"}function X(e){return e.replace(/\/+$/,"")}function J(e){if(/^https?:\/\//i.test(e)){var r=v(e);e=r.path.replace(/\/{2,}/g,"/"),e=e.replace("/","//"),r.query&&(e+="?"+r.query)}return e}function N(e){return e.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function Y(e){return z()&&H(e)&&O(r.appBaseUrl,e,!0)&&!b(e)?K(e):e}function Z(e){var t=ce.httpsDomains;if(!A(e))return e;var n,i=e.indexOf("/",7);if(n=-1===i?e:e.slice(0,i),n=n.toLowerCase().slice(7),de.test(n)){if(!s.endsWith(n,":80"))return e;n=n.slice(0,-3),e=e.replace(":80","")}return!z()||n!==r.appUrl.authority||ye.test(e)&&b(e)?((Q()&&n===r.appUrl.authority||t&&t.some(function(e){return n===e||s.endsWith(n,"."+e)})||W()&&!ce.forceProxy&&!y(e))&&(e=_(e)),e):e}function ee(e,r,t){if(!(r&&t&&e&&j(e)))return e;var n=e.indexOf("//"),i=e.indexOf("/",n+2),a=e.indexOf(":",n+2),o=Math.min(i<0?e.length:i,a<0?e.length:a);return e.slice(n+2,o).toLowerCase()!==r.toLowerCase()?e:""+e.slice(0,n+2)+t+e.slice(o)}function re(e){return"string"==typeof e?new i(q(e)):(e.scheme||(e.scheme=r.appUrl.scheme),e)}function te(e,r){return r&&!r.isPortal&&r.urlKey&&r.customBaseUrl?ee(e,r.urlKey+"."+r.customBaseUrl,r.portalHostname):e}function ne(e,t){if(!t||t.isPortal||!t.urlKey||!t.customBaseUrl)return e;var n=t.urlKey+"."+t.customBaseUrl;return O(r.appUrl,r.appUrl.scheme+"://"+n)?ee(e,t.portalHostname,n):ee(e,n,t.portalHostname)}function ie(e,r){var t=r&&r.url&&r.url.path;return e&&t&&(e=q(e,t,{preserveProtocolRelative:!0})),ne(e,r&&r.portal)}function ae(e,r){if(!e)return e;!j(e)&&r&&r.blockedRelativeUrls&&r.blockedRelativeUrls.push(e);var t=q(e);if(r){var n=r.verifyItemRelativeUrls&&r.verifyItemRelativeUrls.rootPath||r.url&&r.url.path;n&&(t=C(t,n,n))!==e&&r.verifyItemRelativeUrls&&r.verifyItemRelativeUrls.writtenUrls.push(t)}return t=te(t,r&&r.portal)}function oe(e,r){e&&I(e)&&(e="https:"+e),r.url=e?R(e):e}function le(e){return xe.test(e)}function se(e,r){var t=f(e),n=Object.keys(t.query||{});return n.length>0&&r&&r.warn("removeQueryParameters()","Url query parameters are not supported, the following parameters have been removed: "+n.join(", ")+"."),t.path}Object.defineProperty(r,"__esModule",{value:!0});var ue=u.getLogger("esri.core.urlUtils"),ce=a.request,fe="esri/config: esriConfig.request.proxyUrl is not set. If making a request to a CORS-enabled\n server, please push the domain into esriConfig.request.corsEnabledServers.",pe=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,he=/^\s*http:/i,ve=/^\s*https:/i,ge=/^\s*file:/i,de=/:\d+$/,ye=/^https?:\/\/[^\/]+\.arcgis.com\/sharing(\/|$)/i;r.appUrl=new i(l.location),r.corsServersUrlCache={},r.appBaseUrl=function(){var e=r.appUrl.path,t=e.substring(0,e.lastIndexOf(e.split("/")[e.split("/").length-1]));return r.appUrl.scheme+"://"+r.appUrl.host+(null!=r.appUrl.port?":"+r.appUrl.port:"")+t}(),r.urlToObject=f,r.getProxyUrl=p,r.addProxy=h;var me={path:"",query:""};r.addProxyRule=d,r.getProxyRule=y,r.hasSamePortal=m,r.getInterceptor=x,r.hasSameOrigin=O,r.canUseXhr=b,r.getCorsConfig=w,r.makeAbsolute=q,r.makeRelative=C,r.normalize=R,r.join=S,r.getOrigin=L,r.isAbsolute=j,r.isBlobProtocol=B,r.isDataProtocol=T;var Ue=/^data:(.*?)(;base64)?,(.*)$/;r.dataComponents=$,r.makeData=k,r.isProtocolRelative=I,r.hasProtocol=E,r.toHTTPS=_,r.removeFile=G,r.removeTrailingSlash=X,r.changeDomain=ee,r.read=ie,r.write=ae,r.writeOperationalLayerUrl=oe,r.isSVG=le,r.removeQueryParameters=se;var xe=/(^data:image\/svg|\.svg$)/i});