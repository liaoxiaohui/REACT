// COPYRIGHT © 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["dojo/date/locale","../../Color","../../core/lang","../../core/numberUtils","dojo/i18n!dojo/cldr/nls/gregorian"],function(e,t,a,n,o){function i(e){return e&&e.map(function(e){return new t(e)})}function r(e,t,a){var n="";return 0===t?n=s.lt+" ":t===a&&(n=s.gt+" "),n+e}var l={},s={lte:"<=",gte:">=",lt:"<",gt:">",pct:"%",ld:"–"},m={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},u={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},c={dateOptions:{formatLength:"short",fullYear:!0},timeOptions:{formatLength:"short"}};return a.mixin(l,{meterIn:{inches:1/.0254,feet:1/.3048,"us-feet":3.28084,yards:1/.9144,miles:1/1609.344,"nautical-miles":1/1852,millimeters:1e3,centimeters:100,decimeters:10,meters:1,kilometers:.001,"decimal-degrees":180/20015077},timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(t,n){var i,r=[];null==t||t instanceof Date||(t=new Date(t)),n=n||{},n=a.mixin({},n);var l=n.selector?n.selector.toLowerCase():null,s=!l||l.indexOf("time")>-1,m=!l||l.indexOf("date")>-1;return s&&(n.timeOptions=n.timeOptions||c.timeOptions,n.timeOptions&&(n.timeOptions=a.mixin({},n.timeOptions),n.timeOptions.selector=n.timeOptions.selector||"time",r.push(n.timeOptions))),m&&(n.dateOptions=n.dateOptions||c.dateOptions,n.dateOptions&&(n.dateOptions=a.mixin({},n.dateOptions),n.dateOptions.selector=n.dateOptions.selector||"date",r.push(n.dateOptions))),r&&r.length?(r=r.map(function(a){return e.format(t,a)}),i=1==r.length?r[0]:o["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(e,t){return r[t]})):i=e.format(t),i},createColorStops:function(e){var t=e.values,a=e.colors,o=e.labelIndexes,i=e.isDate,s=e.dateFormatOptions;return t.map(function(e,m){var u=!o||o.indexOf(m)>-1,c=null;if(u){var d;d=i?l.formatDate(e,s):n.format(e),d&&(c=r(d,m,t.length-1))}return{value:e,color:a[m],label:c}})},updateColorStops:function(e){var t,a=e.stops,o=e.changes,i=e.isDate,s=e.dateFormatOptions,m=[],u=a.map(function(e){return e.value});o.forEach(function(e){m.push(e.index),u[e.index]=e.value}),t=n.round(u,{indexes:m}),a.forEach(function(e,o){if(e.value=u[o],null!=e.label){var m,c=null;m=i?l.formatDate(t[o],s):n.format(t[o]),m&&(c=r(m,o,a.length-1)),e.label=c}})},createClassBreakLabel:function(e){var t=e.minValue,a=e.maxValue,o=e.isFirstBreak,i=e.normalizationType,r=o?"":s.gt+" ",l="percent-of-total"===i?s.pct:"";return t=null==t?"":n.format(t),a=null==a?"":n.format(a),r+t+l+" "+s.ld+" "+a+l},setLabelsForClassBreaks:function(e){var t=e.classBreakInfos,a=e.classificationMethod,o=e.normalizationType,i=[];t&&t.length&&("standard-deviation"===a?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):e.round?(i.push(t[0].minValue),t.forEach(function(e){i.push(e.maxValue)}),i=n.round(i),t.forEach(function(e,t){e.label=l.createClassBreakLabel({minValue:0===t?i[0]:i[t],maxValue:i[t+1],isFirstBreak:0===t,normalizationType:o})})):t.forEach(function(e,t){e.label=l.createClassBreakLabel({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===t,normalizationType:o})}))},updateClassBreak:function(e){var t,a=e.classBreaks,n=e.classificationMethod,o=e.normalizationType,i=e.change,r=i.index,s=i.value,m=-1,u=-1,c=a.length;if("standard-deviation"===n)return void console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method.");0===r?m=r:r===c?u=r-1:(u=r-1,m=r),m>-1&&m<c&&(t=a[m],t.minValue=s,t.label=l.createClassBreakLabel({minValue:t.minValue,maxValue:t.maxValue,isFirstBreak:0===m,normalizationType:o})),u>-1&&u<c&&(t=a[u],t.maxValue=s,t.label=l.createClassBreakLabel({minValue:t.minValue,maxValue:t.maxValue,isFirstBreak:0===u,normalizationType:o}))},calculateDateFormatInterval:function(e){var t,a,n,o,i,r,l,s,u,c,d=e.length,p=1/0;for(e=e.map(function(e){return new Date(e)}),t=0;t<d-1;t++){for(n=e[t],i=[],s=1/0,u="",a=t+1;a<d;a++)o=e[a],r=n.getFullYear()!==o.getFullYear()&&"year"||n.getMonth()!==o.getMonth()&&"month"||n.getDate()!==o.getDate()&&"day"||n.getHours()!==o.getHours()&&"hour"||n.getMinutes()!==o.getMinutes()&&"minute"||n.getSeconds()!==o.getSeconds()&&"second"||"millisecond",l=m[r],l<s&&(s=l,u=r),i.push(r);s<p&&(p=s,c=u)}return c},createUniqueValueLabel:function(e){var t=e.value,a=e.fieldInfo,o=e.domain,i=e.dateFormatInterval,r=String(t),s=o&&o.codedValues?o.getName(t):null;return s?r=s:"number"==typeof t&&(r=a&&"date"===a.type?l.formatDate(t,i&&u[i]):n.format(t)),r},cloneColorVariable:function(e){var n;return e&&(n=a.mixin({},e),n.colors=i(n.colors),n.stops=n.stops&&n.stops.map(function(e){return e=a.mixin({},e),e.color&&(e.color=new t(e.color)),e}),n.legendOptions&&(n.legendOptions=a.mixin({},n.legendOptions))),n},cloneOpacityVariable:function(e){var t;if(e){t=a.mixin({},e);var n=t.opacityValues;n&&(t.opacityValues=n.slice(0)),n=t.stops,n&&(t.stops=n.map(function(e){return a.mixin({},e)})),n=t.legendOptions,n&&(t.legendOptions=a.mixin({},n))}return t},cloneSizeVariable:function(e){var t;if(e){t=a.mixin({},e),t.stops&&(t.stops=t.stops.map(function(e){return a.mixin({},e)}));var n=t.minSize;n&&"object"==typeof n&&(t.minSize=l.cloneSizeVariable(n)),n=t.maxSize,n&&"object"==typeof n&&(t.maxSize=l.cloneSizeVariable(n)),n=t.legendOptions,n&&(t.legendOptions=a.mixin({},n),(n=n.customValues)&&(t.legendOptions.customValues=n.slice(0)))}return t}}),l});