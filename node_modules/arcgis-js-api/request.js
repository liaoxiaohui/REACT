// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/assignHelper","dojo/Deferred","dojo/has!host-browser?./core/request/script","dojo/has!host-webworker?./core/workers/request","dojo/io-query","dojo/_base/url","dojo/request/xhr","./config","./core/deferredUtils","./core/Error","./core/global","./core/lang","./core/promiseUtils","./core/sniff","./core/urlUtils"],function(e,r,t,n,o,s,a,i,u,l,c,d,f,p,h,g,v){function m(e){var r=a.objectToQuery(e.content);if(r&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+r),!v.isDataProtocol(e.url)&&e.url.length>2e3)return h.reject(p.mixin(new Error,{message:"When using responseType 'image', URL length cannot exceed 2000 characters."}));var t=new Image;e.allowImageDataAccess&&(e.withCredentials?t.crossOrigin="use-credentials":t.crossOrigin="anonymous");var o=!1,s=new n(function(){o=!0,t.onload=t.onerror=t.onabort=null,t.src=""}),i=function(){t.onload=t.onerror=t.onabort=null,o||s.reject(new Error("Unable to load the resource"))};return t.onload=function(){t.onload=t.onerror=t.onabort=null,o||s.resolve(this)},t.onerror=i,t.onabort=i,t.alt="",t.src=e.url,s.promise}function w(e){var r=new i(e);return(r.host+(r.port?":"+r.port:"")).toLowerCase()}function b(){return S||(S=h.create(function(r){e(["./identity/IdentityManager"],r)}).then(function(e){k=e}))}function y(e,r){var s=!!e.useProxy,i=e.method||"auto",l=p.isDefined(e.crossOrigin)?e.crossOrigin:P.useCors;e=t({},e),e._ssl&&(e.url=e.url.replace(/^http:/i,"https:"));var c=e.content,d=e.url;e._token&&(e.content=e.content||{},e.content.token=e._token);var f,h=0;d&&(f=a.objectToQuery(c),h=f.length+d.length+1,g("esri-url-encodes-apostrophe")&&(h=f.replace(/'/g,"%27").length+d.length+1)),e.timeout=p.isDefined(e.timeout)?e.timeout:P.timeout,e.handleAs=e.handleAs||"json";try{var w=void 0,b=void 0,y=l&&v.canUseXhr(e.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(e.url),O=v.hasSameOrigin(e.urlObj,v.appUrl)||y,C="post"===i||!!e.body||h>P.maxUrlLength,q=!O&&-1!==e.handleAs.indexOf("json")&&e.callbackParamName&&!e.body,_=!!v.getProxyRule(e.url)||P.forceProxy||s||("image"!==e.handleAs||e.allowImageDataAccess)&&(!q||C)&&!O;if(_&&(v.isBlobProtocol(e.url)||v.isDataProtocol(e.url))&&(_=!1),(g("host-browser")||g("host-webworker"))&&_)if(w=v.getProxyUrl(d,l),b=w.path,w._xo&&(y=!0),!C&&b.length+1+h>P.maxUrlLength&&(C=!0),e.url=b+"?"+d,C)e.content=p.mixin(w.query||{},c);else{var j=a.objectToQuery(p.mixin(w.query||{},c));j&&(e.url+=(-1===d.indexOf("?")?"?":"&")+j),e.content=null}if(q&&!C&&!_&&g("host-browser"))return e.jsonp=e.callbackParamName,e.query=e.content,o.get(e.url,e);var x=e.headers;if(!g("host-browser")&&!g("host-webworker")||x&&x.hasOwnProperty("X-Requested-With")||(x=e.headers=x||{},x["X-Requested-With"]=null),g("host-browser")&&r){var D=e.content&&e.content.token;D&&(r.set?r.set("token",D):r.append("token",D)),e.contentType=!1}if(y&&!e.hasOwnProperty("withCredentials")&&"with-credentials"===P.useCors){var S=_?b:d,A=v.getCorsConfig(S);if(A&&A.hasOwnProperty("withCredentials"))A.withCredentials&&(e.withCredentials=!0);else if(k){var U=k.findServerInfo(S);U&&U.webTierAuth&&(e.withCredentials=!0)}}return"image"===e.handleAs?m(e):C?(e.body?(e.data=r||e.body,e.query=e.content):e.data=e.content,delete e.body,delete e.content,!_&&g("safari")&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+"_ts="+(new Date).getTime()+T++),u.post(e.url,e)):(e.query=e.content,delete e.content,u.get(e.url,e))}catch(e){var I=new n;return I.reject(e),I.promise}}function O(e){var r=P.corsStatus,t=v.getCorsConfig(e,!0);t>-1&&P.corsEnabledServers.splice(t,1);var o=new n;return o.reject(new d("disabled")),r[w(e)]=o.promise,t}function C(e){var r=e.toLowerCase();return-1!==r.indexOf("/rest/services")||-1!==r.indexOf("/rest/admin/services")}function q(e){var r=P.corsStatus;try{var t=w(e.url);if(P.corsDetection&&P.useCors&&g("esri-cors")&&e.url&&C(e.url)&&!v.hasSameOrigin(e.urlObj,v.appUrl)&&!v.canUseXhr(e.urlObj)){if(r[t])return r[t];var o=new n;r[t]=o.promise;var s=e.url.substring(0,e.url.toLowerCase().indexOf("/rest/")+"/rest/".length)+"info";return u.get(s,{query:{f:"json"},handleAs:"json",headers:{"X-Requested-With":null},timeout:1e3*P.corsDetectionTimeout}).then(function(r){r?(v.canUseXhr(e.url)||P.corsEnabledServers.push(t),o.resolve()):o.reject()},function(e){o.reject()}),o.promise}}catch(e){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}return I}function _(e,r,o,s){function a(e){e._pendingDfd=y(o,c);var r=!!e._pendingDfd.response;(e._pendingDfd.response||e._pendingDfd).then(function(e){if(!r||!e.data)return e;var o=e.getHeader("Content-Type");if(o&&(o=o.toLowerCase(),-1===o.indexOf("text/plain")&&-1===o.indexOf("application/json")))return e;var s,a=e.data;if(a instanceof ArrayBuffer&&a.byteLength<=750)s=new Blob([a]);else{if(!(a instanceof Blob&&a.size<=750))return e;s=a}var i=new n,u=new FileReader;return u.readAsText(s),u.onloadend=function(){if(!u.error)try{var r=JSON.parse(u.result);r.error&&(Object.isExtensible(e)||(e=t({},e)),e._jsonData=r)}catch(e){}i.resolve(e)},i.promise}).then(function(t){var n=r?t.data:t,o=r?t.getHeader.bind(t):U;if(n){var a=r&&t._jsonData||n;if(a.error||"error"===a.status){var i=p.mixin(new Error,a.error||a);throw i.getHeader=o,i}}e.resolve({data:n,url:s.url,requestOptions:s.requestOptions,getHeader:o}),e._pendingDfd=null}).catch(function(r){var t,n,a;if(r&&(t=Number(r.code),n=r.hasOwnProperty("subcode")?Number(r.subcode):null,a=r.messageCode,a=a&&a.toUpperCase()),r&&403===t&&(4===n||r.message&&r.message.toLowerCase().indexOf("ssl")>-1&&-1===r.message.toLowerCase().indexOf("permission"))){if(!o._ssl)return o._ssl=o._sslFromServer=!0,void _(e,!0,o,s)}else if(r&&415===r.status){if(O(o.url),!o._err415)return o._err415=1,void _(e,!0,o,s)}else if(l&&"no-prompt"!==o.authMode&&k._errorCodes&&-1!==k._errorCodes.indexOf(t)&&!k._isPublic(o.url)&&(403!==t||A&&-1===A.indexOf(a)&&(!p.isDefined(n)||2===n&&o._token)))return void j(e,o,s,x("request:server",r,s));e.reject(x("request:server",r,s)),e._pendingDfd=null})}var i,u=o.body,l=o.useIdentity,c=null,f=u instanceof FormData;(f||u&&u.elements)&&(c=f?u:new FormData(u));var h=!!(-1!==o.url.toLowerCase().indexOf("token=")||o.content&&o.content.token||c&&c.get&&c.get("token")||u&&u.elements&&u.elements.token);if(!r){if(l&&!h&&!o._token&&!k._isPublic(o.url)){var g=function(e){e&&(o._token=e.token,o._ssl=e.ssl)};"immediate"===o.authMode?i=k.getCredential(o.url).then(g):"no-prompt"===o.authMode?i=k.checkSignInStatus(o.url).then(g).catch(function(){}):g(k.findCredential(o.url))}e.then(function(e){if((/\/sharing\/rest\/accounts\/self/i.test(o.url)||/\/sharing\/rest\/portals\/self/i.test(o.url))&&!h&&!o._token&&e.user&&e.user.username){var r=P.corsEnabledServers,t=v.getCorsConfig(o.url,!0),n={host:w(o.url),withCredentials:!0};if(-1===t)r.push(n);else{var s=r[t];s instanceof RegExp?(n.host=s,r.splice(t,1,n)):"object"==typeof s?s.withCredentials=!0:r.splice(t,1,n)}}var a=o._credential;if(a){var i=k.findServerInfo(a.server),u=i&&i.owningSystemUrl,l=void 0;u&&(u=u.replace(/\/?$/,"/sharing"),(l=k.findCredential(u,a.userId))&&-1===k._getIdenticalSvcIdx(u,l)&&l.resources.splice(0,0,u))}return e}).always(function(e){if(delete o._credential,e){var r=!!o._ssl;e instanceof d?e.details.ssl=r:e.ssl=r}})}return i?i.then(function(){a(e)}).catch(function(r){e.reject(r)}):a(e),e.promise}function j(e,r,t,n){e._pendingDfd=k.getCredential(r.url,{error:n,token:r._token}),e._pendingDfd.then(function(n){r._token=n.token,r._credential=n,r._ssl=r._sslFromServer||n.ssl,_(e,!0,r,t)}).catch(function(r){e.reject(r),e._pendingDfd=null})}function x(e,r,t){var n="Error",o={url:t.url,requestOptions:t.requestOptions,getHeader:U};if(r instanceof d)return r.details?(r.details=p.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=o,r;if(r){var s=r.response,a=s&&s.getHeader,i=s&&s.status,u=r.message,l=r.getHeader||a;u&&(n=u),l&&(o.getHeader=l),o.httpStatus=(p.isDefined(r.httpCode)?r.httpCode:r.code)||i,o.subCode=r.subcode,o.messageCode=r.messageCode,"string"==typeof r.details?o.messages=[r.details]:o.messages=r.details}var c=new d(e,n,o);return r&&"cancel"===r.dojoType&&(c.dojoType="cancel"),c}function D(e,r){if(s&&f.invokeStaticMessage)return s.execute(e,r);v.isBlobProtocol(e)||v.isDataProtocol(e)||(e=v.normalize(e));var n={url:e,requestOptions:t({},r)},o=v.getInterceptor(e);if(o){if(null!=o.responseData)return h.resolve({data:o.responseData,requestOptions:n.requestOptions,getHeader:U,url:e});if(o.headers&&(n.requestOptions.headers=t({},n.requestOptions.headers,o.headers)),o.query&&(n.requestOptions.query=t({},n.requestOptions.query,o.query)),o.before){var a=o.before(n);if(null!=a)return a instanceof Error||a instanceof d?h.reject(x("request:interceptor",a,n)):h.resolve({data:a,requestOptions:n.requestOptions,getHeader:U,url:n.url})}}var u=t({url:n.url},n.requestOptions);if(u.content=u.query,delete u.query,u.preventCache=!!u.cacheBust,delete u.cacheBust,u.handleAs=u.responseType,delete u.responseType,"array-buffer"===u.handleAs&&(u.handleAs="arraybuffer"),"image"===u.handleAs){if(g("host-webworker")||g("host-node"))return h.reject(x("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),n));u.preventCache&&(u.content=u.content||{},u.content["request.preventCache"]=Date.now()),u.method="auto"}else if(v.isDataProtocol(e))return h.reject(x("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+u.handleAs),n));var l=P.useIdentity;"anonymous"===u.authMode&&(l=!1),u.useIdentity=l,u.urlObj=new i(u.url);var p=c.makeDeferredCancellingPending();return q(u).always(function(){if(l&&!k)return b()}).always(function(){_(p,!1,u,n)}),p.then(function(e){return o&&o.after&&o.after(e),e})}var k,S,P=l.request,A=["COM_0056","COM_0057"],T=0,U=function(){return null},I=(new n).resolve();return D});