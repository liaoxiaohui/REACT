// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../Color","../../../../core/screenUtils","../../../../geometry/Polygon","../../../../symbols/SimpleMarkerSymbol","../../../../symbols/support/gfxUtils","../../libs/gl-matrix/mat2d","../../libs/gl-matrix/mat2dExtras"],function(e,t,r,n,i,a,l,o,s,c){function u(e){return"simple-marker"===e.type}function p(e){return"picture-marker"===e.type}function f(e){return"simple-line"===e.type}function h(e){return"picture-fill"===e.type}function g(e){return"text"===e.type}function y(e){return"extent"===e.type}function d(e){return"polygon"===e.type}function S(e){return"polyline"===e.type}function v(e,t){return t?(t.toRgba?(e[0]=t.r,e[1]=t.g,e[2]=t.b,e[3]=t.a):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e):null}function x(e,t,r){return null!=r&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=r),e}function m(e,t,r){var n=t[0]/t[1];return e[0]=e[1]=1,isNaN(r)||(n>1?(e[0]=r/t[0],e[1]=r/n/t[1]):(e[1]=r/t[1],e[0]=r*n/t[0])),e}function b(e,t,r,n,a,f,h){var y,d,S=a.symbol,v=e.toScreenPoint(R,r,h[0]),x=[v.x,v.y],b=v.x,T=v.y,A=a.heading,M=a.size&&a.size[0];s.identity(C),"number"==typeof M&&(d=isFinite(M)&&M);var _=d&&isFinite(d)&&!isNaN(d);d=_?i.pt2px(d):NaN,f&&c.rotategAt(C,C,f,x),A&&c.rotategAt(C,C,A,x);var Y,P=i.pt2px(S.xoffset),F=i.pt2px(S.yoffset);0===P&&0===F||(Y=[P,-F]);var z=null;0!==S.angle&&(z=s.create(),c.rotategAt(z,z,S.angle,x));var O;if(u(S)){var G=S.style,I=Math.round;d=_?d:i.pt2px(S.size);var U=void 0;switch(G){case l.STYLE_SQUARE:case l.STYLE_CROSS:case l.STYLE_X:case l.STYLE_DIAMOND:U=isNaN(d)?16:.5*d,y=k(t,n,L(G,b,T,I(b-U),I(b+U),I(T-U),I(T+U)));break;case l.STYLE_PATH:var B=k(t,n,S.path);y=B;var D=B.getBoundingBox(),V=m(s.create(),[D.width,D.height],d);1===V[0]&&1===V[3]||c.scaleAt(C,C,V,x),O=[-(D.x+.5*D.width)+b,-(D.y+.5*D.height)+T];break;default:U=isNaN(d)?16:.5*d,y=E(t,n,{cx:b,cy:T,r:U})}}else if(p(S)){var j=null,X=null,q=i.pt2px(S.width),H=i.pt2px(S.height);_?(X=d,j=X*(q/H)):(j=q,X=H),Y&&(null!=Y[0]&&(Y[0]=j*(Y[0]/q)),null!=Y[1]&&(Y[1]=X*(Y[1]/H))),y=w(t,n,{x:b-.5*j,y:T-.5*X,width:j,height:X,src:S.url});var Q=y.getNode();Q&&(null!=a.opacity?Q.setAttribute("opacity",a.opacity.toString()):Q.setAttribute("opacity","1"))}else if(g(S)){var Z=S.font&&S.font.clone();Z&&(Z.size=_?d:i.pt2px(Z.size)),y=N(t,n,{type:"text",text:S.text,x:b,y:T,align:o.getSVGAlign(S),decoration:S.decoration||Z&&Z.decoration,rotated:S.rotated,kerning:S.kerning}),Z&&y.setFont(Z);var Q=y.getNode(),W=o.getSVGBaseline(S),J=o.getSVGBaselineShift(S);Q&&(Q.setAttribute("dominant-baseline",W),J&&Q.setAttribute("baseline-shift",J))}return Y&&s.translate(C,C,Y),z&&s.multiply(C,C,z),O&&s.translate(C,C,O),y.setTransform(C),y}function T(e,t,r,n,i,a,l,o){var s=i.symbol,c=r.points,u=n||t.createGroup(),p=[0];u.children[0]&&_(s,u.children[0])&&u.clear();for(var f=0,h=c.length,g=0;g<h;g++)for(var y=c[g],d=l.length,S=0;S<d;S++){p[0]=l[S];var v=b(e,u,{x:y[0],y:y[1]},u.children[f++],i,a,p);v.getNode().gfxObject=o,u.add(v)}var x=u.children.length;if(c.length*l.length<x)for(var m=c.length*l.length,g=x-1;g>=m;g--)u.children[g].removeShape();return u}function A(e,t,r,n,i){var l=[];if(y(r)&&(r=a.fromExtent(r)),S(r)||d(r)){for(var o=i.length,s=0;s<o;s++)l=l.concat(e.toScreenPath(r,i[s]));n=k(t,n,l)}return n}function M(e,t,r){return t?t.setShape(r):e.createRect(r)}function w(e,t,r){return t?t.setShape(r):e.createImage(r)}function E(e,t,r){return t?t.setShape(r):e.createCircle(r)}function k(e,t,r){var n=Array.isArray(r)?r.join(" "):r;return t?t.setShape(n):e.createPath(n)}function N(e,t,r){return t?t.setShape(r):e.createText(r)}function _(e,t){var r=t&&t.shape&&t.shape.type,n=e&&e.type,i=e&&e.style;return n&&(i=z[n]||i),O[i]&&(i="path"),!(!r||!i||r===i)}function L(e,t,r,n,i,a,o,s){switch(e){case l.STYLE_SQUARE:return["M",n+","+a,i+","+a,i+","+o,n+","+o,"Z"];case l.STYLE_CROSS:return["M",t+","+a,t+","+o,"M",n+","+r,i+","+r];case l.STYLE_X:return["M",n+","+a,i+","+o,"M",n+","+o,i+","+a];case l.STYLE_DIAMOND:return["M",t+","+a,i+","+r,t+","+o,n+","+r,"Z"];case l.STYLE_TARGET:return["M",n+","+a,i+","+a,i+","+o,n+","+o,n+","+a,"M",n-s+","+r,n+","+r,"M",t+","+(a-s),t+","+a,"M",i+s+","+r,i+","+r,"M",t+","+(o+s),t+","+o]}}function Y(e,t){var n=t.symbol;if(!p(n)){var i=o.getFill(n);if(u(n)){var a=n.style,s=o.getStroke(n),c=s&&s.color,f=a===l.STYLE_X||a===l.STYLE_CROSS,h=t.opacity,y=t.color||v([0,0,0,0],f?c:i);y&&null!=h&&(y=x([0,0,0,0],y,h)),y&&(f?y!==c&&(s=r({},s),s.color=y):y!==i&&(i=y)),e.setFill(i).setStroke(s)}else if(g(n)){var h=t.opacity,y=t.color||v([0,0,0,0],i);y&&null!=h&&(y=x([0,0,0,0],y,h)),y&&y!==i&&(i=y),e.setFill(i)}}}function P(e,t){for(var r=e.children,n=r.length,i=0;i<n;i++)Y(e.children[i],t)}function F(e,t){var a,l=t.symbol,s=t.size,c=t.color,u=t.opacity,p=t.outlineSize,g=o.getStroke(l),y=o.getFill(l),d=!1;f(l)?(d=!0,a="none"!==l.style):a=l.outline&&"none"!==l.outline.style;var S,m,b;if(null!=s||null!=p){var T=s&&isFinite(s[0])&&s[0],A=d?null:p;null==T&&null==A||(b=i.pt2px(A||T))}var M=h(l);!c&&null==u||M||(d?(S=c||g&&g.color&&v([0,0,0,0],g.color))&&null!=u&&(S=x(S,S,u)):y&&(m=c||v([0,0,0,0],y))&&null!=u&&(m=x(m,m,u))),!a||null==b&&!S?e.setStroke(g):e.setStroke(r({},g,null!=b?{width:b}:null,S&&{color:S}));var w=y,E=c&&new n(c)||l.color;w&&"pattern"===w.type&&E&&!M?o.getPatternUrlWithColor(w.src,E.toCss(!0)).then(function(t){w.src=t,e.setFill(w)}):e.setFill(m||y),e.rawNode.setAttribute("vector-effect","non-scaling-stroke")}Object.defineProperty(t,"__esModule",{value:!0}),t.getScalingVector=m;var R={x:0,y:0},C=s.create();t.drawPoint=b,t.drawMarkers=T,t.drawShape=A,t.drawRect=M,t.drawImage=w,t.drawCircle=E,t.drawPath=k,t.drawText=N;var z={"picture-marker":"image","picture-fill":"path","simple-fill":"path","simple-line":"path",text:"text"},O={square:1,cross:1,x:1,diamond:1,target:1};t.isShapeInvalid=_,t.smsToPath=L,t.stylePoint=Y,t.styleMarkers=P,t.styleShape=F});