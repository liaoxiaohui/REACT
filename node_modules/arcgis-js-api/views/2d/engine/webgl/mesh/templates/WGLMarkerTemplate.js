// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix/mat2d","../../../../../../core/libs/gl-matrix/vec2","../../color","../../definitions","../../enums","../../number","../../WGLDisplayRecord","./WGLMeshTemplate"],function(t,e,r,i,o,s,h,n,p,u,a,l,f){Object.defineProperty(e,"__esModule",{value:!0});var d=i.getLogger("esri.views.2d.engine.webgl.WGLMeshTemplate"),_=function(t){function e(e,r,i,o,n,p,l,f,d,_,c){var y=t.call(this)||this;y.geometryType=u.WGLGeometryType.MARKER;var m=h.create(),g=s.create(),x=c.sdf?.5:1;if(s.translate(g,g,new Float32Array([x*i,x*-o])),n){s.rotate(g,g,3.14159265359/180*n)}y._materialStore=e,y.vvFlags=r,y._materialId=e.createSpriteMaterial(c,y.geometryType,r),y._fillColor=p,y._outlineColor=d,y._sizeOutlineWidth=a.i8888to32(l,f,_,0);var w=Math.round(c.rect.x/4),M=Math.round(c.rect.y/4),v=w+Math.round(c.rect.width/4),V=M+Math.round(c.rect.height/4);return m.set([-.5*l,-.5*f]),h.transformMat2d(m,m,g),y._offsetAndTexUpperLeft=a.i8888to32(m[0],m[1],w,M),m.set([.5*l,-.5*f]),h.transformMat2d(m,m,g),y._offsetAndTexUpperRight=a.i8888to32(m[0],m[1],v,M),m.set([-.5*l,.5*f]),h.transformMat2d(m,m,g),y._offsetAndTexBottomLeft=a.i8888to32(m[0],m[1],w,V),m.set([.5*l,.5*f]),h.transformMat2d(m,m,g),y._offsetAndTexBottomRight=a.i8888to32(m[0],m[1],v,V),y.height=f,y.width=l,y.xOffset=i,y.yOffset=o,y}return r(e,t),e.fromPictureMarker=function(t,r,i,s,h){var n=Math.round(o.pt2px(i.width)),u=Math.round(o.pt2px(i.height)),a=p.PICTURE_FILL_COLOR;return new e(t,r,Math.round(o.pt2px(i.xoffset||0)),Math.round(o.pt2px(i.yoffset||0)),i.angle,a,n,u,0,0,s)},e.fromSimpleMarker=function(t,r,i,s,h){var p=n.premultiplyAlphaRGBA(i.color),u=Math.round(o.pt2px(i.size)),a=u,l=Math.round(o.pt2px(i.xoffset||0)),f=Math.round(o.pt2px(i.yoffset||0)),d=i.outline,_=0|(d&&d.color&&n.premultiplyAlphaRGBA(d.color)),c=0|(d&&d.width&&Math.round(o.pt2px(d.width)));return new e(t,r,l,f,i.angle,p,u,a,_,c,s)},e.prototype.writeMesh=function(t,e,r,i,o,s,h){var n=this._materialStore.get(this._materialId),p=e.indexVector,u=e.get("geometry"),a=new l(i,this.geometryType,this._materialId),f=this._getOffset(u,n);switch(t.push(a),a.vertexFrom=f,a.indexFrom=p.length,r){case"esriGeometryPoint":var _=o.geometry,c=_.x,y=_.y;return this._writeVertices(a,u,i,this._getPos(c,y),n,h),void this._writeIndices(a,p,f);case"esriGeometryPolyline":var m=o.geometry.paths;return void this._writeMany(a,p,u,f,i,m[0],n,h);case"esriGeometryPolygon":var g=o.centroid;if(g){var c=g.x,y=g.y;this._writeVertices(a,u,i,this._getPos(c,y),n,h),this._writeIndices(a,p,f)}else d.error("Tried to render polygon geometries as markers, but found no centroid!");return;case"esriGeometryMultipoint":var x=o.geometry.points;return void this._writeMany(a,p,u,f,i,x,n,h);case"esriGeometryEnvelope":default:d.error("Unable to handle geometryType: "+r)}},e.prototype._getPos=function(t,e){return a.i1616to32(t,e)},e.prototype._writeMany=function(t,e,r,i,o,s,h,n){for(var p=0,u=0,a=0,l=0,f=s;l<f.length;l++){var d=f[l],_=d[0],c=d[1];this._writeVertices(t,r,o,this._getPos(_+p,c+u),h,n),this._writeIndices(t,e,i+a),p+=_,u+=c,a+=4}},e.prototype._getOffset=function(t,e){var r=e.materialKeyInfo,i=r.hasVV()?10:6;return t.length/i},e.prototype._writeVertices=function(t,e,r,i,o,s){e.push(i),e.push(this._offsetAndTexUpperLeft),e.push(r),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,s,o),e.push(i),e.push(this._offsetAndTexUpperRight),e.push(r),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,s,o),e.push(i),e.push(this._offsetAndTexBottomLeft),e.push(r),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,s,o),e.push(i),e.push(this._offsetAndTexBottomRight),e.push(r),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,s,o),t.vertexCount+=4},e.prototype._writeVV=function(t,e,r){r.materialKeyInfo.hasVV()&&(t.push(e[u.VVType.SIZE]),t.push(e[u.VVType.COLOR]),t.push(e[u.VVType.OPACITY]),t.push(e[u.VVType.ROTATION]))},e.prototype._writeIndices=function(t,e,r){var i=r;e.push(i+0),e.push(i+1),e.push(i+2),e.push(i+1),e.push(i+3),e.push(i+2),t.indexCount+=6},e}(f.default);e.default=_});