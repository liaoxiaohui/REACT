// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/Logger","./enums","./MaterialInfo","./Utils","./util/serializationUtils"],function(e,t,r,n,i,o,l,s){var a=n.getLogger("esri.views.2d.engine.webgl.WGLDisplayList"),y=function(){function e(){this.symbolLevels=[]}return Object.defineProperty(e.prototype,"empty",{get:function(){return!this.symbolLevels||0===this.symbolLevels.length},enumerable:!0,configurable:!0}),e.prototype.addToList=function(e){var t=this;if(!Array.isArray(e))return void this._addToList(e);e.forEach(function(e){t._addToList(e)})},e.prototype.removeFromList=function(e){var t=this;Array.isArray(e)||(e=[e]),e.forEach(function(e){t._removeFromList(e)})},e.prototype.ofType=function(e){var t,n,i,o,l,s,a,y,m,u,f;return r(this,function(r){switch(r.label){case 0:t=0,n=this.symbolLevels,r.label=1;case 1:if(!(t<n.length))return[3,8];i=n[t],o=0,l=i.zLevels,r.label=2;case 2:if(!(o<l.length))return[3,7];if(s=l[o],a=s.geometryDPInfo,y=this._getDPInfoType(e),!a[y])return[3,6];m=0,u=a[y],r.label=3;case 3:return m<u.length?(f=u[m],[4,f]):[3,6];case 4:r.sent(),r.label=5;case 5:return m++,[3,3];case 6:return o++,[3,2];case 7:return t++,[3,1];case 8:return[2]}})},e.prototype.clone=function(){for(var t=new e,r=0,n=this.symbolLevels;r<n.length;r++){var i=n[r];t.symbolLevels.push(i.clone())}return t},e.prototype._addToList=function(e){var t=e.symbolLevel,r=e.zOrder,n=this._getDisplayList(t,r,e.geometryType),i=n.length>0?n[n.length-1]:null;if(null!==i&&l.isSameMaterialInfo(i.materialInfo,e.materialInfo)&&i.indexFrom+i.indexCount===e.indexFrom)i.indexCount+=e.indexCount;else{var o=new m;o.indexFrom=e.indexFrom,o.indexCount=e.indexCount,o.materialInfo=e.materialInfo,o.geometryType=e.geometryType,n.push(o)}},e.prototype._removeFromList=function(e){for(var t=e.symbolLevel,r=e.zOrder,n=this._getDisplayList(t,r,e.geometryType),i=n.length,l=void 0,s=0;s<i;++s){var a=n[s];e.indexFrom+e.indexCount>a.indexFrom&&e.indexFrom<a.indexFrom+a.indexCount&&(l=s)}if(void 0!==l){var a=n[l];if(e.indexFrom===a.indexFrom)a.indexCount-=e.indexCount,a.indexFrom+=e.indexCount,0===a.indexCount&&n.splice(l,1);else if(e.indexFrom+e.indexCount===a.indexFrom+a.indexCount)a.indexCount-=e.indexCount,0===a.indexCount&&n.splice(l,1);else{var y=a.indexFrom,u=e.indexFrom-a.indexFrom,f=e.indexCount,p=a.indexFrom+a.indexCount-(e.indexFrom+e.indexCount);a.indexCount=u;var L=new m;L.geometryType=a.geometryType,L.materialInfo=new o.default,L.materialInfo.copy(a.materialInfo),L.indexFrom=y+u+f,L.indexCount=p,n.splice(l+1,0,L)}}},e.prototype._getDisplayList=function(e,t,r){for(var n,o=this.symbolLevels.length,l=0;l<o;l++)if(this.symbolLevels[l].symbolLevel===e){n=this.symbolLevels[l];break}n||(n=new p,n.symbolLevel=e,this.symbolLevels.push(n));for(var s,a=n.zLevels.length,y=0;y<a;y++)if(n.zLevels[y].zLevel===t){s=n.zLevels[y];break}s||(s=new f,s.geometryDPInfo=new u,s.zLevel=t,n.zLevels.push(s));var m;switch(r){case i.WGLGeometryType.FILL:s.geometryDPInfo.fill||(s.geometryDPInfo.fill=[]),m=s.geometryDPInfo.fill;break;case i.WGLGeometryType.LINE:s.geometryDPInfo.line||(s.geometryDPInfo.line=[]),m=s.geometryDPInfo.line;break;case i.WGLGeometryType.MARKER:s.geometryDPInfo.marker||(s.geometryDPInfo.marker=[]),m=s.geometryDPInfo.marker;break;case i.WGLGeometryType.TEXT:s.geometryDPInfo.text||(s.geometryDPInfo.text=[]),m=s.geometryDPInfo.text;break;case i.WGLGeometryType.LABEL:s.geometryDPInfo.label||(s.geometryDPInfo.label=[]),m=s.geometryDPInfo.label;break;default:console.error("Trying to add a record with geometry type '"+r+"'.")}return m},e.prototype.serialize=function(e){return s.serializeList(e,this.symbolLevels),e},e.deserialize=function(t){var r=new e;return r.symbolLevels=s.deserializeList(t,p),r},e.prototype._getDPInfoType=function(e){switch(e){case i.WGLGeometryType.FILL:return"fill";case i.WGLGeometryType.LINE:return"line";case i.WGLGeometryType.MARKER:return"marker";case i.WGLGeometryType.TEXT:return"text";case i.WGLGeometryType.LABEL:return"label";default:a.error("DisplayList: Tried to convert unknown geometryType: "+e)}},e}(),m=function(){function e(){this.materialInfo=null,this.indexFrom=0,this.indexCount=0}return e.prototype.clone=function(){var t=new e;return t.geometryType=this.geometryType,t.materialInfo=new o.default,t.materialInfo.copy(this.materialInfo),t.indexFrom=this.indexFrom,t.indexCount=this.indexCount,t},e.prototype.serialize=function(e){return this.materialInfo.serialize(e),e.writeInt32(this.indexFrom),e.writeInt32(this.indexCount),e},e.deserialize=function(t,r){var n=new e;return n.geometryType=r.geometryType,n.materialInfo=o.default.deserialize(t),n.indexFrom=t.readInt32(),n.indexCount=t.readInt32(),n},e}(),u=function(){function e(){this.fill=null,this.line=null,this.marker=null,this.text=null,this.label=null}return e.prototype.clone=function(){var t=new e;return t.fill=this.fill&&this.fill.map(function(e){return e.clone()}),t.line=this.line&&this.line.map(function(e){return e.clone()}),t.marker=this.marker&&this.marker.map(function(e){return e.clone()}),t.text=this.text&&this.text.map(function(e){return e.clone()}),t.label=this.label&&this.label.map(function(e){return e.clone()}),t},e.prototype.serialize=function(e){return s.serializeList(e,this.fill),s.serializeList(e,this.line),s.serializeList(e,this.marker),s.serializeList(e,this.text),s.serializeList(e,this.label),e},e.deserialize=function(t){var r=new e,n={geometryType:i.WGLGeometryType.FILL},o=s.deserializeList(t,m,n);o.length&&(r.fill=o),n.geometryType=i.WGLGeometryType.LINE;var l=s.deserializeList(t,m,n);l.length&&(r.line=l),n.geometryType=i.WGLGeometryType.MARKER;var a=s.deserializeList(t,m,n);a.length&&(r.marker=a),n.geometryType=i.WGLGeometryType.TEXT;var y=s.deserializeList(t,m,n);y.length&&(r.text=y),n.geometryType=i.WGLGeometryType.LABEL;var u=s.deserializeList(t,m,n);return u.length&&(r.label=u),r},e}(),f=function(){function e(){this.geometryDPInfo=new u}return e.prototype.clone=function(){var t=new e;return t.zLevel=this.zLevel,t.geometryDPInfo=this.geometryDPInfo.clone(),t},e.prototype.serialize=function(e){return e.writeInt32(this.zLevel),this.geometryDPInfo.serialize(e),e},e.deserialize=function(t){var r=new e;return r.zLevel=t.readInt32(),r.geometryDPInfo=u.deserialize(t),r},e}(),p=function(){function e(){this.zLevels=[]}return e.prototype.clone=function(){var t=new e;t.symbolLevel=this.symbolLevel;for(var r=0,n=this.zLevels;r<n.length;r++){var i=n[r];t.zLevels.push(i.clone())}return t},e.prototype.serialize=function(e){return e.writeInt32(this.symbolLevel),s.serializeList(e,this.zLevels),e},e.deserialize=function(t){var r=new e;return r.symbolLevel=t.readInt32(),r.zLevels=s.deserializeList(t,f),r},e}();return y});