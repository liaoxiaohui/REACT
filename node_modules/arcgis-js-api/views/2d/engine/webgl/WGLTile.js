// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix/mat2d","../../../../core/libs/gl-matrix/mat4","../../../../core/libs/gl-matrix/vec2","../DisplayObject","./definitions","./DirtyMap","./DisplayRecordStore","./enums","./number","./Utils","./WGLBuffers","./WGLDisplayList","../../tiling/enums","../../tiling/TileKey"],function(t,e,r,i,a,s,o,l,n,d,p,u,y,c,f,h,m){function D(t,e){return t.sortKey-e.sortKey}return function(t){function e(e,r){var o=t.call(this)||this;return o.status=h.TileStatus.INITIALIZED,o._data=null,o.hlDisplayList=null,o._displayList=null,o._wglBuffers=null,o._dirtyMap=new n.default,o.coords=[0,0],o.bounds=[0,0,0,0],o.tileTransform={transform:Float32Array[16],screenTransform:Float32Array[16],displayCoord:Float32Array[2],screenCoord:Float32Array[2]},o._labelIndex=null,o.tileTransform.screenTransform=i.create(),o.tileTransform.transform=a.create(),o.tileTransform.displayCoord=s.create(),o.tileTransform.screenCoord=s.create(),o.key=m.pool.acquire(e),o.coords[0]=r[0],o.coords[1]=r[3],o.bounds=r,o}return r(e,t),Object.defineProperty(e.prototype,"iconGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.MARKER)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.TEXT)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.FILL)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.LINE)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"labelGeometry",{get:function(){return this.getGeometry(p.WGLGeometryType.LABEL)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"canDisplay",{get:function(){return!!this.attached&&!!this._data},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isDirty",{get:function(){return this.status===h.TileStatus.MODIFIED},set:function(t){t&&this.status===h.TileStatus.READY?this.setStatus(h.TileStatus.MODIFIED):t||this.status!==h.TileStatus.MODIFIED||this.setStatus(h.TileStatus.READY),this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasData",{get:function(){return this.status===h.TileStatus.MODIFIED||this.status===h.TileStatus.READY},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0}),e.prototype.getGeometry=function(t){return this._wglBuffers&&this._wglBuffers.has(t)?this._wglBuffers.get(t):null},e.prototype.getDisplayList=function(t){switch(t){case p.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._displayList}},Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),e.prototype.setData=function(t,e){if(this.status!==h.TileStatus.INITIALIZED&&this.clear(),!t||!t.tileDisplayData)return this.clear(),void this.setStatus(h.TileStatus.NO_DATA);this._dispRecStore=d.default.fromTileData(t,this._dirtyMap),this._data=t,t.tileBufferData.geometries[4].indexBuffer.length?(this.setStatus(e?h.TileStatus.MODIFIED:h.TileStatus.READY),this._rebuildLabelIndex()):this.setStatus(h.TileStatus.READY),this._dirtyMap.markAllDirty(),this._displayList=t.tileDisplayData.displayList.clone()},e.prototype.patchData=function(t,e){this._patchData(t)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=d.default.fromTileData(this._data,this._dirtyMap)),t.addOrUpdate&&t.addOrUpdate.tileBufferData.geometries[4].indexBuffer.length?(this.setStatus(e?h.TileStatus.MODIFIED:h.TileStatus.READY),this._rebuildLabelIndex()):this.setStatus(h.TileStatus.READY)},e.prototype.commitChanges=function(t){this._data&&this.status===h.TileStatus.READY&&(this._wglBuffers||(this._wglBuffers=new c.default(t.context)),this._displayList=this._data.tileDisplayData.displayList.clone(),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._dirtyMap.markAllClean())},e.prototype.setVisibility=function(t,e){for(var r=this._data.tileBufferData.geometries.map(function(t){return{vertexFrom:void 0,vertexTo:void 0,geometry:t}}),i=0,a=t;i<a.length;i++)for(var s=a[i],o=this._data.tileDisplayData.displayObjectRegistry.get(s.id),l=0,n=o.displayRecords;l<n.length;l++){var d=n[l];if(null==e||e===d.geometryType){var p=r[d.geometryType],u=p.geometry.vertexBuffer[y.C_VBO_VISIBILITY];if(u){p.vertexFrom=null==p.vertexFrom?d.vertexFrom:Math.min(p.vertexFrom,d.vertexFrom),p.vertexTo=null==p.vertexTo?d.vertexFrom+d.vertexCount:Math.max(p.vertexTo,d.vertexFrom+d.vertexCount);for(var c=d.vertexFrom*u.stride/4,f=d.vertexCount*u.stride/4,m=0;m<f;++m)u.data[c+m]=s.visibility?4294967295:0}}}for(var D=!1,g=0;g<r.length;++g){var p=r[g];if(null!=p.vertexFrom&&null!=p.vertexTo){var v=p.vertexTo?p.vertexTo-p.vertexFrom:0;this.setStatus(h.TileStatus.MODIFIED),this._dirtyMap.markDirtyVertices(g,y.C_VBO_VISIBILITY,p.vertexFrom,v),D=!0}}D&&this.requestRender()},e.prototype.setVisibilityRange=function(t,e,r,i){for(var a=u.i8888to32(r,i,r,i),s=void 0,o=void 0,l=this._data.tileBufferData.geometries[p.WGLGeometryType.LABEL],n=l.vertexBuffer[y.C_VBO_VISIBILITY_RANGE],d=this._data.tileDisplayData.displayObjectRegistry.get(t),c=d.metrics[e],f=c.range.from,h=f+c.range.count,m=f;m<h;++m){var D=d.displayRecords[m];if(D.geometryType===p.WGLGeometryType.LABEL){s=null==s?D.vertexFrom:Math.min(s,D.vertexFrom),o=null==o?D.vertexFrom+D.vertexCount:Math.max(o,D.vertexFrom+D.vertexCount);for(var g=D.vertexFrom*n.stride/4,v=D.vertexCount*n.stride/4,_=0;_<v;++_)n.data[g+_]=a}}var b=o?o-s:0;this._dirtyMap.markDirtyVertices(p.WGLGeometryType.LABEL,y.C_VBO_VISIBILITY_RANGE,s,b)},e.prototype.setStatus=function(t){this.status=t,t!==h.TileStatus.READY&&t!==h.TileStatus.NO_DATA||(this.attached=!0)},e.prototype.clear=function(){this._data=null,this.setStatus(h.TileStatus.INVALID),this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null),this.hlDisplayList&&(this.hlDisplayList=null)},e.prototype.dispose=function(){this.clear()},e.prototype.attach=function(t){return this.canDisplay},e.prototype.detach=function(e){t.prototype.detach.call(this,e)},e.prototype.doRender=function(t){var e=this;if(this.attached){this.commitChanges(t),t.context.setStencilFunction(514,this.stencilRef,255);t.painter.getBrushes(t.drawPhase).forEach(function(r){return r.draw(t,e)})}},e.prototype.buildHLList=function(t){var e=this;this.hlDisplayList=new f;var r=function(t){e._addToHLDisplayList(e.hlDisplayList,t)};t.forEach(r)},e.prototype._addToHLDisplayList=function(t,e){if(this._data){var r=this._data.tileDisplayData.displayObjectRegistry.get(e);if(r){for(var i=[],a=0,s=r.displayRecords;a<s.length;a++){var o=s[a],l=o.copy();l.meshData=null,l.symbolLevel=0,l.zOrder=0,i.push(l)}i.sort(D),t.addToList(i)}}},e.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var t=0,e=this.displayObjects;t<e.length;t++){var r=e[t];this._insertIntoLabelIndex(r)}},e.prototype._insertIntoLabelIndex=function(t){var e=t.anchor;if(-1!==t.xBucket&&e){this.labelIndex[t.yBucket][t.xBucket].push(t)}},e.prototype._initLabelIndex=function(){for(var t=[],e=0;e<l.TILE_SIZE/l.COLLISION_BUCKET_SIZE;e++){t.push([]);for(var r=0;r<l.TILE_SIZE/l.COLLISION_BUCKET_SIZE;r++)t[e].push([])}return t},e.prototype._patchData=function(t){for(var e=!0,r=0,i=t.remove||[];r<i.length;r++){var a=i[r],s=this._data.tileDisplayData.displayObjectRegistry.get(a);if(s){this._data.tileDisplayData.displayList.removeFromList(s.displayRecords);for(var o=0,l=s.displayRecords;o<l.length;o++){var n=l[o];this._dispRecStore.delete(n)}this._data.tileDisplayData.displayObjectRegistry.delete(a);var d=this._data.tileDisplayData.displayObjects.indexOf(s);this._data.tileDisplayData.displayObjects.splice(d,1)}}for(var p=t.addOrUpdate&&t.addOrUpdate.tileDisplayData&&t.addOrUpdate.tileDisplayData.displayObjects||[],u=0,y=p;u<y.length;u++){var c=y[u],s=this._data.tileDisplayData.displayObjectRegistry.get(c.id);if(s){var f=s.displayRecords;s.set(c),s.displayRecords=f;for(var h=s.displayRecords.length,m=0;m<h;++m){var D=s.displayRecords[m],g=c.displayRecords[m];(m>=c.displayRecords.length||D.geometryType!==g.geometryType||D.symbolLevel!==g.symbolLevel||D.zOrder!==g.zOrder||D.materialInfo.materialKey!==g.materialInfo.materialKey)&&(this._dispRecStore.delete(s.displayRecords[m]),m<c.displayRecords.length&&(s.displayRecords[m]=void 0))}s.displayRecords.length=c.displayRecords.length,s.anchor=c.anchor,s.metrics=c.metrics}else s=c.copy(),s.displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(c.id,s),this._data.tileDisplayData.displayObjects.push(s);for(var v=c.displayRecords.length,m=0;m<v;++m){var g=c.displayRecords[m],D=s.displayRecords[m];D?(D.meshData=g.meshData,D.materialInfo=g.materialInfo):(D=g.copy(),D.vertexFrom=void 0,D.indexFrom=void 0,s.displayRecords[m]=D);var _=g.geometryType,b=t.addOrUpdate.tileBufferData.geometries[_],I=b.vertexBuffer,T=b.indexBuffer;e=this._dispRecStore.setMeshData(D,g,I,T)&&e}}return e},e}(o)});