// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","dojo/dom","dojo/dom-attr","dojo/_base/Color","dojox/gfx/_base","./svg","../gl-matrix/mat2d"],function(t,e,r,i,o,s,a,n){Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(){this.rawNode=null,this.shape=null,this.matrix=null,this.fillStyle=null,this.strokeStyle=null,this.bbox=null,this.parent=null,this.parentMatrix=null}return t.prototype.destroy=function(){if(this.fillStyle&&"type"in this.fillStyle){var t=this.rawNode.getAttribute("fill"),e=a.getRef(t);e&&e.parentNode.removeChild(e)}this.rawNode&&"__gfxObject__"in this.rawNode&&(this.rawNode.__gfxObject__=null),this.rawNode=null},t.prototype.getNode=function(){return this.rawNode},t.prototype.getShape=function(){return this.shape},t.prototype.getTransform=function(){return this.matrix},t.prototype.getFill=function(){return this.fillStyle},t.prototype.getStroke=function(){return this.strokeStyle},t.prototype.getParent=function(){return this.parent},t.prototype.getBoundingBox=function(){return this.bbox},t.prototype.setTransform=function(t){return this.matrix=this.matrix?n.copy(this.matrix,t):n.clone(t),this._applyTransform()},t.prototype.setFill=function(t){if(!t)return this.fillStyle=null,this.rawNode.setAttribute("fill","none"),this.rawNode.setAttribute("fill-opacity",0),this;var e;if("object"==typeof t&&"type"in t){switch(t.type){case"linear":e=s.makeParameters(s.defaultLinearGradient,t);var r=this._setFillObject(e,"linearGradient");r.setAttribute("x1",e.x1.toFixed(8)),r.setAttribute("y1",e.y1.toFixed(8)),r.setAttribute("x2",e.x2.toFixed(8)),r.setAttribute("y2",e.y2.toFixed(8));break;case"radial":e=s.makeParameters(s.defaultRadialGradient,t);var i=this._setFillObject(e,"radialGradient");i.setAttribute("cx",e.cx.toFixed(8)),i.setAttribute("cy",e.cy.toFixed(8)),i.setAttribute("r",e.r.toFixed(8));break;case"pattern":e=s.makeParameters(s.defaultPattern,t);var o=this._setFillObject(e,"pattern");o.setAttribute("x",e.x.toFixed(8)),o.setAttribute("y",e.y.toFixed(8)),o.setAttribute("width",e.width.toFixed(8)),o.setAttribute("height",e.height.toFixed(8))}return this.fillStyle=e,this}return e=s.normalizeColor(t),this.fillStyle=e,this.rawNode.setAttribute("fill",e.toCss()),this.rawNode.setAttribute("fill-opacity",e.a),this.rawNode.setAttribute("fill-rule","evenodd"),this},t.prototype.setStroke=function(t){var e=this.rawNode;if(!t)return this.strokeStyle=null,e.setAttribute("stroke","none"),e.setAttribute("stroke-opacity",0),this;("string"==typeof t||Array.isArray(t)||t instanceof o)&&(t={color:t});var r=this.strokeStyle=s.makeParameters(s.defaultStroke,t);if(r.color=s.normalizeColor(r.color),r){var i=r.width<0?0:r.width;e.setAttribute("stroke",r.color.toCss()),e.setAttribute("stroke-opacity",r.color.a),e.setAttribute("stroke-width",i),e.setAttribute("stroke-linecap",r.cap),"number"==typeof r.join?(e.setAttribute("stroke-linejoin","miter"),e.setAttribute("stroke-miterlimit",r.join)):e.setAttribute("stroke-linejoin",r.join);var n=r.style.toLowerCase();if(n in a.dasharray&&(n=a.dasharray[n]),Array.isArray(n)){n=n.slice(0);for(var l=0;l<n.length;++l)n[l]*=i;if("butt"!==r.cap){for(var l=0;l<n.length;l+=2)n[l]-=i,n[l]<1&&(n[l]=1);for(var l=1;l<n.length;l+=2)n[l]+=i}n=n.join(",")}e.setAttribute("stroke-dasharray",n),e.setAttribute("dojoGfxStrokeStyle",r.style)}return this},t.prototype._getParentSurface=function(){for(var t=this.parent;t&&!t.defNode;t=t.parent);return t},t.prototype._setFillObject=function(t,e){var r=a.xmlns.svg;this.fillStyle=t;var i=this._getParentSurface(),o=i.defNode,n=this.rawNode.getAttribute("fill"),l=a.getRef(n);if(l)if(n=l,n.tagName.toLowerCase()!==e.toLowerCase()){var h=n.id;n.parentNode.removeChild(n),n=a._createElementNS(r,e),n.setAttribute("id",h),o.appendChild(n)}else for(;n.childNodes.length;)n.removeChild(n.lastChild);else n=a._createElementNS(r,e),n.setAttribute("id",s._base._getUniqueId()),o.appendChild(n);if("pattern"===e){n.setAttribute("patternUnits","userSpaceOnUse");var u=a._createElementNS(r,"image");u.setAttribute("x",0),u.setAttribute("y",0),u.setAttribute("width",(t.width<0?0:t.width).toFixed(8)),u.setAttribute("height",(t.height<0?0:t.height).toFixed(8)),a._setAttributeNS(u,a.xmlns.xlink,"xlink:href",t.src),n.appendChild(u)}else{n.setAttribute("gradientUnits","userSpaceOnUse");for(var d=0;d<t.colors.length;++d){var p=t.colors[d],f=a._createElementNS(r,"stop"),c=p.color=s.normalizeColor(p.color);f.setAttribute("offset",p.offset.toFixed(8)),f.setAttribute("stop-color",c.toCss()),f.setAttribute("stop-opacity",c.a),n.appendChild(f)}}return this.rawNode.setAttribute("fill","url(#"+n.getAttribute("id")+")"),this.rawNode.removeAttribute("fill-opacity"),this.rawNode.setAttribute("fill-rule","evenodd"),n},t.prototype._applyTransform=function(){var t=this.matrix;return t?this.rawNode.setAttribute("transform","matrix("+t[0].toFixed(8)+","+t[1].toFixed(8)+","+t[2].toFixed(8)+","+t[3].toFixed(8)+","+t[4].toFixed(8)+","+t[5].toFixed(8)+")"):this.rawNode.removeAttribute("transform"),this},t.prototype.setRawNode=function(t){var e=this.rawNode=t;"image"!==this.shape.type&&e.setAttribute("fill","none"),e.setAttribute("fill-opacity",0),e.setAttribute("stroke","none"),e.setAttribute("stroke-opacity",0),e.setAttribute("stroke-width",1),e.setAttribute("stroke-linecap","butt"),e.setAttribute("stroke-linejoin","miter"),e.setAttribute("stroke-miterlimit",4),e.__gfxObject__=this},t.prototype.setShape=function(t){this.shape=s.makeParameters(this.shape,t);for(var e in this.shape)if("type"!==e){var r=this.shape[e];"width"!==e&&"height"!==e||(r=r<0?0:r),this.rawNode.setAttribute(e,r)}return this.bbox=null,this},t.prototype._moveToFront=function(){return this.rawNode.parentNode.appendChild(this.rawNode),this},t.prototype._moveToBack=function(){return this.rawNode.parentNode.insertBefore(this.rawNode,this.rawNode.parentNode.firstChild),this},t.prototype._removeClipNode=function(){var t,e=i.get(this.rawNode,"clip-path");return e&&(t=r.byId(e.match(/gfx_clip[\d]+/)[0]))&&t.parentNode.removeChild(t),t},t.prototype.moveToFront=function(){var t=this.getParent();return t&&(t._moveChildToFront(this),this._moveToFront()),this},t.prototype.moveToBack=function(){var t=this.getParent();return t&&(t._moveChildToBack(this),this._moveToBack()),this},t.prototype.removeShape=function(t){return this.parent&&this.parent.remove(this,t),this},t.prototype._setParent=function(t,e){return this.parent=t,this._updateParentMatrix(e)},t.prototype._updateParentMatrix=function(t){return this.parentMatrix=t?n.clone(t):null,this._applyTransform()},t.prototype._getRealMatrix=function(){for(var t=n.clone(this.matrix||n.create()),e=this.parent;e;)e.matrix&&t&&n.multiply(t,e.matrix,t),e=e.parent;return t},t}();e.default=l});