// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojox/gfx/_base","dojox/gfx/matrix","../../../../core/lang","./Shape"],function(t,s,e,i,h,a,o){Object.defineProperty(s,"__esModule",{value:!0});var r=function(t){function s(s){var e=t.call(this)||this;return e.segments=[],e.tbbox=null,e.absolute=!0,e.last={},e.segmented=!1,e._validSegments={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7,z:0},e._2PI=2*Math.PI,e.rawNode=s,e.shape=a.clone(i.defaultPath),e}return e(s,t),s.prototype.setAbsoluteMode=function(t){return this._confirmSegmented(),this.absolute="string"==typeof t?"absolute"===t:t,this},s.prototype.getAbsoluteMode=function(){return this._confirmSegmented(),this.absolute},s.prototype.getBoundingBox=function(){return this._confirmSegmented(),this.bbox&&"l"in this.bbox?{x:this.bbox.l,y:this.bbox.t,width:this.bbox.r-this.bbox.l,height:this.bbox.b-this.bbox.t}:null},s.prototype._getRealBBox=function(){if(this._confirmSegmented(),this.tbbox)return this.tbbox;var t=this.bbox,s=this._getRealMatrix();this.bbox=null;for(var e=this.segments.length,i=0;i<e;++i)this._updateWithSegment(this.segments[i],s);var h=this.bbox;return this.bbox=t,this.tbbox=h?[{x:h.l,y:h.t},{x:h.r,y:h.t},{x:h.r,y:h.b},{x:h.l,y:h.b}]:null,this.tbbox},s.prototype.getLastPosition=function(){return this._confirmSegmented(),"x"in this.last?this.last:null},s.prototype._applyTransform=function(){return this.tbbox=null,t.prototype._applyTransform.call(this),this},s.prototype._updateBBox=function(t,s,e){if(e){var i=h.multiplyPoint(e,t,s);t=i.x,s=i.y}this.bbox&&"l"in this.bbox?(this.bbox.l>t&&(this.bbox.l=t),this.bbox.r<t&&(this.bbox.r=t),this.bbox.t>s&&(this.bbox.t=s),this.bbox.b<s&&(this.bbox.b=s)):this.bbox={l:t,b:s,r:t,t:s}},s.prototype._updateWithSegment=function(t,s){var e,h=t.args,a=h.length;switch(t.action){case"M":case"L":case"C":case"S":case"Q":case"T":for(e=0;e<a;e+=2)this._updateBBox(h[e],h[e+1],s);this.last.x=h[a-2],this.last.y=h[a-1],this.absolute=!0;break;case"H":for(e=0;e<a;++e)this._updateBBox(h[e],this.last.y,s);this.last.x=h[a-1],this.absolute=!0;break;case"V":for(e=0;e<a;++e)this._updateBBox(this.last.x,h[e],s);this.last.y=h[a-1],this.absolute=!0;break;case"m":var o=0;"x"in this.last||(this._updateBBox(this.last.x=h[0],this.last.y=h[1],s),o=2);for(e=o;e<a;e+=2)this._updateBBox(this.last.x+=h[e],this.last.y+=h[e+1],s);this.absolute=!1;break;case"l":case"t":for(e=0;e<a;e+=2)this._updateBBox(this.last.x+=h[e],this.last.y+=h[e+1],s);this.absolute=!1;break;case"h":for(e=0;e<a;++e)this._updateBBox(this.last.x+=h[e],this.last.y,s);this.absolute=!1;break;case"v":for(e=0;e<a;++e)this._updateBBox(this.last.x,this.last.y+=h[e],s);this.absolute=!1;break;case"c":for(e=0;e<a;e+=6)this._updateBBox(this.last.x+h[e],this.last.y+h[e+1],s),this._updateBBox(this.last.x+h[e+2],this.last.y+h[e+3],s),this._updateBBox(this.last.x+=h[e+4],this.last.y+=h[e+5],s);this.absolute=!1;break;case"s":case"q":for(e=0;e<a;e+=4)this._updateBBox(this.last.x+h[e],this.last.y+h[e+1],s),this._updateBBox(this.last.x+=h[e+2],this.last.y+=h[e+3],s);this.absolute=!1;break;case"A":for(e=0;e<a;e+=7)this._updateBBox(h[e+5],h[e+6],s);this.last.x=h[a-2],this.last.y=h[a-1],this.absolute=!0;break;case"a":for(e=0;e<a;e+=7)this._updateBBox(this.last.x+=h[e+5],this.last.y+=h[e+6],s);this.absolute=!1}var r=[t.action];for(e=0;e<a;++e)r.push(i.formatNumber(h[e],!0));if("string"==typeof this.shape.path)this.shape.path+=r.join("");else for(e=0,a=r.length;e<a;++e)this.shape.path.push(r[e]);"string"==typeof this.shape.path&&this.rawNode.setAttribute("d",this.shape.path)},s.prototype._pushSegment=function(t,s){this.tbbox=null;var e,i=this._validSegments[t.toLowerCase()];"number"==typeof i&&(i?s.length>=i&&(e={action:t,args:s.slice(0,s.length-s.length%i)},this.segments.push(e),this._updateWithSegment(e)):(e={action:t,args:[]},this.segments.push(e),this._updateWithSegment(e)))},s.prototype._collectArgs=function(t,s){for(var e=0;e<s.length;++e){var i=s[e];"boolean"==typeof i?t.push(i?1:0):"number"==typeof i?t.push(i):i instanceof Array?this._collectArgs(t,i):"x"in i&&"y"in i&&t.push(i.x,i.y)}},s.prototype._confirmSegmented=function(){if(!this.segmented){var t=this.shape.path;this.shape.path=[],this._setPath(t),this.shape.path=this.shape.path.join(""),this.segmented=!0}},s.prototype._setPath=function(t){var s=Array.isArray(t)?t:t.match(i.pathSvgRegExp);if(this.segments=[],this.absolute=!0,this.bbox={},this.last={},s){for(var e="",h=[],a=s.length,o=0;o<a;++o){var r=s[o],n=parseFloat(r);isNaN(n)?(e&&this._pushSegment(e,h),h=[],e=r):h.push(n)}this._pushSegment(e,h)}},s.prototype.setShape=function(s){return t.prototype.setShape.call(this,"string"==typeof s?{path:s}:s),this.segmented=!1,this.segments=[],this.shape.path?this.rawNode.setAttribute("d",this.shape.path):this.rawNode.removeAttribute("d"),this},s.nodeType="path",s}(o.default);s.default=r});