// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../geometry","../../../../Graphic","../../../../core/Accessor","../../../../core/Handles","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../layers/GraphicsLayer","../../../../symbols/SimpleMarkerSymbol","./drawUtils","./GraphicMover"],function(e,t,r,i,a,n,o,s,c,h,p,l,y,d){var u=function(){function e(e,t){this.graphic=e,this.targetGraphic=t,this.type="reshape-start"}return e}(),f=function(){function e(e,t){this.graphic=e,this.targetGraphic=t,this.type="reshape"}return e}(),v=function(){function e(e,t){this.graphic=e,this.targetGraphic=t,this.type="reshape-stop"}return e}(),g=function(){function e(e,t,r){this.graphic=e,this.dx=t,this.dy=r,this.type="move-start"}return e}(),m=function(){function e(e,t,r){this.graphic=e,this.dx=t,this.dy=r,this.type="move"}return e}(),_=function(){function e(e,t,r){this.graphic=e,this.dx=t,this.dy=r,this.type="move-stop"}return e}();return function(e){function t(t){var r=e.call(this,t)||this;return r._handleSymbol=new l({type:"simple-marker",style:"circle",size:6,color:[33,205,255],outline:{color:[0,12,255],width:1}}),r._handleHoverSymbol=new l({type:"simple-marker",style:"circle",size:8,color:[33,205,255],outline:{color:[0,12,255],width:1}}),r._handleSelectionSymbol=new l({type:"simple-marker",style:"circle",size:8,color:[255,255,255],outline:{color:[0,12,255],width:1}}),r._handles=new s,r._mover=null,r._selectedGraphics=[],r.callbacks={onReshapeStart:function(e){},onReshape:function(e){},onReshapeStop:function(e){},onMoveStart:function(e){},onMove:function(e){},onMoveStop:function(e){}},r.graphic=null,r.handleGraphics=[],r.layer=new p({listMode:"hide"}),r.view=null,r}return r(t,e),t.prototype.initialize=function(){var e=this;this.graphic&&(this._setUpGraphics(),this._setUpMover()),this._handles.add([c.whenOnce(this,"view.ready",function(){e.view&&e.view.map&&e.view.map.add(e.layer)}),c.pausable(this,"graphic",function(){e.refresh()})])},t.prototype.destroy=function(){this._reset(),this._handles.removeAll(),this._handles=null,this.view&&this.view.map&&this.view.map.remove(this.layer),this.layer.destroy(),this._set("layer",null)},t.prototype.refresh=function(){this._reset(),this.graphic&&(this._setUpGraphics(),this._setUpMover())},t.prototype._reset=function(){this._selectedGraphics=[],this.layer&&this.layer.removeMany(this.handleGraphics),this.handleGraphics=[],this.view.container.style.cursor="default",this._mover&&this._mover.destroy(),this._mover=null},t.prototype._setUpGraphics=function(){var e=this.graphic.geometry;this.handleGraphics=this._createHandleGraphics(e),this.layer.addMany(this.handleGraphics)},t.prototype._createHandleGraphics=function(e){var t=this,r=this._getVertices(e),i=[];return r.forEach(function(e,r){e.forEach(function(e,o){var s=e[0],c=e[1];i.push(new n({geometry:new a.Point({x:s,y:c,spatialReference:t.view.spatialReference}),symbol:t._handleSymbol,attributes:{pathIndex:r,pointIndex:o,handleIndex:i.length}}))})}),i.forEach(function(e,t){var r=[],a=e.geometry;i.forEach(function(e,i){if(t!==i){var n=e.geometry;a.x===n.x&&a.y===n.y&&r.push(i)}}),e.attributes.relatedGraphicIndices=r}),i},t.prototype._clearSelection=function(){var e=this;this._selectedGraphics.forEach(function(t){t.set("symbol",e._handleSymbol)}),this._selectedGraphics=[]},t.prototype._setUpMover=function(){var e=this,t=this.graphic.geometry,r=this.handleGraphics.concat(this.graphic),i=new d({graphics:r,view:this.view,callbacks:{onGraphicClick:function(t){var r=t.graphic;if(r!==e.graphic)if(t.viewEvent.native.shiftKey||e._clearSelection(),-1===e._selectedGraphics.indexOf(r))e._selectedGraphics.push(r),r.set("symbol",e._handleSelectionSymbol);else{var i=e._selectedGraphics.indexOf(r);e._selectedGraphics.splice(i,1),r.set("symbol",e._handleHoverSymbol)}},onGraphicMoveStart:function(t){var r=t.graphic;r===e.graphic?(e._clearSelection(),e.callbacks.onMoveStart(new g(e.graphic,t.dx,t.dy))):-1===e._selectedGraphics.indexOf(r)&&(e._clearSelection(),e._selectedGraphics.push(r),r.set("symbol",e._handleSelectionSymbol),e.callbacks.onReshapeStart(new u(e.graphic,r)))},onGraphicMove:function(r){var i=r.graphic;if(i===e.graphic){var n=e._getVertices(e.graphic.geometry);e.handleGraphics.forEach(function(t,r){var i=t.attributes,o=n[i.pathIndex][i.pointIndex],s=o[0],c=o[1];t.set("geometry",new a.Point(s,c,e.view.spatialReference))}),e.callbacks.onMove(new m(e.graphic,r.dx,r.dy))}else{var o=i.attributes,s=i.geometry,c=s.x,h=s.y,p=o.relatedGraphicIndices,l=e._getVertices(e.graphic.geometry);l[o.pathIndex][o.pointIndex]=[c,h],p.forEach(function(t){var r=e.handleGraphics[t],i=r.attributes;l[i.pathIndex][i.pointIndex]=[c,h],r.set("geometry",new a.Point(c,h,e.view.spatialReference))}),e._selectedGraphics.length>1&&e._selectedGraphics.forEach(function(t,a){if(t!==i){var n=t.attributes,o=y.move(t.geometry,r.dx,r.dy,e.view),s=o,c=s.x,h=s.y;t.set("geometry",o),l[n.pathIndex][n.pointIndex]=[c,h]}});var d=null;d="polyline"===t.type?new a.Polyline({paths:l,spatialReference:e.view.spatialReference}):new a.Polygon({rings:l,spatialReference:e.view.spatialReference}),e.graphic.set("geometry",d),e.callbacks.onReshape(new f(e.graphic,i))}},onGraphicMoveStop:function(t){t.graphic===e.graphic?e.callbacks.onMoveStop(new _(e.graphic,t.dx,t.dy)):e.callbacks.onReshapeStop(new v(e.graphic,t.graphic))},onGraphicPointerOver:function(t){var r=t.graphic;if("pointer"!==e.view.container.style.cursor&&(e.view.container.style.cursor="pointer"),r!==e.graphic){var i=e._selectedGraphics.indexOf(r)>-1,a=i?e._handleSelectionSymbol:e._handleHoverSymbol;r.set("symbol",a)}},onGraphicPointerOut:function(t){var r=t.graphic;if("default"!==e.view.container.style.cursor&&(e.view.container.style.cursor="default"),r!==e.graphic){!(e._selectedGraphics.indexOf(r)>-1)&&r.set("symbol",e._handleSymbol)}}}});this._mover=i},t.prototype._getVertices=function(e){if("polyline"===e.type)return e.paths.map(function(e){return Array.apply([],e)});var t=e.rings.map(function(e){return Array.apply([],e)});return t.forEach(function(e){e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&e.pop()}),t},i([h.property()],t.prototype,"callbacks",void 0),i([h.property()],t.prototype,"graphic",void 0),i([h.property()],t.prototype,"handleGraphics",void 0),i([h.property({readOnly:!0})],t.prototype,"layer",void 0),i([h.property()],t.prototype,"view",void 0),t=i([h.subclass("esri.views.2d.draw.support.Reshape")],t)}(h.declared(o))});