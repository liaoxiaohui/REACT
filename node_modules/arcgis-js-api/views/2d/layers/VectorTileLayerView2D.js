// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/decorateHelper","dojo/has","../../../Graphic","../../../core/Handles","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../engine/StageGL","./LayerView2D","../tiling/TileInfoViewPOT","../tiling/TileKey","../tiling/TileQueue","../tiling/TileStrategy","../../support/screenshotUtils","../../../views/vectorTiles/TileHandler","../../../views/vectorTiles/VectorTileContainer","../../../views/vectorTiles/VectorTileDisplayObject"],function(e,t,i,r,n,o,l,s,a,u,c,h,d,p,f,_,y,v,T){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._handles=new l,t._fetchQueue=null,t._tileRequests=new Map,t.container=new u,t}return i(t,e),t.prototype.initialize=function(){this.container.useContextVersion(this.view?this.view.renderContext:null)},t.prototype.hitTest=function(e,t){var i=this;return this.visible&&this._vectorTileContainer?this._vectorTileContainer.hittest(e,t).then(function(e){var t=i._tileHandler.getStyleRepository().layers;if(null===e||e<0||e>=t.length)return null;var r=t[e],n=new o({attributes:{layerId:e,layerName:r.id}});return n.layer=i.layer,n.sourceLayer=i.layer,n}):s.resolve(null)},t.prototype.update=function(e){if(this._tileHandlerPromise&&this._tileHandlerPromise.isFulfilled()){if(e.pixelRatio!==this._tileHandler.devicePixelRatio)return void this._start();this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume();for(var t=this._vectorTileContainer.children,i=0,r=t;i<r.length;i++){var n=r[i];this._tileHandler.updateTile(n,e)}this.notifyChange("updating")}},t.prototype.attach=function(){this._tileHandlerPromise=this._start()},t.prototype.detach=function(){this._stop()},t.prototype.moveStart=function(){this.requestUpdate()},t.prototype.viewChange=function(){this.requestUpdate()},t.prototype.moveEnd=function(){this.requestUpdate()},t.prototype.destroy=function(){this.container.dispose(),this._vectorTileContainer.destroy(),this._tileHandler.destroy()},t.prototype.takeScreenshot=function(e,t){return this.container?(e=_.adjustScreenshotSettings(e,t),this.container.takeScreenshot(e)):s.reject("Could not find an object capable of capturing screenshot!")},t.prototype.isUpdating=function(){var e=!0;return this._tileRequests.forEach(function(t){e=e&&t.isFulfilled()}),!e},t.prototype.acquireTile=function(e){var t=this,i=d.pool.acquire();i.set(e.level,e.row,e.col,e.world);var r=this.updateParameters.state.rotation,n=this._tileHandler.getStyleRepository(),o=T.pool.acquire(i,i,this.layer.tileInfo,n,r);return this._tileHandlerPromise.then(function(){var e=t._tileHandler.getRefKey(i).then(function(e){return e?(o.refKey=e,t._fetchQueue.push(o.key).then(function(e){o.setData(e.tileData,e.client),o.once("attach",function(){return t.requestUpdate()}),t._vectorTileContainer.addChild(o),t.notifyChange("updating")})):(o.setData(null,null),o.once("attach",function(){return t.requestUpdate()}),void t._vectorTileContainer.addChild(o))});t._tileRequests.set(i.id,e),t.notifyChange("updating")}),o},t.prototype.releaseTile=function(e){var t=e.key.id,i=this._tileRequests.get(t);i.isFulfilled()||i.cancel(),this._tileRequests.delete(t),this._vectorTileContainer.removeChild(e),this.requestUpdate(),e.once("detach",function(){return T.pool.release(e)}),this.notifyChange("updating")},t.prototype._stop=function(){this._tileHandlerPromise&&!this._tileHandlerPromise.isFulfilled()&&this._tileHandlerPromise.cancel(),this._handles.removeAll(),this._tileStrategy&&this._tileStrategy.destroy(),this._vectorTileContainer&&(this._vectorTileContainer.removeAllChildren(),this.container.removeChild(this._vectorTileContainer)),this._tileHandler&&this._tileHandler.stop(),T.pool.prune(),this._vectorTileContainer=this._tileHandler=this._tileStrategy=this._tileInfoView=null},t.prototype._start=function(){var e=this;return n("esri-webgl")?(this._stop(),this._handles.add(this.watch("layer.currentStyleInfo",function(){return e.attach()})),this._vectorTileContainer=new v,this.container.addChild(this._vectorTileContainer),this._tileInfoView=new h(this.layer.tileInfo,this.layer.fullExtent),this._tileHandler=new y(this.layer,function(){return e.requestUpdate()},window.devicePixelRatio||1,!0,this._tileInfoView),this._tileHandler.start().then(function(){e._tileStrategy=new f({cachePolicy:"keep",acquireTile:function(t){return e.acquireTile(t)},releaseTile:function(t){return e.releaseTile(t)},tileInfoView:e._tileInfoView}),e._fetchQueue=new p({tileInfoView:e._tileInfoView,process:function(t){return e._getTileData(t)}}),e._vectorTileContainer.initialize(e._tileHandler.spriteMosaic,e._tileHandler.glyphMosaic,e.layer.tileInfo,e._tileInfoView),e.requestUpdate()})):s.reject("WebGL is required but not supported!")},t.prototype._getTileData=function(e){return this._tileHandler.getTileData(e,this.updateParameters.state.rotation)},t=r([a.subclass("esri.views.2d.layers.VectorTileLayerView2D")],t)}(a.declared(c))});