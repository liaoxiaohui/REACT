// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../renderers","../../../../../core/Error","../../../../../core/Logger","../../../../../core/MapPool","../../../../../core/promiseUtils","../../../../../core/SetPool","../../../../../core/accessorSupport/decorators","../../../../../geometry/SpatialReference","../../../../../layers/support/LabelClass","../../../../../renderers/support/jsonUtils","../../../engine/webgl/definitions","../../../engine/webgl/rendererInfoUtils","../../../engine/webgl/Utils","../../../engine/webgl/mesh/factories/WGLMeshFactory","../../../engine/webgl/util/BidiText","./BaseProcessor"],function(e,r,t,n,i,o,s,l,a,u,c,p,f,d,y,h,g,m,b,v){function I(e){return e.outline&&"none"!==e.outline.style}function S(e){return e&&("unique-value"===e.type||"class-breaks"===e.type)&&null!==e.backgroundFillSymbol}function _(e){var r=e&&e.getSymbols();return S(e)||r.some(function(e){return"simple-fill"===e.type||"picture-fill"===e.type})}function C(e,r){switch(e){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryMultipoint":return!0;case"esriGeometryPolygon":return _(r);default:return x.error(new o("mapview-invalid-type",e+" is not supported")),!1}}function P(e,r){g.isMarkerSymbol(e)||g.isLineSymbol(e)?r.add(e):g.isFillSymbol(e)&&(r.add(e),I(e)&&r.add(e.outline))}function O(e,r,t){t.has(e)||t.set(e,new Set);for(var n=t.get(e),i=r.length,o=0;o<i;o++){var s=r.charCodeAt(o);n.add(s)}}Object.defineProperty(r,"__esModule",{value:!0});var x=s.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor"),M=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r._symbolToMosaicItemMap=new Map,r._visualSetPromises=new Map,r.type="symbol",r}return t(r,e),r.prototype.destroy=function(){this._visualSetPromises.forEach(function(e,r){e.cancel()}),this._visualSetPromises.clear(),this._symbolToMosaicItemMap.clear(),this.notifyChange("updating")},Object.defineProperty(r.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"labelingInfo",{get:function(){return this.configuration&&this.configuration.labelingInfo?this.configuration.labelingInfo.map(function(e){return f.fromJSON(e)}):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"labelClassInfos",{get:function(){var e=this;return this.labelingInfo?this.labelingInfo.map(function(r){return{labelOptions:r.getOptions(e.spatialReference),labelExpression:r.getLabelExpression(),labelClass:r}}):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"factory",{get:function(){if(!this.configuration)return null;var e={fields:this.fields};return m.default.from(this.renderer,e,this._symbolToMosaicItemMap,this.service.geometryType,this.service.objectIdField,p.fromJSON(this.spatialReference),this.configuration.devicePixelRatio,this.labelingInfo)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"queryInfo",{get:function(){var e=this.configuration,r=e.renderer,t=e.definitionExpression,n=e.outFields,i=e.gdbVersion,o=e.historicMoment,s=this.service.geometryType,l=this._getReturnCentroid(this.rendererInfo.renderer),a=C(s,this.rendererInfo.renderer),u="esriGeometryPoint"===s||"esriGeometryMultipoint"===s||l,c=u?20:0,p=null,f=r.visualVariables;return f&&f.some(function(e){if("size"===e.type&&e.field&&!e.normalizationField)return p=[e.field+" DESC"],!0}),{definitionExpression:t,orderByFields:p,outFields:n,pixelBuffer:c,returnCentroid:l,returnGeometry:a,gdbVersion:i,historicMoment:o}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"renderer",{get:function(){return this.configuration?d.fromJSON(this.configuration.renderer):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rendererInfo",{get:function(){return this.configuration?h.createRendererInfo(d.fromJSON(this.configuration.renderer),this.tileStore.spatialReference,{fields:this.service.fields}):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updating",{get:function(){return this._visualSetPromises.size>0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fields",{get:function(){return this.service.fields},enumerable:!0,configurable:!0}),r.prototype.onTileData=function(e,r){var t,n=this,i=r.addOrUpdate,o=r.clear,s=r.remove;t=i&&i.length?this._processFeatures(e,i):a.resolve();var l=t.then(function(r){var t=r&&r.message||null,i=r&&r.transferList||null;return n.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:{addOrUpdate:t,remove:s,clear:o}},i)}).catch(function(r){return n._handleError(e,r)});return this._visualSetPromises.set(e,l),l.then(function(){return n._cleanPromise(e)},function(){return n._cleanPromise(e)}),this.notifyChange("updating"),l},r.prototype.onTileError=function(e,r){var t=this,n=this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:r});return this._visualSetPromises.set(e,n),n.then(function(){return t._cleanPromise(e)},function(){return t._cleanPromise(e)}),this.notifyChange("updating"),n},r.prototype.onTileUpdate=function(e){for(var r=0,t=e.removed;r<t.length;r++){var n=t[r],i=this._visualSetPromises;if(!i.has(n))return;i.get(n).cancel(),i.delete(n),this.notifyChange("updating")}},r.prototype._cleanPromise=function(e){this._visualSetPromises.delete(e),this.notifyChange("updating")},r.prototype._processFeatures=function(e,r){var t=this;return r&&r.length?this._getMosaicItems(e,r).then(function(n){return t._writeFeatures(e,r,n)}):a.resolve(null)},r.prototype._writeFeatures=function(e,r,t){for(var n=this.factory,i=n.createMeshData(r.length),o={viewingMode:"",scale:e.scale},s=0,l=r;s<l.length;s++){var a=l[s];n.write(i,a,o,t,this._symbolToMosaicItemMap)}return this._encodeDisplayData(i)},r.prototype._encodeDisplayData=function(e){var r={},t=new Array;return e.encode(r,t),{message:r,transferList:t}},r.prototype._handleError=function(e,r){if(r&&"cancel"!==r.dojoType)return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:r.message})},r.prototype._getReturnCentroid=function(e){function r(e){if(!e)return!1;var r=e.type;return"simple-marker"===r||"picture-marker"===r||"text"===r}if("esriGeometryPolygon"===this.service.geometryType&&this.labelingInfo)return!0;if("esriGeometryPolygon"!==this.service.geometryType)return!1;switch(e.type){case"simple":return r(e.symbol);case"unique-value":return r(e.defaultSymbol)||e.uniqueValueInfos.some(function(e){return r(e.symbol)});case"class-breaks":return r(e.defaultSymbol)||e.classBreakInfos.some(function(e){return r(e.symbol)});default:return!0}},r.prototype._getMosaicItems=function(e,r){for(var t=u.default.acquire(),n=l.acquire(),o=this._createLabelFeatures(e.scale,r,n),s=0,c=this.renderer.getSymbols();s<c.length;s++){var p=c[s];if(g.isTextSymbol(p)){var f=p;O(f,b.bidiText(f.text)[0],n)}else P(p,t)}if(this.renderer instanceof i.UniqueValueRenderer||this.renderer instanceof i.ClassBreaksRenderer){var d=this.renderer.backgroundFillSymbol;d&&P(d,t)}var y=this._symbolToMosaicItemMap,h=l.acquire(),m=[],v=0;return t.forEach(function(e){y.has(e.id)||(h.set(v,e),m.push({symbol:e.toJSON(),id:v}),v++)}),n.forEach(function(e,r){if(y.has(r.id)){var t=y.get(r.id),n=t.glyphMosaicItems,i=[];e.forEach(function(e){(n&&n.length<e||!n[e])&&(i[e]=e)}),i.length>0&&(h.set(v,r),m.push({symbol:r.toJSON(),id:v,glyphIds:i}),v++)}else{h.set(v,r);var o=[];e.forEach(function(e){return o.push(e)}),m.push({symbol:r.toJSON(),id:v,glyphIds:o}),v++}}),m.length>0?this.remoteClient.invoke("tileRenderer.getMaterialItems",m).then(function(e){for(var r=0,t=e;r<t.length;r++){var n=t[r],i=h.get(n.id);if(i)if(g.isTextSymbol(i))if(y.has(i.id)){var s=y.get(i.id),a=s.glyphMosaicItems,u=n.mosaicItem.glyphMosaicItems;if(u)for(var c=0;c<u.length;c++)null!=u[c]&&(a[c]=u[c])}else y.set(i.id,n.mosaicItem);else y.set(i.id,n.mosaicItem)}return l.release(h),o}):(u.default.release(t),l.release(n),a.resolve(o))},r.prototype._getLabelClassInfos=function(e){return this.labelClassInfos.map(function(e,r){return{id:r,labelClassInfo:e}}).filter(function(r){var t=r.labelClassInfo;return(!t.labelClass.minScale||t.labelClass.minScale>=e||0===t.labelClass.minScale)&&(!t.labelClass.maxScale||t.labelClass.maxScale<=e||0===t.labelClass.maxScale)})},r.prototype._createLabelFeatures=function(e,r,t){if(!this.labelingInfo||!r||0===r.length)return null;var n=this._getLabelClassInfos(e);if(0===n.length)return null;for(var i=l.acquire(),o=n.map(function(e){return e.id}),s=new m.LabelGrid(y.COLLISION_EARLY_REJECT_BUCKET_SIZE),a=0,u=r;a<u.length;a++){var c=u[a],p=this.service.geometryType,f=0,d=0;if("esriGeometryPoint"===p){var h=c.geometry;f=h.x,d=h.y}else{if("esriGeometryPolygon"!==p)return null;f=c.centroid.x,d=c.centroid.y}var g=c.attributes[this.service.objectIdField];if(!s.checkOverlap(f,d)){for(var v=new Array(n.length),I=0;I<n.length;I++){var S=n[I].labelClassInfo,_=b.bidiText(this._evaluateLabelExpression(c,S)),C=_[0],P=_[1];O(S.labelClass.symbol,C,t),v[I]={text:C,rtl:P}}i.set(g,{text:v,labelingInfo:o})}}return i},r.prototype._evaluateLabelExpression=function(e,r){return r.labelClass.symbol&&f.evaluateWhere(r.labelClass.where,e.attributes)&&r.labelExpression.expression?f.buildLabelText(r.labelExpression.expression,e,this.fields,r.labelOptions):""},n([c.property({readOnly:!0})],r.prototype,"supportsTileUpdates",null),n([c.property()],r.prototype,"configuration",void 0),n([c.property({dependsOn:["configuration"]})],r.prototype,"labelingInfo",null),n([c.property({dependsOn:["labelingInfo"]})],r.prototype,"labelClassInfos",null),n([c.property({dependsOn:["configuration","service","fields"]})],r.prototype,"factory",null),n([c.property({constructOnly:!0})],r.prototype,"queryInfo",null),n([c.property({dependsOn:["configuration"]})],r.prototype,"renderer",null),n([c.property({dependsOn:["configuration"]})],r.prototype,"rendererInfo",null),n([c.property({readOnly:!0})],r.prototype,"updating",null),n([c.property({dependsOn:["service"]})],r.prototype,"fields",null),r=n([c.subclass()],r)}(c.declared(v.default));r.default=M});