// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","@dojo/shim/Set","dojo/has","../../../../../geometry","../../../../../core/Error","../../../../../core/Logger","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../layers/graphics/optimizedFeatures","../../../../../layers/graphics/data/FeatureStore","../../../../../layers/support/FeatureProcessing","../../../../../tasks/operations/query","../../../../../tasks/support/QuantizationParameters","../../../../../tasks/support/Query","./BaseController","../support/DataTileFeaturesIndex","../support/Tile","../support/TileUpdateQueue","../../../tiling/TileInfoView","../../../tiling/TileQueue"],function(e,t,r,i,o,n,s,u,a,l,c,d,p,h,f,y,g,m,v,_,b,x,T,F){Object.defineProperty(t,"__esModule",{value:!0});var Q=l.getLogger("esri.views.2d.layers.features.controllers.OnDemandController"),I=s("esri-featurelayer-webgl"),w=s("esri-mobile"),P={maxDrillLevel:I&&"object"==typeof I&&null!=I.maxDrillLevel?I.maxDrillLevel:w?1:4,maxRecordCountFactor:I&&"object"==typeof I&&null!=I.maxRecordCountFactor?I.maxRecordCountFactor:w?1:3,enablePBFQuery:!I||"object"!=typeof I||null==I.enablePBFQuery||I.enablePBFQuery},S=new n.default,C=[],O=function(){function e(){this.done=!1,this.displayTile=null,this.tile=null,this.queryInfoHash=null,this.returnExceeded=!1,this.objectIds=new n.default}return Object.defineProperty(e.prototype,"key",{get:function(){return this.tile.key},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.tile.id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bounds",{get:function(){return this.tile.bounds},enumerable:!0,configurable:!0}),e}(),j=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="on-demand",t._queryInfoHash=null,t._processingInMainThread=!1,t._dataTileIndex=new _.default,t}return r(t,e),t.prototype.initialize=function(){var e=this;this._fetchQueue=new F({concurrency:10,strategy:"center-first",tileInfoView:new T(this.tileStore.tileInfo),process:function(t){return e._fetchTile(t)}}),this._updateQueue=new x.default({tileInfoView:new T(this.tileStore.tileInfo),process:function(t){return e._updateTile(t)}}),this.handles.add(this.watch("processor",this._switchProcessor.bind(this)))},t.prototype.destroy=function(){this._fetchQueue.clear(),this._updateQueue.clear(),this.store&&(this.store.destroy(),this._set("store",null))},Object.defineProperty(t.prototype,"processing",{get:function(){return f.fromWorker(this.configuration.processing)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._fetchQueue.length+this._fetchQueue.onGoingCount>0||this._updateQueue.updating},enumerable:!0,configurable:!0}),t.prototype.refresh=function(){},t.prototype.setViewState=function(e){this._fetchQueue.state=e,this._updateQueue.state=e},t.prototype.queryFeatures=function(e){return this.store.executeQuery(m.fromJSON(e))},t.prototype.queryFeatureCount=function(e){return this.store.executeQueryForCount(m.fromJSON(e))},t.prototype.queryObjectIds=function(e){return this.store.executeQueryForIds(m.fromJSON(e))},t.prototype.queryExtent=function(e){return this.store.executeQueryForExtent(m.fromJSON(e))},t.prototype.redraw=function(){this._updateQueue.pause(),this._manageTiles(this.tileStore.tiles),this._updateQueue.resume()},t.prototype.onTileUpdate=function(e){this.store&&this._manageTiles(e.added,e.removed)},t.prototype._manageTiles=function(e,t){void 0===t&&(t=null);for(var r=this._dataTileIndex,i=this._fetchQueue,o=this._updateQueue,n="esriGeometryPoint"===this.service.geometryType,s=this,u=0,a=e;u<a.length;u++){var l=a[u];!function(e){var t=r.get(e.id);t?(t.displayTile=e,n?r.forEach(function(r){b.isChildOf(r,t)&&(r.displayTile=e)}):t.done=!1):(t=new O,t.tile=e.clone(),t.displayTile=e,r.add(t)),s._processDataTile(t)}(l)}if(t)for(var c=0,d=t;c<d.length;c++){var l=d[c];S.add(l),o.cancel(l.id)}r.forEach(function(e){S.has(e.displayTile)&&C.push(e)});for(var p=0,h=C;p<h.length;p++){var f=h[p];i.has(f.id)&&i.get(f.id).cancel(),r.delete(f)}C.length=0,S.clear()},t.prototype._processDataTile=function(e){var t=this,r=e.displayTile,i=e.key,o=this._dataTileIndex,n=this._fetchQueue,s=i.id,u=this._queryInfoHash,a=i.level-r.key.level>=P.maxDrillLevel;if(o.add(e),e.done||n.has(s)){if(e.queryInfoHash!==u||e.returnExceeded!==a)if(e.done)e.done=!1;else{if(!n.isOngoing(s))return e.queryInfoHash=u,void(e.returnExceeded=a);n.get(s).cancel()}}else e.queryInfoHash=u,e.returnExceeded=a;if(e.done)return void this._invalidateTile(e.displayTile);n.has(s)||(n.push(e).then(function(r){if(e.done=!0,p.hydrateOptimizedFeatureSet(r),r.exceededTransferLimit)if(e.returnExceeded)o.load(e,r.features);else for(var i=e.tile.createChildTiles(),n=0,s=i;n<s.length;n++){var u=s[n],a=new O;a.tile=u,a.displayTile=e.displayTile,t._processDataTile(a)}else o.load(e,r.features);t._invalidateTile(e.tile)}).catch(function(t){e.done=!0}).then(function(){t.notifyChange("updating")}),this.notifyChange("updating"))},t.prototype._fetchTile=function(e){var t=this.processor.queryInfo,r=this._createQuery(e.displayTile,e.tile,t,e.returnExceeded),i=this.service.source;return P.enablePBFQuery&&this.service.capabilities.query.supportsFormatPBF?y.executeQueryPBF(i,r).then(function(e){return e.data}):y.executeQuery(i,r).then(function(e){return p.convertFromFeatureSet(e.data)})},t.prototype._invalidateTile=function(e){for(var t=this._updateQueue,r=this.tileStore.intersections(e,this.processor.queryInfo.pixelBuffer),i=0,o=r;i<o.length;i++){var n=o[i].tile;t.has(n.id)||t.push(n.id)}this.notifyChange("updating")},t.prototype._updateTile=function(e){var t=this,r=this.tileStore.get(e),i=this.processor.queryInfo,o=i.returnCentroid,n=i.returnGeometry,s=i.pixelBuffer,u=this.store.executeTileQuery(r,{pixelBuffer:s,returnGeometry:n,returnCentroid:o}),a=u.features,l=u.objectIds;this.notifyChange("updating");var c={features:a,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:{originPosition:"upperLeft",scale:[r.resolution,r.resolution],translate:[r.bounds[0],r.bounds[3]]}};return this._applyProcessing(c).catch(function(e){return e&&"cancel"!==e.dojoType&&Q.error("updating-tile",e),c}).then(function(e){var i=[];return r.objectIds.forEach(function(e){l.has(e)||i.push(e)}),t.processor.onTileData(r,{addOrUpdate:e.features,remove:i}).catch(function(e){e&&"cancel"!==e.dojoType&&Q.error("updating-tile",e)}).then(function(){t.notifyChange("updating")})})},t.prototype._switchProcessor=function(e,t){var r=e.queryInfo,i=r.definitionExpression,o=r.gdbVersion,n=r.historicMoment,s=this._createQueryInfoHash(e);this._queryInfoHash!==s&&(this._queryInfoHash=s,this.store&&this.store.destroy(),this._set("store",new h.default({definitionExpression:i,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference,cacheSpatialQueries:!0,gdbVersion:o,historicMoment:null!=n&&new Date(n)})),this._dataTileIndex.store=this.store,this._dataTileIndex.forEach(function(e){e.done=!1,e.displayTile.objectIds.clear()})),this._fetchQueue.pause(),this._updateQueue.pause(),this._fetchQueue.reset(),this._updateQueue.clear(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),this._updateQueue.resume(),this.notifyChange("updating")},t.prototype._createQuery=function(e,t,r,i){var o=this;void 0===i&&(i=!0);var n=new m,s=r.historicMoment,a="esriGeometryPoint"===this.service.geometryType?t:e,l=g.default.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:a.resolution,extent:{xmin:a.bounds[0],ymin:a.bounds[1],xmax:a.bounds[2],ymax:a.bounds[3],spatialReference:this.spatialReference}}),c=r.outFields,d=r.orderByFields;return this.processing&&(c=c&&c.filter(function(e){return!o.processing.getField(e)}),d=d&&d.filter(function(e){return!o.processing.getField(e)})),c=c.length/this.service.fields.length>=.75?["*"]:c,n.maxRecordCountFactor=P.maxRecordCountFactor,n.gdbVersion=r.gdbVersion,n.historicMoment=null!=s?new Date(s):null,n.outFields=c,n.where=r.definitionExpression||"1=1",n.geometry=u.Extent.fromJSON({xmin:t.bounds[0],ymin:t.bounds[1],xmax:t.bounds[2],ymax:t.bounds[3],spatialReference:this.spatialReference}),this.service.capabilities.query.supportsQuantization?(n.quantizationParameters=l,"esriGeometryPolyline"===this.service.geometryType&&(n.maxAllowableOffset=l.tolerance)):n.maxAllowableOffset=l.tolerance,n.resultType="tile",n.returnExceededLimitFeatures=i,n.returnGeometry=!0,n.returnCentroid=r.returnCentroid,n.orderByFields=d,n},t.prototype._applyProcessing=function(e){var t=this.processing;if(!t)return c.resolve(e);if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{featureSet:e});try{var r=t.process(e,t.options);return r?"then"in r?r:c.resolve(r):c.reject(new a("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(t){return this._processingInMainThread=!0,this.remoteClient.invoke("executeProcessing",{featureSet:e})}},t.prototype._createQueryInfoHash=function(e){var t=this,r=e.queryInfo,i=r.orderByFields,o=r.outFields,n=e.queryInfo,s=n.definitionExpression,u=n.gdbVersion,a=n.historicMoment;return this.processing&&(o=o&&o.filter(function(e){return!t.processing.getField(e)}),i=i&&i.filter(function(e){return!t.processing.getField(e)})),o&&o.sort(),i&&i.sort(),JSON.stringify({definitionExpression:s,outFields:o.length/this.service.fields.length>=.75?["*"]:o,orderByFields:i,gdbVersion:u,historicMoment:a})},i([d.property()],t.prototype,"configuration",void 0),i([d.property({readOnly:!0,dependsOn:["configuration"]})],t.prototype,"processing",null),i([d.property({readOnly:!0})],t.prototype,"store",void 0),i([d.property()],t.prototype,"updating",null),t=i([d.subclass()],t)}(d.declared(v.default));t.default=j});