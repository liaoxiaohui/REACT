// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../geometry/support/spatialReferenceUtils","./LODInfo","./TileCoverage","./TileKey","./TileSpan"],function(e,o,t,r,n,i,l){var s=new i("0/0/0/0"),a=function(){function e(e,o,t,r,n,i,l,s){this.x=e,this.ymin=o,this.ymax=t,this.invM=r,this.leftAdjust=n,this.rightAdjust=i,this.leftBound=l,this.rightBound=s}return e.create=function(o,t){var r;o[1]>t[1]&&(r=[t,o],o=r[0],t=r[1]);var n=o[0],i=o[1],l=t[0],s=t[1],a=l-n,u=s-i,f=0!==u?a/u:0,h=(Math.ceil(i)-i)*f,c=(Math.floor(i)-i)*f;return new e(n,Math.floor(i),Math.ceil(s),f,a<0?h:c,a<0?c:h,a<0?l:n,a<0?n:l)},e.prototype.incrRow=function(){this.x+=this.invM},e.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)},e.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)},e}(),u=[[0,0],[0,0],[0,0],[0,0]];return function(){function e(e,o){var t=this;this.tileInfo=e,this.fullExtent=o,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};var n=e.lods.slice();n.sort(function(e,o){return o.scale-e.scale});var i=this._lodInfos=n.map(function(t){return r.create(e,t,o)});n.forEach(function(e,o){t._infoByLevel[e.level]=i[o],t._infoByScale[e.scale]=i[o],t.scales[o]=e.scale},this),this._wrap=e.isWrappable}return e.prototype.getLODInfoAt=function(e){return this._infoByLevel[e.level]},e.prototype.getTileBounds=function(e,o,t){void 0===t&&(t=!1),s.set(o);var r=this._infoByLevel[s.level];return r?r.getTileBounds(e,s,t):e},e.prototype.getTileCoords=function(e,o,t){void 0===t&&(t=!1),s.set(o);var r=this._infoByLevel[s.level];return r?r.getTileCoords(e,s,t):e},e.prototype.getTileCoverage=function(e,o){void 0===o&&(o=192);var t,r,i,s=this.getClosestInfoForScale(e.scale),f=n.pool.acquire(s),h=this._wrap,c=1/0,p=-1/0,v=f.spans;u[0][0]=u[0][1]=u[1][1]=u[3][0]=-o,u[1][0]=u[2][0]=e.size[0]+o,u[2][1]=u[3][1]=e.size[1]+o;for(var d=0,g=u;d<g.length;d++){var m=g[d];e.toMap(m,m),m[0]=s.getColumnForX(m[0]),m[1]=s.getRowForY(m[1])}for(var y=[],w=3,M=0;M<4;M++)if(u[M][1]!==u[w][1]){var B=a.create(u[M],u[w]);c=Math.min(B.ymin,c),p=Math.max(B.ymax,p),void 0===y[B.ymin]&&(y[B.ymin]=[]),y[B.ymin].push(B),w=M}else w=M;if(null==c||null==p||p-c>100)return null;var _=[];for(t=c;t<p;){null!=y[t]&&(_=_.concat(y[t])),r=1/0,i=-1/0;for(var M=_.length-1;M>=0;M--){var B=_[M];r=Math.min(r,B.getLeftCol()),i=Math.max(i,B.getRightCol())}if(r=Math.floor(r),i=Math.floor(i),t>=s.first[1]&&t<=s.last[1])if(h)if(s.size[0]<s.worldSize[0])for(var C=Math.floor(i/s.worldSize[0]),M=Math.floor(r/s.worldSize[0]);M<=C;M++)v.push(new l(t,Math.max(s.getFirstColumnForWorld(M),r),Math.min(s.getLastColumnForWorld(M),i)));else v.push(new l(t,r,i));else r>s.last[0]||i<s.first[0]||(r=Math.max(r,s.first[0]),i=Math.min(i,s.last[0]),v.push(new l(t,r,i)));t+=1;for(var M=_.length-1;M>=0;M--){var B=_[M];B.ymax>=t?B.incrRow():_.splice(M,1)}}return f},e.prototype.getTileIdAtParent=function(e,o){var t=i.pool.acquire(o),r=this._infoByLevel[t.level];if(e.resolution<r.resolution)throw new Error("Cannot calculate parent tile. destination LOD's resolution "+e.resolution+" is not a parent resolution of "+r.resolution);if(e.resolution===r.resolution)return t.id;var n=Math.floor(t.col*r.resolution/e.resolution+.01),l=Math.floor(t.row*r.resolution/e.resolution+.01);return i.getId(e.level,l,n,t.world)},e.prototype.getTileParentId=function(e){var o=i.pool.acquire(e),t=this._infoByLevel[o.level],r=this._lodInfos.indexOf(t)-1;if(r<0)return i.pool.release(o),null;var n=this._lodInfos[r],l=this.getTileIdAtParent(n,o);return i.pool.release(o),l},e.prototype.getTileResolution=function(e){var o=this._infoByLevel["object"==typeof e?e.level:e];return o?o.resolution:-1},e.prototype.getTileScale=function(e){var o=this._infoByLevel[e.level];return o?o.scale:-1},e.prototype.intersects=function(e,o){var t=i.pool.acquire(o),r=this._infoByLevel[t.level],n=e.lodInfo;if(n.resolution>r.resolution){var l=i.pool.acquire(this.getTileIdAtParent(n,t)),s=n.denormalizeCol(l.col,l.world),a=e.spans.some(function(e){return e.row===l.row&&e.colFrom<=s&&e.colTo>=s});return i.pool.release(t),i.pool.release(l),a}if(n.resolution<r.resolution){var u=e.spans.reduce(function(e,o){return e[0]=Math.min(e[0],o.row),e[1]=Math.max(e[1],o.row),e[2]=Math.min(e[2],o.colFrom),e[3]=Math.max(e[3],o.colTo),e},[1/0,-1/0,1/0,-1/0]),f=u[0],h=u[1],c=u[2],p=u[3],v=r.denormalizeCol(t.col,t.world),d=n.getColumnForX(r.getXForColumn(v)),g=n.getRowForY(r.getYForRow(t.row)),m=n.getColumnForX(r.getXForColumn(v+1))-1,y=n.getRowForY(r.getYForRow(t.row+1))-1;return i.pool.release(t),!(d>p||m<c||g>h||y<f)}var w=n.denormalizeCol(t.col,t.world),M=e.spans.some(function(e){return e.row===t.row&&e.colFrom<=w&&e.colTo>=w});return i.pool.release(t),M},e.prototype.normalizeBounds=function(e,o,r){if(e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],this._wrap){var n=t.getInfo(this.tileInfo.spatialReference),i=-r*(n.valid[1]-n.valid[0]);e[0]+=i,e[2]+=i}return e},e.prototype.getClosestInfoForScale=function(e){var o=this.scales;return this._infoByScale[e]?this._infoByScale[e]:(e=o.reduce(function(o,t,r,n){return Math.abs(t-e)<Math.abs(o-e)?t:o},o[0]),this._infoByScale[e])},e}()});