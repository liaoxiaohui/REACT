// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../lib/glMatrix","./primitiveIntersectionUtils","../../support/mathUtils"],function(e,t,r,a,c){function n(e,t,r){return r[0]=t[0]/e.fullWidth,r[1]=t[1]/e.fullHeight,r}function d(e,t,c,n,d){void 0===d&&(d=!1);var o=C;if(a.createRay(t,c,o,d),!a.intersectSphere(e,o,n))return p(e,o,n),!1;if(r.vec3d.dist2(e.center,o.origin)<e.radius*e.radius){var l=i(e,o.origin),s=-v(o.origin,n,R),u=s-l;if(u>0){var h=F;return r.mat4d.identity(h),r.mat4d.rotate(h,-u,R),r.vec3d.subtract(n,e.center),r.mat4d.multiplyVec3(h,n,n),r.vec3d.add(n,e.center),!1}}return!0}function i(e,t){var a=R;r.vec3d.subtract(t,e.center,a);var c=Math.abs(r.vec3d.length(a)-e.radius);return Math.acos(e.radius/(c+e.radius))}function o(e,t,r,c){var n=C;return a.createRay(t,r,n,!0),a.intersectSphere(e,n,c)}function v(e,t,a){r.vec3d.cross(e,t,a);var n=r.vec3d.dot(e,t)/(r.vec3d.length(e)*r.vec3d.length(t));return-c.acos(n)}function l(e,t,a){var c=R,n=T,d=w;r.vec3d.set(e,n),r.vec3d.set(t,d);var i=r.vec3d.dot(n,a),o=r.vec3d.dot(d,a);r.vec3d.scale(a,i,c),r.vec3d.subtract(n,c),r.vec3d.normalize(n),r.vec3d.scale(a,o,c),r.vec3d.subtract(d,c),r.vec3d.normalize(d);var v=r.vec3d.dot(n,d);r.vec3d.cross(a,n,c);var l=r.vec3d.dot(d,c);return Math.atan2(l,v)}function s(e,t,a){r.vec3d.set(t,a.normal),a.d=-r.vec3d.dot(t,e)}function u(e,t){t.d=-r.vec3d.dot(t.normal,e)}function h(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function m(e,t,a,c){var n=F;r.mat4d.identity(n),r.mat4d.rotate(n,c,a),r.vec3d.subtract(e.eye,t),r.mat4d.multiplyVec3(n,e.eye,e.eye),r.vec3d.add(e.eye,t),r.vec3d.subtract(e.center,t),r.mat4d.multiplyVec3(n,e.center,e.center),r.vec3d.add(e.center,t),r.mat4d.multiplyVec3(n,e.up,e.up),e.markViewDirty()}function p(e,t,a){var n=R,d=T,i=D;r.vec3d.subtract(t.origin,e.center,d),r.vec3d.cross(d,t.direction,n),r.vec3d.cross(n,d,a),r.vec3d.scale(a,1/r.vec3d.length(a)*e.radius);var o=-c.asin(e.radius/r.vec3d.length(t.origin));r.mat4d.identity(i),r.mat4d.rotate(i,o,n),r.mat4d.multiplyVec3(i,a)}function f(e,t,r,c){var n=C;return a.createRay(t,r,n),a.intersectPlane(e,n,c)}function P(e,t,a,c){var n=O,d=1-a;r.vec3d.subtract(t,e.eye,n);var i=r.vec3d.length(n),o=i*(1-d);d>=0&&o<c&&(o=c,d=-(o-i)/i),Math.abs(i-o)<1e-6||(r.vec3d.scale(n,d),r.vec3d.add(e.eye,n),r.vec3d.lerp(e.center,t,d))}function y(e,t,a){r.vec2d.set2(t.padding[3]+t.width/2,t.padding[2]+t.height/2,A),o(e,t,A,t.center),r.vec3d.subtract(t.center,t.eye,O);var c=r.vec3d.length(O),n=c*a;Math.abs(c-n)<1e-6||(r.vec3d.scale(O,a),r.vec3d.subtract(t.center,O,t.eye),t.markViewDirty())}function g(e,t,a){r.vec2d.set2(t.x,e.fullHeight-t.y,a)}function b(e,t,a){M(t,a),r.vec3d.normalize(a),r.vec3d.scale(a,e)}function M(e,t){r.vec3d.set3(0,0,0,t);for(var a=0,c=e;a<c.length;a++){var n=c[a];r.vec3d.add(t,n)}r.vec3d.scale(t,1/e.length)}function S(e,a,c,n){var i=r.vec3d.create(),v={center:r.vec3d.create(),radius:0},l=!0;return e.pickPointInScreen(c,i)?v.radius=r.vec3d.length(i):(a.aboveGround?v.radius=Math.max(r.vec3d.length(a.center),.9*t.Earth.radius):v.radius=r.vec3d.length(a.eye)-a.relativeElevation,n?d(v,a,c,i):l=o(v,a,c,i)),{sphere:v,scenePickPoint:l?i:null}}function V(e,a,c){var n=r.vec3d.length(e.eye),d=n-t.Earth.radius;if(Math.abs(d)>t.VerticalPanTresholds.Elevation)return H.Horizontal;var i=a.radius>n;return e.aboveGround===i?H.Vertical:(r.vec3d.normalize(r.vec3d.subtract(e.eye,c,k)),Math.abs(.5*Math.PI-Math.acos(r.vec3d.dot(c,k)/r.vec3d.length(c)))<t.VerticalPanTresholds.Angle?H.Vertical:H.Horizontal)}function z(e,t,a){r.vec3d.subtract(a,t,x),r.vec3d.subtract(e.eye,x),r.vec3d.subtract(e.center,x),e.markViewDirty()}function I(e,t,r,a){var c=v(r,a,E);m(t,e.center,E,c)}Object.defineProperty(t,"__esModule",{value:!0}),t.Earth={center:r.vec3d.create(),radius:6378137},t.normalizeCoordinate=n,t.sphereOrSilhouettePointFromScreenPoint=d,t.computeHorizonSphereCapAngle=i,t.intersectSphereFromScreenPoint=o,t.rotationAndAxisFromPoints=v,t.rotationFromPointsAroundAxis=l,t.setPlane=s,t.setPlaneD=u,t.normalizeRotationDelta=h,t.applyRotation=m,t.closestPointOnSphereSilhouette=p,t.intersectPlaneFromScreenPoint=f,t.applyZoomToPoint=P,t.applyZoomOnSphere=y;var A=r.vec2d.create();t.navPointToScreenPoint=g,t.centroidOnSphere=b,t.centroid=M;var H;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(H=t.PanMode||(t.PanMode={})),t.VerticalPanTresholds={Elevation:3e4,Angle:8/180*Math.PI},t.pickPointAndInitSphere=S,t.decidePanMode=V;var k=r.vec3d.create();t.applyPanPlanar=z;var x=r.vec3d.create();t.applyPanSpherical=I;var E=r.vec3d.create(),D=r.mat4d.create(),F=r.mat4d.create(),O=r.vec3d.create(),R=r.vec3d.create(),T=r.vec3d.create(),w=r.vec3d.create(),C={origin:r.vec3d.create(),direction:r.vec3d.create()}});