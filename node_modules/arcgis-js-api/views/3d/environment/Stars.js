// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","dojo/text!./materials/StarMaterial.xml","../../../request","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../core/watchUtils","../lib/glMatrix","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/GeometryRenderer","../webgl-engine/lib/RenderPass","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/Util","../webgl-engine/materials/internal/MaterialUtil","../../webgl/Program","../../webgl/Util"],function(t,e,r,a,n,i,s,o,l,d,f,u,h,c,m,p,_){var g=c.VertexAttrConstants,S=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],v=i.getLogger("esri.views.3d.environment.Stars"),b=l.mat3d.toMat4(l.mat3d.createFrom(1,0,0,0,.9174771405229186,.39778850739794974,0,-.39778850739794974,.9174771405229186)),y=l.mat3d.toMat4(l.mat3d.createFrom(1,0,0,0,.9174771405229186,-.39778850739794974,0,.39778850739794974,.9174771405229186)),w=null;return function(){function e(t){this.view=null,this.slot=h.POSTPROCESSING_ATMOSPHERE_OPAQUE,this.numBinaryFloats=2,this.numBinaryUInt8=1,this.bytesPerStar=9,this.needsRender=!1,this.didRender=!0,this._renderData={model:l.mat4d.identity()},this._renderer=null,this._program=null,this._vertexBufferLayout=[{name:"position",count:3,type:5126,offset:0,stride:20,normalized:!1},{name:"color",count:4,type:5121,offset:12,stride:20,normalized:!1},{name:"size",count:1,type:5126,offset:16,stride:20,normalized:!1}],this._loadDataPromise=null,this._numStars=0,this._starData=null,this._dateHandle=null,this.view=t,this._loadDataPromise=this._loadBrightStarCatalogue()}return e.prototype.destroy=function(){this._loadDataPromise.isFulfilled()||this._loadDataPromise.cancel(),this._dateHandle&&(this._dateHandle.remove(),this._dateHandle=null),this._program&&(this._program.dispose(),this._program=null)},e.prototype.initializeRenderContext=function(t){var e=this;t.shaderSnippets.vertexShaderStar||t.shaderSnippets._parse(r),this._program=new p(t.rctx,t.shaderSnippets.vertexShaderStar,t.shaderSnippets.fragmentShaderStar,d.Default3D),this._dateHandle=o.init(this.view,"environment.lighting.date",function(t){return e._update(t)}),this._loadDataPromise.then(function(){e._numStars=e._starData.byteLength/e.bytesPerStar;var r=new Float32Array(e._starData,0,e._numStars*e.numBinaryFloats),a=new Uint8Array(e._starData,e._numStars*e.numBinaryFloats*4,e._numStars*e.numBinaryUInt8),n=e._createStarGeometryData(r,a);e._renderer=new f(n,e._vertexBufferLayout,e._fillInterleaved,t.rctx),e._renderer.enablePointRendering(!0),e.needsRender=!0})},e.prototype.uninitializeRenderContext=function(t){this.destroy()},e.prototype.render=function(t){if(t.slot!==this.slot||t.pass!==u.MATERIAL||null==this._starData)return!1;var e=t.rctx,r=e.gl,a=this._program;return e.bindProgram(a),a.setUniformMatrix4fv("view",t.camera.viewMatrix),a.setUniformMatrix4fv("proj",t.camera.projectionMatrix),a.setUniform4fv("viewport",t.camera.fullViewport),a.setUniformMatrix4fv("model",this._renderData.model),e.setDepthTestEnabled(!0),e.setDepthFunction(r.LEQUAL),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),e.setDepthWriteEnabled(!1),this._renderer.render(a),e.setBlendingEnabled(!1),e.setDepthWriteEnabled(!0),e.setDepthFunction(r.LESS),this.needsRender=!1,!0},e.prototype._fillInterleaved=function(t,e,r,a,n,i,s){for(var o=_.getStride(n),l=o/4,d=t.indices[g.POSITION],f=t.vertexAttr[g.POSITION].data,u=s+_.findAttribute(n,"position").offset/4,h=0;h<d.length;++h){var c=3*d[h];m.fill(f,c,i,u,e,3),u+=l}var p=t.indices[g.COLOR],S=t.vertexAttr[g.COLOR].data;u=s+_.findAttribute(n,"color").offset;for(var v=new Uint8Array(i.buffer),h=0;h<p.length;++h){var c=4*p[h];m.fillColor(S,c,v,u,4),u+=o}var b=t.indices[g.SIZE],y=t.vertexAttr[g.SIZE].data;u=s+_.findAttribute(n,"size").offset/4;for(var h=0;h<b.length;++h){var w=y[b[h]];i[u]=w,u+=l}},e.prototype._computeDayDuration=function(t){var e=t,r=new Date(t.getFullYear(),0,1,11,58,56);return(+e-+r)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+r)},e.prototype._update=function(t){if(t){var e=t.getHours()/12,r=t.getMinutes()/60*(2/24),a=t.getSeconds()/60*(2/1440),n=(e+r+a-.9972222)%2,i=2*this._computeDayDuration(t),s=l.mat4d.create(y);l.mat4d.rotateZ(s,-i*Math.PI),l.mat4d.multiply(b,s,s),l.mat4d.rotateZ(s,-n*Math.PI),this._renderData.model=s,this.needsRender=!0}},e.prototype._hexToRGB=function(t){return[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]},e.prototype._unpackUint8Attributes=function(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]},e.prototype._createStarGeometryData=function(t,e){for(var r=new Float32Array(3*this._numStars),a=new Uint8Array(4*this._numStars),n=new Float32Array(this._numStars),i=new Uint32Array(this._numStars),s=0;s<this._numStars;s++){var o=2*s,l=3*s,d=4*s,f=t[o+0],u=t[o+1];r[l+0]=-Math.cos(f)*Math.sin(u),r[l+1]=-Math.sin(f)*Math.sin(u),r[l+2]=-Math.cos(u);var h=this._unpackUint8Attributes(e[s]),c=this._hexToRGB(S[h[1]]);a[d+0]=255*c[0],a[d+1]=255*c[1],a[d+2]=255*c[2],a[d+3]=255,n[s]=h[0],i[s]=s}var m={};m[g.POSITION]=i,m[g.NORMAL]=i,m[g.UV0]=i,m[g.COLOR]=i,m[g.SIZE]=i;var p={};return p[g.POSITION]={size:3,data:r},p[g.COLOR]={size:4,data:a},p[g.SIZE]={size:1,data:n},{id:"stardata",indices:m,vertexAttr:p,preinterleaved:!1}},e.prototype._verifyStartData=function(t){if(!t)throw new n("stars:no-data-received","Failed to create stars because star catalogue is missing");var e=t.byteLength/this.bytesPerStar;if(e%1!=0||e>5e4||e<5e3)throw new n("stars:invalid-data","Failed to create stars because star catalogue data is invalid")},e.prototype._loadBrightStarCatalogue=function(){var e=this;return w?(this._starData=w,s.resolve()):a(t.toUrl("./resources/stars.wsv"),{responseType:"array-buffer"}).then(function(t){var r=t.data;e._verifyStartData(r),w=r,e._starData=r}).catch(function(t){throw t&&"cancel"!==t.dojoType&&v.error("loadBrightStarCatalogue",t.message),t})},e}()});