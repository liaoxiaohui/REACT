// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","dojo/text!./materials/RealisticAtmosphereMaterial.xml","../../../core/Handles","../../../core/promiseUtils","../../../core/watchUtils","./atmosphereUtils","../lib/glMatrix","../support/earthUtils","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/GeometryRenderer","../webgl-engine/lib/GeometryUtil","../webgl-engine/lib/RenderPass","../webgl-engine/lib/RenderSlot","../../webgl/Program"],function(e,t,a,r,i,s,n,h,o,d,l,f,v,u,m,_){var p=o.earthRadius,c=h.vec3d,D=h.vec2d,g=h.vec4d,S=.02*Math.PI,R=.004*Math.PI,C=c.createFrom(1/Math.pow(.65,4),1/Math.pow(.57,4),1/Math.pow(.475,4)),P=c.create(C);c.scale(P,S),c.add(P,c.createFrom(R,R,R));var A=.25,E=.05,w=1/A,b=1/E,U=-.99999,T=(1-U*U)/(2+U*U)*1.5;return function(){function e(e){this.view=null,this.needsRender=!1,this.didRender=!0,this.slot=m.POSTPROCESSING_ATMOSPHERE_OPAQUE,this._hazeSlot=m.POSTPROCESSING_ATMOSPHERE_TRANSPARENT,this._handles=null,this._hazeProgram=null,this._skyProgram=null,this._renderer=null,this._renderData={texDepth:D.create(),v3CameraPos:c.create(),v3CameraUp:c.create(),v3CameraRight:c.create(),v3CameraDir:c.create(),halfSizeNearPlane:D.create(),v2CameraCenterOffset:D.create(),v4SphereComp:g.create(),v4AtmosParams1:g.create(),v4AtmosParams2:g.create(),v4AtmosParams3:g.create(),v3InvWavelength:C,v3InvWavelengthScaled:P,v4Radii:g.create(),fScale:0,fScaleDepth:A,fLowerAlphaBlendBound:0,fScaleOverScaleDepth:0,fOneOverScaleDepth:0,fScaleDepthBlue:E,fOneOverScaleDepthBlue:b,fScaleOverScaleDepthBlue:0,g:U,g2:U*U,fMiePhaseCoefficients:T,showTest:0,nearFar:D.create(),fCameraHeight:0,fCameraHeight2:0,fC:0,fCSur:0,fInnerFadeDistance:0,fAltitudeFade:0},this._lowerElevationBoundRadius=0,this._earthRadius=p,this.view=e,this._updateRadius(p)}return e.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null),this._hazeProgram&&(this._hazeProgram.dispose(),this._hazeProgram=null),this._skyProgram&&(this._skyProgram.dispose(),this._skyProgram=null)},e.prototype.when=function(e){return i.resolve().then(e)},e.prototype.initializeRenderContext=function(e){var t=this,i=[[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1]],n=v.createSquareGeometry(i),h=n.toRenderData(),o=e.rctx;this._renderer=new f(h,l.Pos3Tex,null,o),this._handles=new r,this._handles.add(s.init(this.view,"state.camera",function(e){return t._update(e)},!0)),this._updateElevation({spatialReference:this.view.basemapTerrain.spatialReference,tile:this.view.basemapTerrain.rootTiles[0],extent:this.view.basemapTerrain.rootTiles[0].extent}),this._handles.add(s.on(this.view,"basemapTerrain","elevation-change",function(e){return t._updateElevation(e)},function(){return t._updateElevation()})),this._handles.add(s.on(this.view,"basemapTerrain","elevation-bounds-change",function(){return t._updateVisibleElevationBounds()},function(){return t._updateVisibleElevationBounds()})),e.shaderSnippets.fsRealisticAtmosphere||e.shaderSnippets._parse(a),this._hazeProgram=new _(o,e.shaderSnippets.vsRealisticAtmosphere,e.shaderSnippets.fsRealisticAtmosphere,d.Default3D,["HAZE"]),this._skyProgram=new _(o,e.shaderSnippets.vsRealisticAtmosphere,e.shaderSnippets.fsRealisticAtmosphere,d.Default3D)},e.prototype.uninitializeRenderContext=function(e){this.destroy()},e.prototype.render=function(e){return(e.slot===this._hazeSlot||e.slot===this.slot)&&e.pass===u.MATERIAL&&(e.slot===this.slot&&this._renderSky(e),e.slot===this._hazeSlot&&this._renderHaze(e),this.needsRender=!1,!0)},e.prototype._renderSky=function(e){var t=e.rctx,a=t.gl,r=this._skyProgram;t.bindProgram(r),t.setBlendFunctionSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA),t.setDepthFunction(a.LEQUAL),t.setDepthTestEnabled(!0),r.setUniform4fv("v4AtmosParams3",this._renderData.v4AtmosParams3),this._renderCommon(r,e)},e.prototype._renderHaze=function(e){var t=this,a=e.rctx,r=a.gl,i=e.offscreenRenderingHelper,s=this._hazeProgram;a.bindProgram(s),a.setBlendFunctionSeparate(r.ONE,r.ONE_MINUS_SRC_COLOR,r.ZERO,r.ONE),i.renderDepthDetached(function(){a.setDepthTestEnabled(!1);var r=i.depthTexture;a.bindTexture(r,0),s.setUniform1i("tDepth",0),t._renderCommon(s,e)})},e.prototype._renderCommon=function(e,t){var a=t.rctx,r=a.gl;e.setUniform3fv("v3InvWavelength",this._renderData.v3InvWavelength),e.setUniform3fv("v3InvWavelengthScaled",this._renderData.v3InvWavelengthScaled),e.setUniform3fv("v3LightDir",t.lightingData.direction),e.setUniform4fv("v4SphereComp",this._renderData.v4SphereComp),e.setUniform3fv("v3CameraPos",this._renderData.v3CameraPos),e.setUniform3fv("v3CameraUp",this._renderData.v3CameraUp),e.setUniform3fv("v3CameraRight",this._renderData.v3CameraRight),e.setUniform3fv("v3CameraDir",this._renderData.v3CameraDir),e.setUniform2fv("nearFar",this._renderData.nearFar),e.setUniform2fv("halfSizeNearPlane",this._renderData.halfSizeNearPlane),e.setUniform2fv("v2CameraCenterOffset",this._renderData.v2CameraCenterOffset),e.setUniform4fv("v4Radii",this._renderData.v4Radii),e.setUniform4fv("v4AtmosParams1",this._renderData.v4AtmosParams1),e.setUniform4fv("v4AtmosParams2",this._renderData.v4AtmosParams2),e.setUniform1f("showTest",this._renderData.showTest),e.setUniform1f("fInnerFadeDistance",this._renderData.fInnerFadeDistance),e.setUniform1f("fAltitudeFade",this._renderData.fAltitudeFade),a.setBlendingEnabled(!0),a.setDepthWriteEnabled(!1),this._renderer.render(e),a.setDepthFunction(r.LESS),a.setDepthTestEnabled(!1),a.setDepthWriteEnabled(!0),a.setBlendingEnabled(!1),a.setBlendFunctionSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA)},e.prototype._adjustRadiusForTesselation=function(e){var t=Math.PI/Math.pow(2,4)/16;return e*Math.cos(t)},e.prototype._normalizeRadius=function(e){return e=this._adjustRadiusForTesselation(e),Math.max(p-1e4,Math.min(e,p))},e.prototype._updateElevation=function(e){var t=e?e.tile:this.view.basemapTerrain.rootTiles[0];if(0===t.lij[0]){var a=this._adjustRadiusForTesselation(p+t.elevationBounds[0]);a!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=a,this._earthRadius=-1,this._updateVisibleElevationBounds())}},e.prototype._updateVisibleElevationBounds=function(){var e=this._adjustRadiusForTesselation(p+this.view.basemapTerrain.getElevationBounds()[0]);return(this._earthRadius<0||e<this._earthRadius)&&this._updateRadius(e)},e.prototype._updateRadius=function(e){this._earthRadius=e;var t=e,a=t*t,r=t/10*10.25,i=r*r,s=1/(r-t),h=s/A,o=s/E,d=.3*(r-t)+t,l=1/(r-d),f=this._renderData;g.set4(s,A,h,w,f.v4AtmosParams1),g.set4(U,E,o,b,f.v4AtmosParams2),g.set4(U*U,T,d,l,f.v4AtmosParams3),g.set4(t,a,r,i,f.v4Radii),f.fScale=s,f.fLowerAlphaBlendBound=d,f.fScaleOverScaleDepth=h,f.fScaleOverScaleDepthBlue=o;var v=n.INNER_ATMOSPHERE_DEPTH;return f.fInnerFadeDistance=2*Math.sqrt((2*e-v)*v),this._update(),!0},e.prototype._update=function(e){if(void 0===e&&(e=this.view.get("state.camera")),e){c.negate(e.viewForward,this._renderData.v3CameraDir),c.set(e.viewUp,this._renderData.v3CameraUp),c.set(e.viewRight,this._renderData.v3CameraRight),this._renderData.fCameraHeight=c.length(e.eye),this._renderData.fCameraHeight2=this._renderData.fCameraHeight*this._renderData.fCameraHeight,this._renderData.fC=this._renderData.fCameraHeight2-this._renderData.v4Radii[3],this._renderData.fCSur=this._renderData.fCameraHeight2-this._renderData.v4Radii[1],this._renderData.v4SphereComp=g.createFrom(this._renderData.fCameraHeight,this._renderData.fCameraHeight2,this._renderData.fC,this._renderData.fCSur),c.set(e.eye,this._renderData.v3CameraPos),D.set2(Math.tan(e.fovX/2)/(e.width/e.fullWidth),Math.tan(e.fovY/2)/(e.height/e.fullHeight),this._renderData.halfSizeNearPlane);var t=(e.padding[3]+e.width/2)/e.fullWidth,a=(e.padding[2]+e.height/2)/e.fullHeight;D.set2(t-.5,a-.5,this._renderData.v2CameraCenterOffset),D.set2(e.near,e.far,this._renderData.nearFar),this._renderData.fAltitudeFade=n.computeInnerAltitudeFade(this._renderData.fCameraHeight-this._earthRadius)}},e.isSupported=function(e){return e.rctx.capabilities.depthTexture},e}()});