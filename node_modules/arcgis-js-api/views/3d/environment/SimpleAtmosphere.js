// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","dojo/text!./materials/SimpleAtmosphereMaterial.xml","../../../core/watchUtils","./atmosphereUtils","./resources/SimpleAtmosphereTexture","../lib/glMatrix","../support/earthUtils","../support/imageUtils","../support/mathUtils","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/GeometryRenderer","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/RenderPass","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/Util","../../webgl/Program","../../webgl/Texture","../../webgl/Util"],function(e,t,r,i,a,n,s,d,l,o,h,c,u,p,m,_,f,g,v){function A(e,t,r,i,a){var n=s.vec3d.length(e),d=Math.sqrt(n*n-i*i),l=i*d/n,o=Math.sqrt(i*i-l*l),h=a.silCircleV1,c=a.silCircleV2;return s.vec3d.scale(e,o/n,a.silCircleCenter),s.vec3d.cross(e,t,h),s.vec3d.length2(h)<1&&s.vec3d.cross(e,r,h),s.vec3d.scale(h,l/s.vec3d.length(h)),s.vec3d.cross(h,e,c),s.vec3d.scale(c,l/s.vec3d.length(c)),l}function x(e,t,r,i){return s.vec3d.add(i.silCircleCenter,i.silCircleV2,y),s.vec3d.scale(y,P,O),s.mat4d.lookAt(t,y,r,U),_.project(y,U,e.projectionMatrix,e.viewport),_.project(O,U,e.projectionMatrix,e.viewport),s.vec3d.dist(y,O)/e.height}function D(e,t,r){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-r*r)+t*r)}var C=-a.INNER_ATMOSPHERE_DEPTH,S=(d.earthRadius+C)/d.earthRadius,b=(d.earthRadius+0)/d.earthRadius,P=(d.earthRadius+3e5)/d.earthRadius,w=function(e){return 1-511/512},R=o.makePiecewiseLinearFunction([[50,.1015625],[500,.21875],[5e3,.51171875],[5e4,.4140625]]),V=function(){function e(e){this.view=null,this.needsRender=!1,this.didRender=!0,this.slot=m.POSTPROCESSING_ATMOSPHERE_OPAQUE,this._renderData={texV:s.vec2d.create(),silCircleCenter:s.vec3d.create(),silCircleV1:s.vec3d.create(),silCircleV2:s.vec3d.create(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._renderer=null,this._program=null,this._texture=null,this._fadeProgram=null,this._fadeVAOCount=0,this._cameraChangeHandle=null,this.view=e}return e.prototype.when=function(e){return this._readyPromise.then(e)},e.prototype.initializeRenderContext=function(e){var t=this,a=this._createRibbonGeometryData();this._renderer=new c(a,[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],null,e.rctx),this._cameraChangeHandle=i.init(this.view,"state.camera",function(e){return t._update(e)},!0),e.shaderSnippets.vsSimpleAtmosphere||e.shaderSnippets._parse(r),this._program=new f(e.rctx,e.shaderSnippets.vsSimpleAtmosphere,e.shaderSnippets.fsSimpleAtmosphere,h.Default3D),this._fadeProgram=new f(e.rctx,e.shaderSnippets.vsSimpleAtmosphereFade,e.shaderSnippets.fsSimpleAtmosphereFade,h.Default3D),this._fadeVAO=u.createQuadVAO(e.rctx),this._fadeVAOCount=v.vertexCount(this._fadeVAO,"geometry"),this._readyPromise=l.requestImage(n).then(function(r){t._texture=new g(e.rctx,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},r),t.needsRender=!0})},e.prototype.uninitializeRenderContext=function(e){this.destroy()},e.prototype.destroy=function(){this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null),this._texture&&(this._texture.dispose(),this._texture=null),this._program&&(this._program.dispose(),this._program=null),this._fadeProgram&&(this._fadeProgram.dispose(),this._fadeProgram=null),this._fadeVAO&&(this._fadeVAO.dispose(),this._fadeVAO=null)},e.prototype.render=function(e){if(e.slot!==this.slot||e.pass!==p.MATERIAL)return!1;if(null==this._texture)return!1;var t=e.rctx,r=t.gl,i=this._program;return t.setDepthTestEnabled(!0),t.setDepthFunction(r.LEQUAL),t.setBlendingEnabled(!0),t.setDepthWriteEnabled(!1),t.setBlendFunctionSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),this._renderData.undergroundFadeAlpha<1&&(t.bindProgram(i),i.setUniformMatrix4fv("proj",e.camera.projectionMatrix),i.setUniformMatrix4fv("view",e.camera.viewMatrix),i.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),i.setUniform3fv("silCircleV1",this._renderData.silCircleV1),i.setUniform3fv("silCircleV2",this._renderData.silCircleV2),i.setUniform2fv("texV",this._renderData.texV),t.bindTexture(this._texture,0),i.setUniform1i("tex",0),i.setUniform3fv("lightDirection",e.lightingData.direction),i.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.setUniform1f("innerScale",this._renderData.innerScale),this._renderer.render(i)),this._renderData.undergroundFadeAlpha>0&&(t.bindProgram(this._fadeProgram),this._fadeProgram.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),this._fadeProgram.setUniform3fv("lightDirection",e.lightingData.direction),this._fadeProgram.setUniform3fv("cameraPosition",e.camera.eye),t.bindVAO(this._fadeVAO),t.drawArrays(5,0,this._fadeVAOCount)),t.setBlendingEnabled(!1),t.setDepthWriteEnabled(!0),t.setDepthFunction(r.LESS),this.needsRender=!1,!0},e.prototype._update=function(e){var t=s.vec3d.create(),r=d.earthRadius,i=s.vec3d.length(e.eye),n=i-r;if(n<0){var l=Math.min(-n/5e3,1);this._renderData.undergroundFadeAlpha=l}else this._renderData.undergroundFadeAlpha=0;var o=Math.max(50,n),h=r+C;this._renderData.innerScale=D(r+o,r,h)-1,this._renderData.altitudeFade=a.computeInnerAltitudeFade(n),s.vec3d.scale(e.eye,(r+50)/i,t),A(t,e.center,e.up,r,this._renderData);var c=x(e,t,e.up,this._renderData),u=w(),p=R(n),m=0+1*u,f=0+c*p*1;if(n>50){A(e.eye,e.center,e.up,r,this._renderData);var g=x(e,e.eye,e.up,this._renderData),v=_.clamp((g-1.5)/(c-1.5),0,1);m=0+v*u*1,f=0+1*_.lerp(1,c*p,v)}s.vec2d.set2(m,f,this._renderData.texV),this.needsRender=!0},e.prototype._createRibbonGeometryData=function(){var e=new Float32Array(1155),t=new Uint32Array(1920);e[0]=0,e[1]=0,e[2]=-1;for(var r=0;r<128;r++){var i=9*r+3;e[i+0]=r,e[i+1]=S,e[i+2]=-1,e[i+3]=r,e[i+4]=b,e[i+5]=0,e[i+6]=r,e[i+7]=P,e[i+8]=1;var a=3*r+1,n=127===r?1:a+3,s=15*r;t[s+0]=a,t[s+1]=a+1,t[s+2]=n+1,t[s+3]=n+1,t[s+4]=n,t[s+5]=a,t[s+6]=a+1,t[s+7]=a+2,t[s+8]=n+2,t[s+9]=n+2,t[s+10]=n+1,t[s+11]=a+1,t[s+12]=a,t[s+13]=n,t[s+14]=0}var d={};d[_.VertexAttrConstants.POSITION]=t;var l={};return l[_.VertexAttrConstants.POSITION]={size:3,data:e},{id:"simpleatmosphereribbon",indices:d,vertexAttr:l,preinterleaved:!1}},e}(),U=s.mat4d.create(),y=s.vec3d.create(),O=s.vec3d.create();return V});