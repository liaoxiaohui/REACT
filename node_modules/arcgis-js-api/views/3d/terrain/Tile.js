// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../core/arrayUtils","../../../geometry/support/aaBoundingRect","../lib/glMatrix","../support/mathUtils","./ElevationData","./ElevationTileAgent","./MapTileAgent","./TerrainConst","./terrainUtils","./TileAgent","./TilePerLayerInfo","./tileUtils","../../vectorTiles/VectorTileDisplayObject","../../webgl/Texture"],function(e,t,i,n,a,r,s,l,o,d,h,p,u,g,c,v){function f(e){return e===d.LayerClass.ELEVATION?l.Pool.acquire():o.Pool.acquire()}function y(e){e instanceof l?l.Pool.release(e):e instanceof o&&o.Pool.release(e)}var A=h.weakAssert,m=a.vec3d.create(),E=a.vec4d.create(),L=a.vec4d.create(),T=a.vec3d.create(),I=p.AGENT_DONE,U=d.LayerClass.LAYER_CLASS_COUNT,D=d.LayerClass.MAP,S=d.LayerClass.ELEVATION,_=d.TileUpdateTypes;return function(){function e(e){this.lij=[0,0,0],this.extent=n.create(),this.elevationBounds=a.vec2d.create(),this.children=[null,null,null,null],this.layerInfo=new Array(U),this.extentWGS84Rad=n.create(),this.centerAtSeaLevel=a.vec3d.create(),this.center=a.vec3d.create(),this.tileUp=T,this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this._maxTesselation=0,this.screenDepth=0,this.renderOrder=0,this.edgeLen=0,this.radius=0,this._memoryUsed=0,this.numSubdivisionsAtLevel=e}return Object.defineProperty(e.prototype,"memoryUsed",{get:function(){return this._memoryUsed},enumerable:!0,configurable:!0}),e.prototype.init=function(e,t,i,n){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],n.getExtent(e[0],e[1],e[2],this.extent,this.extentWGS84Rad),this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this.edgeLen=0,this.radius=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?a.vec2d.set(t.elevationBounds,this.elevationBounds):a.vec2d.set2(0,0,this.elevationBounds),this.parent=t;for(var r=0;r<4;r++)this.children[r]=null;this.pendingUpdates=0,this.renderData=null,this.screenDepth=0,this.visible=!1,this.parentSurface=i;for(var s=0;s<U;s++)if(i){var l=i.numLayers(s),o=void 0;this.layerInfo[s]?(o=this.layerInfo[s],o.length=l):(o=new Array(l),this.layerInfo[s]=o);for(var h=0;h<l;h++)o[h]=u.makeEmptyLayerInfo(s,o[h]),s===S&&this.findElevationBoundsForLayer(h,-1)}else this.layerInfo[s]=null;this.computeElevationBounds(),this._maxTesselation=Math.min(n.pixelSize[0],d.MAX_TILE_TESSELATION)},e.prototype.dispose=function(){for(var e=0;e<U;e++)for(var t=this.layerInfo[e],i=0;i<t.length;i++)t[i].dispose();this.updateMemoryUsed()},e.prototype.updateMemoryUsed=function(){var e=this.parentSurface.tilingScheme.pixelSize,t=e[0]*e[1]*4;this._memoryUsed=0;for(var i=0,n=this.layerInfo[d.LayerClass.MAP];i<n.length;i++){var a=n[i],r=a.data;r instanceof v?this._memoryUsed+=1.3*r.descriptor.width*r.descriptor.height*4:r instanceof HTMLImageElement?this._memoryUsed+=t:r instanceof c&&(this._memoryUsed+=r.getGpuMemoryUsage()+r.getCpuMemoryUsage())}for(var s=0,l=this.layerInfo[d.LayerClass.ELEVATION];s<l.length;s++){var a=l[s];this._memoryUsed+=a.data?t:0}if(this.renderData){this._memoryUsed+=this.renderData.estimateGeometryMemoryUsage();var o=this.renderData.texture?this.renderData.texture.descriptor:null;o&&(this._memoryUsed+=1.3*o.width*o.height*4)}},e.prototype.updateScreenDepth=function(e){a.vec3d.set(this.center,L),L[3]=1,a.mat4d.multiplyVec4(e,L,L),this.screenDepth=L[2]/L[3]},e.prototype.shouldSplit=function(e,t){var i=this.lij[0];a.vec3d.subtract(this.center,t,m);var n=a.vec3d.length(m),s=e[0],l=e[2],o=s*n*2,d=l*n*2,h=this.edgeLen/o,p=this.edgeLen/d,u=e[1],g=e[3],c=e[4],v=e[5];if(n<this.edgeLen&&i<c)return _.SPLIT;if(h<u)return this.vlevel!==this.lij[0]?(this.vlevel=this.lij[0],_.VSPLITMERGE):_.NONE;if(i>=c){var f=i+Math.ceil(-r.log2(u/h));return f!==this.vlevel?(this.vlevel=f,_.VSPLITMERGE):_.NONE}if(i>6&&(a.vec3d.scale(this.tileUp,a.vec3d.dot(this.tileUp,m),E),a.vec3d.subtract(E,m),a.vec3d.length2(E)>this.radius*this.radius)){a.vec3d.scale(E,this.radius/a.vec3d.length(E)),a.vec3d.add(E,this.center),a.vec3d.subtract(t,E,E);var y=this.elevationBounds[1]-this.elevationBounds[0];if(Math.min(1,(Math.abs(a.vec3d.dot(E,this.tileUp))+.5*y+this.curvatureHeight)/a.vec3d.length(E))*p<.1/v*g)return _.NONE}return _.SPLIT},e.prototype.decodeElevationData=function(e){var t;if(e instanceof ArrayBuffer)try{t=s.createFromLERC(this.lij,this.extent,e,d.noDataValueOpt)}catch(e){console.warn("Error decoding raw data: %s",e.message)}else t=s.createFromFetchTileResult(this.lij,this.extent,e);return t},e.prototype.getWGS84Extent=function(){var e=this.extentWGS84Rad;return n.fromValues(r.rad2deg(e[0]),r.rad2deg(e[1]),r.rad2deg(e[2]),r.rad2deg(e[3]))},e.prototype.load=function(e){for(var t=0;t<U;t++)this.layerInfo[t]&&this._createOrUpdateAgents(0,t);e.loadTile(this)},e.prototype.unload=function(e){this.renderData&&e.unloadTile(this);for(var t=0;t<U;t++)for(var i=this.layerInfo[t],n=0;n<i.length;n++){var a=i[n];a.loadingAgent&&a.loadingAgent!==I&&(a.loadingAgent.dispose(),y(a.loadingAgent),a.loadingAgent=null),a.pendingUpdates=0}this.pendingUpdates&=~d.TileUpdateTypes.UPDATE_GEOMETRY,this.pendingUpdates&=~d.TileUpdateTypes.UPDATE_TEXTURE},e.prototype.updateClippingStatus=function(e){if(i.equals(e,this.clippingArea))return!1;var t=this.intersectsClippingArea,n=this.isWithinClippingArea;e?(this.intersectsClippingArea=this.intersectsExtent(e),this.isWithinClippingArea=this.isWithinExtent(e)):(this.intersectsClippingArea=!0,this.isWithinClippingArea=!0),this.clippingArea=e;var a=n&&this.isWithinClippingArea,r=!(n||t||this.isWithinClippingArea||this.intersectsClippingArea);return!this.renderData||a||r||this.updateGeometry(),!0},e.prototype.updateVisibility=function(e){var t=this.isVisible(e)&&this.intersectsClippingArea;if(t!==this.visible){this.visible=t;for(var i=this.layerInfo[0],n=0;n<i.length;n++){var a=i[n];a.loadingAgent&&a.loadingAgent!==I&&a.loadingAgent.setSuspension(!t)}}return t},e.prototype.getLayerInfo=function(e,t){return this.layerInfo[t][e]},e.prototype.hasLayerData=function(e,t){var i=this.layerInfo[t][e];return i&&i.data&&!i.dataInvalidated},e.prototype.tileDataAvailable=function(e,t,i){var n=this.layerInfo[i][t].tilemap;return!n||"unavailable"!==n.getAvailability(e.lij[1],e.lij[2])},e.prototype.requestLayerData=function(e,t,i){d.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),t,e,i.tile.lij.toString());var n=this.layerInfo[t][e];if(n.waitingAgents.indexOf(i)>-1)return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(n.data&&!n.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),n.waitingAgents.push(i),setTimeout(i.dataArrived.bind(i,this),0),!0;if(n.pendingUpdates&_.DECODE_ELEVATION)return n.waitingAgents.push(i),!0;if(n.waitingAgents.push(i),n.requestPromise)return!0;var a=this.parentSurface.requestTileData(this,e,t);if(a.isFulfilled())return!1;var r=function(){n.requestPromise===a&&(n.requestPromise=null)};return n.requestPromise=a,a.then(r,r),!!a},e.prototype.descendants=function(e){e||(e=[]);for(var t=0;t<4;t++){var i=this.children[t];i&&(i.descendants(e),e.unshift(this.children[t]))}return e},e.prototype.isLij=function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]},e.prototype.findByLij=function(e){if(this.isLij(e))return this;for(var t=0;t<4;t++){var i=this.children[t];if(i){var n=i.findByLij(e);if(n)return n}}return null},e.prototype.unrequestLayerData=function(e,t,n){d.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),t,e,n.tile.lij.toString());var a=this.layerInfo[t][e],r=a.waitingAgents,s=null!=i.removeUnordered(r,n);if(A(s,"agent has not requested this piece of map data"),r.length<1){var l=a.requestPromise,o=!1;if(t===D){var p=this.parentSurface.layerViewByIndex(e,D);o=h.isVectorTileLayerView(p)}o||A(l||a.rawData,"no pending operations on layerInfo that agents were waiting for"),l&&!l.isFulfilled()&&(l.cancel(),a.requestPromise=null),d.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),t,e),this.updateMemoryUsed()}},e.prototype.dataArrived=function(e,t,i){var n=this.layerInfo[t][e];n.data=i,n.dataInvalidated=!1;for(var a=0;a<n.waitingAgents.length;a++)n.waitingAgents[a].dataArrived(this);n.waitingAgents.length=0,this.updateMemoryUsed()},e.prototype.dataMissing=function(e,t,i){i.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),t,e);var n=this.layerInfo[t][e];n.dataMissing=!0;for(var a=0;a<n.waitingAgents.length;a++)n.waitingAgents[a].dataMissing(this);n.waitingAgents.length=0,this.updateMemoryUsed()},e.prototype.updateTexture=function(e){void 0===e&&(e=!1),this.renderData&&(e?this.parentSurface.renderer.updateTileTexture(this):(this.pendingUpdates=this.pendingUpdates|d.TileUpdateTypes.UPDATE_TEXTURE,this.parentSurface.setPendingUpdates()))},e.prototype.invalidateLayerData=function(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)},e.prototype.computeElevationBounds=function(){a.vec2d.set2(Number.MAX_VALUE,-Number.MAX_VALUE,this.elevationBounds);for(var e=this.layerInfo[S],t=!1,i=0;i<e.length;i++){var n=e[i];n.elevationBounds&&(this.elevationBounds[0]=Math.min(this.elevationBounds[0],n.elevationBounds[0]),this.elevationBounds[1]=Math.max(this.elevationBounds[1],n.elevationBounds[1]),t=!0)}t||a.vec2d.set2(0,0,this.elevationBounds),this.updateRadiusAndCenter()},e.prototype.updateRadiusAndCenter=function(){var e=.5*(this.elevationBounds[0]+this.elevationBounds[1]);a.vec3d.scale(this.tileUp,e,E),a.vec3d.add(this.centerAtSeaLevel,E,this.center)},e.prototype.findElevationBoundsForLayer=function(e,t){var i=this.layerInfo[S][e];if(!i.elevationBounds||i.elevationBounds[2]<t){var n=this.parentSurface.layerViewByIndex(e,S);if(g.fallsWithinLayer(this,n.layer,!1)){var r=E,s=!1;if(i.data){var l=i.data;a.vec2d.set(l.bounds,r),r[2]=this.lij[0],s=!0}else{for(var o=this.parent,h=0,p=null,l=i.data;o&&(!l||h<d.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&(h=this.vlevel-o.lij[0],p=l||p,!(!(l=o.layerInfo[S][e].data)&&p&&h>=d.ELEVATION_DESIRED_RESOLUTION_LEVEL));)o=o.parent;l=l||p,l&&(l.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],r),r[0]!==1/0&&(r[2]=l.level,s=!0))}s&&(i.elevationBounds?a.vec3d.set(r,i.elevationBounds):i.elevationBounds=[r[0],r[1],r[2]])}}},e.prototype.updateGeometry=function(){this.pendingUpdates=this.pendingUpdates|d.TileUpdateTypes.UPDATE_GEOMETRY,this.parentSurface.setPendingUpdates()},e.prototype.modifyLayers=function(e,t,i){for(var n=t.length,a=this.layerInfo[i],r=new Array(n),s=0;s<a.length;s++){var l=a[s];l.loadingAgent&&l.loadingAgent!==I&&(l.loadingAgent.dispose(),y(l.loadingAgent),l.loadingAgent=null),l.waitingAgents.length=0}if(i===D)for(var s=0;s<a.length;++s)void 0===e[s]&&(a[s].dispose(),this.updateMemoryUsed());for(var s=0;s<n;s++){var o=t[s];r[s]=o>-1?a[o]:u.makeEmptyLayerInfo(i)}this.layerInfo[i]=r,this.updateMemoryUsed()},e.prototype.restartAgents=function(e){if(this.renderData)if(this._createOrUpdateAgents(0,e),e===S){this.updateGeometry();for(var t=this.layerInfo[e],i=0;i<t.length;i++)t[i].pendingUpdates|=d.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface.setPendingUpdates()}else this.updateTexture(!0)},e.prototype.updateAgents=function(e){if(this.renderData){for(var t=this.layerInfo[e],i=0;i<t.length;i++){var n=t[i];n.loadingAgent===I&&(n.loadingAgent=null)}this._createOrUpdateAgents(0,e)}},e.prototype.removeLayerAgent=function(e,t){var i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==I&&i.loadingAgent.dispose(),i.loadingAgent=null},e.prototype.agentDone=function(e,t){var i=this.layerInfo[t],n=i[e];n.loadingAgent=I,n.data||n.upsampleFromTile||e<i.length-1&&this._createOrUpdateAgents(e+1,t)},e.prototype._createOrUpdateAgents=function(e,t){var i;i=t!==S&&!this.visible;for(var n=e,a=this.layerInfo[t];n<a.length;){var r=a[n],s=!1,l=this.parentSurface.layerViewByIndex(n,t);if(null!==r.loadingAgent&&r.loadingAgent!==I)s=r.loadingAgent.update();else if(r.loadingAgent!==I&&g.fallsWithinLayer(this,l.layer,!1)){var o=f(t);s=o.init(this,n,t,i),s?r.loadingAgent=o:(o.dispose(),y(o),r.loadingAgent=I)}if(s&&l.isOpaque)break;n++}},e.prototype.geometryState=function(e){var t,n,a,s=this._getElevationInfo(e?e.samplerData:null),l=this.lij[0],o=!1;if(s.samplerData){t=this.vlevel-l,n=Math.max(l-s.maxTileLevel,d.ELEVATION_DESIRED_RESOLUTION_LEVEL-t);var h=this._maxTesselation;a=r.clamp(1+(h>>n),2,h+1)}else a=l<8?this.numSubdivisionsAtLevel[l]+1:2;var p=this.clippingArea;return this.intersectsClippingArea&&!this.isWithinClippingArea||(p=null),e?(e.numVertsPerRow!==a&&(e.numVertsPerRow=a,o=!0),s.changed&&(e.samplerData=s.samplerData,o=!0),i.equals(e.clippingArea,p)||(e.clippingArea=p,o=!0),e.needsUpdate=o):e={numVertsPerRow:a,samplerData:s.samplerData,needsUpdate:!0,clippingArea:p},e},e.prototype._getElevationInfo=function(e){for(var t=this.layerInfo[S],i=t.length,n=new Array(i),a=0,r=0,s=!1,l=0;l<i;l++){var o=t[l];if(o.upsampleFromTile){var d=o.upsampleFromTile.tile,h=d.layerInfo[S][l].data;e&&e[a]===h.samplerData||(s=!0),n[a++]=h.samplerData,r=Math.max(r,d.lij[0])}else if(o.data){var p=this.parentSurface.layerViewByIndex(l,S);if(g.fallsWithinLayer(this,p.layer,!1)){var h=o.data;e&&e[a]===h.samplerData||(s=!0),n[a++]=h.samplerData,r=this.lij[0]}}}return e&&e.length!==a&&(s=!0),a>0?n.length=a:n=null,{changed:s,samplerData:n,maxTileLevel:r}},e.prototype.isWithinExtent=function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]},e.prototype.intersectsExtent=function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]},e}()});