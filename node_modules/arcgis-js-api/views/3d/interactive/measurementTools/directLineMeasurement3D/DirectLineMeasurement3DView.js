// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/Handles","../../../../../core/StackedObjectPool","./LaserLineRenderer","../support/Label","../support/LabelSegment","../support/labelUtils","../support/PathSegmentInterpolator","../support/viewUtils","../../../lib/glMatrix","../../../support/mathUtils","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryData","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Layer","../../../webgl-engine/lib/Object3D","../../../webgl-engine/lib/Selector","../../../webgl-engine/materials/ColorMaterial","../../../webgl-engine/materials/DefaultMaterial","../../../webgl-engine/materials/MeasurementArrowMaterial","../../../webgl-engine/materials/RibbonLineMaterial","../../../webgl-engine/parts/Model"],function(e,t,i,r,n,o,s,a,l,d,c,h,_,u,p,g,m,b,v,L,w,P,y,f,j){var O,C=new o(function(){return _.vec3d.create()}),T=[1,.5,0,.75],G={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,handleRadiusHovered:10,handleRadiusMouse:10,handleRadiusTouch:25,triangleColor:T,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:T,guideLineWidth:2,guideLineColor:T,guideStippleLengthPixels:6,labelDistance:25};!function(e){e[e.Small=12]="Small",e[e.Large=16]="Large"}(O||(O={}));var A=function(){function e(e,t,i){void 0===i&&(i={}),this._visible=!1,this._laserLineRenderer=null,this._handleGeometry=new p(m.createSphereGeometry(1,32,32),"handle"),this._directDistanceLabel=new a,this._horizontalDistanceLabel=new a,this._verticalDistanceLabel=new a,this._listenerHandles=null,this._cursorPosition=_.vec3d.create(),this._startPosition=_.vec3d.create(),this._endPosition=_.vec3d.create(),this._centerPosition=_.vec3d.create(),this._cornerPosition=_.vec3d.create(),this._arrowLabelSegment=new l,this._horizontalLabelSegment=new l,this._verticalLabelSegment=new l,this._geodesicProjectionLabelSegment=new l,this._origin=_.vec3d.create(),this._originTransform=_.mat4d.create(),this._tempMat4=_.mat4d.create(),this._model=e,this._sceneView=t,this._params=h.copyParameter(G,i),this._layer=new b("point-to-point-measurement",{},"point-to-point-measurement"),this._createMaterials(),this._createObjects(),this._selector=new L(this._sceneView.viewingMode)}return e.prototype.destroy=function(){this.hide()},Object.defineProperty(e.prototype,"requiresCursorPoint",{get:function(){return"initial"===this._model.state},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cameraAboveGround",{get:function(){return this._sceneView.state.camera.aboveGround},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"visible",{get:function(){return this._visible},set:function(e){e?this.show():this.hide()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"testData",{get:function(){return{labels:{direct:this._directDistanceLabel,horizontal:this._horizontalDistanceLabel,vertical:this._verticalDistanceLabel},laserLineRenderer:this._laserLineRenderer}},enumerable:!0,configurable:!0}),e.prototype.show=function(){if(!this._visible){this._visible=!0;var e=this._sceneView._stage,t={glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,globalAlpha:this._params.laserLineGlobalAlpha};this._laserLineRenderer=new s(this._sceneView.renderCoordsHelper,t),e.addExternalRenderer(this._laserLineRenderer.renderSlots,this._laserLineRenderer),this._addToStage(e),this._directDistanceLabel.addToView(this._sceneView),this._horizontalDistanceLabel.addToView(this._sceneView),this._verticalDistanceLabel.addToView(this._sceneView),this._initializeListeners(),this._updateCursorPosition(),this._updateStartPosition(),this._updateEndPosition(),this._updateMouseCursor(),this._updateView()}},e.prototype.hide=function(){if(this._visible){this._visible=!1;var e=this._sceneView._stage;e.removeExternalRenderer(this._laserLineRenderer),this._laserLineRenderer=null,this._removeFromStage(e),this._directDistanceLabel.removeFromView(this._sceneView),this._horizontalDistanceLabel.removeFromView(this._sceneView),this._verticalDistanceLabel.removeFromView(this._sceneView),this._destroyListeners(),this._sceneView.cursor=null}},e.prototype.handleAt=function(e,t){var i=e.toArray(),r="touch"===t?this._params.handleRadiusTouch:this._params.handleRadiusMouse;return this._model.endPoint&&h.pointToScreenPositionDistance(this._model.endPoint,i,this._sceneView)<r?"end":this._model.startPoint&&h.pointToScreenPositionDistance(this._model.startPoint,i,this._sceneView)<r?"start":null},e.prototype.pick=function(t){for(var i=[],r=this._sceneView._stage,n=r.getViewContent(),o=this._sceneView._stage.getAll(j.ContentType.LAYER),s=0,a=n;s<a.length;s++){var l=a[s],d=o[l];d&&d!==this._layer&&d.isPickable&&i.push(d.id)}var c=this._sceneView.spatialReference,h=[t.screenPoint.x,this._sceneView.height-t.screenPoint.y],u=this._sceneView._stage.pick(h,i,!0,this._selector),p=u.getMinResult(),g=_.vec3d.create();if(this._sceneView.basemapTerrain.isSeeThrough()&&!p.getIntersectionPoint(g)&&(u=this._sceneView._stage.pick(h,[],!1,this._selector),p=u.getMinResult()),!p.getIntersectionPoint(g))return new e.PickResult;var m=this._sceneView.renderCoordsHelper.fromRenderCoords(g,c),b="TerrainRenderer"===p.intersector?"surface":"feature";return new e.PickResult(b,g,m)},e.prototype.getElevation=function(e){return this._sceneView.basemapTerrain.ready?this._sceneView.basemapTerrain.getElevation(e)||0:0},e.prototype.overlappingHandles=function(e,t){return h.pointToPointScreenDistance(e,t,this._sceneView)<=this._params.handleRadius},e.prototype._createMaterials=function(){this._handleMaterial=new P({diffuse:this._params.handleColor,transparent:1!==this._params.handleOpacity,opacity:this._params.handleOpacity,castShadows:!1},"handle"),this._handleMaterial.renderOccluded=!0,this._triangleLineMaterial=new f({width:this._params.triangleLineWidth,color:this._params.triangleColor,polygonOffset:!0},"triangle-line"),this._triangleLineMaterial.renderOccluded=!0,this._triangleCornerMaterial=new w({color:this._params.triangleColor,transparent:!0,polygonOffset:!0},"triangle-corner"),this._triangleCornerMaterial.renderOccluded=!0,this._arrowMaterial=new y({outlineColor:this._params.arrowOutlineColor,stripeEvenColor:this._params.arrowStripeEvenColor,stripeOddColor:this._params.arrowStripeOddColor,polygonOffset:!0},"arrow"),this._arrowMaterial.renderOccluded=!0,this._geodesicProjectionLineMaterial=new f({width:this._params.geodesicProjectionLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0},"geodesic-line"),this._geodesicProjectionLineMaterial.renderOccluded=!0,this._geodesicGuideLineMaterial=new f({width:this._params.guideLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0,stippleLength:0},"geodesic-guide"),this._geodesicGuideLineMaterial.renderOccluded=!0},e.prototype._createObjects=function(){this._startHandleObject=new v,this._startHandleObject.addGeometry(this._handleGeometry,[this._handleMaterial],_.mat4d.identity()),this._layer.addObject(this._startHandleObject),this._endHandleObject=new v,this._endHandleObject.addGeometry(this._handleGeometry,[this._handleMaterial],_.mat4d.identity()),this._layer.addObject(this._endHandleObject),this._triangleLineObject=new v,this._layer.addObject(this._triangleLineObject),this._triangleCornerObject=new v,this._layer.addObject(this._triangleCornerObject),this._arrowObject=new v,this._layer.addObject(this._arrowObject),this._geodesicProjectionLineObject=new v,this._layer.addObject(this._geodesicProjectionLineObject),this._geodesicProjectionStartGuideObject=new v,this._layer.addObject(this._geodesicProjectionStartGuideObject),this._geodesicProjectionEndGuideObject=new v,this._layer.addObject(this._geodesicProjectionEndGuideObject)},e.prototype._addToStage=function(e){e.add(j.ContentType.LAYER,this._layer),e.add(j.ContentType.MATERIAL,this._handleMaterial),e.add(j.ContentType.MATERIAL,this._triangleLineMaterial),e.add(j.ContentType.MATERIAL,this._triangleCornerMaterial),e.add(j.ContentType.MATERIAL,this._arrowMaterial),e.add(j.ContentType.MATERIAL,this._geodesicProjectionLineMaterial),e.add(j.ContentType.MATERIAL,this._geodesicGuideLineMaterial),e.add(j.ContentType.OBJECT,this._startHandleObject),e.add(j.ContentType.OBJECT,this._endHandleObject),e.add(j.ContentType.OBJECT,this._triangleLineObject),e.add(j.ContentType.OBJECT,this._triangleCornerObject),e.add(j.ContentType.OBJECT,this._arrowObject),e.add(j.ContentType.OBJECT,this._geodesicProjectionLineObject),e.add(j.ContentType.OBJECT,this._geodesicProjectionStartGuideObject),e.add(j.ContentType.OBJECT,this._geodesicProjectionEndGuideObject),e.addToViewContent([this._layer.id])},e.prototype._removeFromStage=function(e){e.removeFromViewContent([this._layer.id]),e.remove(j.ContentType.LAYER,this._layer.id),e.remove(j.ContentType.MATERIAL,this._handleMaterial.id),e.remove(j.ContentType.MATERIAL,this._triangleLineMaterial.id),e.remove(j.ContentType.MATERIAL,this._triangleCornerMaterial.id),e.remove(j.ContentType.MATERIAL,this._arrowMaterial.id),e.remove(j.ContentType.MATERIAL,this._geodesicProjectionLineMaterial.id),e.remove(j.ContentType.MATERIAL,this._geodesicGuideLineMaterial.id),e.remove(j.ContentType.OBJECT,this._startHandleObject.id),e.remove(j.ContentType.OBJECT,this._endHandleObject.id),e.remove(j.ContentType.OBJECT,this._triangleLineObject.id),e.remove(j.ContentType.OBJECT,this._triangleCornerObject.id),e.remove(j.ContentType.OBJECT,this._arrowObject.id),e.remove(j.ContentType.OBJECT,this._geodesicProjectionLineObject.id),e.remove(j.ContentType.OBJECT,this._geodesicProjectionStartGuideObject.id),e.remove(j.ContentType.OBJECT,this._geodesicProjectionEndGuideObject.id)},e.prototype._getLabelPositions=function(e,t,i,r,n){var o=this._model.triangleView,s=o.collapsed;C.push();var a=C.allocate(),l=C.allocate();n.projectPoint(i,a),n.projectPoint(t,l);var c={direct:s?"top":"bottom",horizontal:"top",vertical:a[0]<l[0]?"left":"right"};if(!s){var p=C.allocate(),g=C.allocate();if(h.screenSpaceTangent(e,i,p,n),h.screenSpaceTangent(e,t,g,n),_.vec2d.dot(p,g)>=M)c.direct=u.sign(p[1])===u.sign(g[1])?d.mirrorPosition(c.vertical):c.vertical;else{var m=C.allocate();h.screenSpaceTangent(i,t,m,n),_.vec2d.dot(m,g)>=M&&(c.direct=u.sign(m[0])===u.sign(g[0])?d.mirrorPosition(c.horizontal):c.horizontal)}}if("below-the-surface"===r){var b=function(e){return"top"===e?"bottom":"top"};c.direct=b(c.direct),c.horizontal=b(c.horizontal),c.vertical=b(c.vertical)}return C.pop(),c},e.prototype._updateView=function(){var e;if(this._sceneView.ready){var t=this._sceneView._stage,i=t.getCamera(),r=this._sceneView.renderCoordsHelper;this._updateHandleObject(this._startHandleObject,this._startPosition,null!==this._model.startPoint,"start"===this._model.hoveredHandle,this._model.draggedHandles.includes("start"),i),this._updateHandleObject(this._endHandleObject,this._endPosition,null!==this._model.endPoint,"end"===this._model.hoveredHandle,this._model.draggedHandles.includes("end"),i);var n=this._model.triangleView;if(!n.visible)return this._triangleLineObject.removeAllGeometries(),this._triangleCornerObject.removeAllGeometries(),this._arrowObject.removeAllGeometries(),this._geodesicProjectionLineObject.removeAllGeometries(),this._geodesicProjectionStartGuideObject.removeAllGeometries(),this._geodesicProjectionEndGuideObject.removeAllGeometries(),this._directDistanceLabel.visible=!1,this._horizontalDistanceLabel.visible=!1,void(this._verticalDistanceLabel.visible=!1);var o="camera-dependent"===this._model.measurementSurfaceLocation?this._sceneView.state.camera.aboveGround?"above-the-surface":"below-the-surface":this._model.measurementSurfaceLocation,s=this._startPosition,a=this._endPosition,l="above-the-surface"===o?1:-1,d=l*(r.getAltitude(a)-r.getAltitude(s));d<0&&(e=[a,s],s=e[0],a=e[1]);var c=this._cornerPosition;r.worldUpAtPosition(s,c),_.vec3d.scale(c,l*Math.abs(d)),_.vec3d.add(c,s);var u=this._centerPosition;h.midpoint([s,a,c],u),_.vec3d.set(u,this._origin),_.mat4d.identity(this._originTransform),_.mat4d.translate(this._originTransform,this._origin),n.collapsed?(this._triangleLineObject.removeAllGeometries(),this._triangleCornerObject.removeAllGeometries()):this._updateTriangleObjects(this._triangleLineObject,this._triangleCornerObject,s,a,c,this._origin,this._originTransform,i,n.mode,this._horizontalLabelSegment,this._verticalLabelSegment),this._updateArrowObject(this._arrowObject,this._startPosition,this._endPosition,this._origin,this._originTransform,n.stripeLength,i,n.mode,this._arrowLabelSegment);var p=this._requiresGeodesicGuides(this._startPosition,this._endPosition,i,n.mode);this._updateGeodesicProjectionLineObject(this._geodesicProjectionLineObject,this._startPosition,this._endPosition,this._origin,this._originTransform,p,this._geodesicProjectionLabelSegment),this._updateGeodesicProjectionGuideObjects(i,p);var g=this._params.labelDistance,m=this._getLabelPositions(s,a,c,o,i);this._updateAuxiliaryMeasureLabels(n,i,m),"geodesic"!==n.mode?this._updateLabel(this._directDistanceLabel,this._arrowLabelSegment,g,m.direct,n.directLabel,n.visible,O.Large,i):(this._updateLabel(this._horizontalDistanceLabel,p?this._geodesicProjectionLabelSegment:this._arrowLabelSegment,g,m.horizontal,n.horizontalLabel,n.visible,O.Large,i),this._directDistanceLabel.visible=!1)}},e.prototype._updateAuxiliaryMeasureLabels=function(e,t,i){if(e.collapsed)return this._horizontalDistanceLabel.visible=!1,void(this._verticalDistanceLabel.visible=!1);var r=this._params.labelDistance;this._updateLabel(this._horizontalDistanceLabel,this._horizontalLabelSegment,r,i.horizontal,e.horizontalLabel,!0,O.Small,t),this._updateLabel(this._verticalDistanceLabel,this._verticalLabelSegment,r,i.vertical,e.verticalLabel,!0,O.Small,t)},e.prototype._updateHandleObject=function(e,t,i,r,n,o){if(e.removeAllGeometries(),i&&!n){var s=r?this._params.handleRadiusHovered:this._params.handleRadius;h.scaleTranslateMatrix(s*o.computePixelSizeAt(t),t,this._tempMat4),e.addGeometry(this._handleGeometry,[this._handleMaterial],this._tempMat4)}},e.prototype._updateTriangleObjects=function(e,t,i,r,n,o,s,a,l,d,c){C.push();var h=[_.vec3d.subtract(i,o,C.allocate()),_.vec3d.subtract(n,o,C.allocate()),_.vec3d.subtract(r,o,C.allocate())];d.update(n,r),c.update(i,n);var u=new p(m.createPolylineGeometry(h),"triangle-line");e.removeAllGeometries(),e.addGeometry(u,[this._triangleLineMaterial],s);var g=C.allocate(),b=C.allocate();_.vec3d.subtract(n,i,g),_.vec3d.normalize(g,g),_.vec3d.subtract(r,n,b),_.vec3d.normalize(b,b);var v=.33*Math.min(_.vec3d.dist(n,i),_.vec3d.dist(n,r)),L=this._params.triangleCornerSize*a.computePixelSizeAt(n),w=Math.min(v,L),P=new p(this._quadGeometryData(n,g,b,w,o),"triangle-corner");t.removeAllGeometries(),t.addGeometry(P,[this._triangleCornerMaterial],s),C.pop()},e.prototype._updateArrowObject=function(e,t,i,r,n,o,s,a,l){this._createInterpolatedLineGeometry(e,this._arrowMaterial,"arrow",t,i,r,n,a,this._arrowLabelSegment);var d=s.computePixelSizeAt(l.origin);this._arrowMaterial.setParameterValues({width:this._params.arrowWidth*d,stripeLength:o})},e.prototype._getSegmentInterpolator=function(e,t){var i=this._sceneView.spatialReference,r=this._sceneView.renderCoordsHelper,n=r.spatialReference;return i.isWebMercator||i.isWGS84?new c.Spherical(e,t,n,n):new c.Linear(e,t)},e.prototype._updateGeodesicProjectionLineObject=function(e,t,i,r,n,o,s){if(!o)return void e.removeAllGeometries();C.push();var a=this._sceneView.renderCoordsHelper,l=_.vec3d.set(t,C.allocate()),d=_.vec3d.set(i,C.allocate());a.setAltitude(0,l),a.setAltitude(0,d),this._createInterpolatedLineGeometry(e,this._geodesicProjectionLineMaterial,"geodesicProjectionLine",l,d,r,n,"geodesic",s),C.pop()},e.prototype._requiresGeodesicGuides=function(e,t,i,r){return!("geodesic"!==r||!this._model.geodesicDistanceExceeded)&&(this._requiresGeodesicGuideAt(e,i)||this._requiresGeodesicGuideAt(t,i))},e.prototype._requiresGeodesicGuideAt=function(e,t){var i=this._sceneView.renderCoordsHelper,r=t.computePixelSizeAt(e);return i.getAltitude(e)/r>=10},e.prototype._updateGeodesicProjectionGuideObjects=function(e,t){if(!t)return this._geodesicProjectionStartGuideObject.removeAllGeometries(),void this._geodesicProjectionEndGuideObject.removeAllGeometries();C.push();var i=this._sceneView.renderCoordsHelper,r=_.vec3d.set(this._startPosition,C.allocate()),n=_.vec3d.set(this._endPosition,C.allocate());i.setAltitude(0,r),i.setAltitude(0,n),this._createInterpolatedLineGeometry(this._geodesicProjectionStartGuideObject,this._geodesicGuideLineMaterial,"geodesicGuideLine",r,this._startPosition,this._origin,this._originTransform,"euclidean"),this._createInterpolatedLineGeometry(this._geodesicProjectionEndGuideObject,this._geodesicGuideLineMaterial,"geodesicGuideLine",n,this._endPosition,this._origin,this._originTransform,"euclidean");var o=Math.min(e.computePixelSizeAt(this._startPosition),e.computePixelSizeAt(r),e.computePixelSizeAt(this._endPosition),e.computePixelSizeAt(n));this._geodesicGuideLineMaterial.setParameterValues({stippleLength:this._params.guideStippleLengthPixels*o}),C.pop()},e.prototype._createInterpolatedLineGeometry=function(e,t,i,r,n,o,s,a,l){C.push();var d=this._sceneView.renderCoordsHelper,c=[],u=[],g=function(e,t){var i=C.allocate();_.vec3d.subtract(e,o,i),c.push(i),u.push(t)};if("euclidean"===a){var b=C.allocate();h.midpoint([r,n],b);var v=C.allocate();d.worldUpAtPosition(b,v),g(r,v),g(n,v),l&&l.update(r,n)}else{for(var L=this._getSegmentInterpolator(r,n),w=this._params.arrowSubdivisions+1&-2,P=null,y=null,f=0;f<w;++f){var j=f/(w-1),O=C.allocate(),v=C.allocate();L.eval(j,O),d.worldUpAtPosition(O,v),f===w/2-1?P=O:f===w/2&&(y=O),g(O,v)}l&&l.update(P,y)}var T=new p(m.createPolylineGeometry(c,u),i);e.removeAllGeometries(),e.addGeometry(T,[t],s),C.pop()},e.prototype._quadGeometryData=function(e,t,i,r,n){C.push();var o=C.allocate(),s=[],a=C.allocate();_.vec3d.scale(i,r,a);var l=C.allocate();_.vec3d.scale(t,-r,l);for(var d=0;d<4;++d)_.vec3d.set(e,o),_.vec3d.subtract(o,n),1&d&&_.vec3d.add(o,a),2&d&&_.vec3d.add(o,l),s.push(o[0],o[1],o[2]);var c=new g({position:{size:3,data:s}},{position:new Uint32Array([0,1,2,1,2,3])});return C.pop(),c},e.prototype._updateLabel=function(e,t,i,r,n,o,s,a){C.push();var l=C.allocate(),c=C.allocate(),h=d.computeLabelPositionFromSegment(a,t,i,r,l,c);e.updatePosition(l,c),e.text=n,e.visible=h&&o,e.fontSize=s,C.pop()},e.prototype._updateMouseCursor=function(){"drawing"===this._model.state||"initial"===this._model.state?this._sceneView.cursor="crosshair":"editing"!==this._model.state&&"measured"!==this._model.state||(this._model.draggedHandles.length>0?this._sceneView.cursor="grabbing":this._model.hoveredHandle?this._sceneView.cursor="pointer":this._sceneView.cursor="crosshair")},e.prototype._updateCursorPosition=function(){this._model.cursorPoint&&this._sceneView.renderCoordsHelper.toRenderCoords(this._model.cursorPoint,this._cursorPosition),this._updateLaserLine()},e.prototype._updateStartPosition=function(){this._model.startPoint&&this._sceneView.renderCoordsHelper.toRenderCoords(this._model.startPoint,this._startPosition),this._updateLaserLine()},e.prototype._updateEndPosition=function(){this._model.endPoint&&this._sceneView.renderCoordsHelper.toRenderCoords(this._model.endPoint,this._endPosition),this._updateLaserLine()},e.prototype._lastAddedDraggedHandle=function(){return this._model.draggedHandles.length>0?this._model.draggedHandles.items[this._model.draggedHandles.length-1]:null},e.prototype._getFocusPosition=function(){var e=this._model,t=e.triangleView.visible&&e.triangleView.collapsed&&"euclidean"===e.measurementMode;switch(e.state){case"drawing":return t?this._startPosition:e.endPoint?this._endPosition:this._startPosition;case"editing":return t?"start"===this._lastAddedDraggedHandle()?this._endPosition:this._startPosition:"start"===this._lastAddedDraggedHandle()?this._startPosition:this._endPosition;default:return e.cursorPoint?this._cursorPosition:null}},e.prototype._getFocusSpherePosition=function(){return"drawing"===this._model.state||"end"===this._lastAddedDraggedHandle()?this._startPosition:this._endPosition},e.prototype._updateLaserLine=function(){var e=this._model,t=this._getFocusPosition(),i=this._params.laserLineEnabled&&!!t&&"measured"!==e.state;i?(this._laserLineRenderer.focusPlaneActive=i&&"euclidean"===e.measurementMode,this._laserLineRenderer.focusSphereActive=i&&!!e.startPoint&&"geodesic"===e.measurementMode,this._laserLineRenderer.focusPosition=t,this._laserLineRenderer.focusSpherePosition=this._getFocusSpherePosition(),this._laserLineRenderer.segmentActive=i&&e.triangleView.visible&&!e.triangleView.collapsed,this._laserLineRenderer.segmentStartPosition=this._startPosition,this._laserLineRenderer.segmentEndPosition=this._endPosition):(this._laserLineRenderer.focusPlaneActive=!1,this._laserLineRenderer.focusSphereActive=!1,this._laserLineRenderer.segmentActive=!1)},e.prototype._initializeListeners=function(){var e=this;this._listenerHandles=new n,this._listenerHandles.add(this._model.watch("state",function(){e._updateMouseCursor(),e._updateLaserLine()})),this._listenerHandles.add(this._model.watch("measurementMode",function(){e._updateLaserLine()})),this._listenerHandles.add(this._model.watch("hoveredHandle",function(){e._updateMouseCursor(),e._updateView()})),this._listenerHandles.add(this._model.draggedHandles.on("change",function(){e._updateMouseCursor(),e._updateView()})),this._listenerHandles.add(this._model.watch("cursorPoint",function(){e._updateCursorPosition()})),this._listenerHandles.add(this._model.watch("startPoint",function(){e._updateStartPosition(),e._updateView()})),this._listenerHandles.add(this._model.watch("endPoint",function(){e._updateEndPosition(),e._updateView()})),this._listenerHandles.add(this._model.watch("unit",function(){e._updateView()})),this._listenerHandles.add(this._sceneView.state.watch("camera",function(){e._updateView()}))},e.prototype._destroyListeners=function(){this._listenerHandles.destroy(),this._listenerHandles=null},e}();!function(e){var t=function(){function e(){}return e}();e.PickRequest=t;var i=function(){function e(e,t,i){void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null),this.type=e,this.scenePoint=t,this.mapPoint=i}return e}();e.PickResult=i}(A||(A={}));var M=Math.cos(u.deg2rad(12));return A});