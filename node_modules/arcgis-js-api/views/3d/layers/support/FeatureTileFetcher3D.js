// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/generatorHelper","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Handles","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/QueueProcessor","../../../../core/throttle","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../tasks/support/QuantizationParameters"],function(e,t,i,r,s,n,a,u,o,l,p,c,h,d,f,y,g,F,T){Object.defineProperty(t,"__esModule",{value:!0});var m=p.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D"),v=function(e){function t(t){var i=e.call(this,t)||this;return i.displayLimitExceeded=!1,i.displayLimitExceededThrottle=1e3,i.handles=new l,i.idToFeatureTile=new Map,i.displayingFeatureReferences=new Map,i.suspended=!0,i.pendingEdits=null,i}return i(t,e),Object.defineProperty(t.prototype,"displayFeatureLimit",{set:function(e){var t=this._get("displayFeatureLimit");if(!(e===t||e&&t&&e.min===t.min&&e.max===t.max&&e.perTile===t.perTile)){var i=t?t.perTile:1/0,r=e?e.perTile:1/0;this._set("displayFeatureLimit",s({},e)),this.perTileLimitUpdated(i,r),this.update()}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this.fetchQueue.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filterExtent",{set:function(e){if(e&&this.tilingScheme&&!e.spatialReference.equals(this.tilingScheme.spatialReference))return void m.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");var t=this._get("filterExtent");if(t!==e&&!(t&&e&&t.equals(e))){var i=e?e.clone():null;this._set("filterExtent",i),this.reclip(i,t)}},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.updateDisplayLimitExceededThrottled=d.throttle(this.updateDisplayLimitExceeded,this.displayLimitExceededThrottle,this),this.capabilities=this.calculateCapabilities(),this.fetchQueue=this.createFetchQueue(),this.handles.add(f.on(this,"tileDescriptors","change",function(){return e.update()},function(){return e.update()})),this.objectIdField=this.layer.objectIdField,this.update()},t.prototype.destroy=function(){var e=this;this.handles&&(this.handles.destroy(),this.handles=null),this.updateDisplayLimitExceededThrottled.remove(),this.forEachFeatureTile(function(t){return e.cancelFetchTile(t)}),this.fetchQueue.clear(),this.pendingEdits&&(this.pendingEdits.edits.cancel(q),this.pendingEdits=null)},Object.defineProperty(t.prototype,"paused",{get:function(){return this.suspended||!!this.pendingEdits},enumerable:!0,configurable:!0}),t.prototype.filtersChanged=function(){var e=this;this.fetchQueue.clear(),this.forEachFeatureTile(function(t){e.resetFetchTile(t),e.queueFetchTile(t)}),this.update()},t.prototype.suspend=function(){this.suspended||(this.suspended=!0,this.pause())},t.prototype.resume=function(){this.suspended&&(this.suspended=!1,this.unpause())},t.prototype.pause=function(){this.paused&&(this.fetchQueue.pause(),this.fetchQueue.reset())},t.prototype.unpause=function(){this.paused||(this.update(),this.fetchQueue.resume())},t.prototype.getFeatureTileById=function(e){return this.idToFeatureTile.get(e)||null},t.prototype.forEachFeatureTile=function(e){this.idToFeatureTile.forEach(e)},t.prototype.applyEdits=function(e){var t=this;this.pendingEdits||(this.pendingEdits={edits:c.resolve(),count:0},this.pause()),this.pendingEdits.count++,this.pendingEdits.edits=this.pendingEdits.edits.then(function(){return e.result.catch(function(e){if(e===q)throw e;return null}).then(function(e){if(e)return t.applyEditsDeleteFeatures(e.deletedFeatures),t.applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures)}).then(function(){0==--t.pendingEdits.count&&(t.pendingEdits=null,t.unpause())})})},t.prototype.applyEditsDeleteFeatures=function(e){var t=this;if(0!==e.length){var i=new Set;e.forEach(function(e){return i.add(e.objectId)}),this.forEachFeatureTile(function(e){if(e.features){var r=e.features.filter(function(e){return!i.has(t.getFeatureId(e))});r.length!==e.features.length&&(e.features=r)}})}},t.prototype.applyEditsAddUpdateFeatures=function(e,t){var i=this,r=[],s=new Set;if(e.forEach(function(e){return r.push(e.objectId)}),t.forEach(function(e){r.push(e.objectId),s.add(e.objectId)}),0!==r.length){var n=[];return this.forEachFeatureTile(function(e){var t=o.cancellable(function(t){return i.applyEditsAddUpdateTile(e,r,s,t)});t&&n.push(t)}),c.all(n)}},t.prototype.applyEditsAddUpdateTile=function(e,t,i,r){return n(this,void 0,void 0,function(){var s,n,u,o,l,p,c,h=this;return a(this,function(a){switch(a.label){case 0:return e.features?(s=this.createQuery(e),s.resultType=void 0,s.objectIds=t,[4,r(this.queryFeatures(s))]):[2];case 1:if(n=a.sent(),u=null,i.size>0&&(o=e.features.filter(function(e){return!i.has(h.getFeatureId(e))}),o.length!==e.features.length&&(u=o)),n.features.length>0)for(u||(u=e.features.slice()),this.verticalScale.adjust(n.features),l=0,p=n.features;l<p.length;l++)c=p[l],u.push(c);return u&&(e.features=u),[2]}})})},t.prototype.queryFeatures=function(e){return this.layer.queryFeaturesJSON?this.layer.queryFeaturesJSON(e).then(function(e){return{features:F.fromFeatureSetJSON(e),exceededTransferLimit:!!e.exceededTransferLimit}}):this.layer.queryFeatures(e).then(function(e){return{features:e.features,exceededTransferLimit:!!e.exceededTransferLimit}})},t.prototype.calculateCapabilities=function(){var e=this.layer,t=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsPagination),i=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsResultType),r=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization);return{supportsMultipleResolutions:this.calculateSupportsMultipleResolutions(),supportsPagination:t,supportsResultType:i,supportsQuantization:r}},t.prototype.calculateSupportsMultipleResolutions=function(){var e=this.layer,t=e.geometryType;return"polyline"===t||"polygon"===t&&(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization)},t.prototype.createFetchQueue=function(){var e=this;return new h({concurrency:6,ordered:!0,peeker:function(t){return e.highestPriorityTile(t)},process:function(t){return e.fetchTile(t)}})},t.prototype.highestPriorityTile=function(e){return e.reduce(function(e,t){return e&&e.descriptor.loadPriority<=t.descriptor.loadPriority?e:t},null)},t.prototype.update=function(){if(!this.suspended&&this.constructed){var e=this.getListOfTiles();this.markTilesNotAlive(e),this.addTiles(e);var t=this.sortTiles(e);this.removeTiles(t),this.displayTiles(t),this.queueFetchTiles(t),this.updated()}},t.prototype.markTilesNotAlive=function(e){for(var t=0,i=e;t<i.length;t++){i[t].alive=0}},t.prototype.addTiles=function(e){var t=this;this.tileDescriptors.forEach(function(i){var r=t.getFeatureTileById(i.id);r?r.alive=1:e.push(t.addTile(i))})},t.prototype.removeTiles=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];0===r.alive||r.intersects(this.filterExtent)||this.clearTile(r)}for(var s=!1,n=e.length-1;n>=0;n--){var r=e[n];r.displayingFeatures&&r.displayingFeatures.length>0&&this.displayFeatureLimit&&this.displayingFeatureReferences.size<=this.displayFeatureLimit.min?0===r.alive&&(r.alive=2):0===r.alive&&(this.removeTile(r),n!==e.length-1&&(s=!0),e[n]=e[e.length-1],e.pop())}s&&this.sortTiles(e)},t.prototype.sortTiles=function(e){return e.sort(function(e,t){return e.descriptor.loadPriority-t.descriptor.loadPriority}),e},t.prototype.displayTiles=function(e){for(var t=0,i=e.length-1,r=null;t<=i;)if(!r&&this.isDisplayingFeaturesAtMaximumLimit()){var s=e[i--],n=this.featureCountDifferenceWhenHidingTile(s);this.displayFeatureLimit&&this.displayingFeatureReferences.size-n>=this.displayFeatureLimit.max?this.hideTile(s):r=s}else{var s=e[t++],n=this.featureCountDifferenceWhenShowingTile(s);n>0&&r&&(this.hideTile(r),r=null),this.showTile(s)}r&&this.showTile(r)},t.prototype.queueFetchTiles=function(e){var t=e.length-1;if(this.isDisplayingFeaturesAtMaximumLimit())for(var i=e.length-1;i>=0;i--){var r=e[i];if(r.displayingFeatures&&r.displayingFeatures.length>0){t=i;break}}for(var i=0;i<=t;i++)this.queueFetchTile(e[i])},t.prototype.reclip=function(e,t){var i=this;if(this.constructed){var r=[];this.forEachFeatureTile(function(s){s.displayingFeatures&&0!==s.displayingFeatures.length&&(s.intersection(t,R),s.intersection(e,L),g.equals(R,L)||(r.push(s),i.hideTileFeatures(s)))});for(var s=0,n=r;s<n.length;s++){var a=n[s];this.showTile(a)}this.updated()}},t.prototype.updated=function(){this.notifyChange("updating"),this.debugger&&this.debugger.update(),this.updateDisplayLimitExceededThrottled()},t.prototype.updateDisplayLimitExceeded=function(){if(!this.updating){var e=!1;this.forEachFeatureTile(function(t){(t.perTileDisplayLimitExceeded&&2!==t.alive||!t.displayingFeatures&&!t.isFetchFetching)&&(e=!0)}),this._set("displayLimitExceeded",e)}},t.prototype.perTileLimitUpdated=function(e,t){if(e!==t)if(t<e)for(var i=0,r=this.getListOfTiles();i<r.length;i++){var s=r[i];s.features&&s.features.length>t&&(s.features=s.features.slice(0,t),s.perTileDisplayLimitExceeded=!0)}else for(var n=0,a=this.getListOfTiles();n<a.length;n++){var s=a[n];s.features&&s.features.length>=e&&(this.cancelFetchTile(s),this.resetFetchTile(s))}},t.prototype.addTile=function(e){var t=new b(e);return this.idToFeatureTile.set(t.id,t),this.resetFetchTile(t),this.referenceDisplayingFeaturesFromRelatedTiles(t),t},t.prototype.referenceDisplayingFeaturesFromRelatedTiles=function(e){var t=this;this.forEachFeatureTile(function(i){if(i.displayingFeatures&&t.tilesAreRelated(e,i)){e.displayingFeatures||(e.displayingFeatures=[]);for(var r=0,s=i.displayingFeatures;r<s.length;r++){var n=s[r];e.displayingFeatures.push(n),t.getDisplayingFeatureReference(n).ref()}}})},t.prototype.tilesAreRelated=function(e,t){if(e===t)return!1;var i=e.descriptor.lij,r=t.descriptor.lij;if(!i||!r)return!0;var s=i[0]<r[0],n=s?i:r,a=s?r:i,u=a[0]-n[0];if(0===u)return!1;var o=1<<u;return Math.floor(a[1]/o)===n[1]&&Math.floor(a[2]/o)===n[2]},t.prototype.removeTile=function(e){this.clearTile(e),this.idToFeatureTile.delete(e.id)},t.prototype.resetFetchTile=function(e){e.intersects(this.filterExtent)?e.fetchStatus=0:0===e.fetchStatus&&(e.fetchStatus=2)},t.prototype.cancelFetchTile=function(e){var t=e.fetchRequest;t&&(e.fetchRequest=null,e.fetchStatus=0,t.cancel())},t.prototype.fetchTile=function(e){var t=this;return o.cancellable(function(i){return t.fetchTileAll(e,i)})},t.prototype.setPagingParameters=function(e,t,i){if(!this.capabilities.supportsPagination)return!1;var r=this.capabilities.supportsResultType&&this.layer.tileMaxRecordCount||this.layer.maxRecordCount||x;return e.start=t,i>0&&this.capabilities.supportsResultType?(e.maxRecordCountFactor=Math.ceil(i/r),e.num=i):e.num=Math.min(r,i),!0},t.prototype.fetchTileAll=function(e,t){return n(this,void 0,void 0,function(){var i,r,s,n,u,o,l,p,c,h;return a(this,function(a){switch(a.label){case 0:i=0,r=[],s=!1,e.perTileDisplayLimitExceeded=!1,a.label=1;case 1:return n=this.createQuery(e),u=this.displayFeatureLimit&&this.displayFeatureLimit.perTile,o=this.setPagingParameters(n,i,u),[4,t(this.queryFeatures(n))];case 2:return l=a.sent(),p=l.features,c=l.exceededTransferLimit,(s=c,r=0===r.length?p:r.concat(p),!o||!c||u>0&&r.length>=u)?[3,3]:(e.needsDisplayUpdate?e.features=e.features.concat(p):e.displayingFeatures?e.features=e.displayingFeatures.concat(p):e.features=p,this.update(),i+=n.num,[3,1]);case 3:return t(null),h=this.displayFeatureLimit&&this.displayFeatureLimit.perTile,h&&r.length>h?(e.perTileDisplayLimitExceeded=!0,r=r.slice(0,h)):s&&(e.perTileDisplayLimitExceeded=!0),this.verticalScale.adjust(r),[2,r]}})})},t.prototype.createQuery=function(e){var t=this.tilingScheme.spatialReference,i=e.descriptor.extent,r=this.createDefaultQuery();return i&&(r.geometry=g.toExtent(i,t)),this.setResolutionParams(r,e),this.capabilities.supportsResultType&&(r.resultType="tile"),r},t.prototype.createDefaultQuery=function(){var e=this.tilingScheme.spatialReference,t=this.layer.createQuery(),i=this.layer.capabilities&&this.layer.capabilities.data;return i&&i.supportsZ&&null==t.returnZ&&(t.returnZ=!0),t.outSpatialReference=e,t},t.prototype.setResolutionParams=function(e,t){if(this.capabilities.supportsMultipleResolutions){var i=this.layer,r=i.geometryType,s=t.descriptor.resolution;null!=s&&("polyline"===r&&(e.maxAllowableOffset=s),this.capabilities.supportsQuantization&&(e.quantizationParameters=new T.default({mode:"view",originPosition:"upper-left",tolerance:s,extent:i.fullExtent})))}},t.prototype.queueFetchTile=function(e){var t=this;if(e.isFetchPending){var i=this.fetchQueue.push(e),r=!1,s=i.then(function(t){e.fetchRequest=null,e.fetchStatus=2,e.features=t}).catch(function(t){e.fetchRequest===s&&(e.fetchRequest=null,e.fetchStatus=2),t&&"cancel"===t.dojoType?r=!0:(e.features=[],m.error("#fetchTile()",t&&t.message?t.message:t))}).then(function(){r||t.update()});s.isFulfilled()?e.fetchStatus=2:(e.fetchRequest=s,e.fetchStatus=1)}},t.prototype.getDisplayingFeatureReference=function(e){return this.displayingFeatureReferences.get(this.getFeatureId(e))},t.prototype.displayingFeatureNeedsReplacement=function(e,t,i){return!!(this.capabilities.supportsMultipleResolutions&&i.descriptor.resolution>e.resolution)||!F.equals(e.feature,t)},t.prototype.showTile=function(e){if(!e.displayingFeatures||e.needsDisplayUpdate){if(!e.features)return void(e.displayingFeatures=[]);for(var t=e.descriptor.resolution,i=0,r=e.features;i<r.length;i++){var s=r[i],n=this.getFeatureId(s),a=this.displayingFeatureReferences.get(n);if(a){if(a.ref(),!this.displayingFeatureNeedsReplacement(a,s,e))continue;S.push(a.feature),a.feature=s,a.resolution=e.descriptor.resolution}else this.displayingFeatureReferences.set(n,new E(s,t));D.push(s)}this.hideTileFeatures(e),S.length>0&&this.features.removeMany(S),D.length>0&&this.features.addMany(D),S.length=0,D.length=0,e.displayingFeatures=e.features}},t.prototype.featureCountDifferenceWhenShowingTile=function(e){if(!e.needsDisplayUpdate)return 0;for(var t=-this.featureCountDifferenceWhenHidingTile(e,!0),i=0,r=e.features;i<r.length;i++){var s=r[i],n=this.getDisplayingFeatureReference(s);(!n||n.isSingle&&n.markedTile===e)&&t++}return t},t.prototype.getFeatureId=function(e){return null!=e.objectId?e.objectId:e.attributes[this.objectIdField]},t.prototype.featureCountDifferenceWhenHidingTile=function(e,t){if(void 0===t&&(t=!1),!e.displayingFeatures)return 0;for(var i=0,r=0,s=e.displayingFeatures;r<s.length;r++){var n=s[r],a=this.getDisplayingFeatureReference(n);a&&a.isSingle&&(t&&(a.markedTile=e),i++)}return i},t.prototype.hideTile=function(e){this.cancelFetchTile(e),this.hideTileFeatures(e)},t.prototype.hideTileFeatures=function(e){if(e.displayingFeatures){for(var t=0,i=e.displayingFeatures;t<i.length;t++){var r=i[t],s=this.getFeatureId(r),n=this.displayingFeatureReferences.get(s);n&&!n.unref()&&(this.displayingFeatureReferences.delete(s),P.push(n.feature))}P.length>0&&this.features.removeMany(P),P.length=0}e.displayingFeatures=null},t.prototype.clearTile=function(e){this.hideTile(e),e.features=null},t.prototype.isDisplayingFeaturesAtMaximumLimit=function(){return this.displayFeatureLimit&&this.displayingFeatureReferences.size>=this.displayFeatureLimit.max},t.prototype.getListOfTiles=function(){var e=new Array(this.idToFeatureTile.size),t=0;return this.forEachFeatureTile(function(i){return e[t++]=i}),e},r([y.property({constructOnly:!0})],t.prototype,"features",void 0),r([y.property()],t.prototype,"tileDescriptors",void 0),r([y.property({constructOnly:!0})],t.prototype,"tilingScheme",void 0),r([y.property()],t.prototype,"displayFeatureLimit",null),r([y.property({constructOnly:!0})],t.prototype,"layer",void 0),r([y.property({readOnly:!0})],t.prototype,"updating",null),r([y.property({readOnly:!0})],t.prototype,"displayLimitExceeded",void 0),r([y.property({constructOnly:!0})],t.prototype,"displayLimitExceededThrottle",void 0),r([y.property()],t.prototype,"filterExtent",null),r([y.property({constructOnly:!0})],t.prototype,"verticalScale",void 0),t=r([y.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],t)}(y.declared(u));t.FeatureTileFetcher3D=v;var b=function(){function e(e){this.descriptor=e,this.fetchRequest=null,this.fetchStatus=0,this.features=null,this.displayingFeatures=null,this.perTileDisplayLimitExceeded=!1,this.alive=1}return Object.defineProperty(e.prototype,"id",{get:function(){return this.descriptor.id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isFetchFetching",{get:function(){return 1===this.fetchStatus},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isFetchPending",{get:function(){return 0===this.fetchStatus},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isFetchDone",{get:function(){return 2===this.fetchStatus},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needsDisplayUpdate",{get:function(){return this.features&&this.displayingFeatures!==this.features},enumerable:!0,configurable:!0}),e.prototype.intersects=function(e){return!e||!this.descriptor.extent||(g.fromExtent(e,R),g.intersects(this.descriptor.extent,R))},e.prototype.intersection=function(e,t){return void 0===t&&(t=g.create()),e||this.descriptor.extent?(e?(g.fromExtent(e,t),this.descriptor.extent&&g.intersection(t,this.descriptor.extent,t)):g.set(t,this.descriptor.extent),t):t},e}();t.FeatureTile=b;var E=function(){function e(e,t){this.feature=e,this.resolution=t,this.refCount=1}return Object.defineProperty(e.prototype,"isReferenced",{get:function(){return 0!==this.refCount},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isSingle",{get:function(){return 1===this.refCount},enumerable:!0,configurable:!0}),e.prototype.ref=function(){this.refCount+=1},e.prototype.unref=function(){return!(this.refCount>0)||(this.refCount-=1,this.isReferenced)},e}(),x=2e3,R=g.create(),L=g.create(),D=[],S=[],P=[],q={};t.default=v});