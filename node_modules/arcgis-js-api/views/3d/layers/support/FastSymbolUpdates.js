// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../renderers/support/utils","../graphics/graphicUtils","../../lib/glMatrix"],function(e,o,t,i,n){function r(e){return null!==e&&void 0!==e}function l(e){return"number"==typeof e}function a(e){return"string"==typeof e}function s(e){return null==e||a(e)}function u(e,o){e&&e.push(o),d(o)}function f(e){T&&console.warn("[FastSymbolUpdates] "+e)}function d(e){T&&console.info("[FastSymbolUpdates] "+e)}function c(e,o,i,n,a){var s=e.minSize,f=e.maxSize;if(e.expression)return u(a,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){var d=n.symbolSize[i];return o.minSize[i]=d,o.maxSize[i]=d,o.offset[i]=o.minSize[i],o.factor[i]=0,o.type[i]=1,!0}if(r(e.field))return r(e.stops)?2===e.stops.length&&l(e.stops[0].size)&&l(e.stops[1].size)?(v(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,o,i),o.type[i]=1,!0):(u(a,"Could not convert size info: stops only supported with 2 elements"),!1):l(s)&&l(f)&&r(e.minDataValue)&&r(e.maxDataValue)?(v(s,f,e.minDataValue,e.maxDataValue,o,i),o.type[i]=1,!0):null!=t.meterIn[e.valueUnit]?(o.minSize[i]=-1/0,o.maxSize[i]=1/0,o.offset[i]=0,o.factor[i]=1/t.meterIn[e.valueUnit],o.type[i]=1,!0):"unknown"===e.valueUnit?(u(a,"Could not convert size info: proportional size not supported"),!1):(u(a,"Could not convert size info: scale-dependent size not supported"),!1);if(!r(e.field)){if(e.stops&&e.stops[0]&&l(e.stops[0].size))return o.minSize[i]=e.stops[0].size,o.maxSize[i]=e.stops[0].size,o.offset[i]=o.minSize[i],o.factor[i]=0,o.type[i]=1,!0;if(l(s))return o.minSize[i]=s,o.maxSize[i]=s,o.offset[i]=s,o.factor[i]=0,o.type[i]=1,!0}return u(a,"Could not convert size info: unsupported variant of sizeInfo"),!1}function v(e,o,t,i,n,r){var l=Math.abs(i-t)>0?(o-e)/(i-t):0;n.minSize[r]=l>0?e:o,n.maxSize[r]=l>0?o:e,n.offset[r]=e-t*l,n.factor[r]=l}function p(e,o,t,i){if(e.normalizationField||e.valueRepresentation)return u(i,"Could not convert size info: unsupported property"),null;if(!s(e.field))return u(i,"Could not convert size info: field is not a string"),null;if(o.size){if(e.field)if(o.size.field){if(e.field!==o.size.field)return u(i,"Could not convert size info: multiple fields in use"),null}else o.size.field=e.field}else o.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[0,0,0]};var n;switch(e.axis){case"width":return n=c(e,o.size,0,t,i),n?o:null;case"height":return n=c(e,o.size,2,t,i),n?o:null;case"depth":return n=c(e,o.size,1,t,i),n?o:null;case"width-and-depth":return n=c(e,o.size,0,t,i),n&&c(e,o.size,1,t,i),n?o:null;case null:case void 0:case"all":return n=c(e,o.size,0,t,i),n=n&&c(e,o.size,1,t,i),n=n&&c(e,o.size,2,t,i),n?o:null;default:return u(i,'Could not convert size info: unknown axis "'+e.axis+'""'),null}}function z(e,o,t){for(var i=0;i<3;++i){var n=o.unitInMeters;1===e.type[i]&&(n*=o.modelSize[i],e.type[i]=2),e.minSize[i]=e.minSize[i]/n,e.maxSize[i]=e.maxSize[i]/n,e.offset[i]=e.offset[i]/n,e.factor[i]=e.factor[i]/n}var r;if(0!==e.type[0])r=0;else if(0!==e.type[1])r=1;else{if(0===e.type[2])return u(t,"No size axis contains a valid size or scale"),!1;r=2}for(var i=0;i<3;++i)0===e.type[i]&&(e.minSize[i]=e.minSize[r],e.maxSize[i]=e.maxSize[r],e.offset[i]=e.offset[r],e.factor[i]=e.factor[r],e.type[i]=e.type[r]);return!0}function m(e,o,t){e[4*o+0]=t.r/255,e[4*o+1]=t.g/255,e[4*o+2]=t.b/255,e[4*o+3]=t.a}function S(e,o,t){if(e.normalizationField)return u(t,"Could not convert color info: unsupported property"),null;if(a(e.field))if(e.stops){if(e.stops.length>8)return u(t,"Could not convert color info: too many color stops"),null;o.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(var i=e.stops,n=0;n<8;++n){var l=Math.min(n,i.length-1),s=i[l];o.color.values[n]=s.value,m(o.color.colors,n,s.color)}}else{if(!e.colors)return u(t,"Could not convert color info: missing stops or colors"),null;if(!r(e.minDataValue)||!r(e.maxDataValue))return u(t,"Could not convert color info: missing data values"),null;if(2!==e.colors.length)return u(t,"Could not convert color info: invalid colors array"),null;o.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},o.color.values[0]=e.minDataValue,m(o.color.colors,0,e.colors[0]),o.color.values[1]=e.maxDataValue,m(o.color.colors,1,e.colors[1]);for(var n=2;n<8;++n)o.color.values[n]=e.maxDataValue,m(o.color.colors,n,e.colors[1])}else{if(!(e.stops&&e.stops.length>=0||e.colors&&e.colors.length>=0))return u(t,"Could not convert color info: no field and no colors/stops"),null;var f=e.stops&&e.stops.length>=0?e.stops[0].color:e.colors[0];o.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(var n=0;n<8;n++)o.color.values[n]=1/0,m(o.color.colors,n,f)}return o}function b(e,o,t,i){var n=2===t&&"arithmetic"===e.rotationType;o.offset[t]=n?90:0,o.factor[t]=n?-1:1,o.type[t]=1}function y(e,o,t){if(!a(e.field))return u(t,"Could not convert rotation info: field is not a string"),null;if(o.rotation){if(e.field)if(o.rotation.field){if(e.field!==o.rotation.field)return u(t,"Could not convert rotation info: multiple fields in use"),null}else o.rotation.field=e.field}else o.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return b(e,o.rotation,0,t),o;case"roll":return b(e,o.rotation,1,t),o;case null:case void 0:case"heading":return b(e,o.rotation,2,t),o;default:return u(t,'Could not convert rotation info: unknown axis "'+e.axis+'""'),null}}function x(e,o,t){if(!e)return null;var i=!o.supportedTypes||!!o.supportedTypes.size,n=!o.supportedTypes||!!o.supportedTypes.color,r=!o.supportedTypes||!!o.supportedTypes.rotation;T&&(t=t||[]);var l=e.reduce(function(e,l){if(!e)return e;if(l.valueExpression)return u(t,"Could not convert visual variables: arcade expressions not supported"),null;switch(l.type){case"size":return i?p(l,e,o,t):e;case"color":return n?S(l,e,t):e;case"rotation":return r?y(l,e,t):e;default:return u(t,"Could not convert visual variables: unsupported type "+l.type),null}},{size:null,color:null,rotation:null});return l&&l.size&&!z(l.size,o,t)?null:l}function h(e){return e&&null!=e.size}function C(e,o,t){if(F)return f("State not initialized, fast updates disabled (globally disabled)"),{enabled:!1};if(!o)return f("State not initialized, fast updates disabled (no shader support)"),{enabled:!1};if(!e)return f("State not initialized, fast updates disabled (no renderer)"),{enabled:!1};if(e.disableFastUpdates)return f("State not initialized, fast updates disabled (renderer.disableFastUpdates set)"),{enabled:!1};var i=x(e.visualVariables,t);return i?(d("State initialized, fast updates enabled"),{enabled:!0,visualVariables:i,materialParameters:M(i,t),customTransformation:h(i)}):(f("State not initialized, fast updates disabled (conversion failed)"),{enabled:!1})}function V(e,o,t){if(!o||!e.enabled)return!1;var i=e.visualVariables,n=x(o.visualVariables,t);return n?!!(g(i.size,n.size,"size")&&g(i.color,n.color,"color")&&g(i.rotation,n.rotation,"rotation"))&&(e.visualVariables=n,e.materialParameters=M(n,t),e.customTransformation=h(n),d("State updated"),!0):(f("State update failed (conversion failed)"),!1)}function g(e,o,t){if(!!e!=!!o)return f("State update failed ({$name} enabled/disabled)"),!1;if(e&&e.field!==o.field)return f("State update failed ({$name} field changed)"),!1;if(e&&"rotation"===t)for(var i=e,n=o,r=0;r<3;r++)if(i.type[r]!==n.type[r]||i.offset[r]!==n.offset[r]||i.factor[r]!==n.factor[r])return!1;return!0}function M(e,o){var t={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvSymbolAnchor:null,vvSymbolRotation:null},i=h(e);return e&&e.size?(t.vvSizeEnabled=!0,t.vvSizeMinSize=e.size.minSize,t.vvSizeMaxSize=e.size.maxSize,t.vvSizeOffset=e.size.offset,t.vvSizeFactor=e.size.factor):e&&i&&(t.vvSizeValue=o.transformation.scale),e&&i&&(t.vvSymbolAnchor=o.transformation.anchor,t.vvSymbolRotation=o.transformation.rotation),e&&e.color&&(t.vvColorEnabled=!0,t.vvColorValues=e.color.values,t.vvColorColors=e.color.colors),t}Object.defineProperty(o,"__esModule",{value:!0});var T=!1,F=!1;o.convertVisualVariables=x,o.initFastSymbolUpdatesState=C,o.updateFastSymbolUpdatesState=V,o.getMaterialParams=M;var w;!function(e){function o(e,o,t){return e<o?o:e>t?t:e}function t(e,t,n){if(!e.vvSizeEnabled)return n;if(r.set(n,a),i.computeObjectRotation(e.vvSymbolRotation[2],e.vvSymbolRotation[0],e.vvSymbolRotation[1],a),e.vvSizeEnabled){for(var l=0;l<3;++l){var u=e.vvSizeOffset[l]+t[0]*e.vvSizeFactor[l];s[l]=o(u,e.vvSizeMinSize[l],e.vvSizeMaxSize[l])}r.scale(a,s,a)}else r.scale(a,e.vvSizeValue,a);return r.translate(a,e.vvSymbolAnchor,a),a}var r=n.mat4d,l=n.vec3,a=r.create(),s=l.create();e.evaluateModelTransform=t}(w||(w={})),o.evaluateModelTransform=w.evaluateModelTransform});