// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../geometry/Point","../graphics/ElevationContext","../graphics/featureExpressionInfoUtils","../graphics/Graphics3DSymbolCommonCode","./I3SUtil","../../lib/glMatrix","../../support/geometryUtils","../../support/orientedBoundingBox","../../support/projectionUtils","../../webgl-engine/lib/Util"],function(e,t,i,s,r,o,n,a,c,h,p,d){return function(){function e(e,t,o,n,h,p,d,l){void 0===l&&(l={}),this.indexSR=e,this._renderCoordsHelper=t,this.extent=h,this.elevationProvider=p,this.options=l,this._computedOBBs={},this._computedMBSs={},this._isNodeVisibleCached={},this.fp=[],this._idleCamera=!0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=[0,0,0],this._tmp2=[0,0,0],this._tmp3=[0,0,0],this._tmp0=[0,0,0],this.supportedMetrics=["maxScreenThreshold","screenSpaceRelative","removedFeatureDiameter","distanceRangeFromDefaultCamera"],this.screenspaceErrorBias=l.screenspaceErrorBias||1,this.progressiveLoadFactor=l.progressiveLoadFactor||1,this.enableLoD=!l.disableLod;for(var u=0;u<8;++u)this.fp[u]=c.plane.create();this.updateCamera(o),this._poi=a.vec3d.create(n),this.engineSR=this._renderCoordsHelper.spatialReference,d?(this._elevationContext=new s,this._elevationContext.featureExpressionInfoContext=r.createContext(r.extractExpressionInfo(d,!1)),this._elevationContext.mixinApi(d)):this._elevationContext=null,this.tmpPoint=new i({x:0,y:0,z:0,spatialReference:e})}return e.prototype.updateCamera=function(e){d.matrixToFrustumPlanes(e.viewMatrix,e.projectionMatrix,this.fp),this._screenSizeFactor=1/e.perPixelRatio,this._camPos=e.eye,this._isNodeVisibleCached={}},e.prototype.updateNode=function(e){delete this._isNodeVisibleCached[e]},e.prototype.updatePointOfInterest=function(e){a.vec3d.set(e,this._poi),this.maxDistance=0},e.prototype.updateScreenSpaceErrorBias=function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t},e.prototype.setCameraIdle=function(e){this._idleCamera!==e&&(this._idleCamera=e,this._isNodeVisibleCached={})},e.prototype.updateExtent=function(e){this.extent=e,this._isNodeVisibleCached={}},e.prototype.computeMbs=function(e){var t=this._computedMBSs[e.id];return t||(t=a.vec4d.createFrom(e.mbs[0],e.mbs[1],e.mbs[2],-1),this._computedMBSs[e.id]=t),t[3]<0&&(a.vec4d.set(e.mbs,t),this._elevationContext&&t[3]<1e5&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=o.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),p.mbsToMbs(t,this.indexSR,t,this.engineSR)),t},e.prototype.computeObb=function(e){if(e.obb&&!(e.obb.halfSize[0]<0)){var t=this._computedOBBs[e.id];return t||(t=h.clone(e.obb),t.halfSize[0]=-1,this._computedOBBs[e.id]=t),t.halfSize[0]<0&&(t.halfSize[0]=e.obb.halfSize[0],a.vec3d.set(e.obb.center,t.center),this._elevationContext&&e.mbs[3]<1e5&&(this.tmpPoint.x=e.obb.center[0],this.tmpPoint.y=e.obb.center[1],this.tmpPoint.z=e.obb.center[2],t.center[2]=o.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),p.bufferToBuffer(t.center,this.indexSR,0,t.center,this.engineSR,0,1)),t}},e.prototype._isNodeVisible=function(e){var t=this.computeMbs(e);if(!this.isMBSinExtent(t))return!1;if(e.hasServiceOBB&&e.obb){var i=this.computeObb(e);return h.isVisible(i,this.fp)}return this.isMBSVisible(t)},e.prototype.isNodeVisible=function(e){return!this.enableLoD||(this._idleCamera?null!=this._isNodeVisibleCached[e.id]?this._isNodeVisibleCached[e.id]:(this._isNodeVisibleCached[e.id]=this._isNodeVisible(e),this._isNodeVisibleCached[e.id]):this._isNodeVisible(e))},e.prototype.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;if(e.hasServiceOBB)return!0;var t=this.computeObb(e);return!t||h.isVisible(t,this.fp)},e.prototype.invalidateCache=function(e){if(null==e){for(var t=0,i=Object.keys(this._computedMBSs);t<i.length;t++){var s=i[t];this._computedMBSs[s][3]=-1}for(var r=0,o=Object.keys(this._computedOBBs);r<o.length;r++){var s=o[r];this._computedOBBs[s].halfSize[0]=-1}}else this._computedMBSs[e]&&(this._computedMBSs[e][3]=-1),this._computedOBBs[e]&&(this._computedOBBs[e].halfSize[0]=-1)},e.prototype.isMBSinExtent=function(e){return!this.extent||0!==n.intersectBoundingBoxWithMbs(this.extent,e)},e.prototype.isMBSVisible=function(e){var t=e[0],i=e[1],s=e[2],r=e[3],o=this.fp;return o[0][0]*t+o[0][1]*i+o[0][2]*s+o[0][3]<=r&&o[1][0]*t+o[1][1]*i+o[1][2]*s+o[1][3]<=r&&o[2][0]*t+o[2][1]*i+o[2][2]*s+o[2][3]<=r&&o[3][0]*t+o[3][1]*i+o[3][2]*s+o[3][3]<=r&&o[4][0]*t+o[4][1]*i+o[4][2]*s+o[4][3]<=r&&o[5][0]*t+o[5][1]*i+o[5][2]*s+o[5][3]<=r},e.prototype.calcScreenSpaceSize=function(e,t){var i=this.computeMbs(e),s=i[3],r=a.vec3d.dist2(i,this._camPos)-s*s;return r<0?.5*Number.MAX_VALUE:t/Math.sqrt(r)*this._screenSizeFactor},e.prototype.calcCameraDistance=function(e){var t=this.computeMbs(e);return Math.max(0,a.vec3d.dist(t,this._camPos)-t[3])},e.prototype.calcAngleDependentLoD=function(e){var t=this.computeMbs(e),i=t[3],s=Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/a.vec3d.length(t),r=(s+i)/a.vec3d.dist(t,this._camPos);return Math.min(1,r)},e.prototype.hasLOD=function(e){return null!=e.lodSelection},e.prototype.hasFeatures=function(e){return null!=e.featureData},e.prototype.getDistancePlanarMode=function(e,t,i){var s=e[0]-t[0],r=e[1]-t[1],o=e[2]-t[2],n=s+s+r*r;if(n<=i*i)return Math.abs(o);var a=Math.sqrt(n)-i;return Math.sqrt(o*o+a*a)},e.prototype.getDistanceGlobeMode=function(e,t,i){var s=a.vec3d.length(t),r=a.vec3d.length(e)-s;if(a.vec3d.scale(e,a.vec3d.dot(e,t)/a.vec3d.length2(e),this._tmp0),a.vec3d.dist2(t,this._tmp0)<=i*i)return Math.abs(r);var o=a.vec3d.scale(t,1/s,this._tmp0),n=i,c=s,h=n*n/2/c,p=a.vec3d.scale(o,c-h,this._tmp1),d=e,l=a.vec3d.subtract(d,p,this._tmp2),u=a.vec3d.subtract(l,a.vec3d.scale(o,a.vec3d.dot(o,l),this._tmp3),this._tmp2),m=a.vec3d.add(p,a.vec3d.scale(u,n/a.vec3d.length(u),this._tmp2),this._tmp2),v=a.vec3d.dist(d,m);if(r>=2e5){var b=a.vec3d.subtract(d,m,this._tmp1),f=a.vec3d.dot(b,o)/a.vec3d.length(b);f<.08&&(f=1e-4),v/=f}return v},e.prototype.getDistance=function(e,t,i){return this.engineSR===p.SphericalECEFSpatialReference?this.getDistanceGlobeMode(e,t,i):this.getDistancePlanarMode(e,t,i)},e.prototype._selectErrorMetric=function(e){for(var t=0;t<e.length;t++)if(this.supportedMetrics.indexOf(e[t].metricType)>=0)return e[t];return null},e.prototype.getLodLevel=function(e){if(!e.lodSelection||e.lodSelection.length<=0||!1===this.hasFeatures(e))return 0;if(null==e.children||0===e.children.length)return this.maxLodLevel;var t=this.enableLoD?this._selectErrorMetric(e.lodSelection):null;if(null==t)return 0;if(this.progressiveLoadFactor<1){var i=this.progressiveLoadFactor*this.screenspaceErrorBias,s=this.screenspaceErrorBias;return this.evaluateLODmetric(e,i,t)?this.evaluateLODmetric(e,s,t)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias,t)?this.maxLodLevel:0},e.prototype.evaluateLODmetric=function(e,t,i){switch(i.metricType){case"screenSpaceRelative":var s=this.computeMbs(e),r=this.getDistance(this._camPos,s,s[3]),o=2*r/this._screenSizeFactor;return i.maxError*t<=o;case"maxScreenThreshold":var n=this.calcScreenSpaceSize(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(n*=this.calcAngleDependentLoD(e)),n<i.maxError;case"removedFeatureDiameter":return this.calcScreenSpaceSize(e,i.maxError)*t<10;case"distanceRangeFromDefaultCamera":return this.calcCameraDistance(e)>i.maxError*t}return!1},e.prototype.distToPOI=function(e){var t=this.computeMbs(e),i=a.vec3d.dist(t,this._poi)-t[3];return this.maxDistance=Math.max(this.maxDistance,i),i},e.prototype.distCameraToPOI=function(){return a.vec3d.dist(this._camPos,this._poi)},e}()});