// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","dojo/text!./PointCloudPointRenderer.xml","../../../../geometry/support/aaBoundingBox","../../support/geometryUtils","../../support/orientedBoundingBox","../../webgl-engine/lib/gl-matrix","../../webgl-engine/lib/RenderPass","../../../webgl/BufferObject","../../../webgl/Program","../../../webgl/VertexArrayObject"],function(e,t,i,r,n,o,s,a,d,c,l){function p(e){return e?256:64}function u(e,t,i,r,n){if(i.drawScreenSpace)return i.fixedSize*t*r;var o=p(n)*t*r;return i.drawFixedSize?Math.min(i.fixedSize/2,o):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*r,e/2),o):Math.min(e/2,o)}function h(e,t,i,r,n){return i.drawScreenSpace?0:u(e,t,i,r,n)}function f(e,t,i){return null==i&&(i=s.vec3d.create()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}var m={aPosition:0,aColor:1},_={positions:[{name:"aPosition",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"aColor",count:3,type:5121,offset:0,stride:3,normalized:!0}]};return function(){function e(){this.didRender=!1,this.needsRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._clipBox=r.create(r.POSITIVE_INFINITY),this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null,this.tempMatrix4=s.mat4.create(),this.tempVec3=s.vec3.create(),this.nodes=[]}return e.prototype.initializeRenderContext=function(e){e.shaderSnippets.fsPointCloudPointRenderer||e.shaderSnippets._parse(i);var t=e.shaderSnippets.vsPointCloudPointRenderer,r=e.shaderSnippets.fsPointCloudPointRenderer;this._programWorld=new c(e.rctx,t,r,m,[]),this._programScreen=new c(e.rctx,t,r,m,["DRAW_SCREEN_SIZE"]),this._programWorldDepth=new c(e.rctx,t,r,m,["DEPTH_PASS"]),this._programScreenDepth=new c(e.rctx,t,r,m,["DRAW_SCREEN_SIZE","DEPTH_PASS"]),this.needsRender=!0},e.prototype.uninitializeRenderContext=function(e){this._programWorld&&this._programWorld.dispose(),this._programScreen&&this._programScreen.dispose(),this._programWorldDepth&&this._programWorldDepth.dispose(),this._programScreenDepth&&this._programScreenDepth.dispose(),this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null},e.prototype.intersect=function(e,t,i,a){var d=s.vec3d.create(),c=s.vec3d.create(),l=s.vec3d.create(),p=s.vec3d.create(),m=n.plane.create(),_=e.camera.perPixelRatio,S=e.camera.near,g=this._getSizeParams();s.vec3d.subtract(i,t,c);var v=1/s.vec3d.length(c);s.vec3d.scale(c,v,c),s.vec3d.negate(c,l),s.vec4d.set4(c[0],c[1],c[2],-s.vec3d.dot(c,t),m);var x={},b={},z=r.create(),P=r.create(this._clipBox);r.offset(P,-t[0],-t[1],-t[2],P);for(var y=0,R=this.nodes;y<R.length;y++){var M=R[y],I=M.splatSize*this._scaleFactor,w=o.minimumDistancePlane(M.obb,m),D=o.maximumDistancePlane(M.obb,m);w-=h(I,w+S,g,_,M.isLeaf),D-=h(I,D+S,g,_,M.isLeaf);var F=D<0,U=null!=x.dist&&null!=b.dist&&x.dist<w*v&&b.dist>D*v;if(!F&&!U){var W=u(I,D+S,g,_,M.isLeaf);if(o.intersectLine(M.obb,t,c,W)){var E=W*W;o.toAaBoundingBox(M.obb,z),r.offset(z,-t[0],-t[1],-t[2],z);var C=!r.contains(P,z);s.vec3d.subtract(M.origin,t,p);for(var V=0;V<M.pointCount;V++)if(d[0]=p[0]+M.coordinates[3*V],d[1]=p[1]+M.coordinates[3*V+1],d[2]=p[2]+M.coordinates[3*V+2],!C||r.containsPoint(P,d)){var A=s.vec3d.dot(d,c),T=A+S,O=h(I,T,g,_,M.isLeaf);if(!(A-O<0)){var j=s.vec3d.length2(d)-A*A;if(!(j>E)){T-=O;var q=u(I,T,g,_,M.isLeaf);if(!(j>q*q)){var B=this.layerUid+"/"+M.id+"/"+V,L=(A-O)*v;(null==x.dist||L<x.dist)&&(x.point=f(M,V,x.point),x.dist=L,x.normal=l,x.pointId=B,x.layerUid=this.layerUid),(null==b.dist||L>b.dist)&&(b.point=f(M,V,b.point),b.dist=L,b.normal=l,b.pointId=B,b.layerUid=this.layerUid)}}}}}}}if(null!=x.dist){var N=e.getMinResult();if(null==N.dist||x.dist<N.dist){var H={type:"external",point:x.point,metadata:{pointId:x.pointId,layerUid:x.layerUid}};N.set(H,x.pointId,x.dist,x.normal,void 0),N.setIntersector("PointRenderer")}}if(null!=b.dist){var Y=e.getMaxResult();if(null==Y.dist||b.dist>Y.dist){var H={type:"external",point:b.point,metadata:{pointId:b.pointId,layerUid:b.layerUid}};Y.set(H,b.pointId,b.dist,b.normal,void 0),Y.setIntersector("PointRenderer")}}},e.prototype.render=function(e){if(e.pass!==a.MATERIAL&&e.pass!==a.MATERIAL_DEPTH)return!1;for(var t=e.pass===a.MATERIAL_DEPTH,i=e.rctx,n=0,o=this.nodes;n<o.length;n++){var d=o[n];null==d.vao&&this._initNode(e,d)}var c=this._getSizeParams(),l=t?c.drawScreenSpace?this._programScreenDepth:this._programWorldDepth:c.drawScreenSpace?this._programScreen:this._programWorld;if(null==l||0===this.nodes.length)return!0;var u=this._clipBox,h=!r.equals(u,r.POSITIVE_INFINITY,function(e,t){return e===t});h||(s.vec3.set3(-1/0,-1/0,-1/0,this.tempVec3),l.setUniform3fv("uClipMin",this.tempVec3),s.vec3.set3(1/0,1/0,1/0,this.tempVec3),l.setUniform3fv("uClipMax",this.tempVec3)),i.setDepthTestEnabled(!0),i.bindProgram(l);var f=e.camera.projectionMatrix;l.setUniformMatrix4fv("uProjectionMatrix",f),t&&l.setUniform2f("nearFar",e.camera.near,e.camera.far),c.drawFixedSize&&l.setUniform2f("uPointScale",c.fixedSize,e.camera.fullHeight);for(var m=0,_=this.nodes;m<_.length;m++){var d=_[m];if(l.setUniform2f("uScreenMinMaxSize",c.screenMinSize,p(d.isLeaf)),!c.drawFixedSize){var S=d.splatSize*this._scaleFactor;l.setUniform2f("uPointScale",S,e.camera.fullHeight)}var g=d.origin;h&&(s.vec3.set3(u[0]-g[0],u[1]-g[1],u[2]-g[2],this.tempVec3),l.setUniform3fv("uClipMin",this.tempVec3),s.vec3.set3(u[3]-g[0],u[4]-g[1],u[5]-g[2],this.tempVec3),l.setUniform3fv("uClipMax",this.tempVec3)),s.mat4.identity(this.tempMatrix4),s.mat4.translate(this.tempMatrix4,g,this.tempMatrix4),s.mat4.multiply(e.camera.viewMatrix,this.tempMatrix4,this.tempMatrix4),l.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),i.bindVAO(d.vao),i.drawArrays(0,0,d.pointCount)}return!0},Object.defineProperty(e.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sizePx",{get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clippingBox",{set:function(e){r.set(this._clipBox,e||r.POSITIVE_INFINITY)},enumerable:!0,configurable:!0}),e.prototype.addNode=function(e){this.nodes.push({id:e.id,splatSize:e.splatSize,obb:e.obb,origin:s.vec3.create(e.origin),coordinates:e.coordinates,pointCount:e.coordinates.length/3,rgb:e.rgb,vao:null,isLeaf:e.isLeaf}),this._requestRender()},e.prototype.removeNode=function(e){this.nodes=this.nodes.filter(function(t){return t.id===e&&t.vao&&(t.vao.dispose(!0),t.vao=null),t.id!==e}),this._requestRender()},e.prototype.removeAll=function(){this.nodes.forEach(function(e){e.vao&&(e.vao.dispose(!0),e.vao=null)}),this.nodes=[],this._requestRender()},e.prototype._initNode=function(e,t){var i=e.rctx;t.vao=new l(i,m,_,{positions:d.createVertex(i,35044,t.coordinates),colors:d.createVertex(i,35044,t.rgb)})},e.prototype._requestRender=function(){this.didRender=!1,this.needsRender=!0},e.prototype._getSizeParams=function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,i=t?this._sizePx:this._size,r=this._minSizePx;return e&&(r=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:i,screenMinSize:r}},e}()});