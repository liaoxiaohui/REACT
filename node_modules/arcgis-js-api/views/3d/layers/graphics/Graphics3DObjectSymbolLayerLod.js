// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/errors/CancelError","../../../../Color","../../../../core/lang","../../../../core/screenUtils","../../../../geometry/support/aaBoundingBox","../../../../symbols/ObjectSymbol3DLayer","./ElevationAligners","./Graphics3DLodInstanceGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./lodResourceUtils","./primitiveObjectSymbolUtils","../support/FastSymbolUpdates","../../lib/glMatrix","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Util","../../webgl-engine/lib/lodRendering/LodRenderer","../../webgl-engine/lib/lodRendering/LodResources","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,i,o,s,a,n,l,c,p,d,u,h,m,_,f,y,v,g,b,x,R,S){var P=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._instanceIndexToGraphicUid={},t}return r(t,e),Object.defineProperty(t.prototype,"lodRenderer",{get:function(){return this._lodRenderer},enumerable:!0,configurable:!0}),t.prototype._prepareResources=function(){var e=this.symbol,t=this._getStageIdHint();if(this._optionalFields=[],!this._isPropertyDriven("size")){var r=h.validateSymbolLayerSize(this.symbol);if(r)return this._logWarning(r),void this.reject()}if(e.resource&&e.resource.href)this._prepareModelResources(e.resource.href,t);else{var i=e.resource?e.resource.primitive:"sphere";this._preparePrimitiveResources(i,t)}},t.prototype._preparePrimitiveResources=function(e,t){if(!_.isValidPrimitive(e))return this._logWarning("Unknown object symbol primitive: "+e),void this.reject();var r=this.symbol,i=this._getMaterialOpacity(),l={specular:[0,0,0],opacity:i,transparent:i<1||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:U,diffuse:U},c=this.symbolContainer;if("point-3d"===c.type&&c.verticalOffset){var p=c.verticalOffset,d=p.screenLength,u=p.minWorldLength,m=p.maxWorldLength;l.verticalOffset={screenLength:a.pt2px(d),minWorldLength:u||0,maxWorldLength:null!=m?m:1/0},l.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(l.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._isPropertyDriven("color"))l.externalColor=L;else{var y=r.material?o.toUnitRGBA(r.material.color):L;l.externalColor=y}this._fastUpdates=f.initFastSymbolUpdatesState(this._context.renderer,!0,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(s.mixin(l,this._fastUpdates.materialParameters),l.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(l.instanced.push("color"),this._optionalFields.push("color"));var v=new S(l,t+"_objectmat");if(this._lodResources=_.primitiveLodResources(e,v,t),!this._lodResources)return this._logWarning("Unknown object symbol primitive: "+e),void this.reject();this._resourceBoundingBox=n.create(_.primitiveBoundingBox(e)),this._resourceSize=n.size(this._resourceBoundingBox),this._symbolSize=h.computeSizeWithResourceSize(this._resourceSize,r),this.finalizeSymbolResources(),this.initializeLodRenderer(),this.resolve()},t.prototype._prepareModelResources=function(e,t){var r=this,o=["transformation"],l={instanced:o},c={materialParamsMixin:l,idHint:t,streamDataSupplier:this._context.streamDataSupplier};this._fastUpdates=f.initFastSymbolUpdatesState(this._context.renderer,!0,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(s.mixin(c.materialParamsMixin,this._fastUpdates.materialParameters),o.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(o.push("color"),this._optionalFields.push("color"));var p=this.symbolContainer;if("point-3d"===p.type&&p.verticalOffset){var d=p.verticalOffset,u=d.screenLength,_=d.minWorldLength,y=d.maxWorldLength;c.materialParamsMixin.verticalOffset={screenLength:a.pt2px(u),minWorldLength:_||0,maxWorldLength:null!=y?y:1/0},c.materialParamsMixin.castShadows=!1}this._symbolLoaderPromise=m.fetchObjectLodResources(e,c),this._symbolLoaderPromise.then(function(e){if(r._symbolLoaderPromise=null,!r.isRejected()){m.fillEstimatedMinScreenSpaceRadius(e),r._lodResources=e;var t=r._context,i=r.symbol.material,o=r._getExternalColorParameters(i),s=r._getMaterialOpacity(),a=r._isPropertyDriven("opacity"),l=R.materialsFromLodResources(r._lodResources);r._originalOpacities=l.map(function(e){return e.getParameterValues().opacity||1}),l.forEach(function(e){var r=e.getParameterValues();e.setParameterValues(o);var i=r.opacity*s,n=i<1||a||r.transparent;e.setParameterValues({opacity:i,transparent:n}),t.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:t.sharedResources.screenSizePerspectiveSettings})}),r._resourceBoundingBox=R.computeBoundingBox(r._lodResources.levels[0]),r._resourceSize=n.size(r._resourceBoundingBox),r._pivotOffset=r._lodResources.levels[0].pivotOffset,r._symbolSize=h.computeSizeWithResourceSize(r._resourceSize,r.symbol),r.finalizeSymbolResources(),r.initializeLodRenderer(),f.updateFastSymbolUpdatesState(r._fastUpdates,r._context.renderer,r._fastVisualVariableConvertOptions())&&r._materials.forEach(function(e){return e.setParameterValues(r._fastUpdates.materialParameters)}),r.resolve()}},function(e){if(r._symbolLoaderPromise=null,!r.isFulfilled()){if(!(e instanceof i)){var t="ObjectSymbol3DLayer failed to load";e&&e.message&&(t+=" ("+e.message+")"),r._logWarning(t)}r.reject()}})},t.prototype.finalizeSymbolResources=function(){var e=this._context.stage;this._materials=R.materialsFromLodResources(this._lodResources),this._originalOpacities||(this._originalOpacities=this._materials.map(function(e){return e.getParameterValues().opacity||1})),this._materials.forEach(function(t){e.add(g.ModelContentType.MATERIAL,t)}),this._textures=R.texturesFromLodResources(this._lodResources),this._textures.forEach(function(t){e.add(g.ModelContentType.TEXTURE,t)}),this._geometries=R.geometriesFromLodResources(this._lodResources),this._geometries.forEach(function(t){e.add(g.ModelContentType.GEOMETRY,t)})},t.prototype.initializeLodRenderer=function(){var e=this,t=this._context.stage,r=function(t){return{layerUid:e._context.layer.uid,graphicUid:e._instanceIndexToGraphicUid[t]}};this._lodRenderer=new x.LodRenderer(this._lodResources,this._optionalFields,r),t.addExternalRenderer(this._lodRenderer.slots,this._lodRenderer)},t.prototype._getExternalColorParameters=function(e){var t={};return this._isPropertyDriven("color")?t.externalColor=L:e&&e.color?t.externalColor=o.toUnitRGBA(e.color):(t.externalColor=L,t.colorMixMode="ignore"),t},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._symbolLoaderPromise&&this._symbolLoaderPromise.cancel();var t=this._context.stage;this._lodRenderer&&(t.removeExternalRenderer(this._lodRenderer),this._lodRenderer.destroy()),this._materials&&this._materials.forEach(function(e){return t.remove(g.ModelContentType.MATERIAL,e.id)}),this._textures&&this._textures.forEach(function(e){return t.remove(g.ModelContentType.TEXTURE,e.id)}),this._geometries&&this._geometries.forEach(function(e){return t.remove(g.ModelContentType.GEOMETRY,e.id)})},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if(!this._validateGeometry(t.geometry))return null;var r=d.placePointOnGeometry(t.geometry);if(!r)return this._logWarning("unsupported geometry type for icon symbol: "+t.geometry.type),null;var i="graphic"+t.uid,o=this.getGraphicElevationContext(t),s=e.renderingInfo;return this._createAs3DShape(t,r,s,o,i,t.uid)},t.prototype.notifyDestroyGraphicLayer=function(e){delete this._instanceIndexToGraphicUid[e.instanceIndex]},t.prototype.graphicLayerToGraphicId=function(e){return 0},t.prototype.layerPropertyChanged=function(e,t,r){var i=this;if("opacity"===e){var o=this._isPropertyDriven("opacity");return this._materials.forEach(function(e,t){var r=i._getMaterialOpacity()*i._originalOpacities[t];e.setParameterValues({opacity:r,transparent:r<1||o})}),!0}if("elevationInfo"===e){this._updateElevationContext();for(var s in t){var a=t[s],n=r(a);if(n){var l=a.graphic,c=this.getGraphicElevationContext(l);n.needsElevationUpdates=d.needsElevationUpdates3D(c.mode),n.elevationContext.set(c)}}return!0}return!1},t.prototype.applyRendererDiff=function(e,t,r,i){var o=this;for(var s in e.diff)switch(s){case"visualVariables":if(!f.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;this._materials.forEach(function(e){return e.setParameterValues(o._fastUpdates.materialParameters)});break;default:return!1}return!0},Object.defineProperty(t.prototype,"numberOfVertices",{get:function(){return R.geometriesFromLodLevelResources(this._lodResources.levels[0]).reduce(function(e,t){return e+t.data.getIndices(b.VertexAttrConstants.POSITION).length},0)},enumerable:!0,configurable:!0}),t.prototype._createAs3DShape=function(e,t,r,i,o,s){var a=this.getFastUpdateAttrValues(e),n=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?h.mixinColorAndOpacity(r.color,r.opacity):null,l=this._context.clippingExtent;if(v.pointToVector(t,O,this._context.elevationProvider.spatialReference),l&&!d.pointInBox2D(O,l))return null;v.pointToVector(t,O,this._context.renderSpatialReference);var u="absolute-height"!==i.mode,m=d.computeElevation(this._context.elevationProvider,t,i,this._context.renderCoordsHelper,u?B:null),_=C,f=z;y.mat4d.identity(C),this._applyObjectRotation(r,_),this._applyObjectRotation(this.symbol,_),this._applyObjectScale(r,_),this._applyAnchor(_),O[0]=t.x,O[1]=t.y,O[2]=m,v.computeLinearTransformation(t.spatialReference,O,f,this._context.renderSpatialReference)||console.warn("Could not locate symbol object properly, it might be misplaced");var g=this._lodRenderer.instanceData;y.mat4d.multiply(f,_,f);var b=g.addInstance();this._instanceIndexToGraphicUid[b]=s,g.setTransform(b,f),a&&g.setFeatureAttribute(b,a),n&&g.setColor(b,n);var x=c.perLodInstanceElevationAligner,R=new p(this,b,x,i);return u&&(R.alignedTerrainElevation=B.terrainElevation),R.needsElevationUpdates=d.needsElevationUpdates3D(i.mode),d.extendPointGraphicElevationContext(R,t,this._context.elevationProvider),R},t.prototype._applyObjectScale=function(e,t){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var r=this._isPropertyDriven("size")&&e.size?e.size:this._symbolSize,i=h.computeObjectScale(r,this._symbolSize,this._resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||y.mat4d.scale(t,i)}},t.prototype._applyObjectRotation=function(e,t){if(!(this._fastUpdates.enabled&&this._fastUpdates.customTransformation&&e instanceof l))return h.computeObjectRotation(e.heading,e.tilt,e.roll,t)},t.prototype._computeAnchor=function(){switch(this.symbol.anchor){case"center":return y.vec3d.scale(n.center(this._resourceBoundingBox),-1);case"top":var e=n.center(this._resourceBoundingBox);return[-e[0],-e[1],-this._resourceBoundingBox[5]];case"bottom":var e=n.center(this._resourceBoundingBox);return[-e[0],-e[1],-this._resourceBoundingBox[2]];case"origin":default:return this._pivotOffset?y.vec3d.scale(this._pivotOffset,-1,new Array(3)):E}},t.prototype._applyAnchor=function(e){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var t=this._computeAnchor();t&&y.mat4d.translate(e,t)}},t.prototype._hasPerInstanceColor=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")},t.prototype._fastVisualVariableConvertOptions=function(){var e=this._resourceBoundingBox?n.size(this._resourceBoundingBox):U,t=this._resourceBoundingBox?this._computeAnchor():E,r=this._context.renderCoordsHelper.unitInMeters,i=h.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,r),o=[this.symbol.tilt||0,this.symbol.roll||0,this.symbol.heading||0];return{modelSize:e,symbolSize:this._symbolSize||U,unitInMeters:r,transformation:{anchor:t,scale:i,rotation:o}}},t}(u),U=[1,1,1],L=[1,1,1,1],E=[0,0,0],O=y.vec3d.create(),C=y.mat4d.create(),z=y.mat4d.create(),B={verticalDistanceToGround:0,terrainElevation:0};return P});