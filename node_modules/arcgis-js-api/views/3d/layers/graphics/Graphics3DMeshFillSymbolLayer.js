// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../Color","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/MeshComponent","../../../../geometry/support/webMercatorUtils","../../../../geometry/support/meshUtils/projection","./ElevationAligners","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","../support/edgeUtils","../support/symbolColorUtils","../../lib/glMatrix","../../support/debugFlags","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Texture","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/NativeLineMaterial"],function(e,t,r,a,o,i,n,s,l,c,u,p,m,h,f,d,v,g,_,y,b,x,C,O,w){var A=C.VertexAttrConstants,M=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._edgeStageObjects=new Set,t._materials={},t._textures={},t}return r(t,e),t.prototype._prepareResources=function(){d.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new w({color:[1,0,1,1]},"debugVertexNormal"),this._debugFaceNormalMaterial=new w({color:[0,1,1,1]},"debugFAceNormal")),this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject();for(var t in this._materials){var r=this._materials[t];this._context.stage.remove(g.ModelContentType.MATERIAL,r.material.id)}for(var t in this._textures){var a=this._textures[t];this._context.stage.remove(g.ModelContentType.TEXTURE,a.id)}this._materials={},this._textures={}},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if("mesh"!==t.geometry.type)return this._logWarning("unsupported geometry type for fill on mesh-3d symbol: "+t.geometry.type),null;if(!this._validateGeometry(t.geometry))return null;var r="graphic"+t.uid,a=this.getGraphicElevationContext(t),o=e.renderingInfo;return this._createAs3DShape(t,o,a,r,t.uid)},t.prototype.layerPropertyChanged=function(e,t,r){if("opacity"===e){var a=this._getLayerOpacity();for(var o in this._materials){var i=this._materials[o];i.material.setParameterValues({layerOpacity:a});var n=i.material.getParameterValues();this._setMaterialTransparentParameter(n),i.material.setParameterValues({transparent:n.transparent})}if(this._edgeStageObjects.size>0){var s=this._context.stage.view.getEdgeView(),l=this._getLayerOpacity();this._edgeStageObjects.forEach(function(e){s.updateAllComponentOpacities(e,[l])})}return!0}if("elevationInfo"===e){this._updateElevationContext();for(var c in t){var p=t[c],m=r(p);if(m){var h=p.graphic,f=this.getGraphicElevationContext(h);m.needsElevationUpdates=u.needsElevationUpdates3D(f.mode),m.elevationContext.set(f)}}return!0}return!1},Object.defineProperty(t.prototype,"numberOfVertices",{get:function(){return 0},enumerable:!0,configurable:!0}),t.prototype._requiresVertexColors=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")},t.prototype._colorUid=function(e){var t=e.material&&e.material.color;if(!t)return"-";if(t)switch(t.type){case"value":return t.value.toHex();case"image":return t.uid}},t.prototype._materialProperties=function(e,t){var r=this._requiresVertexColors();return{hasVertexColors:r,color:t.material&&t.material.color,uid:"vc:"+r+",cmuid:"+this._colorUid(t)}},t.prototype._setInternalColorValueParameters=function(e,t){t.diffuse=a.toUnitRGB(e.value),t.opacity=e.value.a},t.prototype._setInternalColorImageParameters=function(e,t,r){var a=e.url;if(a){var o=this._textures[e.uid];o||(o=new x(a,t+"_"+e.uid+"_tex",{mipmap:!0,wrapClamp:!1,noUnpackFlip:!0}),this._textures[e.uid]=o,this._context.stage.add(g.ModelContentType.TEXTURE,o)),r.textureId=o.id}},t.prototype._setInternalMaterialParameters=function(e,t,r){var a=e.material&&e.material.color;if(a)switch(a.type){case"value":this._setInternalColorValueParameters(a,r);break;case"image":this._setInternalColorImageParameters(a,t,r)}},t.prototype._setExternalMaterialParameters=function(e){if(this._isPropertyDriven("color"))e.externalColor=I;else{var t=this.symbol.material?a.toUnitRGBA(this.symbol.material.color):I;e.externalColor=t}var r=this.symbol.material&&this.symbol.material.colorMixMode;r&&(e.colorMixMode=r)},t.prototype._getOrCreateMaterial=function(e,t){var r=this._materialProperties(e,t),a=this._materials[r.uid];if(a)return a.material;var o=this._getStageIdHint(),i={specular:S,symbolColors:r.hasVertexColors,ambient:S,diffuse:N,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:"none",layerOpacity:this._getLayerOpacity()};this._setInternalMaterialParameters(t,o,i),this._setExternalMaterialParameters(i),this._setMaterialTransparentParameter(i);var n=new O(i,o+"_"+r.uid+"_mat"),s=t.material&&t.material.color&&"value"===t.material.color.type&&t.material.color.value,l=s?s.a:1;return this._materials[r.uid]={geometryOpacity:l,material:n},this._context.stage.add(g.ModelContentType.MATERIAL,n),n},t.prototype._setMaterialTransparentParameter=function(e){this._isPropertyDriven("opacity")&&(e.transparent=!0),e.transparent=e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1},t.prototype._addDebugNormals=function(e,t,r,a){for(var o,i,n,s,l=t.length,c=e.spatialReference.isWGS84?20015077/180:1,u=.1*Math.max(e.extent.width*c,e.extent.height*c,e.extent.zmax-e.extent.zmin),p=[],m=[],h=[],d=[],v=0;v<l;v++)for(var g=t[v],b=g.data.getAttribute(A.POSITION),x=g.data.getAttribute(A.NORMAL),C=g.data.getIndices(A.POSITION),O=g.data.getIndices(A.NORMAL),w=b.data,M=x.data,N=0;N<C.length;N++){for(var I=3*C[N],S=3*O[N],P=0;P<3;P++)p.push(w[I+P]);for(var P=0;P<3;P++)p.push(w[I+P]+M[S+P]*u);if(m.push(m.length),m.push(m.length),N%3==0){this._calculateFaceNormal(w,C,N,U),this._getFaceVertices(w,C,N,F,E,T),f.vec3d.add(F,E),f.vec3d.add(F,T),f.vec3d.scale(F,1/3);for(var P=0;P<3;P++)h.push(F[P]);for(var P=0;P<3;P++)h.push(F[P]+U[P]*u);d.push(d.length),d.push(d.length)}}var R=(o={},o[A.POSITION]={data:new Float64Array(p),size:3},o),V=(i={},i[A.POSITION]=new Uint32Array(m),i),B=new y(R,V,void 0,"line"),j=new _(B,"debugVertexNormal");j.singleUse=!0,t.push(j),r.push([this._debugVertexNormalMaterial]),a.push(f.mat4d.create(a[0]));var R=(n={},n[A.POSITION]={data:new Float64Array(h),size:3},n),V=(s={},s[A.POSITION]=new Uint32Array(d),s),B=new y(R,V,void 0,"line"),j=new _(B,"debugFaceNormal");j.singleUse=!0,t.push(j),r.push([this._debugFaceNormalMaterial]),a.push(f.mat4d.create(a[0]))},t.prototype._createAs3DShape=function(e,t,r,a,o){var i=this,n=e.geometry;if("mesh"!==n.type)return null;var s=this._createGeometryInfo(n,t,a);if(!s)return null;var p=s.geometries,h=s.materials,f=s.transformations,v=s.objectTransformation;d.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,p,h,f);var g=new b({geometries:p,materials:h,transformations:f,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:o},idHint:a});g.setObjectTransformation(v);var _=function(e){var t=i._context.stage.view.getEdgeView();if(t){t.removeObject(e),i._edgeStageObjects.delete(e);var r=m.createMaterial(t,i.symbol,i._getLayerOpacity());r&&(i._edgeStageObjects.add(e),t.addObject(e,[r],{mergeGeometries:!0}))}};_(g);var y=function(e,t,r,a,o){var i=l.perObjectElevationAligner(e,t,r,a,o);return _(g),i},x=new c(this,g,p,null,null,y,r);x.needsElevationUpdates=u.needsElevationUpdates3D(r.mode);var C=n.extent.center.clone();return C.z=0,x.elevationContext.centerPointInElevationSR=C,x.alignedTerrainElevation=y(x,x.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper,this._context.featureExpressionInfoContext),x},t.prototype._createComponentNormals=function(e,t,r,a){var o=r.shading||"flat";switch(o){case"source":return this._createComponentNormalsSource(e,t,r,a);case"flat":return this._createComponentNormalsFlat(e,r,a);case"smooth":return this._createComponentNormalsSmooth(e,r,a)}},t.prototype._createComponentNormalsSource=function(e,t,r,a){if(!t)return this._createComponentNormalsFlat(e,r,a);for(var o=!1,i=0;i<a.length;i+=3){this._calculateFaceNormal(e,a,i,U);for(var n=0;n<3;n++){var s=3*a[i+n];F[0]=t[s+0],F[1]=t[s+1],F[2]=t[s+2],f.vec3d.dot(U,F)<0&&(t[s+0]=-t[s+0],t[s+1]=-t[s+1],t[s+2]=-t[s+2],o=!0)}}return{normals:t,indices:a,didFlipNormals:o}},t.prototype._createComponentNormalsFlat=function(e,t,r){for(var a=new Float32Array(r.length),o=new Uint32Array(3*r.length),i=0;i<r.length;i+=3)for(var n=this._calculateFaceNormal(e,r,i,U),s=0;s<3;s++)a[i+s]=n[s],o[i+s]=i/3;return{normals:a,indices:o,didFlipNormals:!1}},t.prototype._createComponentNormalsSmooth=function(e,t,r){for(var a={},o=0;o<r.length;o+=3)for(var i=this._calculateFaceNormal(e,r,o,U),n=0;n<3;n++){var s=r[o+n],l=a[s];l||(l={normal:f.vec3d.create(),count:0},a[s]=l),f.vec3d.add(l.normal,i),l.count++}for(var c=new Float32Array(3*r.length),u=new Uint32Array(3*r.length),o=0;o<r.length;o++){var s=r[o],l=a[s];1!==l.count&&(f.vec3d.normalize(f.vec3d.scale(l.normal,1/l.count)),l.count=1);for(var n=0;n<3;n++)c[3*o+n]=l.normal[n];u[o]=o}return{normals:c,indices:u,didFlipNormals:!1}},t.prototype._getFaceVertices=function(e,t,r,a,o,i){var n=3*t[r+0],s=3*t[r+1],l=3*t[r+2];a[0]=e[n+0],a[1]=e[n+1],a[2]=e[n+2],o[0]=e[s+0],o[1]=e[s+1],o[2]=e[s+2],i[0]=e[l+0],i[1]=e[l+1],i[2]=e[l+2]},t.prototype._calculateFaceNormal=function(e,t,r,a){return this._getFaceVertices(e,t,r,F,E,T),f.vec3d.subtract(E,F),f.vec3d.subtract(T,F),f.vec3d.cross(E,T,F),f.vec3d.normalize(F,a),a},t.prototype._getOrCreateComponents=function(e){return e.components?e.components:j},t.prototype._createPositionBuffer=function(e){var t=e.vertexAttributes.position,r=new Float64Array(t.length),a=this._context.renderSpatialReference;return u.reproject(e.vertexAttributes.position,0,e.spatialReference,r,0,a,t.length/3),r},t.prototype._createNormalBuffer=function(e,t){var r=e.vertexAttributes.normal;if(!r)return null;if("local"===this._context.layerView.view.viewingMode)return r;var a=e.vertexAttributes.position,o=new Float32Array(r.length);return s.projectNormalToECEF(r,a,t,e.spatialReference,o)},t.prototype._createColorBuffer=function(e){if(this._requiresVertexColors()){var t=this._getVertexOpacityAndColor(e),r=this.symbol.material&&this.symbol.material.colorMixMode||null,a=new Uint8Array(4);return h.encodeSymbolColor(t,r,a),a}return null},t.prototype._createColorIndices=function(e,t){for(var r=new Uint32Array(t.length),a=0;a<r.length;a++)r[a]=0;return r},t.prototype._createBuffers=function(e,t){var r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return this._logWarning("Mesh geometry must contain position vertex attributes"),null;var a=e.vertexAttributes.normal,o=e.vertexAttributes.uv;if(a&&a.length!==r.length)return this._logWarning("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(o&&o.length/2!=r.length/3)return this._logWarning("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;var i=this._createPositionBuffer(e),n=this._createColorBuffer(t),s=this._createNormalBuffer(e,i);return{positionBuffer:i,normalBuffer:s,uvBuffer:o,colorBuffer:n,objectTransformation:this._transformCenterLocal(e,i,s)}},t.prototype._transformCenterLocal=function(e,t,r){var a=e.extent.center,o=this._context.renderSpatialReference;P[0]=a.x,P[1]=a.y,P[2]=0;var i=f.mat4d.create();v.computeLinearTransformation(e.spatialReference,P,i,o),f.mat4d.inverse(i,R);for(var n=0;n<t.length;n+=3)F[0]=t[n+0],F[1]=t[n+1],F[2]=t[n+2],f.mat4d.multiplyVec3(R,F),t[n+0]=F[0],t[n+1]=F[1],t[n+2]=F[2];if(r){f.mat4d.toMat3(i,V),f.mat3d.transpose(V,V);for(var n=0;n<r.length;n+=3)F[0]=r[n+0],F[1]=r[n+1],F[2]=r[n+2],f.mat3d.multiplyVec3(V,F),r[n+0]=F[0],r[n+1]=F[1],r[n+2]=F[2]}return i},t.prototype._validateFaces=function(e,t){var r=e.vertexAttributes.position.length/3,a=t.faces;if(a){for(var o=-1,i=0;i<a.length;i++){var n=a[i];n>o&&(o=n)}if(r<=o)return this._logWarning("Vertex index "+o+" is out of bounds of the mesh position buffer"),!1}else if(r%3!=0)return this._logWarning("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0},t.prototype._getOrCreateFaces=function(e,t){if(t.faces)return t.faces;for(var r=new Uint32Array(e.vertexAttributes.position.length/3),a=0;a<r.length;a++)r[a]=a;return r},t.prototype._isOutsideClippingArea=function(e){if(!this._context.clippingExtent)return!1;var t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;var r,a=this._context.elevationProvider.spatialReference,o=t.length/3;return e.spatialReference.equals(a)?r=t:(r=new Float64Array(t.length),u.reproject(e.vertexAttributes.position,0,e.spatialReference,r,0,a,o)),u.computeBoundingBox(r,0,o,B),u.boundingBoxClipped(B,this._context.clippingExtent)},t.prototype._createGeometryInfo=function(e,t,r){var a,o;if(!n.canProject(e,this._context.layerView.view.spatialReference))return this._logWarning("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;var i=this._createBuffers(e,t);if(!i)return null;for(var s=i.positionBuffer,l=i.uvBuffer,c=i.colorBuffer,u=i.normalBuffer,p=i.objectTransformation,m=this._getOrCreateComponents(e),h=[],d=[],v=[],g=!1,b=0,x=m;b<x.length;b++){var C=x[b];if(!this._validateFaces(e,C))return null;var O=this._getOrCreateFaces(e,C);if(0!==O.length){var w=this._createComponentNormals(s,u,C,O);w.didFlipNormals&&(g=!0);var M=(a={},a[A.POSITION]={size:3,data:s},a[A.NORMAL]={size:3,data:w.normals},a),N=(o={},o[A.POSITION]=O,o[A.NORMAL]=w.indices,o);c&&(M[A.SYMBOLCOLOR]={size:4,data:c},N[A.SYMBOLCOLOR]=this._createColorIndices(C,O)),e.vertexAttributes.uv&&(M[A.UV0]={size:2,data:l},N[A.UV0]=O);var I=new y(M,N),S=new _(I,r+"_mesh");S.singleUse=!0,h.push(S),d.push(f.mat4d.identity()),v.push([this._getOrCreateMaterial(e,C)])}}return g&&this._logWarning("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:h,transformations:d,materials:v,objectTransformation:p}},t}(p),N=[1,1,1],I=[1,1,1,1],S=[0,0,0],P=f.vec3d.create(),F=f.vec3d.create(),E=f.vec3d.create(),T=f.vec3d.create(),U=f.vec3d.create(),R=f.mat4d.create(),V=f.mat3d.create(),B=o.create(),j=[new i];return M});