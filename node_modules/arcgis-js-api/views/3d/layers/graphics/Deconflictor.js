// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/Handles","../../../../core/Logger","../../../../core/now","../../../../core/PooledArray","../../../../geometry/support/aaBoundingRect","./deconflictorDebug","../../lib/glMatrix","../../support/ResourceController","../../webgl-engine/lib/screenSizePerspectiveUtils","../../webgl-engine/lib/Util","../../webgl-engine/materials/HUDMaterial","../../webgl-engine/materials/internal/MaterialUtil"],function(i,t,e,s,c,r,n,a,o,l,h,p,f,u,g){function d(i){return!!i&&"selection"===i.type}var b,y=l.vec2d,v=l.vec4d,I=f.VertexAttrConstants,m=c.getLogger("esri.views.3d.graphics.Deconflictor"),x=v.create(),w=v.create(),G=v.create(),B=v.create(),O=a.create(),M=a.create(),D=new Set,S=f.lerp,T=function(){function i(i,t){this.creator=i,this.disposer=t,this.list=[],this.currentIndex=0}return i.prototype.alloc=function(){for(var i=[],t=0;t<arguments.length;t++)i[t]=arguments[t];return this.currentIndex>=this.list.length&&this.list.push(new this.creator(i)),this.list[this.currentIndex++]},i.prototype.freeAll=function(){for(var i=this.currentIndex,t=this.disposer,e=this.list;--i>=0;)t(e[i]);this.currentIndex=0},i}(),P=function(){function i(){this.graphics3DGraphic=null,this.xMin=0,this.xMax=0,this.yMin=0,this.yMax=0,this.posView=0,this.graphicsOwner=null,this.id=0}return i.release=function(i){i.graphics3DGraphic=null,i.graphicsOwner=null},i.copyMetadata=function(i,t){return t.graphics3DGraphic=i.graphics3DGraphic,t.graphicsOwner=i.graphicsOwner,t.iconDeconflictionEnabled=i.iconDeconflictionEnabled,t.labelDeconflictionEnabled=i.labelDeconflictionEnabled,t},i}();!function(i){i[i.Idle=0]="Idle",i[i.Collect=1]="Collect",i[i.Process=2]="Process",i[i.SortIcons=3]="SortIcons",i[i.SortLabels=4]="SortLabels",i[i.Deconflict=5]="Deconflict"}(b||(b={}));var V=function(){function i(i){var t=this;this.graphicsOwners=[],this.lastRunTimestamp=0,this.nextRunTimestamp=Number.POSITIVE_INFINITY,this.syncBudget=null,this.state=b.Idle,this.collectIndex=0,this.collectGraphics=null,this.collectGraphicsIndex=0,this.handles=new s,this.graphicInfosToProcess=new n,this.graphicInfoPool=new T(P,P.release),this.nextGraphicInfoId=0,this.visibleObjects={icons:new n,labels:new n},this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0,this.iconMarginFactor=-.1,this.view=i,this.handles.add([i.watch("state.camera",function(){t.setDirty({async:!0,forceMaxIntervalRun:!0})})]),this.frameWorker=i.resourceController.registerFrameWorker(function(i){return t.run(i)})}return i.prototype.destroy=function(){this.handles.destroy(),this.handles=null,this.graphicInfoPool.freeAll(),this.graphicInfoPool=null,this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null),this.view=null},i.prototype.addGraphicsOwner=function(i){var t=this;this.graphicsOwners.push(i),this.setDirty(),i.layer&&"function"==typeof i.layer.watch&&i.layer.watch("featureReduction",function(e,s){d(e)?(t._setIconVisibilityFlags(i,!1),t.setDirty()):d(s)&&(t._setIconVisibilityFlags(i,void 0),t.setDirty())})},i.prototype.removeGraphicsOwner=function(i){var t=this.graphicsOwners.indexOf(i);t>=0&&this.graphicsOwners.splice(t,1),this.setDirty()},Object.defineProperty(i.prototype,"isDirty",{get:function(){return this.nextRunTimestamp!==Number.POSITIVE_INFINITY},enumerable:!0,configurable:!0}),i.prototype.setDirty=function(i){var t=!i||i.async,e=!!i&&i.forceMaxIntervalRun;this.state!==b.Idle&&(this.state=b.Idle);var s=r();e&&s-this.lastRunTimestamp>1e3?(this.lastRunTimestamp=s,this.nextRunTimestamp=s):this.nextRunTimestamp=s+200,t||this.syncBudget||(this.syncBudget=new h.Budget(r),this.syncBudget.enabled=!1)},i.prototype.setClean=function(){this.graphicInfoPool.freeAll(),this.graphicInfosToProcess.clear(),this.nextGraphicInfoId=0,this.state=b.Idle,this.lastRunTimestamp=r(),this.nextRunTimestamp=Number.POSITIVE_INFINITY,this.syncBudget=null},i.prototype.setInitialIconVisibilityFlag=function(i,t){var e=!d(i?i.featureReduction:null);t.setVisibilityFlag(2,e)},i.prototype.doesIntersectExistingPoly=function(i){var t=i.graphics3DGraphic.graphic.uid;D.clear();for(var e=Math.floor(i.xMin/this.accBinsSizeX);e<=Math.floor(i.xMax/this.accBinsSizeX);e++)if(!(e<0||e>=this.accBinsNumX))for(var s=Math.floor(i.yMin/this.accBinsSizeY);s<=Math.floor(i.yMax/this.accBinsSizeY);s++)if(!(s<0||s>=this.accBinsNumY))for(var c=this.accBins[e][s],r=0;r<c.length;r++){var n=c.data[r];if(n.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,!(n.xMin>i.xMax||n.xMax<i.xMin||n.yMin>i.yMax||n.yMax<i.yMin)))return!0}return!1},i.prototype.initBins=function(i,t){if(null==this.accBins){this.accBins=[];for(var e=0;e<this.accBinsNumX;e++){this.accBins.push([]);for(var s=this.accBins[this.accBins.length-1],c=0;c<this.accBinsNumY;c++)s.push(new n({initialSize:10}))}}for(var e=0;e<this.accBinsNumX;e++)for(var c=0;c<this.accBinsNumY;c++)this.accBins[e][c].clear();this.accBinsSizeX=i/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0},i.prototype.addToBins=function(i){for(var t=Math.floor(i.xMin/this.accBinsSizeX);t<=Math.floor(i.xMax/this.accBinsSizeX);t++)if(!(t<0||t>=this.accBinsNumX))for(var e=Math.floor(i.yMin/this.accBinsSizeY);e<=Math.floor(i.yMax/this.accBinsSizeY);e++)e<0||e>=this.accBinsNumY||this.accBins[t][e].push(i)},i.prototype.run=function(i){if(this.view.ready&&!(i.now()<this.nextRunTimestamp))switch(o.prepare(this.view),this.syncBudget&&(i=this.syncBudget),this.state){case b.Idle:this.collectIndex=0,this.collectGraphics=null,this.visibleObjects.icons.clear(),this.visibleObjects.labels.clear(),this.graphicInfosToProcess.clear();case b.Collect:if(this.state=b.Collect,!this._collectVisibleObjects(i))return;if(0===this.graphicInfosToProcess.length)return void this.setClean();case b.Process:if(this.state=b.Process,i.done())return;for(;this.graphicInfosToProcess.length&&!i.done();)this._processVisibleObject(this.graphicInfosToProcess.pop());if(this.graphicInfosToProcess.length>0)return;case b.SortIcons:if(this.state=b.SortIcons,i.done())return;this.visibleObjects.icons.sort(function(i,t){return i.posView-t.posView});case b.SortLabels:if(this.state=b.SortLabels,i.done())return;this.visibleObjects.labels.sort(function(i,t){return i.posView-t.posView});case b.Deconflict:if(this.state=b.Deconflict,i.done())return;this._deconflictVisibleObjects(this.visibleObjects.icons,!1,i),this.visibleObjects.labels.length&&this._deconflictVisibleObjects(this.visibleObjects.labels,!0,i),o.drawAccelerationStruct(this,this.visibleObjects.icons),o.drawAccelerationStruct(this,this.visibleObjects.labels),0===this.visibleObjects.icons.length&&0===this.visibleObjects.labels.length&&this.setClean()}},i.prototype._collectVisibleObjects=function(i){for(var t=this.view.state.camera,e=t.fullWidth,s=t.fullHeight;this.collectIndex<this.graphicsOwners.length;++this.collectIndex){var c=this.graphicsOwners[this.collectIndex],r=c.graphics3DGraphics;if(r){var n=c.labelsEnabled,a=d(c.layer?c.layer.featureReduction:null);if((n||a)&&(this.collectGraphics||(this.collectGraphics=c.graphics3DGraphicsKeys,this.collectGraphicsIndex=0),this.collectGraphics)){if(this.collectGraphics!==c.graphics3DGraphicsKeys)return this.collectIndex=0,this.collectGraphics=null,!1;for(;this.collectGraphicsIndex<this.collectGraphics.length&&!i.done();++this.collectGraphicsIndex){var o=r[this.collectGraphics[this.collectGraphicsIndex]];if(o&&o.areVisibilityFlagsSet(void 0,2)){var l=this.graphicInfoPool.alloc();l.id=this.nextGraphicInfoId++,l.graphicsOwner=c,l.graphics3DGraphic=o,l.iconDeconflictionEnabled=a,l.labelDeconflictionEnabled=n,this.graphicInfosToProcess.push(l)}}this.collectGraphicsIndex>=this.collectGraphics.length&&(this.collectGraphics=null)}}}return this.collectIndex!==this.graphicsOwners.length||this.collectGraphics?(this.collectGraphics&&--this.collectIndex,!1):(this.collectIndex=0,0===this.graphicInfosToProcess.length||(this.initBins(e,s),!0))},i.prototype._processVisibleObject=function(i){var t=this.view.state.camera;if(i.iconDeconflictionEnabled&&this._collectGraphics(i,t,0),i.labelDeconflictionEnabled){var e=i.iconDeconflictionEnabled?P.copyMetadata(i,this.graphicInfoPool.alloc()):i;e.id=this.nextGraphicInfoId++,this._collectGraphics(e,t,1)}},i.prototype._collectGraphics=function(i,t,e){var s=i.graphics3DGraphic,c=i.graphicsOwner,r=1===e,n=r?this.visibleObjects.labels:this.visibleObjects.icons,o=r?s._labelGraphics:s._graphics,l=r?0:this.iconMarginFactor;if(o.length){for(var h,f,d=a.empty(O),b=0,y=o;b<y.length;b++){var v=y[b];if(v&&"object3d"===v.type){var D=v.stageObject,T=D?D.getNumGeometryRecords():0;if(!(T<1)){var P=D.getGeometryRecord(0),V=P.materials[0];if(V instanceof u)if(T>1)m.warn("Graphic objects with more than 1 geometry record are not supported");else{var R=P.geometry.getData(),_=R.getVertexAttr();if(!f){var z=D.getCenter(),F=P.origin.vec3;g.transformToWorld(z,F,x),g.transformToView(x,F,t.viewMatrix,w);var E=_[I.NORMAL].data;V.applyVerticalOffsetTransformation(w,E,D.objectTransformation,t,j);var Y=_[I.AUXPOS1].data,A="screen"!==V.getParams().centerOffsetUnits,X=A?Y:[0,0,0];g.transformToProjection(w,t.projectionMatrix,X,G),f=g.transformToNDC(G,B),A||(f[0]+=Y[0]/t.fullWidth*2,f[1]+=Y[1]/t.fullHeight*2);var C=f[0]<-1||f[1]<-1||f[2]<-1||f[0]>=1||f[1]>=1;if(C)break;h=w[2],s.areVisibilityFlagsSet(2,void 0,e)&&(h*=.7)}var W=v.getScreenSize(N);p.applyPrecomputedScaleFactorVec2(W,j.factor,W);var L=a.offset(V.calculateRelativeScreenBounds(W,j.scaleAlignment,M),S(0,t.fullWidth,.5+.5*f[0]),S(0,t.fullHeight,.5+.5*f[1]));if(0!==l){var k=l*Math.min(a.width(L),a.height(L));L[0]-=k,L[1]-=k,L[2]+=k,L[3]+=k}a.expand(d,L)}}}}null!=h&&(i.xMin=d[0],i.yMin=d[1],i.xMax=d[2],i.yMax=d[3],i.graphics3DGraphic=s,i.posView=h,i.graphicsOwner=c,n.push(i))}},i.prototype._deconflictVisibleObjects=function(i,t,e){for(var s=t?1:0;i.length>0&&!e.done();){var c=i.pop(),r=c.graphics3DGraphic,n=t&&!1===r.areVisibilityFlagsSet(2),a=!n&&!this.doesIntersectExistingPoly(c);a&&this.addToBins(c),r.setVisibilityFlag(2,a,s),t&&this.view.labeler.setLabelGraphicVisibility(r,a),o.drawPoly(c,a?"green":"red")}},i.prototype._setIconVisibilityFlags=function(i,t){var e=i.graphics3DGraphics,s=i.graphics3DGraphicsKeys;if(null!=e&&null!=s)for(var c=0,r=s;c<r.length;c++){var n=r[c],a=e[n];a.setVisibilityFlag(2,t)}},i}(),j={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},scaleAlignment:0,minPixelSizeAlignment:0},N=y.create();return V});