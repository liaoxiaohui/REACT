// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../geometry/Point","../../../../layers/graphics/dehydratedFeatures","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../../../../views/3d/lib/glMatrix","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,i,a,n,o,s,l,p,h,c,d,g,y,u,v){function f(e,t,r,i){for(var a=e.stageObject,n=a.getGeometryRecords(),s=n.length,l="absolute-height"!==t.mode,p=0,h=0;h<s;h++){var c=n[h].geometry,d=[n[h].transformation[12],n[h].transformation[13],n[h].transformation[14]],g=c.getData(),y=g.getVertexAttr(),u=y[S.POSITION].data,v=y.zOffset.data,f=y.mapPos.data,m=f.length/3;x(u.length/3==m*P+2,"unexpected tube geometry");var _=0,b=0;E.spatialReference=r.spatialReference;for(var A=0,G=0;G<m;G++){E.x=f[3*G],E.y=f[3*G+1],E.z=f[3*G+2];var w=o.computeElevation(r,E,t,i,l?C:null);l&&(A+=C.terrainElevation);var z=P;0!==G&&G!==m-1||z++;for(var O=0;O<z;O++)D[0]=u[_]+d[0],D[1]=u[_+1]+d[1],D[2]=u[_+2]+d[2],i.setAltitude(w+v[b],D),u[_]=D[0]-d[0],u[_+1]=D[1]-d[1],u[_+2]=D[2]-d[2],_+=3,b+=1;c.invalidateBoundingInfo()}a.geometryVertexAttrsUpdated(h),p+=A/m}return p/s}var m=p.vec3d,_=p.mat4d,x=u.assert,b=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=l.validateSymbolLayerSize(this._getSymbolSize());if(e)return this._logWarning(e),void this.reject()}var t=this._getStageIdHint(),r=this._getMaterialOpacityAndColor(),i=m.create(r),a=r[3],n={diffuse:i,ambient:i,opacity:a,transparent:a<1||this._isPropertyDriven("opacity"),vertexColors:this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};this._material=new v(n,t+"_3dlinemat"),this._context.stage.add(c.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(c.ModelContentType.MATERIAL,this._material.id),this._material=null)},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if("polyline"!==t.geometry.type)return this._logWarning("unsupported geometry type for path symbol: "+t.geometry.type),null;if(!this._validateGeometry(t.geometry))return null;var r="graphic"+t.uid,i=this.getGraphicElevationContext(t),a=e.renderingInfo;return this._createAs3DShape(t,a,i,r,t.uid)},t.prototype.layerPropertyChanged=function(e,t,r){if("opacity"===e){var i=this._getMaterialOpacity(),a=i<1||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:i,transparent:a}),!0}if("elevationInfo"===e){this._updateElevationContext();for(var n in t){var s=t[n],l=r(s);if(l){var p=s.graphic,h=this.getGraphicElevationContext(p);l.needsElevationUpdates=o.needsElevationUpdates3D(h.mode),l.elevationContext.set(h)}}return!0}return!1},Object.defineProperty(t.prototype,"numberOfVertices",{get:function(){return 0},enumerable:!0,configurable:!0}),t.prototype._getPathSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?o.getSingleSizeDriver(e.size):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbol.size||1},t.prototype._createAs3DShape=function(e,t,r,i,s){var l=e.geometry,p=l.paths,c=[],u=[],v=[],x=m.create(),b=this._context.renderSpatialReference,S=b===h.SphericalECEFSpatialReference,D=new Array(6),E=this._getPathSize(t),C=o.getGeometryVertexData3D(p,a.hasZ(l),l.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,r);if(this._logGeometryCreationWarnings(C,p,"paths","PathSymbol3DLayer"),p.length>0){for(var A=C.geometryData.outlines,G=C.eleVertexData,w=C.vertexData,z=0;z<A.length;++z){var O=A[z];if(!(O.count<=1)){var U=O.index,I=O.count;if(!this._context.clippingExtent||(o.computeBoundingBox(G,U,I,D),!o.boundingBoxClipped(D,this._context.clippingExtent))){o.chooseOrigin(w,U,I,x),o.subtractCoordinates(w,U,I,x);var R=new Float64Array(G.buffer,3*U*G.BYTES_PER_ELEMENT,3*I),T=o.flatArrayToArrayOfArrays(w,U,I),M=g.createTubeGeometry(T,.5*E,P,S,x);if(M.getVertexAttr().mapPos={size:3,data:R,offsetIdx:0,strideIdx:3},this._material.getParams().vertexColors){var V=this._getVertexOpacityAndColor(t);M=g.addVertexColors(M,V)}var j=new d(M,i+"path"+z);j.singleUse=!0,c.push(j),u.push([this._material]);var L=_.identity();_.translate(L,x,L),v.push(L)}}}if(c.length>0){var B=new y({geometries:c,materials:u,transformations:v,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:s},idHint:i}),H=f,F=new n(this,B,c,null,null,H,r);return F.alignedTerrainElevation=C.terrainElevation,F.needsElevationUpdates=o.needsElevationUpdates3D(r.mode),F}}return null},t}(s),S=u.VertexAttrConstants,D=m.create(),E=new i,C={verticalDistanceToGround:0,terrainElevation:0},P=10;return b});