// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/asyncUtils","../../../../core/ObjectPool","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","./featureExpressionInfoUtils","../../support/projectionUtils"],function(t,i,e,r,n,a,o,s,h,c,p){function u(t,i){for(var e=new Array(t),r=0;r<e.length;r++)e[r]=new Array(i);return e}var l=new a(Array,function(t){return o.set(t,o.ZERO)},null,10,5),f=s.create();return function(){function t(t,i,e,r){this.addedToSpatialIndex=!1,this._labelGraphics=[],this._auxiliaryGraphics=[],this._visibilityFlags=u(2,3),this._featureExpressionFeature=null,this.extent=null,this.graphics3DSymbol=i,this.graphic=t,this._graphics=e,this._featureExpressionFeature=c.createFeature(t,r)}return t.prototype.initialize=function(t,i){var e=this;this._layer=t,this._stage=i,this.forEachSymbolLayerGraphic(function(r){r.initialize(t,i),r.setVisibility(e.isVisible())})},t.prototype.destroy=function(){this.forEachRenderedGraphic(function(t){return t.destroy()}),this._graphics.length=0,this._labelGraphics.length=0,this._auxiliaryGraphics.length=0},t.prototype.clearLabelGraphics=function(){this.forEachLabelGraphic(function(t){return t.destroy()}),this._labelGraphics.length=0},t.prototype.addLabelGraphic=function(t,i,e){this._labelGraphics.push(t),t.initialize(i,e),t.setVisibility(this.isVisible(1))},t.prototype.addAuxiliaryGraphic=function(t){this._auxiliaryGraphics.push(t),this._layer&&(t.initialize(this._layer,this._stage),t.setVisibility(this.isVisible()))},t.prototype.isDraped=function(){var t=!1;return this.forEachSymbolLayerGraphic(function(i){"draped"===i.type&&(t=!0)}),t},t.prototype.areVisibilityFlagsSet=function(t,i,e){void 0===e&&(e=0);var r=this._visibilityFlags[e];if(null!=t)return r[t];for(var n=!0,a=0;a<r.length;a++)if(a!==i){var o=r[a];n=n&&(null==o||!0===o)}return n},t.prototype.isVisible=function(t){void 0===t&&(t=0);for(var i=0;i<=t;i++)for(var e=this._visibilityFlags[i],r=0;r<e.length;r++){var n=e[r];if(null!==n&&!1===n)return!1}return!0},t.prototype.setVisibilityFlag=function(t,i,e){void 0===e&&(e=0);var r=this.isVisible(e);this._visibilityFlags[e][t]=i;var n=this.isVisible(e);if(r===n)return!1;if(1===e)this.forEachLabelGraphic(function(t){return t.setVisibility(n)});else{this.forEachSymbolLayerGraphic(function(t){return t.setVisibility(n)});var a=this.isVisible(1);this.forEachLabelGraphic(function(t){return t.setVisibility(a)})}return!0},t.prototype.getBSRadius=function(){var t=0;return this.forEachSymbolLayerGraphic(function(i){t=Math.max(t,i.getBSRadius())}),t},t.prototype.getCenterObjectSpace=function(){return this._graphics[0].getCenterObjectSpace()},t.prototype.computeExtent=function(t){if(!this.extent){this.extent=s.create();var i=this.graphic.geometry,e=i.spatialReference;if(h.computeAABR(i,this.extent),!e.equals(t)&&!p.boundingRectToBoundingRect(this.extent,e,this.extent,t))return this.extent=null,!1}return!0},t.prototype.getProjectedBoundingBox=function(t,i,a,h){return r(this,void 0,void 0,function(){var c=this;return e(this,function(p){switch(p.label){case 0:return h||(h={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),h.boundingBox?o.empty(h.boundingBox):h.boundingBox=o.empty(),h.requiresDrapedElevation=!1,[4,n.forEach(this._graphics,function(n){return r(c,void 0,void 0,function(){var r,s,c;return e(this,function(e){switch(e.label){case 0:return n?(r="draped"===n.type?i:t,s=l.acquire(),[4,n.getProjectedBoundingBox(r,a,s,h.screenSpaceObjects)]):[2];case 1:return c=e.sent(),isFinite(c[2])&&isFinite(c[5])||(h.requiresDrapedElevation=!0),c&&o.expand(h.boundingBox,s),l.release(s),[2]}})})})];case 1:return p.sent(),o.allFinite(h.boundingBox)||s.allFinite(o.toRect(h.boundingBox,f))?[2,h]:[2,null]}})})},t.prototype.needsElevationUpdates=function(){for(var t=0,i=this._graphics;t<i.length;t++){var e=i[t];if(e&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0}for(var r=0,n=this._labelGraphics;r<n.length;r++){var e=n[r];if(e&&e.needsElevationUpdates)return!0}return!1},t.prototype.alignWithElevation=function(t,i){var e=this;this.forEachRenderedGraphic(function(r){"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(t,i,e._featureExpressionFeature)})},t.prototype.addHighlight=function(t,i){this.forEachSymbolLayerGraphic(function(e){return e.addHighlight(t,i)})},t.prototype.removeHighlight=function(t){this.forEachSymbolLayerGraphic(function(i){return i.removeHighlight(t)})},t.prototype.forEachGraphicList=function(t,i){t.forEach(function(t,e){return t&&i(t,e)})},t.prototype.forEachSymbolLayerGraphic=function(t){this.forEachGraphicList(this._graphics,t),this.forEachGraphicList(this._auxiliaryGraphics,t)},t.prototype.forEachLabelGraphic=function(t){this.forEachGraphicList(this._labelGraphics,t)},t.prototype.forEachRenderedGraphic=function(t){this.forEachSymbolLayerGraphic(t),this.forEachLabelGraphic(t)},t}()});