// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/earcut/earcut","../../../../geometry/Point","../../../../geometry/Polygon","../../../../layers/graphics/dehydratedFeatures","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/edgeUtils","../../lib/glMatrix","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,a,n,i,o,s,l,c,p,g,h,u,d,y,v,f,m,_){function E(e,t,r,a,n,i,o,s,l,c,p,g,h,u){var d=r.length/3,y=0;p+=2*a.count,b(e,t,a.index,a.count,r,0,d,n,i,o,s,l,c,p,g,h,u),l+=2*a.count,p+=2*d,p-=2*a.count+2*d,S(n,i,s,o,y,a.pathLengths[0],a.count,l,c,p,g),l+=4*a.pathLengths[0],p+=2*a.pathLengths[0],y+=a.pathLengths[0];for(var v=1;v<a.pathLengths.length;++v)S(n,i,s,o,y,a.pathLengths[v],a.count,l,c,p,g),l+=4*a.pathLengths[v],p+=2*a.pathLengths[v],y+=a.pathLengths[v]}function b(e,t,r,a,n,i,o,s,l,c,p,g,h,u,d,y,v){L.set(y,P);for(var f=d>0?1:-1,m=3*r,_=g,E=3*_,b=g+a,x=3*b,S=0;S<a;++S)v&&(P[0]=e[m+0],P[1]=e[m+1],P[2]=e[m+2],L.normalize(P)),s[E+0]=e[m+0],s[E+1]=e[m+1],s[E+2]=e[m+2],l[E+0]=t[m+0],l[E+1]=t[m+1],l[E+2]=t[m+2],c[E+0]=-f*P[0],c[E+1]=-f*P[1],c[E+2]=-f*P[2],p[_]=0,s[x+0]=e[m+0]+d*P[0],s[x+1]=e[m+1]+d*P[1],s[x+2]=e[m+2]+d*P[2],l[x+0]=t[m+0],l[x+1]=t[m+1],l[x+2]=t[m+2],c[x+0]=f*P[0],c[x+1]=f*P[1],c[x+2]=f*P[2],p[b]=d,E+=3,x+=3,m+=3,_+=1,b+=1;m=3*i,E=3*u,x=3*(u+o);E=3*(u+o),x=3*u;var w=z,O=M;d<0&&(w=M,O=z);for(var S=0;S<o;++S)h[E+0]=n[m+w[0]],h[E+1]=n[m+w[1]],h[E+2]=n[m+w[2]],h[x+0]=n[m+O[0]]+a,h[x+1]=n[m+O[1]]+a,h[x+2]=n[m+O[2]]+a,E+=3,x+=3,m+=3}function x(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function S(e,t,r,a,n,i,o,s,l,c,p){var g=n,h=n+1,u=n+o,d=n+o+1,y=s,v=s+1,f=s+2*i,m=s+2*i+1;p<0&&(g=n+o+1,d=n),c*=3;for(var _=0;_<i;++_)_===i-1&&(p>0?(h=n,d=n+o):(h=n,g=n+o)),w(e,g,h,u,I),x(e,t,a,r,I,y,g),x(e,t,a,r,I,v,h),x(e,t,a,r,I,f,u),x(e,t,a,r,I,m,d),l[c++]=y,l[c++]=f,l[c++]=m,l[c++]=y,l[c++]=m,l[c++]=v,g++,h++,u++,d++,y+=2,v+=2,f+=2,m+=2}function w(e,t,r,a,n){t*=3,r*=3,a*=3,L.set3(e[t++],e[t++],e[t++],U),L.set3(e[r++],e[r++],e[r++],j),L.set3(e[a++],e[a++],e[a++],F),L.subtract(j,U,N),L.subtract(F,U,V),L.cross(V,N,n),L.normalize(n,n)}function O(e,t,r,a){var n=a.setAltitude;R.spatialReference=r.spatialReference;for(var i=e.getGeometryRecords(),o=i.length,s="absolute-height"!==t.mode,c=0,p=0;p<o;p++){var g=i[p].geometry,h=i[p].transformation,u=g.getData();H[0]=h[12],H[1]=h[13],H[2]=h[14],g.invalidateBoundingInfo();for(var d=u.getVertexAttr(),y=d[A.POSITION].data,v=d[A.SIZE].data,f=d.mapPos.data,m=y.length/3,_=0,E=0,b=!1,x=0,S=0;S<m;S++){R.x=f[E],R.y=f[E+1],R.z=f[E+2],B[0]=y[_],B[1]=y[_+1],B[2]=y[_+2];var w=l.computeElevation(r,R,t,a,s?T:null);s&&(x+=T.terrainElevation),C[0]=y[_]+H[0],C[1]=y[_+1]+H[1],C[2]=y[_+2]+H[2],n(w+v[_/3],C),y[_]=C[0]-H[0],y[_+1]=C[1]-H[1],y[_+2]=C[2]-H[2];var O=.01/a.unitInMeters;(Math.abs(B[0]-y[_])>O||Math.abs(B[1]-y[_+1])>O||Math.abs(B[2]-y[_+2])>O)&&(b=!0),E+=3,_+=3}b&&e.geometryVertexAttrsUpdated(p),c+=x/m}return c/o}var A=m.VertexAttrConstants,L=h.vec3d,D=h.mat4d,C=L.create(),P=L.create(),z=[0,2,1],M=[0,1,2],R=new n,T={verticalDistanceToGround:0,terrainElevation:0},G=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._edgeStageObjects=new Set,t}return r(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=p.validateSymbolLayerSize(this._getSymbolSize());if(e)return this._logWarning(e),void this.reject()}var t=this._getStageIdHint(),r=this._getMaterialOpacityAndColor(),a=L.create(r),n=r[3],i={diffuse:a,ambient:a,opacity:n,transparent:n<1||this._isPropertyDriven("opacity"),vertexColors:!0};this._material=new _(i,t+"_3dlinemat"),this._context.stage.add(d.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&this._context.stage.remove(d.ModelContentType.MATERIAL,this._material.id)},t.prototype.createGraphics3DGraphic=function(e){var t=e.renderingInfo,r=e.graphic,a=r.geometry;if("polygon"!==a.type&&"extent"!==a.type)return this._logWarning("unsupported geometry type for extrude symbol: "+a.type),null;if(!this._validateGeometry(a))return null;var n="polygon"===a.type||"extent"===a.type?"rings":"paths",i="graphic"+r.uid,o=this._getVertexOpacityAndColor(t,Float32Array,255),s=this.getGraphicElevationContext(r);return this._createAs3DShape(r,n,t,o,s,i,r.uid)},t.prototype.layerPropertyChanged=function(e,t,r){if("opacity"===e){var a=this._getMaterialOpacity(),n=a<1||this._isPropertyDriven("opacity");if(this._material.setParameterValues({opacity:a,transparent:n}),this._edgeStageObjects.size>0){var i=this._context.stage.view.getEdgeView(),o=this._getLayerOpacity();this._edgeStageObjects.forEach(function(e){i.updateAllComponentOpacities(e,[o])})}return!0}if("elevationInfo"===e){this._updateElevationContext();for(var s in t){var c=t[s],p=r(c);if(p){var g=c.graphic,h=this.getGraphicElevationContext(g);p.needsElevationUpdates=l.needsElevationUpdates3D(h.mode),p.elevationContext.set(h)}}return!0}return!1},Object.defineProperty(t.prototype,"numberOfVertices",{get:function(){return 0},enumerable:!0,configurable:!0}),t.prototype._getExtrusionSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?l.getSingleSizeDriver(e.size,2):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbol.size||1},t.prototype._createAs3DShape=function(e,t,r,n,c,p,h){var d=this,v=e.geometry;"extent"===v.type&&(v=i.fromExtent(v));var m=v[t],_=[],b=[],x=[],S=L.create(),w=new Array(6),A=this._context.renderSpatialReference===u.SphericalECEFSpatialReference,C=this._getExtrusionSize(r),P=L.create();A||this._context.renderCoordsHelper.worldUpAtPosition(null,P);var z=l.getGeometryVertexData3D(m,o.hasZ(v),v.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,c);if(this._logGeometryCreationWarnings(z,m,t,"ExtrudeSymbol3DLayer"),m.length>0){for(var M=z.geometryData.polygons,R=z.eleVertexData,T=z.vertexData,G=T.length/3,I=new Float64Array(3*G*6),U=new Float64Array(3*G*6),j=new Float64Array(3*G*6),F=new Float64Array(1*G*6),N=0,V=this,B=0;B<M.length;++B)!function(e){var t=M[e],r=t.count,i=t.index;if(V._context.clippingExtent&&(l.computeBoundingBox(R,i,r,w),l.boundingBoxClipped(w,V._context.clippingExtent)))return"continue";var o=new Float64Array(R.buffer,3*i*I.BYTES_PER_ELEMENT,3*r),s=t.holeIndices.map(function(e){return e-i}),c=a(o,s,3);if(c.length>0){l.chooseOrigin(T,i,r,S);var g=3*r*2+2*c.length,h=new Uint32Array(g),u=6*r,d=new Float64Array(I.buffer,3*N*I.BYTES_PER_ELEMENT,3*u),v=new Float64Array(U.buffer,3*N*U.BYTES_PER_ELEMENT,3*u),f=new Float64Array(j.buffer,3*N*j.BYTES_PER_ELEMENT,3*u),m=new Float64Array(F.buffer,1*N*F.BYTES_PER_ELEMENT,1*u);E(T,R,c,t,d,f,v,m,0,h,0,C,P,A),l.subtractCoordinates(d,0,u,S),N+=6*r;var O=V._createExtrudeGeometry(h,{positions:d,elevation:f,normals:v,heights:m},n),L=new y(O,p+"path"+e);L.singleUse=!0,_.push(L),b.push([V._material]);var z=D.identity();D.translate(z,S,z),x.push(z)}}(B);if(_.length>0){var H=new f({geometries:_,materials:b,transformations:x,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:h},idHint:p}),Y=function(e){var t=d._context.stage.view.getEdgeView();if(t){t.removeObject(e),d._edgeStageObjects.delete(e);var r=g.createMaterial(t,d.symbol,d._getLayerOpacity());r&&(d._edgeStageObjects.add(e),t.addObject(e,[r]))}};Y(H);var W=function(e,t,r,a){var n=O(e.stageObject,t,r,a);return Y(H),n},Z=new s(this,H,_,null,null,W,c);return Z.alignedTerrainElevation=z.terrainElevation,Z.needsElevationUpdates=l.needsElevationUpdates3D(c.mode),Z}return null}return null},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;o<a;o++)i[o]=0;var s={},l={};return s[A.POSITION]=n,s[A.NORMAL]=n,s[A.COLOR]=i,l[A.POSITION]={size:3,data:t.positions},l[A.NORMAL]={size:3,data:t.normals},l[A.COLOR]={size:4,data:r},l[A.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new v(l,s)},t}(c),I=L.create(),U=L.create(),j=L.create(),F=L.create(),N=L.create(),V=L.create(),B=L.create(),H=L.create();return G});