// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../Color","../../../../core/screenUtils","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/TextTexture","../../webgl-engine/materials/HUDMaterial"],function(e,t,n,i,r,o,a,l,s,c,h,p,f,u,d){var g=[1,1,1,1],v=[0,0,1],y={mode:"relative-to-ground",offset:0},m=[0,0,0,1];return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},t}return n(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=h.validateSymbolLayerSize(this._getTextSize());if(e)return this._logWarning(e),void this.reject()}this._anchor="center",this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject()},t.prototype.createGraphics3DGraphic=function(e,t,n,i){void 0===t&&(t={});var r=e.graphic,o=s.placePointOnGeometry(r.geometry);if(!o)return this._logWarning("unsupported geometry type for text symbol: "+r.geometry.type),null;var a=t.text||this.symbol.text;if(!a||a.length<1)return null;null!=t.needsOffsetAdjustment&&(this._elevationOptions.needsOffsetAdjustment=t.needsOffsetAdjustment);var l=this.getGraphicElevationContext(r,t.elevationOffset||0),c=this._context.layer.id+"_label_"+r.uid,h="polyline"===r.geometry.type;return this._createAs3DShape(this.symbol,o,a,l,c,r.uid,t,n,i,h)},t.prototype.getGraphicElevationContext=function(t,n){void 0===n&&(n=0);var i=e.prototype.getGraphicElevationContext.call(this,t);return i.addOffsetRenderUnits(n),i},t.prototype.layerPropertyChanged=function(e,t,n){if("opacity"===e)this._logWarning("layer opacity change not yet implemented in Graphics3DTextSymbolLayer");else if("elevationInfo"===e){if(this._updateElevationContext(),t)for(var i in t){var r=t[i],o=n(r);o&&this.updateGraphicElevationContext(r.graphic,o)}return!0}return!1},t.prototype.updateGraphicElevationContext=function(e,t){var n=this.getGraphicElevationContext(e,t.metadata.elevationOffset);t.elevationContext.set(n),t.needsElevationUpdates=s.needsElevationUpdates2D(n.mode)||"absolute-height"===n.mode},Object.defineProperty(t.prototype,"numberOfVertices",{get:function(){return 6},enumerable:!0,configurable:!0}),t.prototype._defaultElevationInfoNoZ=function(){return y},t.prototype._createAs3DShape=function(e,t,n,c,h,y,x,b,O,S){var _=x.centerOffset||m,G=x.screenOffset||[0,0],C=x.debugDrawBorder||!1,E=x.translation||[0,0,0],w=x.anchor||this._anchor||"center";this._anchor=w;var z,P=e.material?i.toUnitRGBA(e.material.color):g,D=e.halo&&e.halo.color&&e.halo.size>0,U=D?i.toUnitRGBA(e.halo.color):g,A=D?r.pt2px(e.halo.size):0,j=this._getTextSize(e),L=new u(n,{size:j,color:P,font:{family:e.font&&e.font.family?e.font.family:"sans-serif",weight:e.font&&e.font.weight?e.font.weight:"normal",style:e.font&&e.font.style?e.font.style:"normal"},halo:{size:A,color:U}},h);b?z=x:o.isCalloutSupport(this.symbolContainer)&&this.symbolContainer.hasVisibleVerticalOffset()&&(z=this.symbolContainer);var T={textureId:O?O.textureId:L.id,texCoordScale:O?[1,1]:L.texcoordScale,occlusionTest:!0,screenOffset:G,anchorPos:w,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:x.centerOffsetUnits,debugDrawBorder:C,drawInSecondSlot:!0};if(z&&z.verticalOffset){var W=z.verticalOffset,I=W.screenLength,R=W.minWorldLength,B=W.maxWorldLength;T.verticalOffset={screenLength:r.pt2px(I),minWorldLength:R||0,maxWorldLength:null!=B?B:1/0}}if(this._context.screenSizePerspectiveEnabled){var H=this._context.sharedResources,M=H.screenSizePerspectiveSettings,V=H.screenSizePerspectiveSettingsLabels;T.screenSizePerspective=V.overridePadding(A),T.screenSizePerspectiveAlignment=M}S&&(T.shaderPolygonOffset=1e-4);var F=null,N=JSON.stringify(T);null!=b?null==(F=b.getMaterial(N))&&(F=new d(T,h),b.addMaterial(N,F)):F=new d(T,h);var q=[F],J=f.createPointGeometry(v,E,void 0,O?[0,0]:[L.textWidth,L.textHeight],_,O?[0,0]:null),Z=[new p(J,h)],k=this._context.layer.uid,K=s.createStageObjectForPoint.call(this,t,Z,[q],null,null,c,h,k,y,!0);if(null===K)return null;var Q=a.perObjectElevationAligner,X=new l(this,K.object,Z,null==b?q:null,O?null:[L],Q,c);return X.alignedTerrainElevation=K.terrainElevation,X.needsElevationUpdates=s.needsElevationUpdates2D(c.mode)||"absolute-height"===c.mode,X.getScreenSize=function(e){return void 0===e&&(e=new Array(2)),e[0]=O?L.textWidth:L.width,e[1]=O?L.textHeight:L.height,e},X.metadata={labelText:n,elevationOffset:x.elevationOffset||0},s.extendPointGraphicElevationContext(X,t,this._context.elevationProvider),X},t.prototype._getTextSize=function(e){return r.pt2px((e||this.symbol).size)||12},t}(c)});