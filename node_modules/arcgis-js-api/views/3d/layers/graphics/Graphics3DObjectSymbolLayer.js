// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/errors/CancelError","../../../../Color","../../../../core/lang","../../../../core/screenUtils","../../../../geometry/support/aaBoundingBox","../../../../symbols/ObjectSymbol3DLayer","./ElevationAligners","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./objectResourceUtils","./primitiveObjectSymbolUtils","../support/FastSymbolUpdates","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,i,s,a,o,n,l,c,p,h,u,d,m,_,f,y,g,v,b,S){var x=y.mat4d,M=y.vec3d,P=[g.ModelContentType.MATERIAL,g.ModelContentType.TEXTURE,g.ModelContentType.GEOMETRY],O=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){var e=this.symbol,t=this._getStageIdHint();if(!this._isPropertyDriven("size")){var r=d.validateSymbolLayerSize(this.symbol);if(r)return this._logWarning(r),void this.reject()}if(e.resource&&e.resource.href)this._prepareModelResources(e.resource.href,t);else{var i=e.resource?e.resource.primitive:"sphere";this._preparePrimitiveResources(i,t)}},t.prototype._preparePrimitiveResources=function(e,t){if(!_.isValidPrimitive(e))return this._logWarning("Unknown object symbol primitive: "+e),void this.reject();var r=this.symbol;this._geometry=new v(_.primitiveGeometryData(e),t),this._context.stage.add(g.ModelContentType.GEOMETRY,this._geometry),this._resourceBoundingBox=_.primitiveBoundingBox(e),this._resourceSize=n.size(this._resourceBoundingBox),this._symbolSize=d.computeSizeWithResourceSize(this._resourceSize,r);var i=this._getMaterialOpacity(),l={specular:[0,0,0],opacity:i,transparent:i<1||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:C,diffuse:C},c=this.symbolContainer;if("point-3d"===c.type&&c.verticalOffset){var p=c.verticalOffset,h=p.screenLength,u=p.minWorldLength,m=p.maxWorldLength;l.verticalOffset={screenLength:o.pt2px(h),minWorldLength:u||0,maxWorldLength:null!=m?m:1/0},l.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(l.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._isPropertyDriven("color"))l.externalColor=E;else{var y=r.material?s.toUnitRGBA(r.material.color):E;l.externalColor=y}this._fastUpdates=f.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(a.mixin(l,this._fastUpdates.materialParameters),l.instanced.push("featureAttribute")):this._hasPerInstanceColor()&&l.instanced.push("color"),this._material=new S(l,t+"_objectmat"),this._context.stage.add(g.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype._prepareModelResources=function(e,t){var r=this,s=["transformation"],l={instanced:s},c={materialParamsMixin:l,idHint:t,streamDataSupplier:this._context.streamDataSupplier};this._fastUpdates=f.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(a.mixin(c.materialParamsMixin,this._fastUpdates.materialParameters),s.push("featureAttribute")):this._hasPerInstanceColor()&&s.push("color");var p=this.symbolContainer;if("point-3d"===p.type&&p.verticalOffset){var h=p.verticalOffset,u=h.screenLength,_=h.minWorldLength,y=h.maxWorldLength;c.materialParamsMixin.verticalOffset={screenLength:o.pt2px(u),minWorldLength:_||0,maxWorldLength:null!=y?y:1/0},c.materialParamsMixin.castShadows=!1}this._symbolLoaderPromise=m.fetch(e,c),this._symbolLoaderPromise.then(function(e){if(r._symbolLoaderPromise=null,!r.isRejected()){var t=r._context,i=e.stageResources,s=t.stage,a=r.symbol.material,o=r._getExternalColorParameters(a),l=r._getMaterialOpacity(),c=r._isPropertyDriven("opacity"),p=i[g.ModelContentType.MATERIAL];e.originalMaterialOpacities=new Array(p.length),p.forEach(function(r,i){var s=r.getParameterValues();r.setParameterValues(o),e.originalMaterialOpacities[i]=s.opacity;var a=s.opacity*l,n=a<1||c||s.transparent;r.setParameterValues({opacity:a,transparent:n}),t.screenSizePerspectiveEnabled&&r.setParameterValues({screenSizePerspective:t.sharedResources.screenSizePerspectiveSettings})}),P.forEach(function(e){for(var t=i[e],r=0;t&&r<t.length;r++)s.add(e,t[r])}),r._resourceBoundingBox=m.computeBoundingBox(e),r._resourceSize=n.size(r._resourceBoundingBox),r._pivotOffset=e.pivotOffset,r._symbolSize=d.computeSizeWithResourceSize(r._resourceSize,r.symbol),r._i3sModel=e,f.updateFastSymbolUpdatesState(r._fastUpdates,r._context.renderer,r._fastVisualVariableConvertOptions())&&p.forEach(function(e){return e.setParameterValues(r._fastUpdates.materialParameters)}),r.resolve()}},function(e){if(r._symbolLoaderPromise=null,!r.isFulfilled()){if(!(e instanceof i)){var t="ObjectSymbol3DLayer failed to load";e&&e.message&&(t+=" ("+e.message+")"),r._logWarning(t)}r.reject()}})},t.prototype._forEachMaterial=function(e){if(this._i3sModel){this._i3sModel.stageResources[g.ModelContentType.MATERIAL].forEach(e)}else e(this._material)},t.prototype._getExternalColorParameters=function(e){var t={};return this._isPropertyDriven("color")?t.externalColor=E:e&&e.color?t.externalColor=s.toUnitRGBA(e.color):(t.externalColor=E,t.colorMixMode="ignore"),t},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._symbolLoaderPromise&&this._symbolLoaderPromise.cancel();var t=this._context.stage;if(this._i3sModel){var r=this._i3sModel.stageResources;P.forEach(function(e){for(var i=r[e],s=0;i&&s<i.length;s++)t.remove(e,i[s].id)})}else this._material&&t.remove(g.ModelContentType.MATERIAL,this._material.id),this._geometry&&t.remove(g.ModelContentType.GEOMETRY,this._geometry.id)},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if(!this._validateGeometry(t.geometry))return null;var r=h.placePointOnGeometry(t.geometry);if(!r)return this._logWarning("unsupported geometry type for icon symbol: "+t.geometry.type),null;var i="graphic"+t.uid,s=this.getGraphicElevationContext(t),a=e.renderingInfo;return this._createAs3DShape(t,r,a,s,i,t.uid)},t.prototype.layerPropertyChanged=function(e,t,r){var i=this;if("opacity"===e){var s=this._isPropertyDriven("opacity");if(this._i3sModel){var a=this._getMaterialOpacity();this._i3sModel.stageResources[g.ModelContentType.MATERIAL].forEach(function(e,t){var r=i._i3sModel.originalMaterialOpacities[t],o=r*a;e.setParameterValues({opacity:o,transparent:o<1||s})})}else{var o=this._getMaterialOpacity();this._material.setParameterValues({opacity:o,transparent:o<1||s})}return!0}if("elevationInfo"===e){this._updateElevationContext();for(var n in t){var l=t[n],c=r(l);if(c){var p=l.graphic,u=this.getGraphicElevationContext(p);c.needsElevationUpdates=h.needsElevationUpdates3D(u.mode),c.elevationContext.set(u)}}return!0}return!1},t.prototype.applyRendererDiff=function(e,t,r,i){var s=this;for(var a in e.diff)switch(a){case"visualVariables":if(!f.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;this._forEachMaterial(function(e){return e.setParameterValues(s._fastUpdates.materialParameters)});break;default:return!1}return!0},Object.defineProperty(t.prototype,"numberOfVertices",{get:function(){return this._i3sModel?this._i3sModel.numberOfVertices:this._geometry.data.getIndices(b.VertexAttrConstants.POSITION).length},enumerable:!0,configurable:!0}),t.prototype._createAs3DShape=function(e,t,r,i,s,a){var o,n=this,l=null,u=null,m=this.getFastUpdateAttrValues(e);m&&(l={featureAttribute:m},u=function(e){return f.evaluateModelTransform(n._fastUpdates.materialParameters,m,e)}),!this._fastUpdates.enabled&&this._hasPerInstanceColor()&&(l=l||{},l.color=d.mixinColorAndOpacity(r.color,r.opacity));var _=this._context.layer.uid,y=x.identity();if(this._applyObjectRotation(r,y),this._applyObjectRotation(this.symbol,y),this._applyObjectScale(r,y),this._applyAnchor(y),this._i3sModel){for(var v=this._i3sModel.stageResources[g.ModelContentType.GEOMETRY],b=this._i3sModel.materialsByComponent,S=new Array(v.length),M=0;M<S.length;M++)S[M]=y;o=h.createStageObjectForPoint.call(this,t,v,b,S,l,i,s,_,a,null,u)}else o=h.createStageObjectForPoint.call(this,t,[this._geometry],[[this._material]],[y],l,i,s,_,a,null,u);if(null===o)return null;if(this._fastUpdates.enabled){var P=f.getMaterialParams(this._fastUpdates.visualVariables,this._fastVisualVariableConvertOptions());this._forEachMaterial(function(e){return e.setParameterValues(P)})}o.object.setCastShadow(!0);var O=c.perObjectElevationAligner,C=new p(this,o.object,null,null,null,O,i,p.VisibilityModes.REMOVE_OBJECT);return C.alignedTerrainElevation=o.terrainElevation,C.needsElevationUpdates=h.needsElevationUpdates3D(i.mode),h.extendPointGraphicElevationContext(C,t,this._context.elevationProvider),C},t.prototype._applyObjectScale=function(e,t){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var r=this._isPropertyDriven("size")&&e.size?e.size:this._symbolSize,i=d.computeObjectScale(r,this._symbolSize,this._resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||x.scale(t,i)}},t.prototype._applyObjectRotation=function(e,t){if(!(this._fastUpdates.enabled&&this._fastUpdates.customTransformation&&e instanceof l))return d.computeObjectRotation(e.heading,e.tilt,e.roll,t)},t.prototype._computeAnchor=function(){switch(this.symbol.anchor){case"center":return M.scale(n.center(this._resourceBoundingBox),-1);case"top":var e=n.center(this._resourceBoundingBox);return[-e[0],-e[1],-this._resourceBoundingBox[5]];case"bottom":var e=n.center(this._resourceBoundingBox);return[-e[0],-e[1],-this._resourceBoundingBox[2]];case"origin":default:return this._pivotOffset?M.scale(this._pivotOffset,-1,new Array(3)):U}},t.prototype._applyAnchor=function(e){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var t=this._computeAnchor();t&&x.translate(e,t)}},t.prototype._hasPerInstanceColor=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")},t.prototype._supportsShaderVisualVariables=function(){return!!this._context.stage.has("instancedRendering")},t.prototype._fastVisualVariableConvertOptions=function(){var e=this._resourceBoundingBox?n.size(this._resourceBoundingBox):C,t=this._resourceBoundingBox?this._computeAnchor():U,r=this._context.renderCoordsHelper.unitInMeters,i=d.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,r),s=[this.symbol.tilt||0,this.symbol.roll||0,this.symbol.heading||0];return{modelSize:e,symbolSize:this._symbolSize||C,unitInMeters:r,transformation:{anchor:t,scale:i,rotation:s}}},t}(u),C=[1,1,1],E=[1,1,1,1],U=[0,0,0];return O});