// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/sniff","dojo/errors/CancelError","../../../../request","../../../../core/Error","../../../../core/lang","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../core/Version","../../../../geometry/support/aaBoundingBox","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],function(e,r,t,a,n,i,o,s,l,u,c,p,f,m,d,v,g,y,x){function h(e,r){return M(e,r).then(function(e){return B(e,r)})}function b(e,r){var t=c.removeFile(e);return M(e,r).then(function(e){return e.lods?u.all(e.lods.map(function(r){return r.href?M(c.makeAbsolute(r.href,t)):e})).then(function(t){return w(t.map(function(e){return B(e,r)}),e)}):w([B(e,r)],e)})}function w(e,r){return r.lods&&r.lods.length===e.length&&e.forEach(function(e,t){e.lodMetrics=r.lods[t].metrics}),e}function M(e,r){r=r||{};var t=r.streamDataSupplier;if(t){var a=t.request(e,"json");return u.create(function(e,r){a.then(function(r,t){e(t)},function(e){r(e instanceof n?e:U(e))})},function(){t.cancelRequest(a)})}var o=i(e);return u.create(function(e,r){o.then(function(r){e(r.data)},function(e){r(e instanceof n?e:U(e))})},function(){o.cancel()})}function U(e){return new o("","Request for object resource failed: "+e)}function A(e){for(var r=e.stageResources[d.ModelContentType.GEOMETRY],t=f.empty(),a=[0,0,0],n=[0,0,0],i=0;i<r.length;i++){var o=r[i],s=o.getBoundingInfo();m.vec3d.set(s.getBBMin(),a),m.vec3d.set(s.getBBMax(),n);for(var l=0;l<3;++l)t[l]=Math.min(t[l],a[l]),t[l+3]=Math.max(t[l+3],n[l])}return t}function j(e){var r=e.params,t=r.topology,a=!0;switch(r.vertexAttributes||(P.warn("Geometry must specify vertex attributes"),a=!1),r.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:var n=r.faces;if(n){if(r.vertexAttributes)for(var i in r.vertexAttributes){var o=n[i];o&&o.values?(null!=o.valueType&&"UInt32"!==o.valueType&&(P.warn("Unsupported indexed geometry indices type '"+o.valueType+"', only UInt32 is currently supported"),a=!1),null!=o.valuesPerElement&&1!==o.valuesPerElement&&(P.warn("Unsupported indexed geometry values per element '"+o.valuesPerElement+"', only 1 is currently supported"),a=!1)):(P.warn("Indexed geometry does not specify face indices for '"+i+"' attribute"),a=!1)}}else P.warn("Indexed geometries must specify faces"),a=!1;break;default:P.warn("Unsupported topology '"+t+"'"),a=!1}e.params.material||(P.warn("Geometry requires material"),a=!1);var s=e.params.vertexAttributes;for(var l in s){s[l].values||(P.warn("Geometries with externally defined attributes are not yet supported"),a=!1)}return a}function B(e,r){var t=[],n=[],i=[],o=[],l=[],u=p.Version.parse(e.version||"1.0","wosr");T.validate(u);var c="meshsymbol_"+e.model.name,f=e.textureDefinitions,m={};for(var d in f){var h=f[d],b=h.images[0].data;if(b){var w=h.encoding+";base64,"+b,M="/textureDefinitions/"+d,U={noUnpackFlip:!0,wrapClamp:!1};a("enable-feature:jkieboom/alpha-channel-usage")&&(U.wrapClamp=!0);var A=new y(w,c,U);l.push(A),m[M]={engineTexObj:A,alphaChannelUsage:"rgba"===h.channels?h.alphaChannelUsage||"transparency":"none"}}else P.warn("Externally referenced texture data is not yet supported")}for(var B=e.model.geometries,I=e.materialDefinitions,O=0,k=0;k<B.length;k++){var R=B[k];if(j(R)){var q=C(R),D=R.params.vertexAttributes,G={};for(var S in D){var V=D[S],F=V.values;G[S]={data:F,size:V.valuesPerElement}}i.push([]);var L={};if("PerAttributeArray"===R.params.topology){var _=G.position.data.length/G.position.size,z=E(_);for(var H in G)L[H]=z}else{var Y=R.params.faces;for(var J in Y)L[J]=new Uint32Array(Y[J].values)}var K=q.texture?m[q.texture]:null,N=o[q.material]?o[q.material][q.texture]:null;if(!N){var Q=q.material.substring(q.material.lastIndexOf("/")+1),W=I[Q].params;1===W.transparency&&(W.transparency=0);var X={ambient:W.diffuse,diffuse:W.diffuse,specular:[0,0,0],opacity:1-(W.transparency||0),transparent:W.transparency>0,textureId:K?K.engineTexObj.id:void 0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:W.externalColorMixMode||"tint"};a("enable-feature:jkieboom/alpha-channel-usage")&&(!K||"transparency"!==K.alphaChannelUsage&&"maskAndTransparency"!==K.alphaChannelUsage||(X.transparent=!0)),r&&r.materialParamsMixin&&s.mixin(X,r.materialParamsMixin),N=new x(X,c),o[q.material]||(o[q.material]={}),o[q.material][q.texture]=N,n.push(N)}i[k].push(N);var Z=new v(new g(G,L),c);O+=L.position?L.position.length:0,t.push(Z)}}return{stageResources:{textures:l,materials:n,geometries:t},materialsByComponent:i,pivotOffset:e.model.pivotOffset,numberOfVertices:O}}function C(e){var r=e.params;return{id:1,material:r.material,texture:r.texture,region:r.texture}}function E(e){for(var r=new Uint32Array(e),t=0;t<e;t++)r[t]=t;return r}Object.defineProperty(r,"__esModule",{value:!0});var P=l.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),T=new p.Version(1,2,"wosr");r.fetch=h,r.fetchLod=b,r.computeBoundingBox=A,r.createStageResources=B});