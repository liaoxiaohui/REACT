// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Graphic","../../../core/Collection","../../../core/Error","../../../core/Evented","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../layers/graphics/controllers/support/controllerUtils","../../../layers/graphics/sources/MemorySource","./FeatureLikeLayerView3D","../../layers/RefreshableLayerView"],function(e,t,r,o,n,s,i,a,u,c,l,p,d,h,y,f,m,v){function g(e){return p.create(e)}var w=function(t){function n(e){return t.call(this)||this}r(n,t),l=n,Object.defineProperty(n.prototype,"controllerTypeForSource",{get:function(){return this.layer.source&&this.layer.source.isInstanceOf&&this.layer.source.isInstanceOf(f)?"memory":"point"===this.layer.geometryType?"feature-tile-3d":"snapshot"},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"asyncGraphicsUpdates",{get:function(){if(this.controller&&"feature-tile-3d"===this.controller.type)switch(this.controller.mode){case"snapshot":return!1;case"tiles":return!0;default:this.controller.mode}var e=this.controller?this.controller.type:this.controllerTypeForSource;switch(e){case"feature-tile-3d":return!0;case"memory":case"snapshot":return!1}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"suspendResumeExtentMode",{get:function(){if(this.controller&&"feature-tile-3d"===this.controller.type)return this.controller.suspendResumeExtentMode;var e=this.controller?this.controller.type:this.controllerTypeForSource;switch(e){case"feature-tile-3d":return"data";case"memory":case"snapshot":return"computed"}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"displayLimitExceeded",{get:function(){return!(!this.controller||"feature-tile-3d"!==this.controller.type)&&!(this.suspended||!this.controller.displayLimitExceeded)},enumerable:!0,configurable:!0}),n.prototype.createController=function(){return i(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:switch(e=this.controllerTypeForSource){case"memory":return[3,1];case"snapshot":return[3,3];case"feature-tile-3d":return[3,5]}return[3,7];case 1:return[4,this.createMemoryController()];case 2:return[2,t.sent()];case 3:return[4,this.createSnapshotController()];case 4:return[2,t.sent()];case 5:return[4,this.createFeatureTileController()];case 6:return[2,t.sent()];case 7:return this.controllerTypeForSource,[3,8];case 8:return[2]}})})},n.prototype.createMemoryController=function(){return i(this,void 0,void 0,function(){var t;return s(this,function(r){switch(r.label){case 0:return[4,g(function(t){e(["../../../layers/graphics/controllers/MemoryController"],t)})];case 1:return t=r.sent(),[2,new t({layerView:this,layer:this.layer,graphics:this.layer.source})]}})})},n.prototype.createFeatureTileController=function(){return i(this,void 0,void 0,function(){var t,r,o=this;return s(this,function(n){switch(n.label){case 0:return[4,g(function(t){e(["../../../layers/graphics/controllers/FeatureTileController3D"],t)})];case 1:return t=n.sent(),r=new t({layerView:this,graphics:new x,extent:this.clippingExtent}),this.handles.add([r.watch("suspendResumeExtentMode",function(){return o.notifyChange("suspendResumeExtentMode")},!0),r.watch("displayLimitExceeded",function(){return o.notifyChange("displayLimitExceeded")},!0),r.watch("mode",function(){return o.notifyChange("asyncGraphicsUpdates")},!0)]),this.handles.add(d.init(r,"serviceDataExtent",function(e){return o.graphics3d.dataExtent=e})),this.handles.add(d.init(this,"suspended",function(e){e?r.suspend():r.resume()},!0)),this.handles.add(d.init(this.graphics3d.graphicsCore,"maxNumberOfFeatures",function(e){var t=Math.ceil(b*e),o=Math.ceil(F*e),n=e;r.displayFeatureLimit={min:t,max:n,perTile:o}})),[2,r]}})})},n.prototype.createSnapshotController=function(){return i(this,void 0,void 0,function(){var t,r,o;return s(this,function(n){switch(n.label){case 0:return this.addResolvingPromise(this.validateMaximumFeatureCount()),[4,g(function(t){e(["../../../layers/graphics/controllers/SnapshotController"],t)})];case 1:return t=n.sent(),r=u.ofType(a),o=new t({layerView:this,layer:this.layer,graphics:new r,maxPageSize:300,defaultReturnZ:!0,extent:this.clippingExtent}),[4,o.when()];case 2:return n.sent(),this.handles.add(d.whenFalseOnce(this,"suspended",function(){o.startup()})),[2,o]}})})},n.prototype.validateMaximumFeatureCount=function(){return l.maximumFeatureCount<0||!this.layer.url?p.resolve():this.layer.queryFeatureCount().then(function(e){if(e>l.maximumFeatureCount)throw new c("featurelayerview3d:maximum-feature-count-exceeded","The maximum number of allowed features (${maximumFeatureCount}) has been exceeded (layer has ${numberOfFeatures} features)",{maximumFeatureCount:l.maximumFeatureCount,numberOfFeatures:e})})},n.prototype.doRefresh=function(){!this.suspended&&y.isRefreshable(this.controller)&&this.controller.refresh()};var l;return n.maximumFeatureCount=-1,o([h.property()],n.prototype,"layer",void 0),o([h.property()],n.prototype,"controller",void 0),o([h.property({readOnly:!0,dependsOn:["layer"]})],n.prototype,"controllerTypeForSource",null),o([h.property({readOnly:!0,dependsOn:["controllerTypeForSource","controller"]})],n.prototype,"asyncGraphicsUpdates",null),o([h.property({readOnly:!0,dependsOn:["controllerTypeForSource","controller"]})],n.prototype,"suspendResumeExtentMode",null),o([h.property({dependsOn:["suspended","controller"]})],n.prototype,"displayLimitExceeded",null),n=l=o([h.subclass("esri.views.3d.layers.FeatureLayerView3D")],n)}(h.declared(m,v)),x=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.items=new Set,t}r(t,e),n=t,Object.defineProperty(t.prototype,"length",{get:function(){return this.items.size},enumerable:!0,configurable:!0}),t.prototype.addMany=function(e){for(var t=0,r=e;t<r.length;t++){var o=r[t];this.items.add(o)}this.emit("change",{added:e,removed:[],moved:[]})},t.prototype.removeMany=function(e){for(var t=0,r=e;t<r.length;t++){var o=r[t];this.items.delete(o)}return this.emit("change",{added:[],removed:e,moved:[]}),e},t.prototype.removeAll=function(){var e=this.toArray();this.emit("change",{added:[],removed:e,moved:[]})},t.prototype.toArray=function(){var e=[];return this.items.forEach(function(t){return e.push(t)}),e},t.prototype.forEach=function(e){this.items.forEach(e)},t.prototype.some=function(e){return this.toArray().some(e)},t.prototype.find=function(e){var t=null;return this.forEach(function(r){!t&&e(r)&&(t=r)}),t},t.prototype.filter=function(e){var t=new n;return this.forEach(function(r){e(r)&&t.items.add(r)}),t};var n;return t=n=o([h.subclass("esri.views.3d.layers.FeatureLayerView3D.SetCollection")],t)}(h.declared(l)),b=.1,F=.25;return w});