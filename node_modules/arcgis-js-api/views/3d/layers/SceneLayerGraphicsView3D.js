// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../Graphic","../../../core/Handles","../../../core/Logger","../../../core/PooledArray","../../../core/promiseUtils","../../../core/sniff","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/rbush/PooledRBush","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/contains","../../../layers/graphics/dehydratedFeatures","../../../renderers/support/renderingInfoUtils","./LayerView3D","./graphics/Graphics3DFeatureLikeLayerView","./graphics/Graphics3DVerticalScale","./i3s/I3SQueryEngine","./i3s/I3SUtil","./i3s/MemCache","./support/layerViewUpdatingProperties","../lib/glMatrix","../support/EventedArray","../support/orientedBoundingBox","../support/projectionUtils"],function(e,t,r,i,n,o,a,d,s,l,u,h,p,c,g,y,f,_,v,b,m,x,E,I,A,C,D,S,w){function N(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,e.hasZ&&(e.zmin-=t,e.zmax+=t),e.hasM&&(e.mmin-=t,e.mmax+=t),e}var F=a.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D"),O=function(e){function t(t){var r=e.call(this)||this;return r._nodesAddedToStage={},r._handles=new o,r._controllerCreated=!1,r.overlayUpdating=!1,r.supportsDraping=!0,r._queryEngine=null,r._memCache=new I(50),r._usedMemory=0,r.loadedGraphics=new D,r.supportsHeightUnitConversion=!0,r._coordinatesOutsideExtentErrors=0,r._maxCoordinatesOutsideExtentErrors=20,r._definitionExpressionErrors=0,r._maxDefinitionExpressionErrors=20,r}return r(t,e),t.prototype.initialize=function(){var e=this;E.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode),this._handles.add([u.init(this.layer,"rangeInfos",function(t){return e._rangeInfosChanged(t)}),this.layer.watch("renderer",function(t,r){return e._rendererChange(t,r)}),this.layer.watch("objectIdFilter",function(){return e._objectIdFilterChange()}),this.watch("_controller.parsedDefinitionExpression",function(){return e._definitionExpressionChange()})]),this.graphics3d=new b({owner:this,layer:this.layer,asyncGraphicsUpdates:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,suspendResumeExtentMode:"data",dataExtent:this.layer.fullExtent,updateClippingExtent:function(t){return e._updateClippingExtent(t)},queryGraphicUIDsInExtent:function(t,r,i){return e._queryGraphicUIDsInExtent(t,r,i)}}),this.supportsHeightUnitConversion&&(this._verticalScale=new m({sourceSpatialReference:this.layer.spatialReference,destSpatialReference:this.view.spatialReference})),this.addResolvingPromise(this.graphics3d.setup()),this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this._createController(),this.when(function(){e._handles.add(e.graphics3d.graphicsCore.watch("maxNumberOfFeatures",function(t){e._controller.featureTarget=t}))})},t.prototype.destroy=function(){this.graphics3d&&(this.graphics3d.destroy(),this.graphics3d=null),this._controller&&(this._controller.destroy(),this._controller=null),this._elevationUpdateNodes=null,this._nodesAddedToStage=null,this._usedMemory=0,this._handles&&(this._handles.destroy(),this._handles=null)},Object.defineProperty(t.prototype,"displayLimitExceeded",{get:function(){return!this.suspended&&(!!this._controller&&!this._controller.leafsReached)},enumerable:!0,configurable:!0}),t.prototype.whenGraphicAttributes=function(e,t){var r=this,i=function(){var t=r._findGraphicNodeAndIndex(e);return{node:t.node,indices:[t.index]}};return E.whenGraphicAttributes(this.layer,[e],this._getObjectIdField(),t,i,{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(e){return e[0]})},t.prototype.getGraphicFromGraphicUid=function(e){if(!this.loadedGraphics)return s.reject();var t=f.hydrateGraphic(this.loadedGraphics.find(function(t){return t.uid===e}),this.layer),r=this._getObjectIdField();return t&&t.attributes&&t.attributes[r]?(t.layer=this.layer,t.sourceLayer=this.layer,s.resolve(t)):s.reject()},t.prototype.whenGraphicBounds=function(e,t){return this.graphics3d.graphicsCore.whenGraphicBounds(e,t)},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this.overlayUpdating||!this._controllerCreated||this._controller&&this._controller.updating||!this.graphics3d.destroyed&&this.graphics3d.updating},t.prototype.getRenderingInfo=function(e){var t=_.getRenderingInfo(e,{renderer:this.layer.renderer});if(t&&t.color){var r=t.color;r[0]=r[0]/255,r[1]=r[1]/255,r[2]=r[2]/255}return t},Object.defineProperty(t.prototype,"symbolUpdateType",{get:function(){return this.graphics3d.graphicsCore.symbolUpdateType},enumerable:!0,configurable:!0}),t.prototype._findGraphicNodeAndIndex=function(e){for(var t=e.attributes[this.layer.objectIdField],r=0,i=Object.keys(this._nodesAddedToStage);r<i.length;r++){var n=i[r],o=this._nodesAddedToStage[n].bundle,a=this._findGraphicIndex(o,t);if(a>=0)return{node:this._controller.nodeIndex[n],index:a}}return null},t.prototype._forAllFeatures=function(e,t){for(var r=0,i=Object.keys(this._nodesAddedToStage);r<i.length;r++){for(var n=i[r],o=this._nodesAddedToStage[n],a=o.bundle,d=0;d<a.length;d++)for(var s=a[d].graphics,l=0;l<s.length;l++){var u=s[l],h=a[d].featureIds[l];u.visible&&e(h,d,u)}null!=t&&t({nodeId:n})}},t.prototype._getGraphicIndices=function(e,t){for(var r=this._nodesAddedToStage[e],i=this._getObjectIdField(),n=[],o=0,a=t;o<a.length;o++){var d=a[o],s=d.attributes[i],l=this._findGraphicIndex(r.bundle,s);l>=0&&n.push(l)}return n},t.prototype._findGraphicIndex=function(e,t){for(var r=0;r<e.length;r++)for(var i=0,n=e[r].featureIds;i<n.length;i++){var o=n[i];if(o===t)return r}return-1},t.prototype._queryGraphicUIDsInExtent=function(e,t,r){if(this._controller){var i=this._controller.crsIndex;w.boundingRectToBoundingRect(e,t,j,i);var n=U;c.fromRect(n,j),n[2]=-1/0,n[5]=1/0,null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new d({initialSize:10}));var o=this._elevationUpdateNodes;o.clear(),this._controller.updateElevationChanged(n,i,o);for(var a=0;a<o.length;a++){var s=o.data[a],u=this._nodesAddedToStage[s.id];if(null!=u){if(!u.spatialIndex&&u.bundle.length>=G){var h=new p.PooledRBush(9,l("csp-restrictions")?function(e){return{minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]);B.length=0;for(var y=0,_=u.bundle;y<_.length;y++){for(var v=_[y],b=g.empty(),m=0,x=v.graphics;m<x.length;m++){var E=x[m];f.expandAABR(E.geometry,b)}v.extent=b,B.push(v)}h.load(B),u.spatialIndex=h}if(u.spatialIndex){var I=j;w.boundingRectToBoundingRect(e,t,j,this.view.spatialReference),R.minX=I[0],R.minY=I[1],R.maxX=I[2],R.maxY=I[3],u.spatialIndex.search(R,function(e){for(var t=0,i=e.graphics;t<i.length;t++){var n=i[t];r(n.uid)}})}else for(var A=0,C=u.bundle;A<C.length;A++)for(var v=C[A],D=0,S=v.graphics;D<S.length;D++){var E=S[D];r(E.uid)}}}}},t.prototype.highlight=function(e,t){return this.graphics3d.highlight(e,t,this.layer.objectIdField)},t.prototype._createController=function(){var e=this,t={addNodeData:function(t,r){return e._addNodeData(t,r)},isNodeLoaded:function(t){return e._isNodeLoaded(t)},removeNodeData:function(t){return e._removeNodeData(t)},getLoadedNodeIDs:function(){return e._getLoadedNodeIDs()},getLoadedAttributes:function(t){return e._getLoadedAttributes(t)},getAttributeData:function(t){return e._getAttributeData(t)},setAttributeData:function(t,r,i){return e._setAttributeData(t.id,r,i)},getMemoryUsage:function(){return e.view.resourceController.usedMemory}},r={loadCachedNodeData:function(t,r){return e._loadCachedNodeData(t,r)},addCachedNodeData:function(t,r,i){return e._addCachedNodeData(t,r,i)}};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){e._controller=t,t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})}).always(function(){e._controllerCreated=!0,e.notifyChange("updating")})},t.prototype._addNodeData=function(e,t){var r=t.allGeometryData,i=t.attributeDataInfo,o=this._controller.crsIndex,a=this.view.spatialReference,d=[0,0,0],l=this._getObjectIdField();e.memory=4096,null==this._nodesAddedToStage[e.id]&&(this._nodesAddedToStage[e.id]={bundle:[],attributeData:i?i.attributeData:null,loadedAttributes:i?i.loadedAttributes:null});var u=[];this._nodesAddedToStage[e.id].bundle=u;for(var h=this.layer.fullExtent&&N(this.layer.fullExtent.clone(),.5),p=[],c=[],g=0;g<r.length;g++){var _=r[g],v=_.featureDataPosition,b=v.length,m=_.geometries||[T[b]],x=_.featureIds;h&&!y.extentContainsCoords3D(h,v)&&(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&F.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&F.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++);for(var E=0;E<m.length;E++){var I=m[E];if("points"===I.params.type){var A=[],C=E<x.length?E:0,D=x[C],O={};null!=D&&(O[l]=D);var G=void 0;"Embedded"===I.type&&(G=I.params.vertexAttributes.position);for(var j=0;j<G.length;j+=b){for(var U=0;U<b;U++)d[U]=v[U]+G[j+U];w.bufferToBuffer(d,o,0,M,a,0,1);var R=f.makeDehydratedPoint(M[0],M[1],M[2],a);b<3&&(R.z=void 0),A.push({uid:n.generateUID(),geometry:R,attributes:O,visible:!0}),e.obb||c.push(R.x,R.y,R.z?R.z:0)}e.memory+=16*G.length,p.push.apply(p,A),u.push({featureIds:_.featureIds,graphics:A})}}}e.numFeatures=p.length,e.memory/=1048576;var B=this._nodesAddedToStage[e.id];if(this._setBundleAttributes(B.bundle,B.loadedAttributes,B.attributeData),c.length>0){var V=this.view.renderSpatialReference,L=this._controller.crsVertex;w.bufferToBuffer(c,a,0,c,V,0,c.length/3);var q={data:c,size:3,offsetIdx:0,strideIdx:3};e.obb=S.compute(q),w.vectorToVector(e.obb.center,V,e.obb.center,L),this._controller.updateVisibility(e.id)}return this._controller.isGeometryVisible(e)?(this._verticalScale&&this._verticalScale.adjust(p),this._usedMemory+=e.memory,this.loadedGraphics.addMany(p),this._filterNode(B),s.resolve()):(this._memCache.put(e.id,this._nodesAddedToStage[e.id],e.memory),delete this._nodesAddedToStage[e.id],s.resolve())},t.prototype._isNodeLoaded=function(e){return null!=this._nodesAddedToStage[e.id]},t.prototype._removeAllNodeData=function(){var e=this;Object.keys(this._nodesAddedToStage).forEach(function(t){var r=e._nodesAddedToStage[t];if(r){var i=e._controller.nodeIndex[t];e._memCache.put(t,r,i.memory)}}),this._nodesAddedToStage={},this._usedMemory=0,this.loadedGraphics.clear()},t.prototype._removeNodeData=function(e){var t=this,r=[];e.forEach(function(e){var i=t._removeNodeStageData(e,r);i&&t._memCache.put(e.id,i,e.memory)}),this.loadedGraphics.removeUnorderedMany(r)},t.prototype._removeNodeStageData=function(e,t){var r=this._nodesAddedToStage[e.id];if(!r)return null;for(var i=0,n=r.bundle;i<n.length;i++){var o=n[i];t.push.apply(t,o.graphics)}return delete this._nodesAddedToStage[e.id],this._usedMemory-=e.memory,this._usedMemory<9.5367431640625e-7&&(this._usedMemory=0),r},t.prototype._loadCachedNodeData=function(e,t){return s.resolve(this._memCache.get(e.id))},t.prototype._addCachedNodeData=function(e,t,r){for(var i=[],n=0,o=t.bundle;n<o.length;n++){var a=o[n];i.push.apply(i,a.graphics)}return this._nodesAddedToStage[e.id]=t,this._setAttributeData(e.id,r.loadedAttributes,r.attributeData),this._usedMemory+=e.memory,this.loadedGraphics.addMany(i),this._filterNode(t),s.resolve()},t.prototype._getLoadedNodeIDs=function(){return Object.keys(this._nodesAddedToStage)},t.prototype._getLoadedAttributes=function(e){var t=this._nodesAddedToStage[e.id];if(t)return t.loadedAttributes},t.prototype._getAttributeData=function(e){var t=this._nodesAddedToStage[e.id];if(t)return t.attributeData},t.prototype._setAttributeData=function(e,t,r){var i=this._nodesAddedToStage[e];if(i&&(i.loadedAttributes=t,i.attributeData=r,this._setBundleAttributes(i.bundle,t,r),this._filterNode(i),this.graphics3d.graphicsCore.labelsEnabled)){var n=i.bundle.map(function(e){return e.graphics.length&&e.graphics[0].uid});this.graphics3d.graphicsCore.updateLabelingInfo(n)}},t.prototype._setBundleAttributes=function(e,t,r){for(var i=0;i<e.length;i++)for(var n=e[i],o=0,a=n.graphics;o<a.length;o++){var d=a[o];if(d.attributes||(d.attributes={}),t)for(var s=0,l=t;s<l.length;s++){var u=l[s].name;r[u]&&(d.attributes[u]=E.getCachedAttributeValue(r[u],i))}}},t.prototype._updateClippingExtent=function(e){return this._controller&&this._controller.updateClippingArea(e),!1},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._rendererChange=function(e,t){var r=e?e.requiredFields:[],i=t?t.requiredFields:[];r.length===i.length&&r.every(function(e,t){return r[t]===i[t]})||this._reloadAllNodes()},t.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&F.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},t.prototype._objectIdFilterChange=function(){var e=this;Object.keys(this._nodesAddedToStage).forEach(function(t){return e._filterNode(e._nodesAddedToStage[t])})},t.prototype._reloadAllNodes=function(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()},t.prototype._definitionExpressionChange=function(){this._definitionExpressionErrors=0},t.prototype._evaluateClause=function(e,t){try{return!!e.calculateValue(t)}catch(e){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&F.error("Error while evaluating definitionExpression: "+e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&F.error("Further errors are ignored"),!1}},t.prototype._filterNode=function(e){var t=this._getObjectIdField(),r=null;if(this.layer.objectIdFilter){var i=this.layer.objectIdFilter.ids,n="include"===this.layer.objectIdFilter.method;r=function(e){return i.indexOf(e)>=0===n}}for(var o=this._controller.parsedDefinitionExpression,a=0,d=e.bundle;a<d.length;a++)for(var s=d[a],l=0,u=s.graphics;l<u.length;l++){var h=u[l],p=h.visible;r&&!r(h.attributes[t])?h.visible=!1:h.visible=!o||this._evaluateClause(o,h),p!==h.visible&&(V.graphic=h,V.property="visible",V.oldValue=p,V.newValue=h.visible,this.layer.graphicChanged(V))}},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},t.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,graphic:null},r=this;return new x(this.layer,{forAll:function(r,i){function n(e,i,n){t.id=e,t.index=i,t.graphic=n,r(t)}e._forAllFeatures(n,i)},createGraphic:function(e){return f.hydrateGraphic(e.graphic,r.layer)},requestFields:function(t,r,i){var n=function(){var i=e._getGraphicIndices(t.nodeId,r);return{node:e._controller.nodeIndex[t.nodeId],indices:i}};return E.whenGraphicAttributes(e.layer,r,e._getObjectIdField(),i,n,{ignoreUnavailableFields:!1})},createExtentBuilder:function(){var t=c.empty(),r=e.layer.spatialReference;return{add:function(e){return f.expandAABB(e.graphic.geometry,t)},getExtent:function(){return c.toExtent(t,r)}}}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},t.prototype.getUsedMemory=function(){var e=this._usedMemory;return this._controller&&(e+=512*Object.keys(this._controller.nodeIndex).length/1048576),e},t.prototype.getUnloadedMemory=function(){return this._controller?this._controller.getUnloadedMemoryEstimate():0},t.prototype.getCachedMemory=function(){return this._memCache.getSize()},t.prototype.removeCachedData=function(){if(this._memCache.getSize()>0)return void this._memCache.clear();this.suspended&&this._removeAllNodeData(),this._memCache.clear()},t.prototype.getStats=function(){var e=this.inherited(arguments)||{};return e.index=this._controller?Object.keys(this._controller.nodeIndex).length:0,e.nodes=Object.keys(this._nodesAddedToStage).length,e.features=this.loadedGraphics.length,e.cache=this._memCache.getSize().toFixed(2)+"MB, "+Math.round(100*this._memCache.getHitRate())+"% hit",this._controller&&this._controller.updateStats(e),e},i([h.property()],t.prototype,"graphics3d",void 0),i([h.property()],t.prototype,"drawingOrder",void 0),i([h.property({aliasOf:"graphics3d.graphicsCore.hasDraped"})],t.prototype,"hasDraped",void 0),i([h.property({type:Boolean})],t.prototype,"overlayUpdating",void 0),i([h.property({type:Boolean})],t.prototype,"supportsDraping",void 0),i([h.property()],t.prototype,"loadedGraphics",void 0),i([h.property()],t.prototype,"layer",void 0),i([h.property()],t.prototype,"_controller",void 0),i([h.property({dependsOn:["_controller.updating","graphics3d.updating","overlayUpdating"]})],t.prototype,"updating",void 0),i([h.property(A.updatingPercentage)],t.prototype,"updatingPercentage",void 0),i([h.property({aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),i([h.property({dependsOn:["suspended","_controller.leafsReached"]})],t.prototype,"displayLimitExceeded",null),t=i([h.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],t)}(h.declared(v)),T={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},G=100,j=g.create(),U=c.create(c.POSITIVE_INFINITY),R={minX:0,minY:0,maxX:0,maxY:0},M=C.vec3d.create(),B=[],V={graphic:null,property:null,oldValue:null,newValue:null};return O});