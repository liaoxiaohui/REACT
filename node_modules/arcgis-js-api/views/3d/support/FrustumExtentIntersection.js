// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../lib/glMatrix","./earthUtils","./geometryUtils","./intersectionUtils","./mathUtils","./projectionUtils"],function(e,t,i,n,r,o,a,s,c,d){Object.defineProperty(t,"__esModule",{value:!0});var l=.5*Math.PI,p=l/Math.PI*180,h=l*o.earthRadius,u=.9*o.earthRadius,g=function(){function e(e){this.renderCoordsHelper=e.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:r.vec3d.create(),direction:r.vec3d.create()};for(var t=0;t<4;t++)this.extent[t]={origin:r.vec3d.create(),direction:r.vec3d.create(),cap:{next:null,direction:r.vec3d.create()}},this.planes[t]=a.plane.create();this.planes[4]=a.plane.create(),this.planes[5]=a.plane.create(),this.planesWithoutFar=this.planes.slice(0,5)}return e.prototype.update=function(e,t,i,n){void 0===n&&(n=!0);var o=this.extent;this.toRenderBoundingExtent(e,t,i),r.vec3d.add(o[0].origin,o[2].origin,this.center.origin),r.vec3d.scale(this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),n||r.vec3d.scale(this.center.direction,-1);for(var s=0;s<4;s++){var c=o[s];this.renderCoordsHelper.worldUpAtPosition(c.origin,c.direction);var d=o[3===s?0:s+1];c.cap.next=d.origin,r.vec3d.direction(d.origin,c.origin,c.cap.direction),a.plane.fromVectorsAndPoint(c.direction,c.cap.direction,c.origin,this.planes[s]),n||r.vec3d.scale(c.direction,-1)}a.plane.fromVectorsAndPoint(o[0].cap.direction,o[1].cap.direction,o[0].origin,this.planes[4]),n?a.plane.negate(this.planes[4],this.planes[5]):(a.plane.set(this.planes[5],this.planes[4]),a.plane.negate(this.planes[4])),this.maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this.maxSpanSpatialReference=t},e.prototype.isVisibleInFrustum=function(e,t){if(void 0===t&&(t=!1),"global"===this.renderCoordsHelper.type){var i=this.maxSpanSpatialReference.isWGS84?p:h;if(this.maxSpan>i)return!0;if(e.altitude>=u)return this.isVisibleInFrustumGlobal(e)}for(var n=0;n<this.extent.length;n++){var r=this.extent[n];if(!t&&e.intersectsRay(r.origin,null,r.direction))return!0;if(e.intersectsLineSegment(r.origin,r.cap.next,r.cap.direction))return!0}for(var o=t?this.planes:this.planesWithoutFar,n=0;n<e.lines.length;n++){var a=e.lines[n];if(s.frustumLineSegment(o,a.origin,a.endpoint,a.direction))return!0}return!1},e.prototype.toRenderBoundingExtentGlobal=function(e,t,o){n.center(e,v),v[2]=o,d.computeLinearTransformation(t,v,f,this.renderCoordsHelper.spatialReference),r.mat4d.inverse(f,m),i.empty(y);for(var a=0,s=x;a<s.length;a++)for(var l=s[a],p=l.x0,h=l.x1,u=l.y0,g=l.y1,b=0;b<5;b++){var R=b/4;v[0]=c.lerp(e[p],e[h],R),v[1]=c.lerp(e[u],e[g],R),v[2]=o,d.vectorToVector(v,t,v,this.renderCoordsHelper.spatialReference),r.mat4d.multiplyVec3(m,v),i.expandPointInPlace(y,v)}r.mat4d.multiplyVec3(f,r.vec3d.set3(y[0],y[1],y[2],this.extent[0].origin)),r.mat4d.multiplyVec3(f,r.vec3d.set3(y[3],y[1],y[2],this.extent[1].origin)),r.mat4d.multiplyVec3(f,r.vec3d.set3(y[3],y[4],y[2],this.extent[2].origin)),r.mat4d.multiplyVec3(f,r.vec3d.set3(y[0],y[4],y[2],this.extent[3].origin))},e.prototype.toRenderBoundingExtentLocal=function(e,t,i){r.vec3d.set3(e[0],e[1],i,this.extent[0].origin),r.vec3d.set3(e[2],e[1],i,this.extent[1].origin),r.vec3d.set3(e[2],e[3],i,this.extent[2].origin),r.vec3d.set3(e[0],e[3],i,this.extent[3].origin)},e.prototype.toRenderBoundingExtent=function(e,t,i){switch(this.renderCoordsHelper.type){case"global":this.toRenderBoundingExtentGlobal(e,t,i);break;case"local":this.toRenderBoundingExtentLocal(e,t,i);break;default:this.renderCoordsHelper.type}},e.prototype.isVisibleInFrustumGlobal=function(e){if(r.vec3d.dot(this.center.direction,e.direction)<0)return!0;for(var t=0;t<4;t++){var i=this.extent[t];if(r.vec3d.dot(i.direction,e.direction)<0)return!0}return!1},e}();t.FrustumExtentIntersection=g;var x=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],v=r.vec3d.create(),f=r.mat4d.create(),m=r.mat4d.create(),y=i.create();t.default=g});