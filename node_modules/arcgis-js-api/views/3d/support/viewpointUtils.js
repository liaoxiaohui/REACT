// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../Camera","../../../geometry","../../../Graphic","../../../Viewpoint","../../../core/Error","../../../core/promiseUtils","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/webMercatorUtils","../camera/intersectionUtils","../lib/glMatrix","./cameraUtils","./intersectionUtils","./mathUtils","./projectionUtils"],function(e,t,a,n,r,i,o,c,l,s,u,m,f,p,d,g,v){function h(e){return 360-g.cyclicalDeg.normalize(e)}function y(e){return g.cyclicalDeg.normalize(360-e)}function x(e,t,r){if(!t)return null;var i=e.spatialReference||n.SpatialReference.WGS84;if(t.camera){var o=t.get("camera.position.spatialReference");if(!u.canProject(o,i))return null;var c=t.camera.clone();return o.equals(i)||(c.position=u.project(c.position,i)),c}var l=t.get("targetGeometry.spatialReference");if(l&&!u.canProject(l,i))return null;var s=p.internalToExternal(e,e.state.camera),m={noReset:!1};if(null!=t.rotation&&(s.heading=h(t.rotation),m.noReset=!0),null!=r&&(s.tilt=r),"point"===t.targetGeometry.type){var f=t.targetGeometry,d=void 0,g=t.targetGeometry.clone();d=null!=t.scale?p.scaleToDistance(e,t.scale,f.latitude):e.state.camera.distance;var y=p.eyeHeadingTiltForCenterPointAtDistance(e,s.heading,s.tilt,g,d,m),x=v.vectorToPoint(y.eye,e.renderSpatialReference,i);return new a(x,y.heading,y.tilt,s.fov)}var R=t.targetGeometry.extent;return p.fromExtent(e,R,s.heading,s.tilt,m)}function R(e,t,n){return n||(n=new i({camera:new a})),p.internalToExternal(e,t,n.camera),z(e,t,n)}function w(e,t,a){return a||(a=new i),a.camera=t.clone(),z(e,null,a)}function b(e,t){var r=U(e,t);if(!r)return c.reject(new o("viewpointutils-create:no-target","Missing target for creating viewpoint"));var u=new i({camera:new a({fov:e.camera.fov})}),m=null!=r.scale||null!=r.zoom;if(r.target instanceof i)return k(P(e,r.target,r,u));if(r.target instanceof a)return k(B(e,r,r.target,u));if(r.target instanceof n.Extent){var f=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return k(m||f?F(e,r,r.target.center,u):D(e,r,r.target,u))}var p={boundingBox:l.empty(),hasZ:!1,screenSpaceObjects:[]},d=m?G(e,r):void 0;return M(e,r.target,d,p).then(function(){if(isFinite(p.boundingBox[0])){l.center(p.boundingBox,I),K.x=I[0],K.y=I[1],K.z=I[2],K.spatialReference=e.spatialReference;var t=void 0;return isFinite(K.z)&&p.hasZ?t=l.isPoint(p.boundingBox):(K.z=void 0,t=s.isPoint(l.toRect(p.boundingBox,L))),m||t?F(e,r,K,u):Z(e,r,K,p.boundingBox,_(e,p.screenSpaceObjects),u)}return r.position?V(e,r,u):C(e,r,u)}).then(function(e){return k(e)})}function T(e,t){var a=t.scale;return null==a&&null!=t.zoom&&(a=p.zoomToScale(e,t.zoom)),a}function G(e,t){return p.scaleToResolution(e,T(e,t))}function S(e,t){var a=!1;return null!=t.heading?(e.heading=t.heading,a=!0):null!=t.rotation&&(e.heading=h(t.rotation),a=!0),null!=t.tilt&&(e.tilt=t.tilt,a=!0),null!=t.fov&&(e.fov=t.fov),a}function z(e,t,a){var r=e.spatialReference||n.SpatialReference.WGS84;return t=t||p.externalToInternal(e,a.camera),a.targetGeometry=v.vectorToPoint(t.center,e.renderSpatialReference,r),a.scale=p.computeScale(e,t),a.rotation=y(a.camera.heading),a}function E(e,t,a){if(t){if(!u.canProject(t.spatialReference,e.spatialReference))throw new o("viewpointutils:incompatible-spatialreference","Spatial reference ("+(t.spatialReference?t.spatialReference.wkid:"unknown")+") is incompatible with the view ("+e.spatialReference.wkid+")",{geometry:t});var n=[];if(!t.hasZ&&e.basemapTerrain){var r=void 0;switch(t.type){case"point":r=t;break;case"multipoint":case"polyline":case"mesh":r=t.extent.center;break;case"extent":r=t.center;break;case"polygon":r=t.centroid}r&&u.canProject(r,e.basemapTerrain.spatialReference)?I[2]=e.basemapTerrain.getElevation(r)||0:I[2]=0}(0,Q[t.type])(t,function(e){n.push(e[0],e[1],e[2])},I);var i=n.length/3;if(0!==i){var c=new Array(n.length);if(v.bufferToBuffer(n,t.spatialReference,0,c,e.spatialReference,0,i)){t.hasZ&&(a.hasZ=!0);for(var s=0;s<c.length;s+=3)t.hasZ?(I[0]=c[s+0],I[1]=c[s+1],I[2]=c[s+2]):(I[0]=c[s+0],I[1]=c[s+1]),l.expand(a.boundingBox,I)}}}}function A(e,t,a,n){return e.whenViewForGraphic(t).then(function(e){if(e&&e.whenGraphicBounds)return e.whenGraphicBounds(t,{minDemResolution:a})}).then(function(e){var t=e.boundingBox;l.expand(n.boundingBox,t),e.screenSpaceObjects&&e.screenSpaceObjects.forEach(function(e){n.screenSpaceObjects.push(e)}),isFinite(t[2])&&(n.hasZ=!0)}).catch(function(){E(e,t.geometry,n)})}function M(e,t,a,i){if(Array.isArray(t)&&2===t.length){var o=t[0],l=t[1];if("number"==typeof o&&"number"==typeof l)return K.x=o,K.y=l,K.z=void 0,K.spatialReference=n.SpatialReference.WGS84,E(e,K,i),c.resolve()}if(t&&"function"==typeof t.map)return c.eachAlways(t.map(function(t){return M(e,t,a,i)}));if(t instanceof n.BaseGeometry)try{E(e,t,i)}catch(e){return c.reject(e)}else if(t instanceof r)return A(e,t,a,i);return c.resolve()}function P(e,t,a,n){if(t.camera)return B(e,a,t.camera,n);n.scale=t.scale,n.rotation=t.rotation,n.targetGeometry=t.targetGeometry?t.targetGeometry.clone():null,n.camera=null,null!=a.heading?n.rotation=y(a.heading):null!=a.rotation&&(n.rotation=a.rotation);var r=T(e,a);return null!=r&&(n.scale=r),n.camera=x(e,n,a.tilt),n}function B(e,t,a,n){n.camera=a.clone(),n.camera.fov=e.camera.fov;var r=e.spatialReference,i=n.camera.position.spatialReference;return u.canProject(i,r)?(i.equals(r)||(n.camera.position=u.project(n.camera.position,r)),z(e,null,n)):null}function j(e,t,a,r,i){var o=e.renderSpatialReference;return v.pointToVector(a.position,Y,o),v.pointToVector(t,X,o),i.targetGeometry=new n.Point(t),i.camera.position=new n.Point(a.position),f.vec3d.subtract(X,Y,W),p.directionToHeadingTilt(e,Y,W,r.up,i.camera),i.scale=p.distanceToScale(e,f.vec3d.dist(Y,X),i.targetGeometry.latitude),i.rotation=y(i.camera.heading),i}function F(e,t,a,n){if(!a)return null;n.targetGeometry=a.clone();var r=m.cameraOnContentAlongViewDirection(e);if(t.position)return j(e,n.targetGeometry,t,r,n);if(t.zoomFactor){var i=r.distance/t.zoomFactor,o=f.vec3d.scale(r.viewForward,-i,I);f.vec3d.add(r.center,o,r.eye),r.markViewDirty(),n.scale=p.distanceToScale(e,i,a.latitude)}p.internalToExternal(e,r,n.camera);var c={noReset:!1};return S(n.camera,t)&&(c.noReset=!0),t.zoomFactor||(n.scale=T(e,t),null==n.scale&&(v.pointToVector(a,I,e.renderSpatialReference),d.frustumPoint(r.frustumPlanes,I)?n.scale=p.distanceToScale(e,f.vec3d.dist(r.eye,I),a.latitude):n.scale=p.computeScale(e,r)),p.fromCenterScale(e,n.targetGeometry,n.scale,n.camera,c,n.camera))?n:null}function V(e,t,a){var r=m.cameraOnContentAlongViewDirection(e);return f.vec3d.set(r.viewForward,W),p.directionToHeadingTilt(e,r.eye,W,r.up,J),a.camera.position=new n.Point(t.position),a.camera.heading=null!=t.heading?t.heading:J.heading,a.camera.tilt=null!=t.tilt?t.tilt:J.tilt,z(e,null,a)}function C(e,t,a){var n=m.cameraOnContentAlongViewDirection(e);return F(e,t,v.vectorToPoint(n.center,e.renderSpatialReference,K,e.spatialReference),a)}function D(e,t,a,n){n.targetGeometry=a.clone();var r=m.cameraOnContentAlongViewDirection(e);p.internalToExternal(e,r,n.camera);var i={noReset:!1};return S(n.camera,t)&&(i.noReset=!0),p.fromExtent(e,a,n.camera.heading,n.camera.tilt,i,n.camera)?n:null}function O(e,t,a,n,r){var i=0;a.hasZ?i=a.z:e.basemapTerrain&&(i=e.basemapTerrain.getElevation(a)),f.vec3d.set3(a.x,a.y,i,I),v.computeLinearTransformation(e.spatialReference,I,q,e.renderSpatialReference),f.mat4d.toMat3(q,H),f.mat3d.transpose(H),l.empty(N);for(var o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],c=0;c<o.length;c++){var s=o[c],u=n[s[2]];isFinite(u)||(u=i),f.vec3d.set3(n[s[0]],n[s[1]],u,I),v.vectorToVector(I,e.spatialReference,I,e.renderSpatialReference),l.expand(N,f.mat3d.multiplyVec3(H,I))}var m=l.width(N),p=l.height(N),d=l.depth(N),g=1/Math.tan(t.fovX/2),h=1/Math.tan(t.fovY/2),y=Math.sqrt(m*m+d*d),x=.5*y*Math.max(h,g)+.5*p,R=.5*p*h+.5*Math.max(m,d);return Math.max(x,R)/r}function Z(e,t,a,n,r,i){i.targetGeometry=a.clone();var o=m.cameraOnContentAlongViewDirection(e),c=O(e,o,a,n,r);p.internalToExternal(e,o,i.camera);var l={noReset:!1};return S(i.camera,t)&&(l.noReset=!0),i.scale=p.distanceToScale(e,c,i.targetGeometry.latitude),p.fromCenterScale(e,i.targetGeometry,i.scale,i.camera,l,i.camera)?i:null}function U(e,t){if(!t||!e.spatialReference)return null;var a={target:null};if("declaredClass"in t||Array.isArray(t))a.target=t;else{for(var n in t)a[n]=t[n];t.center&&!a.target&&(a.target=t.center)}return a}function k(e){return e&&(e.rotation=y(e.camera.heading)),c.resolve(e)}function _(e,a){var n=t.DEFAULT_FRAME_COVERAGE;if(!a.length)return n;for(var r=Number.NEGATIVE_INFINITY,i=0;i<a.length;i++){var o=a[i].screenSpaceBoundingRect;r=Math.max(r,Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2]),Math.abs(o[3]))}return n-r/Math.min(e.width,e.height)*2}Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_FRAME_COVERAGE=.66,t.rotationToHeading=h,t.headingToRotation=y,t.toCamera=x,t.fromInternalCamera=R,t.fromCamera=w,t.create=b;var I=f.vec3d.create(),q=f.mat4d.create(),H=f.mat3d.create(),N=l.create(),L=s.create(),W=f.vec3d.create(),Y=f.vec3d.create(),X=f.vec3d.create(),J={heading:0,tilt:0},K=new n.Point,Q={point:function(e,t,a){a[0]=e.x,a[1]=e.y,e.hasZ&&(a[2]=e.z),t(a)},polygon:function(e,t,a){for(var n=e.hasZ,r=0;r<e.rings.length;r++)for(var i=e.rings[r],o=0;o<i.length;o++)a[0]=i[o][0],a[1]=i[o][1],n&&(a[2]=i[o][2]),t(a)},polyline:function(e,t,a){for(var n=e.hasZ,r=0;r<e.paths.length;r++)for(var i=e.paths[r],o=0;o<i.length;o++)a[0]=i[o][0],a[1]=i[o][1],n&&(a[2]=i[o][2]),t(a)},multipoint:function(e,t,a){for(var n=e.points,r=e.hasZ,i=0;i<n.length;i++)a[0]=n[i][0],a[1]=n[i][1],r&&(a[2]=n[i][2]),t(a)},extent:function(e,t,a){e.hasZ?(t(f.vec3d.set3(e.xmin,e.ymin,e.zmin,a)),t(f.vec3d.set3(e.xmax,e.ymin,e.zmin,a)),t(f.vec3d.set3(e.xmin,e.ymax,e.zmin,a)),t(f.vec3d.set3(e.xmax,e.ymax,e.zmin,a)),t(f.vec3d.set3(e.xmin,e.ymin,e.zmax,a)),t(f.vec3d.set3(e.xmax,e.ymin,e.zmax,a)),t(f.vec3d.set3(e.xmin,e.ymax,e.zmax,a)),t(f.vec3d.set3(e.xmax,e.ymax,e.zmax,a))):(t(f.vec3d.set3(e.xmin,e.ymin,a[2],a)),t(f.vec3d.set3(e.xmax,e.ymin,a[2],a)),t(f.vec3d.set3(e.xmin,e.ymax,a[2],a)),t(f.vec3d.set3(e.xmax,e.ymax,a[2],a)))},mesh:function(e,t,a){var n=e.vertexAttributes&&e.vertexAttributes.position;if(n)for(var r=0;r<n.length;r+=3)t(f.vec3d.set3(n[r+0],n[r+1],n[r+2],a))}}});