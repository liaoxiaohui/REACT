// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../Camera","../../../config","../../../core/Logger","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/scaleUtils","../../../geometry/support/webMercatorUtils","../camera/intersectionUtils","../lib/glMatrix","./cameraUtilsPlanar","./cameraUtilsSpherical","./earthUtils","./mathUtils","./projectionUtils","../webgl-engine/lib/Camera"],function(e,t,n,r,a,i,o,c,l,s,u,d,f,m,v,p,g,h){function T(e){return e.spatialReference||c.WGS84}function x(e){return"global"===e.viewingMode?m:f}function M(e,t){var n=e.renderSpatialReference,r=x(e).headingTiltToDirectionUp,a=d.vec3d.create();if(g.pointToVector(t.position,a,n)){var i=r(a,t.heading,t.tilt);d.vec3d.add(i.direction,a);var o=u.cameraOnContentAlongViewDirection(e,a,i.direction,i.up);return o.fov=p.deg2rad(t.fov),o}return null}function y(e,t,n){var a=e.renderSpatialReference,i=d.vec3d.set(t.viewForward,N),l=z(e,t.eye,i,t.up,B),s=T(e);return g.vectorToVector(t.eye,a,Z,s)||(s=c.WGS84,g.vectorToVector(t.eye,a,Z,s)),n?(n.position.x=Z[0],n.position.y=Z[1],n.position.z=Z[2],n.position.spatialReference=s,n.heading=l.heading,n.tilt=l.tilt,n.fov=p.rad2deg(t.fov),n):new r(new o(Z,s),l.heading,l.tilt,p.rad2deg(t.fov))}function w(e,t,n){var r=e.state.camera,i=r.fovX,o=r.width/2;return"global"===e.viewingMode&&null!=n&&(t*=Math.cos(p.deg2rad(n))),t/=e.renderCoordsHelper.unitInMeters,o/(a.screenDPI*O/t)/Math.tan(i/2)}function S(e,t,n){var r=e.state.camera,i=r.fovX,o=t*Math.tan(i/2),c=r.width/2,l=c/o,s=a.screenDPI*O,u=s/l;return"global"===e.viewingMode&&(u/=Math.cos(p.deg2rad(n))),u*=e.renderCoordsHelper.unitInMeters}function R(e,t,n,r,a,i){return C(e,t,w(e,n,t.latitude),r,a,i)}function C(e,t,n,a,i,o){var c=e.renderSpatialReference,l=E(e,a.heading,a.tilt,t,n,i),s=T(e),u=g.vectorToPoint(l.eye,c,s);return u?o?(o.position=u,o.heading=l.heading,o.tilt=l.tilt,o.fov=a.fov,o):new r(u,l.heading,l.tilt,a.fov):null}function b(e,t,n){if(g.pointToVector(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){var r=e.basemapTerrain.getElevation(t);null!=r&&e.renderCoordsHelper.setAltitude(r,n)}}function z(e,t,n,r,a){return x(e).directionToHeadingTilt(t,n,r,a)}function P(e,t,n){return!!e.renderCoordsHelper.fromRenderCoords(t,J,e.spatialReference)&&(e.basemapTerrain&&(e.basemapTerrain.getElevation(J)||0)>J.z-1)}function E(e,t,r,a,i,c){var l=d.vec3d.create(),s=e.renderSpatialReference;if(a?a instanceof o?b(e,a,l):a&&d.vec3d.set(a,l):d.vec3d.set(e.state.camera.center,l),!(a&&a instanceof o)){var u=T(e);a=g.vectorToPoint(l,s,u)}i=Math.max(i,e.state.constraints.minimumPoiDistance);var f=A(e,t,r,l,a,i,c),m=x(e).eyeForCenterWithHeadingTilt,v=m(l,i,f.heading,f.tilt),p={eye:v.eye,up:v.up,center:l,heading:v.heading,tilt:v.tilt};if(!(c&&c.noReset||"global"!==e.viewingMode)&&P(e,p.eye,p.tilt)){return E(e,0,e.state.constraints.tilt(i).min,a,i,n({},c,{noReset:!0}))}return p}function U(e,t,n,a,i,l){var u;i instanceof r?(l=i,u={noReset:!1}):u=i;var d,f="global"===e.viewingMode,m=e.renderSpatialReference,p=T(e),h=c.WebMercator,x=t.spatialReference||h,M=0;null!=t.zmax&&null!=t.zmin&&(d=(t.zmax+t.zmin)/2,M=t.zmax-t.zmin);var y,w,S;if(f){var R=new o(t.xmin,t.ymin,x),C=new o(t.xmax,t.ymax,x);if(R=s.project(R,h),C=s.project(C,h),null===R||null===C)return;y=new o(K.center(R.x,C.x),(C.y+R.y)/2,h),null!=d&&(y.z=d);var b=v.getGreatCircleSpanAt(y,R,C);w=b.lon,S=b.lat,K.diff(R.x,C.x)>K.range/2&&(w+=v.halfEarthCircumference),w=Math.min(w,v.halfEarthCircumference),S=Math.min(S,v.halfEarthCircumference)}else s.canProject(t,p)&&(t=s.project(t,p)),w=t.xmax-t.xmin,S=t.ymax-t.ymin,y=new o({x:t.xmin+.5*w,y:t.ymin+.5*S,z:d,spatialReference:p});var z=e.state.camera,P=1/Math.tan(z.fovX/2),U=1/Math.tan(z.fovY/2),D=1/Math.tan(z.fov/2),H=Math.max(.5*w*P,.5*S*U,.5*M*D)/X,A=E(e,n,a,y,H,u),V=g.vectorToPoint(A.eye,m,p);return V?(l||(l=new r),l.position=V,l.heading=A.heading,l.tilt=A.tilt,l.fov=e.camera.fov,l):null}function D(e,t,n,r,a){var i,o,c=e.renderSpatialReference;if(t||(n||(n=e.state.camera),t=y(e,n,a)),n)o=g.vectorToPoint(n.center,c,T(e)),i=n.distance;else{if(!(o=e.toMap(e.screenCenter)))return null;i=v.computeCarthesianDistance(t.position,o)}n||(n=e.state.camera);var l=Math.tan(n.fovX/2),s=Math.tan(n.fovY/2),u=2*i*l*X,d=2*i*s*X;return"global"===e.viewingMode?m.toExtent(e,o,u,d,r):f.toExtent(e,o,u,d,r)}function H(e,t,n){var r=e.state.camera,a=e.engineToScreen(r.center),i=e.toScreen(t),o=a.x-i.x,c=a.y-i.y,l=Math.sqrt(o*o+c*c),s=Math.max(e.width,e.height),u=e.pointsOfInterest.centerOnSurfaceFrequent.distance,d=Math.log(Math.max(n,u)/Math.min(n,u))/Math.LN2;return l>q*s||d>k&&n>Y}function A(e,t,n,r,a,i,o){if(o&&o.noReset||!H(e,a,i)){var c=j(e,r,i,n);c=e.state.constraints.clampTilt(i,c),n=V(e,r,i,c)}else t=0,n=e.state.constraints.tilt(i).min;return{heading:t,tilt:n}}function V(e,t,n,r){return x(e).lookAtTiltToEyeTilt(t,n,r)}function j(e,t,n,r){return x(e).eyeTiltToLookAtTilt(t,n,r)}function I(e,t){var n=e.basemapTerrain&&e.basemapTerrain.tilingScheme;return n?n.levelAtScale(t):void G.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function F(e,t){var n=e.basemapTerrain&&e.basemapTerrain.tilingScheme;return n?n.scaleAtLevel(t):void G.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function L(e,t){return e.spatialReference?l.getResolutionForScale(t,e.spatialReference):void 0}function W(e,t,n){var r=e.renderSpatialReference;t||(t=e.state.camera);var a,i,o=c.WGS84;return t instanceof h?(g.vectorToVector(t.center,r,_,o),a=_[1],i=t.distance):(a=t.position.latitude,g.pointToVector(t.position,Z,r),g.pointToVector(n,_,r),i=d.vec3d.dist(Z,_)),S(e,i,a)}Object.defineProperty(t,"__esModule",{value:!0});var G=i.getLogger("esri.views.3d.support.cameraUtils"),O=39.37,X=1,q=5,k=8,Y=8e5,Z=d.vec3d.create(),_=d.vec3d.create(),N=d.vec3d.create(),B={heading:0,tilt:0},J=new o,K=new p.Cyclical(-20037508.342788905,20037508.342788905);t.externalToInternal=M,t.internalToExternal=y,t.scaleToDistance=w,t.distanceToScale=S,t.fromCenterScale=R,t.fromCenterDistance=C,t.directionToHeadingTilt=z,t.eyeHeadingTiltForCenterPointAtDistance=E,t.fromExtent=U,t.toExtent=D,t.scaleToZoom=I,t.zoomToScale=F,t.scaleToResolution=L,t.computeScale=W});