// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","dojo/text!../materials/internal/ssao.xml","../../../../core/Logger","../../support/imageUtils","./DefaultVertexAttributeLocations","./DefaultVertexBufferLayouts","./gl-matrix","./glUtil3D","./Util","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../webgl/Program","../../../webgl/Texture","../../../webgl/Util","../../../webgl/VertexArrayObject"],function(e,t,r,i,s,a,o,n,u,h,l,d,p,f,_,m){var c=i.getLogger("esri.views.3d.webgl-engine.lib.SSAOHelper"),b=4,x=function(){function t(e,t,r,i){this._enabled=!1,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=n.vec4d.create(),this._rctx=r,this._programRep=e,this._requestRender=i,this._emptyTexture=u.createEmptyTexture(r)}return t.prototype.dispose=function(){this._emptyTexture.dispose(),this._emptyTexture=null},Object.defineProperty(t.prototype,"isSupported",{get:function(){var e=this._rctx,t=-1!==e.parameters.versionString.indexOf("WebGL 0.93"),r=-1!==e.parameters.versionString.indexOf("WebGL 0.94");return e.capabilities.standardDerivatives&&!(t||r)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enabled",{get:function(){return this._enabled},set:function(e){e?this.enable():this.disable()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"attenuation",{get:function(){return this._attenuation},set:function(e){this._attenuation=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},set:function(e){this._radius=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filterRadius",{get:function(){return b},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"samples",{get:function(){return this._samples},set:function(e){this._samples=e},enumerable:!0,configurable:!0}),t.prototype.computeSSAO=function(e,t,r,i){if(this._noiseTexture){h.assert(this.enabled);var s=this._rctx,a=r.width,o=r.height,l=a/this._BLUR_F,d=o/this._BLUR_F;this._ssaoFBO.resize(a,o),this._blur0FBO.resize(l,d),this._blur1FBO.resize(l,d);var p=1*a,f=1*o;s.bindFramebuffer(this._ssaoFBO),n.vec4d.set(e.fullViewport,this._viewportToRestore),s.setViewport(0,0,a,o);var m=this._programRep.get(this._samples<=8?"ssao8":this._samples<=16?"ssao16":this._samples<=32?"ssao32":"ssao64"),c=this._programRep.get("blur"),x=c;m.setUniform2f("rnmScale",a/this._noiseTexture.descriptor.width,o/this._noiseTexture.descriptor.height),m.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64),s.bindProgram(m);var w=this._data.minDiscrepancy,U=this._samples<w.length?w[this._samples]:5779;m.setUniform1f("numSpiralTurns",U);var T=v,O=g;h.inverseProjectionInfo(e.projectionMatrix,e.fullWidth,e.fullHeight,T,O),m.setUniform4fv("projInfo",T),m.setUniform2fv("zScale",O),m.setUniform2f("nearFar",e.near,e.far);var y=1/e.computePixelSizeAtDist(1);m.setUniform1f("projScale",1*y),m.setUniform2f("screenDimensions",p,f);var S=2*this._radius,F=n.vec3d.dist(e.eye,e.center);S=20*e.computePixelSizeAtDist(F),S=Math.max(.1,S),m.setUniform1f("radius",S),m.setUniform1f("intensity",4*this._attenuation/Math.pow(S,6)),m.setUniform1i("rnm",0),m.setUniform1i("normalMap",1),m.setUniform1i("depthMap",2),s.bindTexture(this._noiseTexture,0),s.bindTexture(i.colorTexture,1),s.bindTexture(r.colorTexture,2);var A=u.createQuadVAO(this._rctx);s.bindVAO(A),s.drawArrays(5,0,_.vertexCount(A,"geometry"));var B=(b+1)/2,D=1/(2*B*B);s.bindTexture(this._ssaoFBO.colorTexture,0),s.setViewport(0,0,p/this._BLUR_F,f/this._BLUR_F),s.bindFramebuffer(this._blur0FBO),x.setUniform2f("screenDimensions",p,f),x.setUniform1i("tex",0),x.setUniform1i("normalMap",1),x.setUniform1i("depthMap",2),x.setUniform2f("blurSize",0,1*this._BLUR_F/f),x.setUniform1i("radius",b),x.setUniform1f("g_BlurFalloff",D),x.setUniform2f("nearFar",e.near,e.far),F>5e4&&(y=Math.max(0,y-(F-5e4))),x.setUniform1f("projScale",y),x.setUniform2f("zScale",1,0),s.drawArrays(5,0,_.vertexCount(A,"geometry")),x.setUniform2f("blurSize",1*this._BLUR_F/p,0),s.bindFramebuffer(this._blur1FBO),s.bindTexture(this._blur0FBO.colorTexture,0),s.drawArrays(5,0,_.vertexCount(A,"geometry")),s.bindFramebuffer(t),s.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}},t.prototype.setUniforms=function(e){var t=this.enabled&&this._noiseTexture,r=this._rctx;r.bindTexture(t?this._blur1FBO.colorTexture:this._emptyTexture,6),r.setActiveTexture(0),e.setUniform1i("ssaoTex",6),t?e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)},t.prototype.bindAll=function(e){for(var t=e.getProgramsUsingUniform("viewportPixelSz"),r=0;r<t.length;r++)this.setUniforms(t[r])},t.prototype.drawQuad=function(e){h.assert(this.enabled);var t=this._programRep.get("showDepth");this._debugQuadVAO||(this._debugQuadVAO=new m(this._rctx,a.Default3D,{geometry:o.Pos2Tex},{geometry:l.createVertex(this._rctx,35044,w)}));var r=this._rctx;r.setDepthTestEnabled(!1),t.setUniformMatrix4fv("proj",new Float32Array(e)),t.setUniform1i("depthTex",0),r.bindTexture(this._ssaoFBO.colorTexture,0),r.bindVAO(this._debugQuadVAO),r.drawArrays(5,0,_.vertexCount(this._debugQuadVAO,"geometry")),r.setDepthTestEnabled(!0)},t.prototype.enable=function(){var e=this;if(!this.enabled){if(!this.isSupported)return void c.warn("SSAO is not supported for this browser or hardware");this._enabled=!0,this.loadResources(function(){e._enabled&&e.initialize()})}},t.prototype.loadResources=function(t){var r=this;this._data?t():e(["./SSAOHelperData"],function(e){r._data=e,t()})},t.prototype.initialize=function(){var e=this,t={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},r={colorTarget:0,depthStencilTarget:0};this._ssaoFBO=d.createWithAttachments(this._rctx,t,r),this._blur0FBO=d.createWithAttachments(this._rctx,t,r),this._blur1FBO=d.createWithAttachments(this._rctx,t,r),s.requestImage(this._data.noiseTexture).then(function(t){e._enabled&&(e._noiseTexture=new f(e._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:t.width,height:t.height},t),e._requestRender())})},t.prototype.disable=function(){this.enabled&&(this._enabled=!1,this._quadVAO&&(this._quadVAO.dispose(!0),this._quadVAO=null),this._noiseTexture&&(this._noiseTexture.dispose(),this._noiseTexture=null),this._blur1FBO&&(this._blur1FBO.dispose(),this._blur1FBO=null),this._blur0FBO&&(this._blur0FBO.dispose(),this._blur0FBO=null),this._ssaoFBO&&(this._ssaoFBO.dispose(),this._ssaoFBO=null))},t.loadShaders=function(e,t,i){h.assert(null==e.samples),e._parse(r);var s=new p(i,e.vertexShaderShowDepth,e.fragmentShaderShowDepth,a.Default3D),o=e.createFsSSAOSrcObscurance,n=new p(i,e.vsUVQuad,o,a.Default3D,{NUM_TAP_SAMPLES:"8"}),u=new p(i,e.vsUVQuad,o,a.Default3D,{NUM_TAP_SAMPLES:"16"}),l=new p(i,e.vsUVQuad,o,a.Default3D,{NUM_TAP_SAMPLES:"32"}),d=new p(i,e.vsUVQuad,o,a.Default3D,{NUM_TAP_SAMPLES:"64"}),f=new p(i,e.vsUVQuad,e.fsBlurEdgeAware,a.Default3D,{RADIUS:b.toString()});t.add("showDepth",s),t.add("ssao8",n),t.add("ssao16",u),t.add("ssao32",l),t.add("ssao64",d),t.add("blur",f)},t}(),g=n.vec2d.create(),v=n.vec4d.create(),w=new Float32Array([0,0,0,0,512,0,1,0,0,512,0,1,512,512,1,1]);return x});