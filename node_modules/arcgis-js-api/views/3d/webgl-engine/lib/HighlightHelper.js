// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","dojo/text!../materials/internal/highlight.xml","../../support/debugFlags","./DefaultVertexAttributeLocations","./DefaultVertexBufferLayouts","./gl-matrix","./glUtil3D","./Util","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../webgl/Program","../../../webgl/Util","../../../webgl/VertexArrayObject"],function(e,t,i,r,l,a,o,h,s,n,p,g,u,d){return function(){function e(e,t,i){this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0},this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null,this._rctx=i,this.viewportToRestore=o.vec4d.create(),this.programRep=e,this.defaultOptions={color:new Float32Array([1,0,1,1]),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05}}return Object.defineProperty(e.prototype,"enabled",{get:function(){return null!==this.blur0Fbo},set:function(e){e?this.enable():this.disable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"profilingCallback",{get:function(){return r.HIGHLIGHTS_PROFILE_TO_CONSOLE?function(e){return console.log(e)}:null},enumerable:!0,configurable:!0}),e.prototype.setDefaultOptions=function(e){this.defaultOptions=e},e.prototype.render=function(e,t,i){var l=!r.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED,a=r.HIGHLIGHTS_VISUALIZE_BLOCKS,h=this._rctx;s.assert(this.enabled),o.vec4d.set(e.fullViewport,this.viewportToRestore);var n=i.width,p=i.height,g=Math.ceil(n/1),d=Math.ceil(p/1);this.blur0Fbo.resize(g,d),this.blur1Fbo.resize(g,d),h.bindVAO(this.quadVAO),h.setDepthWriteEnabled(!1),h.setDepthTestEnabled(!1),h.setBlendingEnabled(!1);var c=null,b=null,f=null,m=null;if(l){var v=this._grid;this._gridUpdateResources(i,32),this._gridComputeMipmap(),f=v.vao,m=4,c=this.programRep.get("highlight-blur-grid-5"),h.bindProgram(c),h.bindTexture(v.coverageMipmap[v.mipmapLevels].colorTexture,1),c.setUniform1i("coverageTex",1)}else f=this.quadVAO,m=5,c=this.programRep.get("highlight-blur-5"),h.bindProgram(c);if(h.bindVAO(f),h.bindFramebuffer(this.blur0Fbo),h.setViewport(0,0,g,d),h.setClearColor(0,0,0,0),h.clear(h.gl.COLOR_BUFFER_BIT),c.setUniform1i("tex",0),h.bindTexture(i.colorTexture,0),c.setUniform2f("blurSize",1/g,0),h.drawArrays(m,0,u.vertexCount(f,"geometry")),h.bindFramebuffer(this.blur1Fbo),h.clear(h.gl.COLOR_BUFFER_BIT),h.bindTexture(this.blur0Fbo.colorTexture,0),c.setUniform2f("blurSize",0,1/d),h.drawArrays(m,0,u.vertexCount(f,"geometry")),h.bindFramebuffer(t),h.setBlendingEnabled(!0),h.setBlendFunctionSeparate(770,771,1,771),h.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),l){b=this.programRep.get(a?"highlight-apply-grid-debug":"highlight-apply-grid"),h.bindProgram(b),b.setUniform1i("coverageTex",2);var O=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;h.bindTexture(O,2)}else b=this.programRep.get("highlight-apply"),h.bindProgram(b);b.setUniform1i("tex",0),h.bindTexture(this.blur1Fbo.colorTexture,0),b.setUniform1i("origin",1),h.bindTexture(i.colorTexture,1),b.setUniform4fv("color",this.defaultOptions.color),b.setUniform1f("outlineSize",8.6),b.setUniform1f("blurSize",.4),b.setUniform4f("opacities",this.defaultOptions.haloOpacity,this.defaultOptions.haloOpacityOccluded,this.defaultOptions.fillOpacity,this.defaultOptions.fillOpacityOccluded),h.drawArrays(m,0,u.vertexCount(f,"geometry")),h.bindVAO(null),h.setDepthWriteEnabled(!0),h.setDepthTestEnabled(!0),h.setBlendingEnabled(!1)},e.prototype.enable=function(){if(!this.enabled){this.quadVAO=h.createQuadVAO(this._rctx);var e={colorTarget:0,depthStencilTarget:0,width:0,height:0},t={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=p.createWithAttachments(this._rctx,t,e),this.blur1Fbo=p.createWithAttachments(this._rctx,t,e)}},e.prototype.disable=function(){this.enabled&&(this.quadVAO.dispose(!0),this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null)},e.prototype._gridUpdateResources=function(e,t){var i=this._rctx,r=this._grid,o=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],o=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(o=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==t&&(r.cellPixelSize=t,o=!0),o){for(var h=1;h<r.coverageMipmap.length;h++)r.coverageMipmap[h].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(var h=0;h<r.mipmapLevels;h++){var s=r.coverageMipmap[h],g={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(s.width/2),height:Math.ceil(s.height/2)},u={colorTarget:0,depthStencilTarget:0,width:Math.ceil(s.width/2),height:Math.ceil(s.height/2)},c=p.createWithAttachments(i,g,u);r.coverageMipmap[h+1]=c}}var b=Math.ceil(e.height/r.cellPixelSize),f=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==b||r.horizontalCellCount!==f){r.verticalCellCount=b,r.horizontalCellCount=f;for(var m=b+1,v=f+1,O=1/b,w=1/f,x=new Float32Array(24*m*v),y=0,T=0;T<m;T++)for(var A=0;A<v;A++)x[y+0]=(A-.5)*w*2-1,x[y+1]=(T-.5)*O*2-1,x[y+2]=A*w,x[y+3]=T*O,x[y+4]=(A+.5)*w*2-1,x[y+5]=(T-.5)*O*2-1,x[y+6]=A*w,x[y+7]=T*O,x[y+8]=(A-.5)*w*2-1,x[y+9]=(T+.5)*O*2-1,x[y+10]=A*w,x[y+11]=T*O,x[y+12]=(A-.5)*w*2-1,x[y+13]=(T+.5)*O*2-1,x[y+14]=A*w,x[y+15]=T*O,x[y+16]=(A+.5)*w*2-1,x[y+17]=(T-.5)*O*2-1,x[y+18]=A*w,x[y+19]=T*O,x[y+20]=(A+.5)*w*2-1,x[y+21]=(T+.5)*O*2-1,x[y+22]=A*w,x[y+23]=T*O,y+=24;r.vao&&r.vao.dispose(!0),r.vao=new d(i,l.Default3D,{geometry:a.Pos2Tex},{geometry:n.createVertex(i,35044,x)})}},e.prototype._gridComputeMipmap=function(){var e=this._rctx,t=this._grid,i=this.programRep.get("conservative-downsample");e.bindVAO(this.quadVAO);for(var r=0;r<t.mipmapLevels;r++){e.bindFramebuffer(t.coverageMipmap[r+1]),e.bindTexture(t.coverageMipmap[r].colorTexture,0);var l=t.coverageMipmap[r+1].width,a=t.coverageMipmap[r+1].height;e.bindProgram(i),i.setUniform1i("tex",0),i.setUniform2f("invFramebufferDim",1/l,1/a),e.setViewport(0,0,l,a),e.drawArrays(5,0,u.vertexCount(this.quadVAO,"geometry"))}},e.loadShaders=function(e,t,r){e._parse(i);for(var a=0,o=["3","5","7","9"];a<o.length;a++){var h=o[a];t.add("highlight-blur-"+h,new g(r,e.vsHighlightBlurFastGaussian,e.fsHighlightBlurFastGaussian,l.Default3D,{GAUSSIAN_SAMPLES:h})),t.add("highlight-blur-grid-"+h,new g(r,e.vsHighlightBlurFastGaussian,e.fsHighlightBlurFastGaussian,l.Default3D,{GAUSSIAN_SAMPLES:h,GRID_OPTIMIZATION:"true"}))}t.add("highlight-apply",new g(r,e.vsHighlightApply,e.fsHighlightApply,l.Default3D)),t.add("highlight-apply-grid",new g(r,e.vsHighlightApply,e.fsHighlightApply,l.Default3D,["GRID_OPTIMIZATION"])),t.add("highlight-apply-grid-debug",new g(r,e.vsHighlightApply,e.fsHighlightApply,l.Default3D,["GRID_OPTIMIZATION","GRID_DEBUG"])),t.add("conservative-downsample",new g(r,e.vsConservativeDownsample,e.fsConservativeDownsample,l.Default3D))},e}()});