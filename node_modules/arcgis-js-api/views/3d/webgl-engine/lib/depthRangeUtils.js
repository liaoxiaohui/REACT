// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/PooledArray","../../support/intersectionUtils","./ComponentUtils","./depthRange","./gl-matrix","./Util"],function(e,t,r,a,n,i,s,o){function h(e,t,r){if(t.size<g)return A.compute(e,t);var a=i.empty();for(var n in r){var s=r[n];i.union(a,f(e,s))}return a}function f(e,t){var r=i.empty(),a=t.getObjects();return t.getSpatialQueryAccelerator()?c(r,e,t.getSpatialQueryAccelerator()):d(r,e,a),r}function c(e,t,r){var a=t.eye,n=t.viewForward,s=t.frustumPlanes,o=function(e){return!e.areAllComponentsHidden()},h=r.objectCount;if(h<m)i.set(S,t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(a,n,"front-to-back",S,function(r,a){l(e,t,r),S.far=e.near,a.setRange(S)},s,o),i.set(S,Math.max(e.far,t.near),t.far),r.forEachInDepthRange(a,n,"back-to-front",S,function(r,a){l(e,t,r),S.near=e.far,a.setRange(S)},s,o);else{var f=Math.max(Math.min(h,y),Math.ceil(h*R)),c=r.findClosest(n,"front-to-back",s,o,f),d=r.findClosest(n,"back-to-front",s,o,f);c&&d&&(p(e,t,c.getCenter(),c.getBSRadius()),p(e,t,d.getCenter(),d.getBSRadius()))}}function d(e,t,r){j.clear(),r.forEach(function(e){e.areAllComponentsHidden()||j.add(e)}),j.empty||(j.sort(t),i.set(S,t.near,Math.min(e.near,t.far)),j.forEachInDepthRange(S,"front-to-back",function(r,a,n){a<e.near&&l(e,t,r)}),i.set(S,Math.max(e.far,t.near),t.far),j.forEachInDepthRange(S,"back-to-front",function(t,r,a){e.far=Math.max(e.far,a)}))}function l(e,t,r){if(!r.areAllComponentsHidden()&&a.frustumSphere(t.frustumPlanes,r.getCenter(),r.getBSRadius())){var n=r.objectTransformation,i=P;r.geometryRecords.forEach(function(r){s.mat4d.multiply(n,r.getShaderTransformation(),i);var a=s.mat4d.maxScale(i),o=r.geometry.getBoundingInfo();u(e,t,o,i,a)})}}function u(e,t,r,n,i){var o=t.eye,h=t.viewForward;s.mat4d.multiplyVec3(n,r.center,M);var f=h[0]*(M[0]-o[0])+h[1]*(M[1]-o[1])+h[2]*(M[2]-o[2]),c=r.bsRadius*i;if(!(f-c>e.near&&f+c<e.far)&&a.frustumSphere(t.frustumPlanes,M,c))if(r.bsRadius>v&&r.getChildren())for(var d=r.getChildren(),l=0;l<8;++l)d[l]&&u(e,t,d[l],n,i);else x.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,n,r.bbMin,r.bbMax)}function p(e,t,r,a){var n=t.eye,i=t.viewForward,s=(r[0]-n[0])*i[0]+(r[1]-n[1])*i[1]+(r[2]-n[2])*i[2];e.near=Math.min(e.near,s-a),e.far=Math.max(e.far,s+a)}Object.defineProperty(t,"__esModule",{value:!0});var g=1e4,v=100,m=500,y=500,R=.1;t.depthRangeFromScene=h,t.depthRangeFromLayer=f;var b=function(){function e(){this._items=new r({allocator:function(){return{obj:null,distance:0,near:0,far:0}}})}return Object.defineProperty(e.prototype,"length",{get:function(){return this._items.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"empty",{get:function(){return 0===this._items.length},enumerable:!0,configurable:!0}),e.prototype.clear=function(){this._items.clear()},e.prototype.add=function(e){this._items.pushNew().obj=e},e.prototype.sort=function(e){var t=e.eye,r=e.viewForward;this._items.forEach(function(e){var a=e.obj,n=a.getCenter(),i=a.getBSRadius(),s=(n[0]-t[0])*r[0]+(n[1]-t[1])*r[1]+(n[2]-t[2])*r[2];e.distance=s,e.near=s-i,e.far=s+i}),this._items.sort(function(e,t){return e.distance-t.distance})},e.prototype.forEachInDepthRange=function(e,t,r){if("front-to-back"===t)for(var a=0;a<this._items.length;++a){var n=this._items.data[a];n.far<e.near||n.near>e.far||r(n.obj,n.near,n.far)}else for(var a=this._items.length-1;a>=0;--a){var n=this._items.data[a];n.far<e.near||n.near>e.far||r(n.obj,n.near,n.far)}},e}(),w=function(){function e(){this.view=s.mat4d.create(),this.viewProj=s.mat4d.create(),this.planes=[s.vec4d.create(),s.vec4d.create(),s.vec4d.create(),s.vec4d.create(),s.vec4d.create(),s.vec4d.create()],this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}return e.prototype.compute=function(e,t){var r=this;this.reset(),s.mat4d.set(e.viewMatrix,this.view),s.mat4d.multiply(e.projectionMatrix,this.view,this.viewProj),e.copyFrustumPlanes(this.planes);var a=this.view,i=a[2],o=a[6],h=a[10],f=a[14],c=this.range,d=0;if(t.forEach(function(e){var t=e.instanceParameters.componentVisibilities,a=e.componentOffsets;if(!n.isAllHidden(t,a)&&e.castShadow){var s,c;e.hasShaderTransformation?(s=e.getBoundingSphere(e.getShaderTransformation(),1,M),c=M):(s=e.bsRadius,c=e.center);var l=i*c[0]+o*c[1]+h*c[2]+f,u=l-s,p=l+s;r.geometries[d]=e,r.near[d]=-p,r.far[d]=-u,++d}}),0===this.geometries.length)return c;for(var l=0;l<this.geometries.length;++l)this.near[l]>c.far&&(c.far=this.near[l]),this.near[l]>2&&this.far[l]<c.near&&(c.near=this.far[l]);var u=this.looseRange;u.near=Math.max(.5*c.near,2),u.far=2*c.far;for(var p=0,g=0,l=0;l<this.geometries.length;++l)this.near[l]<c.near&&(this.near[l]>=u.near?c.near=this.near[l]:this.nearCandidates[p++]=l),this.far[l]>c.far&&(this.far[l]<=u.far?c.far=this.far[l]:this.farCandidates[g++]=l);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return c;this.nearCandidates.sort(function(e,t){return r.near[e]<r.near[t]?-1:r.near[e]>r.near[t]?1:0}),this.farCandidates.sort(function(e,t){return r.far[e]<r.far[t]?1:r.far[e]>r.far[t]?-1:0});for(var l=0;l<this.nearCandidates.length;++l){var v=this.nearCandidates[l];if(this.near[v]<c.near){var m=this.geometries[v],y=m.boundingInfo;this.includeNearBoundingInfoRec(y,m.getShaderTransformation())}}for(var l=0;l<this.farCandidates.length;++l){var v=this.farCandidates[l];if(this.far[v]>c.far){var m=this.geometries[v],y=m.boundingInfo;this.includeFarBoundingInfoRec(y,m.getShaderTransformation())}}return c},e.prototype.reset=function(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE},e.prototype.includeNearBoundingInfoRec=function(e,t){var r=e.getBSRadius(),a=e.getCenter();s.mat4d.multiplyVec3(t,a,M);var n=s.mat4d.maxScale(t),i=M[0],o=M[1],h=M[2];if(r*=n,!(this.planes[0][0]*i+this.planes[0][1]*o+this.planes[0][2]*h+this.planes[0][3]>r||this.planes[1][0]*i+this.planes[1][1]*o+this.planes[1][2]*h+this.planes[1][3]>r||this.planes[2][0]*i+this.planes[2][1]*o+this.planes[2][2]*h+this.planes[2][3]>r||this.planes[3][0]*i+this.planes[3][1]*o+this.planes[3][2]*h+this.planes[3][3]>r)){var f=this.view[2]*i+this.view[6]*o+this.view[10]*h+this.view[14],c=f-r,d=f+r;if(!(-c<2||-d>=this.range.near)){if(-d>this.looseRange.near)return void(this.range.near=-d);if(r>v){var l=e.getChildren();if(void 0!==l){for(var u=0;u<8;++u)void 0!==l[u]&&this.includeNearBoundingInfoRec(l[u],t);return}}x.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}},e.prototype.includeFarBoundingInfoRec=function(e,t){var r=e.getBSRadius(),a=e.getCenter();s.mat4d.multiplyVec3(t,a,M);var n=s.mat4d.maxScale(t),i=M[0],o=M[1],h=M[2];if(r*=n,!(this.planes[0][0]*i+this.planes[0][1]*o+this.planes[0][2]*h+this.planes[0][3]>r||this.planes[1][0]*i+this.planes[1][1]*o+this.planes[1][2]*h+this.planes[1][3]>r||this.planes[2][0]*i+this.planes[2][1]*o+this.planes[2][2]*h+this.planes[2][3]>r||this.planes[3][0]*i+this.planes[3][1]*o+this.planes[3][2]*h+this.planes[3][3]>r)){var f=this.view[2]*i+this.view[6]*o+this.view[10]*h+this.view[14],c=f-r;if(!(-c<=this.range.far)){if(-c<this.looseRange.far)return void(this.range.far=-c);if(r>v){var d=e.getChildren();if(void 0!==d){for(var l=0;l<8;++l)void 0!==d[l]&&this.includeFarBoundingInfoRec(d[l],t);return}}x.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}},e}();t.DepthRangeFromRenderGeometries=w;var C=function(){function e(){this.modelViewProj=s.mat4d.create(),this.clipPosition=[s.vec4d.create(),s.vec4d.create(),s.vec4d.create(),s.vec4d.create(),s.vec4d.create(),s.vec4d.create(),s.vec4d.create(),s.vec4d.create()]}return e.prototype.unionDepthRangeWithAABB=function(e,t,r,a,n){var i=this.modelViewProj;s.mat4d.multiply(t,r,i);for(var o=!1,h=0;h<8;++h){var f=this.clipPosition[h],c=0===h||3===h||4===h||7===h?a[0]:n[0],d=0===h||1===h||4===h||5===h?a[1]:n[1],l=h<4?a[2]:n[2];f[0]=i[0]*c+i[4]*d+i[8]*l+i[12],f[1]=i[1]*c+i[5]*d+i[9]*l+i[13],f[2]=i[2]*c+i[6]*d+i[10]*l+i[14],f[3]=i[3]*c+i[7]*d+i[11]*l+i[15]}for(var h=0;h<12;++h){for(var u=this.clipPosition[B[h][0]],p=this.clipPosition[B[h][1]],g=this.clipPosition[B[h][2]],v=this.clipTriangle(u,p,g),m=!0,y=0;y<v.length;++y){var R=v[y][3];if(R>=2){m=!1;break}}if(!m){o=!0;for(var y=0;y<v.length;++y){var R=v[y][3];R<e.near&&(e.near=R),R>e.far&&(e.far=R)}}}return o},e.prototype.inside=function(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void o.assert(!1)},e.prototype.intersect=function(e,t,r){var a=0;return 0===r?a=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?a=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?a=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(a=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),s.vec4d.lerp(e,t,a,s.vec4d.create())},e.prototype.clipTriangle=function(e,t,r){for(var a=[e,t,r],n=0;n<4;++n){var i=a;a=[];for(var s=0;s<i.length;++s){var o=i[s],h=i[(s+1)%i.length];this.inside(h,n)?(this.inside(o,n)||a.push(this.intersect(o,h,n)),a.push(h)):this.inside(o,n)&&a.push(this.intersect(o,h,n))}}return a},e}(),B=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],M=s.vec3d.create(),P=s.mat4d.create(),S=i.empty(),j=new b,A=new w,x=new C});