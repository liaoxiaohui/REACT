// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../support/geometryUtils","./gl-matrix"],function(t,e,r,a){function n(t,e){if(!t){var r=new Error("dummy");throw r.stack&&console.log(r.stack),new Ot(e)}}function o(t,e){t||(console.log("Verify failed: "+e),console.log(new Error("dummy").stack))}function c(t){return 0==(t&t-1)}function i(t,e,r){return t+(e-t)*r}function u(t,e,r){return t<e?e:t>r?r:t}function s(t){return u(Math.round(32767*t),-32767,32767)}function v(t,e){var r=Math.abs(t[0]),a=Math.abs(t[1]),n=Math.abs(t[2]),o=1/(r+a+n),c=r*o,i=a*o,u=Math.min(t[2]*o,0);e[0]=St(t[0])*(c-u),e[1]=St(t[1])*(i-u)}function f(t,e){return void 0===t?e:t}function d(t){return t=Math.floor(t),[(t>>16&255)/255,(t>>8&255)/255,(255&t)/255]}function h(t){return"0x"+((u(Math.round(255*t[0]),0,255)<<16)+(u(Math.round(255*t[1]),0,255)<<8)+u(Math.round(255*t[2]),0,255)).toString(16)}function M(t){var e=t.toString(16);return"00000000".substr(0,8-e.length)+e}function l(t){return t/180*Math.PI}function m(t){return 180*t/Math.PI}function p(t,e){var r=1.5*Math.PI-t,a=.5*Math.PI-e;return[Math.cos(r)*Math.sin(a),Math.cos(a),Math.sin(r)*Math.sin(a)]}function g(t,e,r,n,o){r=r||Pt;var c=a.vec3d.subtract(t,r,Mt),i=a.vec3d.dot(e,e),u=2*a.vec3d.dot(e,c),s=a.vec3d.dot(c,c)-n*n,v=u*u-4*i*s;if(v<0)return!1;var f=Math.sqrt(v),d=(-u-f)/(2*i),h=(-u+f)/(2*i);return(d<0||h<d&&h>0)&&(d=h),d>0&&(o&&a.vec3d.add(t,a.vec3d.scale(e,d,xt),o),!0)}function E(t,e,r,n,o,c,i,u,s){void 0===s&&(s=a.vec3d.create());var v=n[i]-r[c],f=n[i+1]-r[c+1],d=n[i+2]-r[c+2],h=o[u]-r[c],M=o[u+1]-r[c+1],l=o[u+2]-r[c+2],m=e[1]*l-M*e[2],p=e[2]*h-l*e[0],g=e[0]*M-h*e[1],E=v*m+f*p+d*g;if(E>-1e-5&&E<1e-5)return!1;var I=1/E,T=t[0]-r[c],b=t[1]-r[c+1],C=t[2]-r[c+2];if(s[1]=I*(T*m+b*p+C*g),s[1]<0||s[1]>1)return!1;var y=b*d-f*C,R=C*v-d*T,x=T*f-v*b;return s[2]=I*(e[0]*y+e[1]*R+e[2]*x),!(s[2]<0||s[1]+s[2]>1)&&(s[0]=I*(h*y+M*R+l*x),!0)}function I(t,e,r,a){var n,o=(r[0]-t[0])/e[0],c=(a[0]-t[0])/e[0];o>c&&(n=o,o=c,c=n);var i=(r[1]-t[1])/e[1],u=(a[1]-t[1])/e[1];if(i>u&&(n=i,i=u,u=n),o>u||i>c)return!1;i>o&&(o=i),u<c&&(c=u);var s=(r[2]-t[2])/e[2],v=(a[2]-t[2])/e[2];return s>v&&(n=s,s=v,v=n),!(o>v||s>c)&&(v<c&&(c=v),!(c<0))}function T(t,e,r,n,o,c){void 0===c&&(c=a.vec2d.create());var i=(n[o]-r[o])*(e[0]-t[0])-(n[0]-r[0])*(e[o]-t[o]),u=(n[0]-r[0])*(t[o]-r[o])-(n[o]-r[o])*(t[0]-r[0]);if(0===i)return!1;var s=u/i;return c[0]=t[0]+s*(e[0]-t[0]),c[1]=t[o]+s*(e[o]-t[o]),!0}function b(t,e,r){a.mat4d.multiply(e,t,vt),a.mat4d.inverse(vt);for(var n=0;n<8;++n)a.mat4d.multiplyVec4(vt,ft[n],dt),a.vec3d.set3(dt[0]/dt[3],dt[1]/dt[3],dt[2]/dt[3],r[n])}function C(t,e,r,a){void 0===a&&(a=r,r=ht),b(t,e,r),y(r,a)}function y(t,e){r.plane.fromPoints(t[4],t[0],t[3],e[0]),r.plane.fromPoints(t[1],t[5],t[6],e[1]),r.plane.fromPoints(t[4],t[5],t[1],e[2]),r.plane.fromPoints(t[3],t[2],t[6],e[3]),r.plane.fromPoints(t[0],t[1],t[2],e[4]),r.plane.fromPoints(t[5],t[4],t[7],e[5])}function R(t,e,r,o,c){c||(c=t),dt[0]=t[0],dt[1]=t[1],dt[2]=t[2],dt[3]=1,a.mat4d.multiplyVec4(e,dt),c.length>2&&(c[2]=-dt[2]),a.mat4d.multiplyVec4(r,dt),n(0!==dt[3]),c[0]=dt[0]/dt[3],c[1]=dt[1]/dt[3],c[2]=dt[2]/dt[3],c[0]=(.5*c[0]+.5)*o[2]+o[0],c[1]=(.5*c[1]+.5)*o[3]+o[1]}function x(t){return Math.atan((1-e.ECCENTRICITY_SQUARED)*Math.tan(t))}function P(t,r,a,n){var o=6378137/Math.sqrt(1-e.ECCENTRICITY_SQUARED*Math.pow(Math.sin(t),2)),c=Math.cos(t);n[0]=(o+a)*Math.cos(r)*c,n[1]=(o*(1-e.ECCENTRICITY_SQUARED)+a)*Math.sin(t),n[2]=-(o+a)*Math.sin(r)*c}function O(t,e){var r=a.vec3d.length(t);e[0]=Math.asin(u(t[1]/r,-1,1));var n=Math.cos(e[0]);e[1]=(t[2]<0?1:-1)*Math.acos(u(t[0]/(n*r),-1,1)),e[0]=m(e[0]),e[1]=m(e[1]),e[2]=r}function S(t,r){var a=6378137,n=t[0],o=-t[2],c=t[1],i=Math.sqrt(Math.pow(a,2)*(1-e.ECCENTRICITY_SQUARED)),u=Math.sqrt((Math.pow(a,2)-Math.pow(i,2))/Math.pow(i,2)),s=Math.sqrt(Math.pow(n,2)+Math.pow(o,2)),v=Math.atan2(a*c,i*s),f=Math.atan2(o,n),d=Math.atan2(c+Math.pow(u,2)*i*Math.pow(Math.sin(v),3),s-e.ECCENTRICITY_SQUARED*a*Math.pow(Math.cos(v),3)),h=a/Math.sqrt(1-e.ECCENTRICITY_SQUARED*Math.pow(Math.sin(d),2)),M=s/Math.cos(d)-h+e.EARTH_RADIUS;r[0]=d,r[1]=f,r[2]=M}function A(t,e,r){var n=l(t[0]),o=l(t[1]);return P(n,o,e,lt),a.mat4d.translate(r,lt),a.mat4d.rotateY(r,.5*Math.PI+o),a.mat4d.rotateX(r,.5*Math.PI-n),r}function w(t,e){return t[e]+(t[e+1]<<8)}function D(t,e){return t[e]+(t[e+1]<<8)+(t[e+2]<<16)+(t[e+3]<<24)}function U(t,e,r){void 0!==e[t]&&(r[t]=e[t])}function F(t,e){var r={};if(void 0!==e)for(var a=0,n=t;a<n.length;a++){var o=n[a];r[e(o)]=o}else for(var c=0,i=t;c<i.length;c++){var o=i[c];r[o]=o}return r}function N(t){var e=[];for(var r in t)e.push(t[r]);return e}function L(t,e,r){if(void 0===r&&(r={}),r!==t)for(var a in t)r[a]=t[a];if(r!==e)for(var n in e)r[n]=e[n];return r}function q(t,e){var r={};for(var a in t)void 0===e[a]&&(r[a]=t[a]);return r}function _(t,e){var r={};for(var a in t)void 0!==e[a]&&(r[a]=t[a]);return r}function j(t){for(var e in t)return e}function Y(t){return t[j(t)]}function G(t){for(var e in t)return!1;return!0}function V(t,e,r,a,o){var c=4*e;n(t.length===c*r,"buffer length must match image resolution");var i=document.createElement("canvas");i.width=e,i.height=r;for(var u=i.getContext("2d"),s=u.getImageData(0,0,e,r),v=s.data,f=0;f<r;++f)for(var d=f*c,h=(r-1-f)*c,M=0;M<c;++M)v[d++]=t[h++];return u.putImageData(s,0,0),i.toDataURL(a,o)}function Q(t){return Math.round(100*t)/100}function k(t,e){return Math.log(t)/Math.log(e)}function B(t,e){t[12]=e[0],t[13]=e[1],t[14]=e[2]}function X(t,e,r,a){t[12]=e,t[13]=r,t[14]=a}function H(t,e){return void 0===e&&(e=a.vec3d.create()),e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function W(t,e){return t=a.mat4d.identity(t),B(t,e),t}function z(t){return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&1===t[15]}function K(t,e,r){return 2*Math.atan(r*Math.tan(.5*t)/e)}function Z(t,e,r){return 2*Math.atan(e*Math.tan(.5*t)/r)}function J(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/e)}function $(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/r)}function tt(t,e,r){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}function et(t,e,r){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}function rt(t){--t;for(var e=1;e<32;e<<=1)t|=t>>e;return t+1}function at(t){return Math.pow(10,Math.ceil(Math.LOG10E*Math.log(t)))}function nt(t,e,r,n,o){var c=mt,i=pt;if(c[0]=t[0]-r[0],c[1]=t[1]-r[1],c[2]=t[2]-r[2],i[0]=n[0]-r[0],i[1]=n[1]-r[1],i[2]=n[2]-r[2],Math.abs(i[0])<1e-4&&Math.abs(i[1])<1e-4&&Math.abs(i[2])<1e-4)return o.success=!1,o;var s=gt;if(s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],Math.abs(s[0])<1e-4&&Math.abs(s[1])<1e-4&&Math.abs(s[2])<1e-4)return o.success=!1,o;var v=c[0]*i[0]+c[1]*i[1]+c[2]*i[2],f=i[0]*s[0]+i[1]*s[1]+i[2]*s[2],d=c[0]*s[0]+c[1]*s[1]+c[2]*s[2],h=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],M=s[0]*s[0]+s[1]*s[1]+s[2]*s[2],l=M*h-f*f;if(Math.abs(l)<1e-4)return o.success=!1,o;var m=v*f-d*h,p=u(m/l,0,1),g=u((v+f*p)/h,0,1),E=Et,I=It;E[0]=t[0]+p*s[0],E[1]=t[1]+p*s[1],E[2]=t[2]+p*s[2],I[0]=r[0]+g*i[0],I[1]=r[1]+g*i[1],I[2]=r[2]+g*i[2];var T=a.vec3d.dist2(E,I);return o.success=!0,o.dist2=T,o.pa=E,o.pb=I,o}function ot(t,e,r){var n=yt,o=Rt,c=xt,i=Ct,s=Tt,v=bt;n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=0,o[0]=r[0]-t[0],o[1]=r[1]-t[1],o[2]=0,c[0]=r[0],c[1]=r[1],c[2]=0;var f=a.vec2d.dot(o,n),d=a.vec2d.dot(n,n),h=u(f/d,0,1);i[0]=n[0]*h,i[1]=n[1]*h,s[0]=t[0]+i[0],s[1]=t[1]+i[1],a.vec2d.subtract(c,s,v);var M=a.vec2d.dot(v,v),l=a.vec2d.dot(o,o),m=a.vec2d.dot(n,n),p=a.vec2d.dot(i,i);return(p>l||p>m)&&(M=Number.MAX_VALUE),M}function ct(t,e,r){void 0===r&&(r=0);for(var a=u(t,0,Dt),n=0;n<4;n++)e[r+n]=Math.floor(256*ut(a*At[n]))}function it(t,e){void 0===e&&(e=0);for(var r=0,a=0;a<4;a++)r+=t[e+a]*wt[a];return r}function ut(t){return t-Math.floor(t)}function st(t,e,r,n,o){var c=t;0===t[11]?(n[0]=2/(e*c[0]),n[1]=2/(r*c[5]),n[2]=(1+c[12])/c[0],n[3]=(1+c[13])/c[5],a.vec2d.set2(0,1,o)):(n[0]=-2/(e*c[0]),n[1]=-2/(r*c[5]),n[2]=(1-c[8])/c[0],n[3]=(1-c[9])/c[5],a.vec2d.set2(1,0,o))}Object.defineProperty(e,"__esModule",{value:!0});var vt=a.mat4d.create(),ft=[a.vec4d.createFrom(-1,-1,-1,1),a.vec4d.createFrom(1,-1,-1,1),a.vec4d.createFrom(1,1,-1,1),a.vec4d.createFrom(-1,1,-1,1),a.vec4d.createFrom(-1,-1,1,1),a.vec4d.createFrom(1,-1,1,1),a.vec4d.createFrom(1,1,1,1),a.vec4d.createFrom(-1,1,1,1)],dt=a.vec4d.create(),ht=[a.vec3d.create(),a.vec3d.create(),a.vec3d.create(),a.vec3d.create(),a.vec3d.create(),a.vec3d.create(),a.vec3d.create(),a.vec3d.create()],Mt=a.vec3d.create(),lt=a.vec3d.create(),mt=a.vec3d.create(),pt=a.vec3d.create(),gt=a.vec3d.create(),Et=a.vec3d.create(),It=a.vec3d.create(),Tt=a.vec3d.create(),bt=a.vec3d.create(),Ct=a.vec3d.create(),yt=a.vec3d.create(),Rt=a.vec3d.create(),xt=a.vec3d.create(),Pt=a.vec3d.createFrom(0,0,0),Ot=function(){function t(t){this.message=t}return t.prototype.toString=function(){return"AssertException: "+this.message},t}();e.AssertException=Ot,e.EARTH_RADIUS=6378137,e.METER2FEET=3.28084,e.ECCENTRICITY_SQUARED=.0066943799901414,e.VertexAttrConstants={POSITION:"position",NORMAL:"normal",NORMALCOMPRESSED:"normalCompressed",UV0:"uv0",AUXPOS1:"auxpos1",AUXPOS2:"auxpos2",COLOR:"color",SYMBOLCOLOR:"symbolColor",SIZE:"size",REGION:"region",COMPONENTINDEX:"componentIndex"},e.assert=n,e.verify=o,e.isPowerOfTwo=c,e.lerp=i,e.clamp=u,e.encodeInt16=s,e.encodeNormal=v;var St="function"==typeof Math.sign?Math.sign:function(t){return+(t>0)-+(t<0)||0};e.fallbackIfUndefined=f,e.hex2rgb=d,e.rgb2hex=h,e.dec2hex=M,e.deg2rad=l,e.rad2deg=m,e.azimuthElevationAngle2Direction=p,e.raySphere=g,e.rayTriangle3D=E,e.rayBoxTest=I,e.rayRay2D=T,e.matrixToFrustumPoints=b,e.matrixToFrustumPlanes=C,e.frustumPointsToPlanes=y,e.project=R,e.geodeticToGeocentricLatidude=x,e.latLon2positionWGS84Ellipsoid=P,e.pos2latLon=O,e.pos2latLonWGS84Ellipsoid=S,e.computeGlobeTransformation=A,e.readUInt16=w,e.readUInt32=D,e.setIfDefined=U,e.array2object=F,e.object2array=N,e.mergeObjects=L,e.subtractObjects=q,e.intersectObjects=_,e.getFirstObjectKey=j,e.getFirstObjectValue=Y,e.objectEmpty=G,e.byteBuffer2base64image=V,e.cround=Q,e.logWithBase=k,e.setMatrixTranslation=B,e.setMatrixTranslation3=X,e.getMatrixTranslation=H,e.createTranslationMatrix=W,e.isTranslationMatrix=z,e.fovx2fovy=K,e.fovy2fovx=Z,e.fovx2fovd=J,e.fovy2fovd=$,e.fovd2fovx=tt,e.fovd2fovy=et,e.nextHighestPowerOfTwo=rt,e.nextHighestPowerOfTen=at,e.lineLineDistanceSquared3D=nt,e.pointLineSegmentDistanceSquared2D=ot,e.packFloatRGBA=ct,e.unpackFloatRGBA=it;var At=[1,256,65536,16777216],wt=[1/256,1/65536,1/16777216,1/4294967296],Dt=it(new Uint8ClampedArray([255,255,255,255]));e.inverseProjectionInfo=st});