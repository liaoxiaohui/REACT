// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/extendsHelper","dojo/text!./EdgeRenderer.xml","dojo/text!./EdgeRendererUtils.xml","../../../lib/glMatrix","../../../support/mathUtils","../ShaderVariations","./bufferLayouts"],function(e,t,r,i,o,s,n,a,u,d){Object.defineProperty(t,"__esModule",{value:!0}),t.LINE_WIDTH_FRACTION_FACTOR=8,t.EXTENSION_LENGTH_OFFSET=128;var p={type:"solid",uber:!0,strokesTexture:null},f=function(){function e(){this._value=0}return Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),e.prototype.increment=function(){this._value++},e.prototype.decrement=function(){this._value--},e}(),h=function(){function e(t,i,o){this.rctx=t,this.programRepository=i,this.refCount=new f,this.renderables=new Set,this.depthBiasZ=-4e-4,this.depthBiasXY=.5,this.tmpViewToWorldNormalMatrix=n.mat3d.create(),this.settings=r({},p,o),this.key=e.getKey(this.settings.uber,this.settings.type);var s=this.settings.strokesTexture.variants;this.writerSettings={variants:s},this.createPrograms()}return e.prototype.dispose=function(){for(var e in this.programs){var t=this.programs[e];t&&(this.programRepository.decreaseRefCount(t),this.programs[e]=null)}},e.prototype.addRenderable=function(e){this.renderables.add(e)},e.prototype.removeRenderable=function(e){this.renderables.delete(e)},e.prototype.forEachRenderable=function(e){this.renderables.forEach(e)},e.prototype.bindRegularEdges=function(e,t){this.bind(this.programs.regular,e,t)},e.prototype.bindSilhouetteEdges=function(e,t){this.bind(this.programs.silhouette,e,t)},e.prototype.bind=function(e,t,r){this.rctx.bindProgram(e),e.setUniformMatrix4fv("uProj",t.proj),e.setUniform2f("uDepthBias",this.depthBiasXY,this.depthBiasZ),e.setUniform2f("uPixelToNDC",2/t.viewport[2],2/t.viewport[3]),e.setUniform2f("uNDCToPixel",t.viewport[2]/2,t.viewport[3]/2),e.setUniform1f("uDistanceFalloffFactor",r.distanceFalloffFactor),e.setUniform2f("uViewportDimInv",1/t.viewport[2],1/t.viewport[3])},e.prototype.renderRegularEdges=function(e,t,r){this.render(this.programs.regular,e,e.regular.vao,t,r)},e.prototype.renderSilhouetteEdges=function(e,t,r){this.render(this.programs.silhouette,e,e.silhouette.vao,t,r)},e.prototype.render=function(e,t,r,i,o){this.setUniforms(e,t,i);var s=this.rctx;s.bindVAO(r),s.capabilities.instancing.drawArraysInstanced(6,0,4,o)},e.prototype.setUniforms=function(e,r,i){r.components.buffer.textureBuffer.bind(e,t.componentDataBindParameters),e.setUniformMatrix4fv("uView",i.view),e.setUniformMatrix4fv("uModel",r.transform.modelMatrix);var o=i.viewInvTransp,s=n.mat4d.toMat3(o,this.tmpViewToWorldNormalMatrix);e.setUniform3f("uCameraPosition",o[3],o[7],o[11]),e.setUniformMatrix3fv("uViewToWorldNormalMatrix",s),(this.settings.uber||"sketch"===this.settings.type)&&this.setSketchUniforms(e),e.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(i.fovY/2)/(i.viewport[3]/2)),e.setUniform3fv("uLocalOrigin",r.transform.origin.vec3)},e.prototype.setSketchUniforms=function(e){var t=this.settings.strokesTexture,r=t.texture;this.rctx.bindTexture(r,0),e.setUniform1i("uStrokesTexture",0),e.setUniform2f("uStrokesTextureScale",1/r.descriptor.width,1/r.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",a.log2(t.resolution)),e.setUniform1f("uStrokesNormalizationScale",t.normalizationScale),e.setUniform1f("uStrokesAmplitude",t.amplitude),e.setUniform1f("uStrokeVariants",t.variants)},e.prototype.getDefines=function(e){return[e.silhouette,!!this.rctx.capabilities.blendMinMax,"solid"===this.settings.type&&!this.settings.uber,"sketch"===this.settings.type&&!this.settings.uber,this.settings.uber]},e.prototype.createPrograms=function(){var e=this.programRepository.getShaderVariationsProgram(l,this.getDefines({silhouette:!1}),void 0,void 0,d.EdgeShaderAttributeLocations),t=this.programRepository.getShaderVariationsProgram(l,this.getDefines({silhouette:!0}),void 0,void 0,d.EdgeShaderAttributeLocations);this.programRepository.increaseRefCount(e),this.programRepository.increaseRefCount(t),this.programs={regular:e,silhouette:t}},e.loadShaders=function(e,t,r){if(e.EdgeRendererUtils_readComponentColor||e._parse(s),e.fsRibbonEdge||e._parse(o),!t.getShaderVariations(l)){var i=new u("ribbonEdge",["vsRibbonEdge","fsRibbonEdge"],null,t,e,r);i.addDefine("Silhouette","SILHOUETTE"),i.addDefine("AntiAliasing","ANTIALIASING"),i.addDefine("Solid","SOLID"),i.addDefine("Sketch","SKETCH"),i.addDefine("Uber","UBER"),t.addShaderVariations(l,i)}},e.getKey=function(e,t){return e?"edges-uber":"edges-t:"+t},e}();t.EdgeRenderer=h;var l="edge-shader-variations";t.componentDataBindParameters={texName:"uComponentDataTex",invDimName:"uComponentDataTexInvDim",unit:2}});