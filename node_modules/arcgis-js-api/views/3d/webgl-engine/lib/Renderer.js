// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/iteratorUtils","./ComponentUtils","./DefaultVertexAttributeLocations","./ExternalRendererContainer","./Float32ArrayList","./FxaaRenderPass","./gl-matrix","./HighlightTextureHelper","./InstanceBufferData","./IntervalUtilities","./LinearDepthTextureHelper","./NormalTextureHelper","./RenderContext","./RenderPass","./RenderSlot","./SmaaRenderPass","./StencilRenderingHelper","./Util","./edgeRendering/EdgeView","../lighting/SceneLighting","../materials/HUDMaterial","../../../webgl/BufferObject","../../../webgl/Profiling","../../../webgl/Texture","../../../webgl/Util","../../../webgl/VertexArrayObject"],function(e,t,r,a,n,i,s,o,d,l,h,g,f,u,p,c,m,_,v,y,R,x,b,I,D,A,T,P){function O(e){if(e.instanceParameters.hidden)return[];var t=e.instanceParameters.componentVisibilities,r=e.componentOffsets;return a.generateVisibleIndexRanges(t,r)}function M(e){if(e.instanceParameters.hidden)return[];var t=e.instanceParameters.componentVisibilities,r=e.instanceParameters.componentHighlights,n=e.componentOffsets;return a.generateHighlightedIndexRanges(t,r,n)}function C(e,t,r){var a=e.origin.vec3;y.setMatrixTranslation3(j,-a[0],-a[1],-a[2]),N.multiply(j,e.transformation,t),N.inverse(t,r),N.transpose(r)}function H(e,t,r){for(var a in e){var n=e[a];t(a,n),n.origin2data.forEach(function(e,t){r(t,e)})}}function w(e){return E(e.data)>=1}function E(e){return!1===e.preinterleaved?y.getFirstObjectValue(e.indices).length:e.indexCount}var S,V=d.vec2d,N=d.mat4d,L=N.identity(),G=1535,B=function(){function e(e,t,r,a,n){this._lighting=new x.SceneLighting,this._mat2DataMerged={},this._mat2DataInstanced={},this._mat2DataPreinterleaved={},this._renderOrder=[],this._externalRenderers=new i,this._renderContext=new p,this._isRendering=!1,this._highlights=[],this._pixelRatio=1,this._threshold=G,this._needsRender=!0,this._fallbackDepthStencilTexture=null,this._stats=new U,this._edgeView=null,this._edgeViewLoaded=!1,this.ssaoEnabled=!1,this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1},this._programRep=e,this._materialRep=t,this._orderedRendering=n,this._rctx=a,this._fxaaPass=new o(a),this._smaaPass=new _(a),this._renderContext.rctx=a,this._renderContext.lightingData=this._lighting.getOld(),a.setDepthTestEnabled(!0),a.setFaceCullingEnabled(!0),a.setBlendingEnabled(!1),a.setBlendFunctionSeparate(770,771,1,771),this._bindParameters={view:null,proj:null,viewInvTransp:null,fovY:0,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null},this._linearDepthTextureHelper=new f(a),this._normalTextureHelper=new u(a),this._highlightTextureHelper=new l(a),this._stencilRenderingHelper=new v(a),this._initializeFramebufferTexture()}return e.prototype._initializeFramebufferTexture=function(){var e=this._rctx.gl,t=this._rctx.contextAttributes,r=t.alpha?e.RGBA:e.RGB,a=new A(this._rctx,{target:3553,pixelFormat:r,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:r,texture:a}},e.prototype.dispose=function(){var e=this,t=function(t){e._releaseMaterials(t)},r=function(e,t){if(t.type===S.Preinterleaved)for(var r in t.instances)t.instances[r].vao.dispose(!0);else t.vao.dispose(!0)};H(this._mat2DataMerged,t,r),H(this._mat2DataInstanced,t,r),H(this._mat2DataPreinterleaved,t,r),this._mat2DataMerged=null,this._mat2DataInstanced=null,this._mat2DataPreinterleaved=null,this._framebuffer.texture.dispose(),this._framebuffer.texture=null,this._linearDepthTextureHelper.enabled=!1,this._normalTextureHelper.enabled=!1,this._highlightTextureHelper.enabled=!1,this._stencilRenderingHelper.enabled=!1,this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null)},Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return"smaa"===this.renderOptions.antialiasing&&this._smaaPass.isLoadingResources},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"edgeView",{get:function(){var e=this;return this._edgeViewLoaded||(this._edgeViewLoaded=!0,R.EdgeView.isSupported(this._rctx)&&(this._edgeView=new R.EdgeView(this._rctx,this._programRep,{setNeedsRender:function(){e._needsRender=!0}}),this._edgeView.initialize())),this._edgeView},enumerable:!0,configurable:!0}),e.prototype.setLighting=function(e){this._lighting.set(e)},e.prototype.setPixelRatio=function(e){this._pixelRatio=e,this._needsRender=!0},e.prototype.getPixelRatio=function(){return this._pixelRatio},e.prototype.addExternalRenderer=function(e,t){return this._externalRenderers.addRenderer(e,t),!0},e.prototype.removeExternalRenderer=function(e){return this._externalRenderers.removeRenderer(e),!0},e.prototype.getExternalRenderers=function(){return this._externalRenderers},e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._externalRenderers.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()},e.prototype.getCombinedStats=function(){var e=this;this._stats.VBOallocatedSize=0,this._stats.VBOoptimalSize=0,this._stats.VBOusedSize=0;var t=function(){},r=function(t,r){if(r.type===S.Preinterleaved)for(var a in r.instances){var n=r.instances[a].vao.size;e._stats.VBOallocatedSize+=n/4,e._stats.VBOusedSize+=n/4,e._stats.VBOoptimalSize+=n/4}else e._stats.VBOallocatedSize+=r.buffer.getArray().length,e._stats.VBOusedSize+=r.buffer.getSize(),e._stats.VBOoptimalSize+=r.optimalCount};return H(this._mat2DataMerged,t,r),H(this._mat2DataInstanced,t,r),H(this._mat2DataPreinterleaved,t,r),this._stats.VBOallocatedSize*=4/1024,this._stats.VBOusedSize*=4/1024,this._stats.VBOoptimalSize*=4/1024,this._stats},e.prototype._addHighlight=function(e){var t=this._getInstance(e);if(null===t)return void console.error("No instance found for RenderGeometry {name: '"+e.name+"', uniqueName: '"+e.uniqueName+"'}");this._highlights.push(t),this._orderedRendering&&this._sortHighlightsByRenderOrder(),this._needsRender=!0,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)},e.prototype._removeHighlight=function(e){var t=this._highlights.length;this._highlights=this._highlights.filter(function(t){return t.uniqueName!==e.uniqueName}),t!==this._highlights.length&&(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights),this._needsRender=!0)},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlights.length>0},enumerable:!0,configurable:!0}),e.prototype._renderHUDVisibility=function(e){var t=this,r=b.shouldRenderVisibilityDuringRenderPass(e.pass),a=e.offscreenRenderingHelper&&e.offscreenRenderingHelper.enabled,n=!1;return r&&a&&e.offscreenRenderingHelper.renderHUDVisibility(function(){n=t._renderInternalSlot(m.OCCLUSION_PIXELS,e)}),n},e.prototype.renderGeometrySlotsPt1=function(e){this._externalRenderers.render(m.INTERNAL_MATERIAL,e),this._renderInternalSlot(m.STENCIL_MATERIAL,e),this._externalRenderers.render(m.OPAQUE_TERRAIN,e),this._renderInternalSlot(m.OPAQUE_MATERIAL,e),this._externalRenderers.render(m.OPAQUE_EXTERNAL,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep),this._externalRenderers.render(m.POSTPROCESSING_ATMOSPHERE_OPAQUE,this._renderContext),this._renderInternalSlot(m.TRANSPARENT_MATERIAL,e),this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(e),this._renderInternalSlot(m.LINE_CALLOUTS,this._renderContext)),this._externalRenderers.render(m.TRANSPARENT_EXTERNAL,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep)},e.prototype.renderTransparentTerrain=function(e){return this._externalRenderers.render(m.TRANSPARENT_TERRAIN,e)},e.prototype.renderGeometrySlots=function(e){this.renderGeometrySlotsPt1(e),this.renderTransparentTerrain(e)},e.prototype.renderHUD=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(m.LINE_CALLOUTS_HUD_DEPTH,this._renderContext),this._renderInternalSlot(m.HUDMATERIAL1,this._renderContext),this._renderInternalSlot(m.HUDMATERIAL2,this._renderContext)},e.prototype._renderHighlights=function(e,t,r){var a=!!r&&r.enabled,n=a&&(this.hasHighlights||this._externalRenderers.needsHighlight());if(this._highlightTextureHelper.enabled=n,n){var i=null;r.profilingCallback&&(i=D.startMeasurement(this._renderContext.rctx)),this._highlightTextureHelper.setupFBOs(e),this._highlightTextureHelper.prepareHighlightPass(),this.renderGeometryPass(c.MATERIAL_HIGHLIGHT,e,null,null);var s=this._rctx.gl;this._rctx.clear(s.DEPTH_BUFFER_BIT),this.renderHUD("both"),this._highlightTextureHelper.finish(t);var o=this._highlightTextureHelper.framebuffer;r.render(e,t,o),null!==i&&r.profilingCallback&&i.stop(function(e){r.profilingCallback&&r.profilingCallback(e)})}},e.prototype._needsRenderOccluded=function(e){for(var t in this._mat2DataInstanced){var r=this._mat2DataInstanced[t],a=r[0];if(a&&a.renderOccluded&&a.beginSlot(e)&&a.isVisible())return!0}return!1},e.prototype._renderOccluded=function(e,t,r){if(t&&r&&r.enabled){var a=this._needsRenderOccluded(m.OPAQUE_MATERIAL)||this._needsRenderOccluded(m.TRANSPARENT_MATERIAL);if(t.enabled=a,a){var n=this._renderContext;t.setupFBOs(e),t.prepareColorPass(),n.pass=c.MATERIAL,n.renderOccludedOnly=!0,this._renderInternalSlot(m.OPAQUE_MATERIAL,n),this._renderInternalSlot(m.TRANSPARENT_MATERIAL,n),n.renderOccludedOnly=!1,t.finish(r.framebuffer),t.apply()}}},e.prototype._renderUnordered=function(e,t,r,a){var n=this,i=this._rctx;this._isRendering=!0,this._stats.reset(),this._updateGlobalUniforms(e.projectionMatrix),this._renderContext.pass=c.MATERIAL,this._renderContext.camera=e,this._renderContext.pixelRatio=this._pixelRatio,this._renderContext.shadowMap=t,this._renderContext.ssaoHelper=a.ssao,this._renderContext.offscreenRenderingHelper=a.offscreenRendering,this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper,this._renderContext.depth=this._linearDepthTextureHelper.framebuffer,this._renderContext.normals=this._normalTextureHelper.framebuffer,this._renderContext.highlight=this._highlightTextureHelper.framebuffer,this._renderContext.options=this.renderOptions,a.offscreenRendering.enabled=!0,a.offscreenRendering.initializeFrame(e),this._externalRenderers.render(m.BACKGROUND,this._renderContext),this.renderGeometrySlotsPt1(this._renderContext),this._edgeView&&this.edgeView.shouldRender()&&a.offscreenRendering.renderSeparateAndComposite(function(){n._edgeView.render(n._bindParameters)},void 0,"alpha");var s={hudVisibility:!1,transparentTerrain:!1};this.renderOptions.earlyOcclusionPixelDraw||(s.hudVisibility=this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(m.LINE_CALLOUTS,this._renderContext)),s.transparentTerrain=this.renderTransparentTerrain(this._renderContext),s.transparentTerrain&&s.hudVisibility&&(a.offscreenRendering.compositeTransparentTerrainOntoHUDVisibility(),a.offscreenRendering.renderToTargets(function(){return n.renderHUD("occluded")},a.offscreenRendering.mainColor,a.offscreenRendering.tmpDepth,void 0,!0)),s.transparentTerrain&&a.offscreenRendering.compositeTransparentTerrainOntoMain(),a.offscreenRendering.renderToTargets(function(){n._externalRenderers.render(m.POSTPROCESSING_ATMOSPHERE_TRANSPARENT,n._renderContext),n._externalRenderers.render(m.POSTPROCESSING_EXTERNAL,n._renderContext),n._renderOccluded(e,a.renderOccluded,a.offscreenRendering)},a.offscreenRendering.mainColor,a.offscreenRendering.mainDepth);var o=this.renderOptions.antialiasing;"smaa"===o&&this._smaaPass.loadResources(function(){n._needsRender=!0}),"smaa"===o&&this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:a.offscreenRendering.colorTexture},null)):"fxaa"===o&&this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:a.offscreenRendering.colorTexture},null)):(a.offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable()),i.bindFramebuffer(null),this._renderContext.framebufferTex=a.offscreenRendering.colorTexture,this.renderHUD("notOccluded"),this._renderHighlights(e,r,a.highlight);this._isRendering=!1},e.prototype._renderGeometryPassOrderedHighlight=function(e){this._renderInternalHighlights(this._highlights)},e.prototype._renderGeometryPassOrderedMaterial=function(e){for(var t=null,r=0;r<this._renderOrder.length;r++){var a=this._renderOrder[r][1];if(a.instanced){var n=a.instanced||a.merged,i=n[e.pass];i&&i.isVisible()&&(this._renderInternalInstanced(n,i,this._bindParameters,1/0),t=null)}if(a.merged){var n=a.merged,i=n[e.pass];if(i&&i.isVisible()){var s=i.getProgram();s!==t&&(s.setUniformMatrix4fv("model",L),s.hasUniform("modelNormal")&&s.setUniformMatrix4fv("modelNormal",L)),t=s,this._renderInternalMerged(n,i,this._bindParameters,1/0)}}}},e.prototype._renderGeometryPassOrdered=function(e){var t=e.camera;this._bindParameters.view=t.viewMatrix,this._bindParameters.proj=t.projectionMatrix,this._bindParameters.viewInvTransp=t.viewInverseTransposeMatrix,q[0]=t.near,q[1]=t.far,this._bindParameters.nearFar=q,this._bindParameters.lightingData=e.lightingData,this._bindParameters.viewport=t.fullViewport,this._bindParameters.framebufferTex=this._framebuffer.texture,this._bindParameters.pixelRatio=e.pixelRatio,e.isHighlightPass?this._renderGeometryPassOrderedHighlight(e):this._renderGeometryPassOrderedMaterial(e)},e.prototype._renderOrdered=function(e,t){this._stats.reset(),this.renderGeometryPass(e,t)},e.prototype.prepareRender=function(e){this._externalRenderers.prepareRender(e),this._renderContext.rctx.setDepthFunction(513)},e.prototype.render=function(e,t,r){this._orderedRendering?this._renderOrdered(c.MATERIAL,e):this._renderUnordered(e,r.shadowMap,t,r)},e.prototype.renderAuxiliaryBuffers=function(e,t,r){var a=r.ssao,n=r.shadowMap,i=this.ssaoEnabled||this._externalRenderers.needsLinearDepth();this._linearDepthTextureHelper.enabled=i,i&&(this._linearDepthTextureHelper.setupFBOs(e),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(c.MATERIAL_DEPTH,e,n,a),this._linearDepthTextureHelper.finish(t)),this._normalTextureHelper.enabled=this.ssaoEnabled,this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(e),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(c.MATERIAL_NORMAL,e,n,a),this._normalTextureHelper.finish(t)),this.ssaoEnabled&&a.computeSSAO(e,t,this._linearDepthTextureHelper.framebuffer,this._normalTextureHelper.framebuffer),a.bindAll(this._programRep)},e.prototype.renderGeometryPass=function(e,t,r,a){this._isRendering=!0,this._updateGlobalUniforms(t.projectionMatrix),this._renderContext.pass=e,this._renderContext.camera=t,this._renderContext.pixelRatio=this._pixelRatio,this._renderContext.shadowMap=r,this._renderContext.ssaoHelper=a,this._renderContext.depth=this._linearDepthTextureHelper.framebuffer,this._renderContext.normals=this._normalTextureHelper.framebuffer,this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext),this._isRendering=!1},e.prototype._renderGeometryPassUnordered=function(e){this.renderGeometrySlots(e)},e.prototype._renderInternalHighlights=function(e,t){void 0===t&&(t=null);for(var r=!1,a=0;a<e.length;++a){var n=e[a],i=n.matData[c.MATERIAL_HIGHLIGHT];i&&(null===t||i.beginSlot(t))&&i.isVisible()&&(r=this._renderInternalHighlight(n,this._bindParameters,c.MATERIAL_HIGHLIGHT)||r)}return r},e.prototype._renderInternalSlotOccluded=function(e,t){var r=!1;for(var a in this._mat2DataInstanced){var n=this._mat2DataInstanced[a],i=n[t.pass];i&&i.renderOccluded&&i.beginSlot(e)&&i.isVisible()&&(r=this._renderInternalInstanced(n,i,this._bindParameters,e)||r)}return r},e.prototype._renderInternalSlotMaterial=function(e,t){var r=!1;for(var a in this._mat2DataInstanced){var n=this._mat2DataInstanced[a],i=n[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&(r=this._renderInternalInstanced(n,i,this._bindParameters,e)||r)}for(var s=this._programRep.getProgramsUsingUniform("model"),o=this._programRep.getProgramsUsingUniform("modelNormal"),d=0;d<s.length;d++){var l=s[d];l.setUniformMatrix4fv("model",L),o.indexOf(l)>-1&&l.setUniformMatrix4fv("modelNormal",L)}for(var a in this._mat2DataMerged){var n=this._mat2DataMerged[a],i=n[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&(r=this._renderInternalMerged(n,i,this._bindParameters,e)||r)}for(var a in this._mat2DataPreinterleaved){var n=this._mat2DataPreinterleaved[a],i=n[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&(r=this._renderInternalPreinterleaved(n,i,this._bindParameters,e)||r)}return e===m.STENCIL_MATERIAL&&this._stencilRenderingHelper.finish(),r},e.prototype._renderInternalSlotHighlights=function(e,t){return this._renderInternalHighlights(this._highlights,e)},e.prototype._renderInternalSlot=function(e,t){this._bindParameters.view=t.camera.viewMatrix,this._bindParameters.proj=t.camera.projectionMatrix,this._bindParameters.viewInvTransp=t.camera.viewInverseTransposeMatrix,this._bindParameters.cameraAboveGround=t.camera.aboveGround,this._bindParameters.fovY=t.camera.fovY,q[0]=t.camera.near,q[1]=t.camera.far;var r=this._renderContext.offscreenRenderingHelper;return this._bindParameters.nearFar=q,this._bindParameters.lightingData=t.lightingData,this._bindParameters.viewport=t.camera.fullViewport,this._bindParameters.framebufferTex=r?r.colorTexture:null,this._bindParameters.shadowMap=t.shadowMap,this._bindParameters.shadowMappingEnabled=!!t.shadowMap&&t.shadowMap.enabled,this._bindParameters.ssaoEnabled=!!t.ssaoHelper&&t.ssaoHelper.enabled,this._bindParameters.pixelRatio=t.pixelRatio,this._bindParameters.hudVisibilityTexture=r?r.hudVisibilityTexture:null,t.isHighlightPass?this._renderInternalSlotHighlights(e,t):t.renderOccludedOnly?this._renderInternalSlotOccluded(e,t):this._renderInternalSlotMaterial(e,t)},e.prototype._renderInternalInstanced=function(e,t,r,a){var n=this,i=this._rctx,s=i.gl,o=!1,d=t.getDrawMode(i),l=i.capabilities.instancing,h=!1;return e.origin2data.forEach(function(e){r.origin=e.origin,a===m.STENCIL_MATERIAL&&(n._stencilRenderingHelper.enabled=!0,n._stencilRenderingHelper.prepareStencilWritePass());var g=!1;if(t.instanced)for(var f in e.perGeometryDataInfo){var u=e.perGeometryDataInfo[f];o||(t.bind(i,r),o=!0),i.bindVAO(u.vao);var p=t.getProgram();T.assertCompatibleVertexAttributeLocations(u.vao,p),g||(t.bindView(i,r),g=!0);var c=u.to-u.from,_=u.refCount;d===s.TRIANGLES&&(n._stats.trianglesRendered+=_*c/3),l.drawArraysInstanced(d,u.from,c,_),h=!0,n._stats.drawCallsAngleInstanced++,n._stats.instancesDrawnAngle+=_}else{var v=e.instances;for(var y in v){var R=v[y],x=R.displayedIndexRange;x&&0===x.length||(o||(t.bind(i,r),o=!0),g||(i.bindVAO(e.vao),t.bindView(i,r),g=!0),t.bindInstance(i,R),n._stats.drawCallsInstanced++,d===s.TRIANGLES&&(n._stats.trianglesRendered+=(R.to-R.from)/3),x?n._drawArraysFaceRange(x,R.from,d):i.drawArrays(d,R.from,R.to-R.from),h=!0)}}}),i.bindVAO(null),o&&t.release(i,r),h},e.prototype._renderInternalHighlight=function(e,t,r){var a=this._rctx,n=a.gl,i=e.matData[r],s=i.getDrawMode(a),o=e.instance,d=o.highlightedIndexRange,l=this._renderContext.offscreenRenderingHelper,h=(l?l.depthTexture:null)||this._getFallbackDepthTexture(),g=i.getProgram(),f=a.capabilities.instancing;t.origin=e.originData.origin;var u=!1;if(i.instanced&&e.type===S.Instanced){var p=e.instancedVAO;i.bind(a,t),a.bindVAO(p),T.assertCompatibleVertexAttributeLocations(p,g),i.bindView(a,t);for(var c=0;c<d.length;c++){var m=d[c],_=m.range?m.range[0]+o.from:o.from,v=m.range?m.range[1]-m.range[0]+1:o.to-o.from;a.bindTexture(h,5),g.setUniform1i("depthTex",5),g.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),f.drawArraysInstanced(s,_,v,1),s===n.TRIANGLES&&(this._stats.trianglesRendered+=1*v/3),this._stats.drawCallsHighlight++,u=!0}}else if(e.type===S.Instanced&&i.instanced)console.error("_renderInternalHighlight: incompatible instance type");else{i.bind(a,t),i.bindView(a,t);var y=null;switch(e.type){case S.Merged:var R=e.originData;a.bindVAO(R.vao),g.setUniformMatrix4fv("model",L);break;case S.Instanced:var R=e.originData;a.bindVAO(R.vao),i.bindInstance(a,o);break;case S.Preinterleaved:var R=e.originData,p=R.instances[e.uniqueName].vao;a.bindVAO(p),i.bindInstance(a,o),y=p.indexBuffer&&p.indexBuffer.indexType}for(var c=0;c<d.length;c++){var m=d[c],_=m.range?m.range[0]+o.from:o.from,v=m.range?m.range[1]-m.range[0]+1:o.to-o.from;if(a.bindTexture(h,5),i.getProgram().setUniform1i("depthTex",5),g.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),y){var x=T.getBytesPerElement(y);a.drawElements(s,v,y,_*x)}else a.drawArrays(s,_,v);s===n.TRIANGLES&&(this._stats.trianglesRendered+=v/3),this._stats.drawCallsHighlight++,u=!0}}return a.bindVAO(null),i.release(a,t),u},e.prototype._drawArraysFaceRange=function(e,t,r){for(var a=this._rctx,n=0,i=e;n<i.length;n++){var s=i[n];a.drawArrays(r,s[0]+t,s[1]-s[0]+1)}this._stats.drawCallsFragmented+=e.length-1},e.prototype._drawElementsFaceRange=function(e,t,r,a){for(var n=this._rctx,i=T.getBytesPerElement(a),s=0,o=e;s<o.length;s++){var d=o[s],l=d[1]-d[0]+1,h=d[0]+t;n.drawElements(r,l,a,h*i)}this._stats.drawCallsFragmented+=e.length-1},e.prototype._renderInternalMerged=function(e,t,r,a){var n=this,i=this._rctx,s=i.gl,o=!1,d=!1;return e.origin2data.forEach(function(e){if(r.origin=e.origin,a===m.STENCIL_MATERIAL&&(n._stencilRenderingHelper.enabled=!0,n._stencilRenderingHelper.prepareStencilWritePass()),!e.displayedIndexRange||0!==e.displayedIndexRange.length){d||(t.bind(i,r),d=!0);var l=t.getProgram();i.bindVAO(e.vao),T.assertCompatibleVertexAttributeLocations(e.vao,l),t.bindView(i,r),n._stats.drawCallsMerged++;var h=t.getDrawMode(i);h===s.TRIANGLES&&(n._stats.trianglesRendered+=e.vao.vertexBuffers.geometry.size/3),e.displayedIndexRange?n._drawArraysFaceRange(e.displayedIndexRange,0,h):i.drawArrays(h,0,T.vertexCount(e.vao,"geometry")),o=!0}}),d&&t.release(i,r),o},e.prototype._renderInternalPreinterleaved=function(e,t,r,a){var n=this,i=this._rctx,s=i.gl,o=!1,d=!1,l=t.getDrawMode(i);return e.origin2data.forEach(function(e){r.origin=e.origin;var h=!1;a===m.STENCIL_MATERIAL&&(n._stencilRenderingHelper.enabled=!0,n._stencilRenderingHelper.prepareStencilWritePass());for(var g in e.instances){var f=e.instances[g],u=f.instance,p=f.vao,c=u.displayedIndexRange;if(!c||0!==c.length){d||(t.bind(i,r),d=!0);var _=t.getProgram();T.assertCompatibleVertexAttributeLocations(p,_),i.bindVAO(p),h||(t.bindView(i,r),h=!0),t.bindInstance(i,u),n._stats.drawCallsPreinterleaved++,l===s.TRIANGLES&&(n._stats.trianglesRendered+=(u.to-u.from)/3);var v=p.indexBuffer&&p.indexBuffer.indexType;if(c)v?n._drawElementsFaceRange(c,u.from,l,v):n._drawArraysFaceRange(c,u.from,l);else if(v){var y=T.getBytesPerElement(v);i.drawElements(l,u.to-u.from,v,u.from*y)}else i.drawArrays(l,u.from,u.to-u.from);o=!0}}}),i.bindVAO(null),d&&t.release(i,r),o},e.prototype._updateGlobalUniforms=function(e){for(var t=this._programRep.getProgramsUsingUniform("proj"),r=0;r<t.length;r++)t[r].setUniformMatrix4fv("proj",e);if(this._lighting){t=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r]);t=this._programRep.getProgramsUsingUniform("lightDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r])}},e.prototype.print=function(){var e=Object.keys(this._mat2DataMerged).length,t=Object.keys(this._mat2DataInstanced).length,r=Object.keys(this._mat2DataPreinterleaved).length;console.log("number of materials (merged/instanced/preinterleaved): "+e+"/"+t+"/"+r);var a=0;H(this._mat2DataMerged,function(){},function(e,t){a+=Object.keys(t.instances).length});var n=0;H(this._mat2DataInstanced,function(){},function(e,t){n+=Object.keys(t.instances).length});var i=0;H(this._mat2DataPreinterleaved,function(){},function(e,t){i+=Object.keys(t.instances).length}),console.log("number of instances (merged/instanced/preinterleaved): "+a+"/"+n+"/"+i)},e.prototype.isEmpty=function(){for(var e in this._mat2DataInstanced){var t=this._mat2DataInstanced[e];if(!r.forEachUntilMap(t.origin2data,function(e){return y.objectEmpty(e.instances)}))return!1}for(var e in this._mat2DataMerged){var t=this._mat2DataMerged[e];if(!r.forEachUntilMap(t.origin2data,function(e){return y.objectEmpty(e.instances)}))return!1}for(var e in this._mat2DataPreinterleaved){var t=this._mat2DataPreinterleaved[e];if(!r.forEachUntilMap(t.origin2data,function(e){return y.objectEmpty(e.instances)}))return!1}return!0},e.prototype.modify=function(e,t,r,a){this._isRendering&&console.warn("Renderer.modify called while rendering");var n=[],i=[],s=[];this._classifyRenderGeometry(e,n,i,s);var o=[],d=[],l=[];this._classifyRenderGeometry(t,o,d,l);var h={};r&&this._performUpdates(r,h);var g=[];this._modifyMerged(n,o,g,h),this._modifyInstanced(i,d,g),this._modifyPreinterleaved(s,l,g),this._updateMergedFaceranges(h),this._releaseMaterials(g);var f=this._highlights.length;t&&t.length>0&&f>0&&(this._highlights=this._highlights.filter(function(e){return!t.some(function(t){return t.uniqueName===e.uniqueName})}),f!==this._highlights.length&&this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)),this._updateHighlightVAOs(),a&&this._modifyMaterials(a),this._needsRender=!0},e.prototype._classifyRenderGeometry=function(e,t,r,a){for(var n=0,i=e;n<i.length;n++){var s=i[n];if(w(s))switch(this._getType(s)){case S.Merged:t.push(s);break;case S.Instanced:r.push(s);break;case S.Preinterleaved:a.push(s)}}},e.prototype._performUpdates=function(e,t){for(var r=0,a=e;r<a.length;r++){var n=a[r],i=n.updateType,s=n.renderGeometry,o=this._getType(s)===S.Merged;if(w(s)){if(2&i&&this._updateFaceranges(s,t),32&i){var d=this._getInstance(s);d&&this._updateHighlightFaceranges(s,d.instance)}4&i||o&&16&i?this._updateVertexAttributes(s,!o):!o&&16&i&&this._updateInstanceTransformation(s)}}},e.prototype._updateFaceranges=function(e,t){var r,a=e.material,n=a.id,i=e.origin.id,s=this._getType(e);if(s===S.Preinterleaved){var o=this._getOriginData(s,n,i);r=o.instances[e.uniqueName].instance}else{var o=this._getOriginData(s,n,i);r=o.instances[e.uniqueName],r&&s===S.Merged&&(t[this._modifiedMergedFacerangesKey(n,i)]=o)}r&&(r.displayedIndexRange=O(e),this._updateHighlightFaceranges(e,r))},e.prototype._updateHighlightFaceranges=function(e,t){if(t){var r=t.highlightedIndexRange,a=M(e);t.highlightedIndexRange=a,a&&!r?this._addHighlight(e):!a&&r&&this._removeHighlight(e)}},e.prototype._updateMergedFaceranges=function(e){for(var t in e){var r=e[t];r.displayedIndexRange=[];var a=r.instances,n=!0;for(var i in a){var s=a[i];s.displayedIndexRange?(r.displayedIndexRange.push.apply(r.displayedIndexRange,g.offsetIntervals(s.displayedIndexRange,s.from)),n=!1):r.displayedIndexRange.push([s.from,s.to-1])}r.displayedIndexRange=n?null:g.mergeIntervals(r.displayedIndexRange)}},e.prototype._updateVertexAttributes=function(e,t){var r=e.material,a=r.id,n=e.origin.id,i=T.getStride(r.getVertexBufferLayout())/4,s=this._getType(e);if(s===S.Preinterleaved)return void console.error("Updating Preinterleaved geometry not supported");var o,d,l=this._getOriginData(s,a,n),h=l.instances[e.uniqueName],g=l.buffer.getArray(),f=l.vao;t||(C(e,k,Q),o=k,d=Q),r.fillInterleaved(e.data,o,d,e.instanceParameters,g,h.from*i),y.assert(h.from+r.getOutputAmount(E(e.data))/i===h.to,"material VBO layout has changed"),f.vertexBuffers.geometry.setSubData(g,h.from*i*4,h.from*i*4,h.to*i*4)},e.prototype._updateInstanceTransformation=function(e){var t=this._getType(e),r=e.material.id,a=e.origin.id;if(t===S.Preinterleaved){var n=this._getOriginData(t,r,a),i=n.instances[e.uniqueName].instance;C(e,i.transformation,i.transformationNormal)}else{var n=this._getOriginData(t,r,a),i=n.instances[e.uniqueName],s=n.perGeometryDataInfo[e.data.id],o=s.instanceBufferData;if(C(e,i.transformation,i.transformationNormal),o){var d=o.getSlot(e.idx);o.fill(d,0,i.transformation),o.fill(d,16,i.transformationNormal);var l=o.getOffset(d),h=4*l,g=T.getStride(s.vao.layout.instance);s.vao.vertexBuffers.instance.setSubData(o.getArray(),h,h,h+g)}}},e.prototype._modifyMerged=function(e,t,r,a){var n=this._compMatToDelta(e,t,S.Merged),i=this._mat2DataMerged;for(var s in n){var o=n[s];for(var d in o){var l=o[d],h=l.optimalCount,g=l.sparseCount,f=l.material,u=f.getVertexBufferLayout(),p=T.getStride(u)/4,c=i[s];null==c&&(y.assert(h>0),c=this._initializeMatData(f),i[s]=c,this._orderedRendering&&this._insertIntoRenderOrder(c,f.renderPriority,"merged"));var m=c.origin2data.get(d);null==m&&(y.assert(h>0),m=this._createMergedData(u,h,l.origin),c.origin2data.set(d,m));if(0===h)m.vao.dispose(!0),m.vao=null,c.origin2data.delete(d),0===c.origin2data.size&&(r.push(s),delete i[s],this._orderedRendering&&this._removeFromRenderOrder(c,"merged"));else{var _=h<l.sparseCount/2,v=_?h:g,R=z,x=m.buffer.getSize(),b=m.buffer.getArray(),I=m.buffer.resize(v);_||I?this._rebuildMerged(m,l.toRemove,p,b,R):l.toRemove.length>0?(this._removeMergedByErasing(m,l.toRemove,p,R),l.toAdd.length>0&&(R.end=x)):(R.begin=x,R.end=x);var D=j;y.setMatrixTranslation3(D,-l.origin[0],-l.origin[1],-l.origin[2]),this._appendMerged(m,f,l.toAdd,p,D,R);var A=m.vao.vertexBuffers.geometry;if(A.byteSize!==m.buffer.getArray().buffer.byteLength)A.setData(m.buffer.getArray());else{var P=R.begin,O=R.end;if(P<O){var M=m.buffer.getArray(),C=4*P,H=4*O;A.setSubData(M,C,C,H)}}(R.updatedDisplayedIndexRange||m.displayedIndexRange)&&(a[this._modifiedMergedFacerangesKey(s,d)]=m)}}}},e.prototype._createMergedData=function(e,t,r){return{type:S.Merged,instances:{},vao:new P(this._rctx,n.Default3D,{geometry:e},{geometry:I.createVertex(this._rctx,35044)}),buffer:new s(t),optimalCount:0,origin:r}},e.prototype._rebuildMerged=function(e,t,r,a,n){for(var i=0;i<t.length;++i){var s=e.instances[t[i].uniqueName];e.optimalCount-=(s.to-s.from)*r,delete e.instances[t[i].uniqueName]}var o=0,d=e.buffer.getArray();n.begin=0,n.end=0;var l=-1,h=-1,g=0;for(var f in e.instances){var s=e.instances[f],u=s.from*r,p=s.to*r,c=p-u;l!==h&&h!==u?(d.set(a.subarray(l,h),g),g+=h-l,l=u):-1===l&&(l=u),h=p,s.from=o/r,o+=c,s.to=o/r}l!==h&&d.set(a.subarray(l,h),g),n.end=o},e.prototype._removeMergedByErasing=function(e,t,r,a){if(0!==t.length){a.begin=1/0,a.end=-1/0;for(var n=-1,i=-1,s=0,o=t;s<o.length;s++){var d=o[s],l=d.uniqueName,h=e.instances[l].from*r,g=e.instances[l].to*r;n!==i&&i!==h?(e.buffer.erase(n,i),n=h):-1===n&&(n=h),i=g,delete e.instances[l],e.optimalCount-=g-h,h<a.begin&&(a.begin=h),g>a.end&&(a.end=g)}n!==i&&e.buffer.erase(n,i)}},e.prototype._appendMerged=function(e,t,r,a,n,i){i.updatedDisplayedIndexRange=!1;for(var s=0,o=r;s<o.length;s++){var d=o[s],l=d.data;N.multiply(n,d.transformation,k),N.inverse(k,Q),N.transpose(Q);var h=i.end;t.fillInterleaved(l,k,Q,d.instanceParameters,e.buffer.getArray(),i.end);var g=t.getOutputAmount(E(l)),f=h+g;y.assert(null==e.instances[d.uniqueName]);var u=O(d),p=new F(d.name,h/a,f/a,u,void 0,void 0,d.idx);e.instances[d.uniqueName]=p,this._updateHighlightFaceranges(d,p),u&&(i.updatedDisplayedIndexRange=!0),e.optimalCount+=g,i.end+=g}},e.prototype._modifyInstanced=function(e,t,r){var a=this._rctx,i=S.Instanced,o=this._compMatToDelta(e,t,i),d=this._mat2DataInstanced;for(var l in o){var g=o[l];for(var f in g){var u=g[f];if(0!==u.optimalCount){var p=u.material,m=d[l];if(null==m){var _=p.renderPriority;m=this._initializeMatData(p),d[l]=m,this._orderedRendering&&this._insertIntoRenderOrder(m,_,"instanced")}var v=p.getVertexBufferLayout(),R=m[c.MATERIAL].instanced?p.getInstanceBufferLayout():void 0,x=R&&T.findAttribute(R,"instanceColor"),b=R&&T.findAttribute(R,"instanceFeatureAttribute"),D=T.getStride(v)/4,A=m.origin2data.get(f);null==A&&(A={type:i,instances:{},vao:new P(a,n.Default3D,{geometry:v},{geometry:I.createVertex(a,35044)}),buffer:new s(u.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:u.origin},m.origin2data.set(f,A));var M=A.buffer.getSize(),C=A.buffer.getArray(),H=u.optimalCount<u.sparseCount/2,w=A.buffer.resize(H?u.optimalCount:u.sparseCount)
;for(var V in u.perGeometryDelta){var L=A.perGeometryDataInfo[V];if(L&&L.instanceBufferData){var G=u.perGeometryDelta[V].removeCount;G>0&&L.instanceBufferData.prepareFree(G)}}var B=u.toRemove;if(H||w){for(var U=0;U<B.length;++U){var z=B[U];delete A.instances[z.uniqueName];var V=z.data.id,L=A.perGeometryDataInfo[V],q=L;0==--q.refCount&&null==u.dataId2refCount[V]?(A.optimalCount-=(q.to-q.from)*D,delete A.perGeometryDataInfo[V]):L.instanceBufferData&&L.instanceBufferData.free(z.idx)}M=0;var k=A.buffer.getArray(),Q={};for(var K in A.perGeometryDataInfo){var q=A.perGeometryDataInfo[K];y.assert(null==Q[q.from]),Q[q.from]=q}for(var W in Q){var q=Q[W],X=q.from*D,Y=q.to*D;k.set(C.subarray(X,Y),M),q.from=M/D,M+=Y-X,q.to=M/D}for(var J in A.instances){var Z=A.instances[J];Z.from=A.perGeometryDataInfo[Z.dataId].from,Z.to=A.perGeometryDataInfo[Z.dataId].to}}else for(var U=0;U<B.length;++U){var z=B[U];delete A.instances[z.uniqueName];var V=z.data.id,L=A.perGeometryDataInfo[V];if(0==--L.refCount&&null==u.dataId2refCount[V]){var X=L.from*D,Y=L.to*D;A.buffer.erase(X,Y),A.optimalCount-=Y-X,delete A.perGeometryDataInfo[V]}else L.instanceBufferData&&L.instanceBufferData.free(z.idx)}y.setMatrixTranslation3(j,-u.origin[0],-u.origin[1],-u.origin[2]);for(var V in u.perGeometryDelta){var L=A.perGeometryDataInfo[V];if(L&&L.instanceBufferData){var $=u.perGeometryDelta[V].addCount;$>0&&L.instanceBufferData.prepareAllocate($)}}for(var ee=u.toAdd,U=0;U<ee.length;++U){var z=ee[U],te=z.data,V=te.id,L=A.perGeometryDataInfo[V];if(null==L){p.fillInterleaved(te,void 0,void 0,void 0,A.buffer.getArray(),M);var re=p.getOutputAmount(E(te)),X=M/D;M+=re;var Y=M/D;if(A.optimalCount+=re,L={refCount:1,from:X,to:Y,vao:null,instanceBufferData:null},R){var ae=T.getStride(R)/4;L.vao=new P(a,n.Default3D,{geometry:v,instance:R},{geometry:A.vao.vertexBuffers.geometry,instance:I.createVertex(a,35044)}),L.instanceBufferData=new h(ae,u.perGeometryDelta[V].addCount)}A.perGeometryDataInfo[V]=L}else++L.refCount;y.assert(L.from*D<=A.buffer.getSize()&&L.to*D<=A.buffer.getSize());var ne=N.create();N.multiply(j,z.transformation,ne);var ie=O(z),Z=new F(z.name,L.from,L.to,ie,ne,z.instanceParameters,z.idx,V);A.instances[z.uniqueName]=Z,this._updateHighlightFaceranges(z,Z);var se=L.instanceBufferData;if(se){var oe=se.allocate(z.idx);se.fill(oe,0,Z.transformation),se.fill(oe,16,Z.transformationNormal),x&&se.fill(oe,x.offset/4,z.instanceParameters.color),b&&se.fill(oe,b.offset/4,z.instanceParameters.featureAttribute)}}y.assert(A.optimalCount===u.optimalCount);var de=new Float32Array(A.buffer.getArray().buffer,0,A.buffer.getSize());A.vao.vertexBuffers.geometry.setData(de);for(var V in A.perGeometryDataInfo){var le=A.perGeometryDataInfo[V];if(le.vao){var he=le.vao.vertexBuffers.instance;if(he){var ge=u.perGeometryDelta[V];if(ge.addCount+ge.removeCount>0){var fe=le.instanceBufferData.compact();he.setData(fe)}}}}}else{var ue=d[l];ue.origin2data.get(f).vao.dispose(!0),ue.origin2data.delete(f),0===ue.origin2data.size&&(r.push(l),delete d[l],this._orderedRendering&&this._removeFromRenderOrder(ue,"instanced"))}}}},e.prototype._modifyPreinterleaved=function(e,t,r){for(var a=this._rctx,i=S.Preinterleaved,s=this._mat2DataPreinterleaved,o=0,d=e;o<d.length;o++){var l=d[o],h=l.material,g=h.id,f=l.origin.id,u=l.origin.vec3,p=s[g];null==p&&(p=this._initializeMatData(h),s[g]=p);var c=p.origin2data.get(f);null==c&&(c={type:i,origin:u,count:0,instances:{}},p.origin2data.set(f,c)),y.setMatrixTranslation3(j,-u[0],-u[1],-u[2]);var m=N.create();N.multiply(j,l.transformation,m);var _=O(l),v=l.data;if(v.preinterleaved)if(null!=v.vertexData){var R=v.indexCount,x=v.id,b=new F(l.name,0,R,_,m,l.instanceParameters,l.idx,x),D=v.indexData?I.createIndex(a,35044,v.indexData):null,A=h.getVertexBufferLayout(),T=new P(a,n.Default3D,{geometry:A},{geometry:I.createVertex(a,35044)},D);T.vertexBuffers.geometry.setData(v.vertexData),v.vertexData=null,c.count+=1,c.instances[l.uniqueName]={instance:b,vao:T},this._updateHighlightFaceranges(l,b)}else y.assert(!1,"Trying to re-add preinterleaved geometry data which is no longer available.");else y.assert(!1,"Non-interleaved render geometry processed as pre-interleaved")}for(var M=0,C=t;M<C.length;M++){var l=C[M],u=l.origin,h=l.material,g=h.id,f=u.id,H=l.uniqueName,p=s[g],w=p.origin2data.get(f);w.instances[H].vao.dispose(),delete w.instances[H],w.count-=1,0===w.count&&p.origin2data.delete(f),0===p.origin2data.size&&(r.push(g),delete s[g])}},e.prototype._compMatToDelta=function(e,t,r){var a={};return this._updateMatToDelta(e,!0,r,a),this._updateMatToDelta(t,!1,r,a),a},e.prototype._updateMatToDelta=function(e,t,r,a){for(var n=r===S.Instanced,i=0,s=e;i<s.length;i++){var o=s[i],d=o.origin,l=o.material,h=l.id,g=n?this._mat2DataInstanced[h]:this._mat2DataMerged[h],f=g&&g.origin2data.get(d.id),u=a[h];null==u&&(u={},a[h]=u);var p=u[d.id];if(null==p){if(p={optimalCount:null==f?0:f.optimalCount,sparseCount:null==f?0:f.buffer.getSize(),material:l,toAdd:[],toRemove:[],perGeometryDelta:null,origin:d.vec3},n){var c={};if(void 0!==f)for(var m in f.perGeometryDataInfo)c[m]=f.perGeometryDataInfo[m].refCount;p.dataId2refCount=c,p.perGeometryDelta={}}u[d.id]=p}var _=l.getOutputAmount(E(o.data));if(n){var v=o.data.id,y=p.perGeometryDelta[v];y||(y={addCount:0,removeCount:0},p.perGeometryDelta[v]=y),t?(y.addCount++,null==p.dataId2refCount[v]&&(p.dataId2refCount[v]=0),1==++p.dataId2refCount[v]&&(p.optimalCount+=_,p.sparseCount+=_),p.toAdd.push(o)):(y.removeCount++,0==--p.dataId2refCount[v]&&(delete p.dataId2refCount[v],p.optimalCount-=_),p.toRemove.push(o))}else t?(p.optimalCount+=_,p.sparseCount+=_,p.toAdd.push(o)):(p.optimalCount-=_,p.toRemove.push(o))}},e.prototype._getType=function(e){if(e.data.preinterleaved)return S.Preinterleaved;var t=!1,r=E(e.data);return t=t||!1===e.material.canBeMerged,t=t||e.material.instanced,t=t||!0===e.material.renderOccluded,e.singleUse||(t=t||r>this._threshold),t?S.Instanced:S.Merged},e.prototype._getTargetMat2Data=function(e){switch(e){case S.Merged:return this._mat2DataMerged;case S.Instanced:return this._mat2DataInstanced;case S.Preinterleaved:return this._mat2DataPreinterleaved}},e.prototype._getOriginData=function(e,t,r){return this._getTargetMat2Data(e)[t].origin2data.get(r)},e.prototype._modifiedMergedFacerangesKey=function(e,t){return e+"_"+t},e.prototype._insertIntoRenderOrder=function(e,t,r){for(var a=e[c.MATERIAL].materialId,n=this._renderOrder.length,i=0;i<n&&this._renderOrder[i][0]>=t;){var s=this._renderOrder[i][1];if(s.id===a)return y.assert(!s[r],"matData for type already exists"),void(s[r]=e);i++}var o={id:a,instanced:null,merged:null};o[r]=e,this._renderOrder.splice(i,0,[t,o])},e.prototype._removeFromRenderOrder=function(e,t){for(var r=e[c.MATERIAL].materialId,a=0;this._renderOrder[a][1].id!==r;)a++;var n=this._renderOrder[a][1];n[t]=null,n.instanced||n.merged||this._renderOrder.splice(a,1)},e.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(e,t){var r=e.matData[c.MATERIAL].renderPriority,a=t.matData[c.MATERIAL].renderPriority;return r>a?-1:a>r?1:0})},e.prototype._updateRenderOrder=function(e,t){for(var r=t.length,a=0;a<r&&t[a][1].id!==e;)a++;if(a<r){var n=t[a][1],i=n.merged||n.instanced,s=i[c.MATERIAL].renderPriority,o=t[a][0];if(s!==t[a][0]){t[a][0]=s;var d=s>o?-1:1;for(a+=d;a>-1&&a<r&&d*t[a][0]>d*s;){var l=t[a];t[a]=t[a-d],t[a-d]=l,a+=d}}}},e.prototype._modifyMaterials=function(e){var t=this;e.forEach(function(e){t._materialRep.updateMaterialParameters(e)})},e.prototype.modifyRenderOrder=function(e){var t=this;this._orderedRendering&&(e.forEach(function(e){t._updateRenderOrder(e,t._renderOrder)}),this._sortHighlightsByRenderOrder(),this._needsRender=!0)},e.prototype._initializeMatData=function(e){var t={origin2data:new Map};return t[c.MATERIAL]=this._materialRep.aquire(e),t[c.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(e),t[c.MATERIAL_NORMAL]=this._materialRep.aquireNormal(e),t[c.MATERIAL_DEPTH]=this._materialRep.aquireDepth(e),t[c.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(e),t},e.prototype._releaseMaterials=function(e){if(Array.isArray(e))for(var t=e,r=0;r<t.length;r++)this._materialRep.release(t[r]),this._materialRep.releaseDepthShadowMap(t[r]),this._materialRep.releaseNormal(t[r]),this._materialRep.releaseDepth(t[r]),this._materialRep.releaseHighlight(t[r]);else this._materialRep.release(e),this._materialRep.releaseDepthShadowMap(e),this._materialRep.releaseNormal(e),this._materialRep.releaseDepth(e),this._materialRep.releaseHighlight(e)},e.prototype._getInstance=function(e){var t=e.material,r=e.uniqueName,a=t.id,n=this._getType(e),i=this._getTargetMat2Data(n),s=e.origin.id,o=i[a];if(!o)return null;var d=o.origin2data.get(s);if(!d)return null;var l;return l=d.type===S.Preinterleaved?d.instances[r].instance:d.instances[r],l?{type:n,uniqueName:r,instance:l,matData:o,originData:d,instancedVAO:null,instancedVAOBaseInstance:null}:null},e.prototype._createBaseInstanceVAO=function(e){var t=this._rctx,r=e.instance,a=e.originData;if(e.type===S.Instanced&&a.perGeometryDataInfo){var n=a.perGeometryDataInfo[r.dataId],i=n.instanceBufferData;if(i){var s=n.vao,o=i.getSlot(r.idx);if(e.instancedVAOBaseInstance!==o){var d=T.setBaseInstanceOffset(s.layout,o);e.instancedVAO=new P(t,s.locations,d,s.vertexBuffers,s.indexBuffer),e.instancedVAOBaseInstance=o}}}},e.prototype._updateHighlightVAOs=function(){for(var e=0;e<this._highlights.length;++e){var t=this._highlights[e];this._createBaseInstanceVAO(t)}},e.prototype._getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new A(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255]))),this._fallbackDepthStencilTexture},e}(),U=function(){function e(){this.reset()}return e.prototype.reset=function(){this.trianglesRendered=0,this.drawCallsInstanced=0,this.drawCallsAngleInstanced=0,this.drawCallsMerged=0,this.drawCallsPreinterleaved=0,this.drawCallsFragmented=0,this.drawCallsHighlight=0,this.instancesDrawnAngle=0,this.VBOallocatedSize=0,this.VBOoptimalSize=0,this.VBOusedSize=0},e}(),F=function(){function e(e,t,r,a,n,i,s,o){this.name=e,this.from=t,this.to=r,this.displayedIndexRange=a,this.transformation=n,this.instanceParameters=i,this.idx=s,this.dataId=o,null!=n&&(this.transformationNormal=N.create(),N.set(n,this.transformationNormal),N.inverse(this.transformationNormal,this.transformationNormal),N.transpose(this.transformationNormal,this.transformationNormal))}return e}();!function(e){e[e.Merged=0]="Merged",e[e.Instanced=1]="Instanced",e[e.Preinterleaved=2]="Preinterleaved"}(S||(S={}));var z={updatedDisplayedIndexRange:!1,begin:0,end:0},q=V.create(),j=N.identity(),k=N.create(),Q=N.create();return B});