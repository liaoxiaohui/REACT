// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","dojo/has","./gl-matrix","./Object3D","./PerformanceTimer"],function(t,e,r,i,s,n){var o=i.vec3d.create(),a=i.vec3d.create(),h=r("dojo-debug-messages"),l=function(){function t(t,e,r,s,o,a,l,m){void 0===m&&(m=!1),this.dir=i.vec3d.create(),this.normalDir=null,this.minResult=new u,this.maxResult=new u,this.transform=i.mat4d.create(),this._transformInverse=new c({value:this.transform},i.mat4d.inverse,i.mat4d.create),this._transformInverseTranspose=new c(this._transformInverse,i.mat4d.transpose,i.mat4d.create),this._transformTranspose=new c({value:this.transform},i.mat4d.transpose,i.mat4d.create),this._transformInverseRotation=new c({value:this.transform},i.mat4d.toInverseMat3,i.mat3d.create),this.enableHUDSelection=!0,this.enableTerrain=!0,this.enableInvisibleTerrain=!1,this.enableBackfacesTerrain=!0,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.viewingMode=t||"global",this.intersectObject=this.intersectObject.bind(this),h&&(this.timer=new n(1)),this.init(e,r,s,o,a,l,m)}return t.prototype.init=function(t,e,r,s,n,o,a){if(e&&r&&i.vec3d.subtract(r,e,this.dir),this.minResult.init(e,r),this.maxResult.init(e,r),this.numObjectsTested=0,this.point=s,this.camera=n,this.isSelection=a,this.layers=t,this.p0=e,this.p1=r,this.hudResults=[],null==o&&(o=1e-5),this.tolerance=o,this.layers){h&&this.timer.start();for(var l=0;l<this.layers.length;++l){var u=this.layers[l],c=u.getSpatialQueryAccelerator?u.getSpatialQueryAccelerator():void 0;if(c)c.forEachAlongRay(this.p0,this.dir,this.intersectObject),a&&c.forEachDegenerateObject(this.intersectObject);else for(var m=u.getObjects(),p=0;p<m.length;++p)this.intersectObject(m[p])}h&&(this.timer.stop(),this.performanceInfo.queryDuration=this.timer.getLast(),this.performanceInfo.numObjectsTested=this.numObjectsTested)}},Object.defineProperty(t.prototype,"transformInverse",{get:function(){return this._transformInverse.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformInverseTranspose",{get:function(){return this._transformInverseTranspose.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformInverseRotation",{get:function(){return this._transformInverseRotation.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformTranspose",{get:function(){return this._transformTranspose.value},enumerable:!0,configurable:!0}),t.prototype.getDirection=function(){return this.normalDir||(this.normalDir=i.vec3d.create(),i.vec3d.normalize(this.dir,this.normalDir)),this.normalDir},t.prototype.intersectObject=function(t){var e=this;this.numObjectsTested++;for(var r,s=t.id,n=t.getGeometryRecords(),h=t.objectTransformation,l=0;l<n.length;l++){var c=n[l],m=c.geometry,p=c.materials,d=c.instanceParameters;d.hidden||(r=m.id,i.mat4d.set(h,this.transform),i.mat4d.multiply(this.transform,c.getShaderTransformation()),this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate(),i.mat4d.multiplyVec3(this.transformInverse,this.p0,o),i.mat4d.multiplyVec3(this.transformInverse,this.p1,a),p[0].intersect(m,d,this.transform,this,o,a,function(i,n,o,a,h,l){if(i>=0)if(h){var c=new u;c.init(e.p0,e.p1),c.set(t,s,i,n,a,l,r,o),e.hudResults.push(c)}else(null==e.minResult.priority||a>=e.minResult.priority)&&(null==e.minResult.dist||i<e.minResult.dist)&&e.minResult.set(t,s,i,n,a,null,r,o),(null==e.maxResult.priority||a>=e.maxResult.priority)&&(null==e.maxResult.dist||i>e.maxResult.dist)&&e.maxResult.set(t,s,i,n,a,null,r,o)},c.customTransformation))}},t.prototype.getMinResult=function(){return this.minResult},t.prototype.getMaxResult=function(){return this.maxResult},t.prototype.getHudResults=function(){return this.hudResults},t.DEFAULT_TOLERANCE=1e-5,t}(),u=function(){function t(t,e){this.normal=i.vec3d.create(),this.init(t,e)}return t.prototype.getIntersectionPoint=function(t){return null!=this.dist&&(i.vec3d.lerp(this.p0,this.p1,this.dist,t),!0)},t.prototype.set=function(t,e,r,n,o,a,h,l){t instanceof s&&(t={type:"stage",obj:t}),this.dist=r,i.vec3d.set(n,this.normal),this.target=t,this.name=e,this.priority=o,this.center=a?i.vec3d.create(a):null,this.geometryId=h,this.triangleNr=l},t.prototype.copyFrom=function(t){this.p0=t.p0,this.p1=t.p1,this.dist=t.dist,this.target=t.target,this.name=t.name,this.priority=t.priority,this.center=t.center?i.vec3d.create(t.center):null,this.geometryId=t.geometryId,this.triangleNr=t.triangleNr,this.intersector=t.intersector,i.vec3d.set(t.normal,this.normal)},t.prototype.setIntersector=function(t){this.intersector=t},t.prototype.init=function(t,e){this.dist=void 0,this.target=void 0,this.name=void 0,this.priority=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",this.p0=t,this.p1=e},t}(),c=function(){function t(t,e,r){this.original=t,this.update=e,this.dirty=!0,this.transform=r()}return t.prototype.invalidate=function(){this.dirty=!0},Object.defineProperty(t.prototype,"value",{get:function(){return this.dirty&&(this.update(this.original.value,this.transform),this.dirty=!1),this.transform},enumerable:!0,configurable:!0}),t}();return l});