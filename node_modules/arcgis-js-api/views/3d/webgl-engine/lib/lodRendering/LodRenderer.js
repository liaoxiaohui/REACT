// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../geometry/support/aaBoundingBox","../Camera","../DefaultVertexAttributeLocations","../gl-matrix","../RenderSlot","./InstanceData","./InstanceOctree","./LevelSelector","./RenderInstanceData","./utils","../../materials/DefaultMaterial","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],function(e,t,n,a,r,i,s,o,c,l,d,u,h,p,f,g,v){function m(e,t,n,a){h.encodeDoubleVec3(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,a),e.model.getMat(t,C),n.model.setMat(a,C),e.modelNormal.getMat(t,C),n.modelNormal.setMat(a,C),e.color&&n.color&&(e.color.getVec(t,D),n.color.setVec(a,D)),e.featureAttribute&&n.featureAttribute&&(e.featureAttribute.getVec(t,D),n.featureAttribute.setVec(a,D))}Object.defineProperty(t,"__esModule",{value:!0});var y=g.assert,b=function(){function e(e,t){this.glMaterials={};var n=e.rctx,a=t.geometry,r=t.material,s=a.data.toRenderData();this.materialRep=e.materialRep,r.setParameterValues({instancedDoublePrecision:!0});var o=r.getVertexBufferLayout(),c=o[0].stride/4,l=s.indices.position.length,d=new Float32Array(l*c);r.fillInterleaved(s,void 0,void 0,void 0,d,0),this.geometry=a,this.material=r,this.glMaterials=h.acquireGLMaterials(r,this.materialRep),this.vertexBufferLayout=o,this.vbo=f.createVertex(n,35044,d),this.vao=new v(n,i.Default3D,{geometry:o},{geometry:this.vbo}),this.vertexCount=l}return e.prototype.destroy=function(){h.releaseGLMaterials(this.material,this.materialRep),this.vbo.dispose(),this.vao.dispose()},Object.defineProperty(e.prototype,"boundingInfo",{get:function(){return this.geometry.getBoundingInfo()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"triangleCount",{get:function(){return this.vertexCount/3},enumerable:!0,configurable:!0}),e.prototype.intersect=function(e,t,n,a,r){var i=this.geometry.id,s=a.toString();this.material.intersect(this.geometry,null,E,e,t,n,function(t,n,o,c,l,d){if(t>=0){var u={type:"external",metadata:r(a)};(null==e.minResult.priority||c>=e.minResult.priority)&&(null==e.minResult.dist||t<e.minResult.dist)&&(e.minResult.set(u,s,t,n,c,null,i,o),e.minResult.setIntersector("LodRenderer")),(null==e.maxResult.priority||c>=e.maxResult.priority)&&(null==e.maxResult.dist||t>e.maxResult.dist)&&(e.maxResult.set(u,s,t,n,c,null,i,o),e.minResult.setIntersector("LodRenderer"))}},null)},e}();t.LodComponentData=b;var _=function(){function e(e,t){var n=this;this.components=[],this.minScreenSpaceRadius=t.minScreenSpaceRadius,t.components.forEach(function(t){n.components.push(new b(e,t))})}return e.prototype.destroy=function(){this.components.forEach(function(e){e.destroy()})},e.prototype.intersect=function(e,t,n,a,r){this.components.forEach(function(i){i.intersect(e,t,n,a,r)})},Object.defineProperty(e.prototype,"boundingBox",{get:function(){if(!this._boundingBox){var e=a.empty();this.components.forEach(function(t){a.expand(e,t.boundingInfo.bbMin),a.expand(e,t.boundingInfo.bbMax)}),this._boundingBox=e}return this._boundingBox},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"boundingSphere",{get:function(){if(!this._boundingSphere){var e=this.boundingBox,t=s.vec3d.create();a.center(e,t),this._boundingSphere={center:t,radius:.5*a.diameter(e)}}return this._boundingSphere},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"triangleCount",{get:function(){return this.components.reduce(function(e,t){return e+t.triangleCount},0)},enumerable:!0,configurable:!0}),e}();t.LodLevelData=_;var I=function(){function e(e,n,a){var i=this;this._levels=[],this._renderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._lastCamera=new r,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.didRender=!1,this._symbol=e,this._optionalFields=n,this._instanceToMetadata=a,this._instanceBufferLayout=p.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:n}),this._instanceData=new c.InstanceData(this._optionalFields),this._instanceData.on("instance-added",function(e){i.resetUpdateCycle()}),this._instanceData.on("instance-removed",function(e){i.resetUpdateCycle()}),this._instanceData.on("instance-transform-changed",function(e){i.resetUpdateCycle()}),this._instanceData.on("instance-visibility-changed",function(e){i.resetUpdateCycle(),i.requestFullCycle()}),this._instanceData.on("instance-highlight-changed",function(e){i.resetUpdateCycle(),i.requestFullCycle()}),t.lodRenderers.push(this),window.lodRenderer=this}return e.prototype.destroy=function(){t.lodRenderers.splice(t.lodRenderers.indexOf(this),1)},Object.defineProperty(e.prototype,"baseBoundingBox",{get:function(){return this._levels[0].boundingBox},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"baseBoundingSphere",{get:function(){return this._levels[0].boundingSphere},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instanceData",{get:function(){return this._instanceData},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"memoryUsage",{get:function(){var e={cpu:0,gpu:0};return this._renderInstanceData.forEach(function(t){var n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu}),this._highlightRenderInstanceData.forEach(function(t){var n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu}),e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderStats",{get:function(){var e=this,t=this._instanceData.size,n=[];return this._levels.forEach(function(t,a){var r=e._renderInstanceData[a],i=e._highlightRenderInstanceData[a],s=r.size+i.size,o=t.triangleCount;n.push({renderedInstances:s,renderedTriangles:s*o,trianglesPerInstance:o})}),{totalInstances:t,renderedInstances:n.reduce(function(e,t){return e+t.renderedInstances},0),renderedTriangles:n.reduce(function(e,t){return e+t.renderedTriangles},0),levels:n}},enumerable:!0,configurable:!0}),e.prototype.initializeRenderContext=function(e){var t=this,n=e.rctx;this._symbol.levels.forEach(function(a){t._levels.push(new _(e,a)),t._renderInstanceData.push(new u.RenderInstanceData(n,t._optionalFields,t._instanceBufferLayout)),t._highlightRenderInstanceData.push(new u.RenderInstanceData(n,t._optionalFields,t._instanceBufferLayout))});var a=this._levels[0].boundingSphere.radius,r=this._levels.map(function(e){return e.minScreenSpaceRadius});this._levelSelector=new d.LevelSelector(a,r),this._octree=new l.InstanceOctree(this._instanceData,this._levels[0].boundingSphere)},e.prototype.uninitializeRenderContext=function(e){this._levels.forEach(function(e){e.destroy()}),this._renderInstanceData.forEach(function(e){e.destroy()}),this._highlightRenderInstanceData.forEach(function(e){e.destroy()})},Object.defineProperty(e.prototype,"slots",{get:function(){return[o.OPAQUE_EXTERNAL,o.TRANSPARENT_EXTERNAL]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needsHighlight",{get:function(){return this._highlightRenderInstanceData.reduce(function(e,t){return e+t.size},0)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needsRender",{get:function(){return this._updateCyclesWithStaticCamera<1},enumerable:!0,configurable:!0}),e.prototype.resetNeedsRender=function(){this.didRender&&(this.didRender=!1)},e.prototype.prepareRender=function(e){var t=e.equivalent(this._lastCamera);this._lastCamera.copyFrom(e),t||this.resetUpdateCycle();var n=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(e,n)},e.prototype.render=function(e){var t=e.rctx,n=e.slot===o.OPAQUE_EXTERNAL?o.OPAQUE_MATERIAL:e.slot===o.TRANSPARENT_EXTERNAL?o.TRANSPARENT_MATERIAL:null;if(n){var a={view:e.camera.viewMatrix,proj:e.camera.projectionMatrix,origin:[0,0,0],viewInvTransp:e.camera.viewInverseTransposeMatrix,lightingData:e.lightingData,viewport:e.camera.viewport,fovY:e.camera.fovY,nearFar:[e.camera.near,e.camera.far],framebufferTex:e.offscreenRenderingHelper?e.offscreenRenderingHelper.colorTexture:null,shadowMap:e.shadowMap,shadowMappingEnabled:!!e.shadowMap&&e.shadowMap.enabled,ssaoEnabled:!!e.ssaoHelper&&e.ssaoHelper.enabled,pixelRatio:e.pixelRatio,cameraAboveGround:e.camera.aboveGround,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null};if(t.bindVAO(),e.isHighlightPass)for(var r=0;r<this._levels.length;++r)this.renderLevel(e,n,a,this._highlightRenderInstanceData[r],this._levels[r]);else for(var r=0;r<this._levels.length;++r)this.renderLevel(e,n,a,this._renderInstanceData[r],this._levels[r]);return!0}},e.prototype.intersect=function(e,t,n,a){var r=this,i=s.vec3d.create();s.vec3d.subtract(n,t,i),this._octree.forEachAlongRay(t,i,function(a){r._instanceData.getTranslation(a,R),r._instanceData.getModel(a,C),s.vec3d.subtract(t,R,x),s.vec3d.subtract(n,R,S),s.mat3d.inverse(C,C),s.mat3d.multiplyVec3(C,x),s.mat3d.multiplyVec3(C,S);var i=r._instanceData.getState(a),o=r._instanceData.getLodLevel(a);y(i&c.StateFlags.ACTIVE,"invalid instance state"),y(o>=0&&o<r._levels.length,"invaid lod level"),r._levels[o].intersect(e,x,S,a,r._instanceToMetadata)})},e.prototype.queryDepthRange=function(e){return this.queryDepthRangeOctree(e)},e.prototype.queryDepthRangeOctree=function(e){var t=e.eye,n=e.viewForward,a=this._octree.findClosest(n,"front-to-back",e.frustumPlanes),r=this._octree.findClosest(n,"back-to-front",e.frustumPlanes);if(null!=a&&null!=r){this._instanceData.view.boundingSphere.getVec(a,D),s.vec3d.subtract(D,t);var i=s.vec3d.dot(D,n)-D[3];this._instanceData.view.boundingSphere.getVec(r,D),s.vec3d.subtract(D,t);var o=s.vec3d.dot(D,n)+D[3];return{near:Math.max(e.near,i),far:Math.min(e.far,o)}}return{near:1/0,far:-1/0}},e.prototype.updateInstances=function(e,t){var n=this._levelSelector;n.updateCamera(e),this._renderInstanceData.forEach(function(e){e.beginUpdate()}),this._highlightRenderInstanceData.forEach(function(e){e.beginUpdate()});var a=this._instanceData,r=this._instanceData.view,i=a.size,s=a.capacity,o=this._instanceIndex;t=Math.min(i,t);for(var l=0;l<t;++l){0===o&&this.startUpdateCycle();var d=r.state.get(o),u=0;if(d&c.StateFlags.ALLOCATED){var h=r.lodLevel.get(o);if(d&c.StateFlags.ACTIVE&&this._renderInstanceData[h].freeTail(),d&c.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[h].freeTail(),d&c.StateFlags.REMOVE)a.notifyRemoved(o);else if(d&c.StateFlags.VISIBLE){r.modelOrigin.getVec(o,R);var p=n.selectLevel(R,r.modelScaleFactor.get(o));if(u=d&~(c.StateFlags.ACTIVE|c.StateFlags.HIGHLIGHT_ACTIVE|c.StateFlags.TRANSFORM_CHANGED),p>=0){var f=this._renderInstanceData[p],g=f.allocateHead();if(m(r,o,f.view,g),u|=c.StateFlags.ACTIVE,d&c.StateFlags.HIGHLIGHT){var v=this._highlightRenderInstanceData[p],y=v.allocateHead();m(r,o,v.view,y),u|=c.StateFlags.HIGHLIGHT_ACTIVE}}r.state.set(o,u),r.lodLevel.set(o,p)}else u=d&~(c.StateFlags.ACTIVE|c.StateFlags.HIGHLIGHT_ACTIVE|c.StateFlags.TRANSFORM_CHANGED),r.state.set(o,u);var b=!!(d&c.StateFlags.ACTIVE),_=!!(u&c.StateFlags.ACTIVE);!b&&_?this._octree.addInstance(o):b&&!_?this._octree.removeInstance(o):b&&_&&d&c.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(o),this._octree.addInstance(o)),o=(o+1)%s}else o=(o+1)%s,t++}this._instanceIndex=o,this._renderInstanceData.forEach(function(e){e.endUpdate()}),this._highlightRenderInstanceData.forEach(function(e){e.endUpdate()})},e.prototype.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++,this._renderInstanceData.forEach(function(e){e.startUpdateCylce()}),this._highlightRenderInstanceData.forEach(function(e){e.startUpdateCylce()})},e.prototype.resetUpdateCycle=function(){this._updateCyclesWithStaticCamera=-1},e.prototype.requestFullCycle=function(){this._needFullCycle=!0},e.prototype.renderLevel=function(e,t,n,a,r){var i=this;r.components.forEach(function(r){i.renderComponent(e,t,n,a,r)})},e.prototype.renderComponent=function(e,t,n,a,r){var s=r.glMaterials[e.pass];if(s&&s.beginSlot(t)&&s.isVisible&&0!==a.size){var c=e.rctx,l=c.capabilities.instancing,d=s.getDrawMode(c);n.origin=[0,0,0],t===o.STENCIL_MATERIAL&&(e.stencilRenderingHelper.enabled=!0,e.stencilRenderingHelper.prepareStencilWritePass()),s.bind(c,n),c.bindVAO(r.vao);var u=s.getProgram();if(g.assertCompatibleVertexAttributeLocations(r.vao,u),e.isHighlightPass){var h=e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null;c.bindTexture(h,5),u.setUniform1i("depthTex",5),u.setUniform4f("highlightViewportPixelSz",0,0,1/n.viewport[2],1/n.viewport[3])}s.bindView(c,n);var p=a.capacity,f=a.headIndex,v=a.tailIndex,m=a.firstIndex,b=this._instanceBufferLayout,_=function(e,t){g.bindVertexBufferLayout(c,i.Default3D,a.buffer,b,e),l.drawArraysInstanced(d,0,r.vertexCount,t-e),g.unbindVertexBufferLayout(c,i.Default3D,a.buffer,b)};r.material.getParams().transparent&&null!=m?f>v?(y(m>=v&&m<=f,"invalid firstIndex"),_(m,f),_(v,m)):f<v&&(m<=f?(y(m>=0&&m<=f,"invalid firstIndex"),_(m,f),_(v,p),_(0,m)):(y(m>=v&&m<=p,"invalid firstIndex"),_(m,p),_(0,f),_(v,m))):f>v?_(v,f):f<v&&(_(0,f),_(v,p)),c.bindVAO(null),s.release(c,n)}},e}();t.LodRenderer=I,t.lodRenderers=[];var R=s.vec3d.create(),D=s.vec4d.create(),C=s.mat3d.create(),x=s.vec3d.create(),S=s.vec3d.create(),E=s.mat4d.identity()});