// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/arrayUtils","./ModelContentType","./Texture","./Util","../../../webgl/Texture"],function(e,t,s,i,r,n,o){var a=512;return function(){function e(e,t){this.dirty=!1,this.elementsToAdd={},this.elementsToRemove={},this.elementsToRender={},this.elements={},this.stageObjects={},this.id=r.idGen.gen(e),this.stage=t._stage,this.controller=t.resourceController,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(i.TEXTURE,this);var s=this.computeAtlasResolution(t.width,t.height);this.createAtlasRegion(s),this.update2DCanvasSize()}return e.prototype.setUnloadFunc=function(e){this.unloadFunc=e},e.prototype.unload=function(){null!=this.unloadFunc&&(this.unloadFunc(this.id),this.unloadFunc=null)},e.prototype.deferredLoading=function(){return!1},e.prototype.getWidth=function(){return this.atlas.size.width},e.prototype.getHeight=function(){return this.atlas.size.height},e.prototype.initializeThroughRender=function(e,t){return t.wrapMode=33071,t.samplingMode=9987,t.flipped=!0,t.preMultiplyAlpha=!0,t.hasMipmap=!0,this.glTexture=new o(e,t,this.canvas),this.glTexture},e.prototype.dispose=function(){this.elements=null,this.elementsToAdd=null,this.elementsToRemove=null,this.elementsToRender=null,this.glTexture&&(this.glTexture=null,this.stage.remove(i.TEXTURE,this.id))},e.prototype.create2DCanvas=function(){var e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",a.toString()),e.setAttribute("height",a.toString()),e},e.prototype.update2DCanvasSize=function(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())},e.prototype.generateTextId=function(e){return JSON.stringify(e.getParams())+"_"+e.getText()},e.prototype.createAtlasRegion=function(e){void 0===e&&(e=a),this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}},e.prototype.computeAtlasResolution=function(e,t){var s=Math.max(e,t);return s+=256,s=n.nextHighestPowerOfTwo(s),s=Math.min(s,4096)},e.prototype.resizeAtlas=function(e,t){t=t||e;var s=this.atlas;s.size.width=e,s.size.height=t,this.glTexture&&this.glTexture.resize(e,t),this.update2DCanvasSize()},e.prototype.resetAtlasCursor=function(){var e=this.atlas;e.cursor.x=0,e.cursor.y=0,e.lineHeight=0},e.prototype.getAtlasUsage=function(){var e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)},e.prototype.getExpectedAtlasUsage=function(){var e=Object.keys(this.elementsToRemove).length,t=Object.keys(this.elementsToAdd).length,s=Object.keys(this.elements).length;return this.getAtlasUsage()/s*(s+t-e)},e.prototype.addAtlasElement=function(e,t,s,i,r){var n=this.atlas;e.placement.offset.x=n.cursor.x,e.placement.offset.y=n.cursor.y,e.placement.size.width=t,e.placement.size.height=s,e.placement.uvMinMax=[e.placement.offset.x/n.size.width,1-(e.placement.offset.y+s)/n.size.height,(e.placement.offset.x+t)/n.size.width,1-e.placement.offset.y/n.size.height],n.cursor.x+=i,n.lineHeight=Math.max(n.lineHeight,r)},e.prototype.removeAtlasElement=function(e){if(e&&this.elements[e.textId]){var t=e.placement.offset,s=e.placement.size;this.ctx.clearRect(t.x,t.y,s.width,s.height),delete this.elements[e.textId]}},e.prototype.addStageObject=function(e,t){this.stageObjects[e]||(this.stageObjects[e]=[]),-1===this.stageObjects[e].indexOf(t)&&this.stageObjects[e].push(t)},e.prototype.removeStageObject=function(e,t){this.stageObjects[e]&&s.removeUnordered(this.stageObjects[e],t)&&(t.geometries[0].data.vertexAttributes.size.data=new Float32Array([0,0]),t.geometryVertexAttrsUpdated(0))},e.prototype.processAdditionRequest=function(e){var t=this.atlas,s=e.textId,i=e.textTexture.renderedWidth,r=e.textTexture.renderedHeight,n=i+2,o=r+2+2;if(t.cursor.x+n<t.size.width&&t.cursor.y+o<t.size.height)this.addAtlasElement(e,i,r,n,o),this.elements[s]=e,this.elementsToRender[s]=e,delete this.elementsToAdd[s];else if(t.cursor.y+o+t.lineHeight<t.size.height)t.cursor.x=2,t.cursor.y+=t.lineHeight,t.lineHeight=0,this.addAtlasElement(e,i,r,n,o),this.elements[s]=e,this.elementsToRender[s]=e,delete this.elementsToAdd[s];else{var a=this.getExpectedAtlasUsage();a>.85&&t.size.width<4096&&this.resizeAtlas(2*t.size.width,2*t.size.height);for(var h in this.elementsToRemove)0===this.stageObjects[h].length&&this.removeAtlasElement(this.elementsToRemove[h]),delete this.elementsToRemove[h];if(a>.95&&4096===t.size.width)return;for(var l in this.elements){var d=this.elements[l];d.rendered=!1,this.elementsToAdd[l]=d,delete this.elements[l]}this.resetAtlasCursor(),this.elementsToRender={}}},e.prototype.processRenderingRequest=function(e){var t=e.textId;this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textTexture.renderText(e.placement.size.width,e.placement.size.height,this.ctx,e.placement.offset.x,e.placement.offset.y);for(var s=0,i=this.stageObjects[t];s<i.length;s++){var r=i[s];r.geometries[0].data.vertexAttributes.uv0.data=new Float32Array(e.placement.uvMinMax),r.geometries[0].data.vertexAttributes.size.data=new Float32Array([e.placement.size.width,e.placement.size.height]),r.geometryVertexAttrsUpdated(0)}e.rendered=!0},e.prototype.run=function(e){if(this.dirty){for(var t in this.elementsToAdd)if(this.elements[t]&&this.elements[t].rendered){for(var s=0,i=this.stageObjects[t];s<i.length;s++){var r=i[s],n=r.geometries[0].data.vertexAttributes;n.uv0.data=new Float32Array(this.elements[t].placement.uvMinMax),n.size.data=new Float32Array([this.elements[t].placement.size.width,this.elements[t].placement.size.height]),r.geometryVertexAttrsUpdated(0)}delete this.elementsToAdd[t]}else this.processAdditionRequest(this.elementsToAdd[t]);var o=!1;for(var t in this.elementsToRender){if(!e.remaining())return void(o&&this.glTexture.setData(this.canvas));this.processRenderingRequest(this.elementsToRender[t]),delete this.elementsToRender[t],o=!0}o&&this.glTexture.setData(this.canvas),this.dirty=!1,this.frameWorker.remove(),this.frameWorker=null}},e.prototype.addTextTexture=function(e,t){var s=this.generateTextId(e);this.elementsToAdd[s]||(this.elementsToAdd[s]={textId:s,placement:{offset:{x:0,y:0},size:{width:0,height:0},uvMinMax:[]},textTexture:e,rendered:!1}),this.addStageObject(s,t),delete this.elementsToRemove[s],this.setDirty()},e.prototype.removeTextTexture=function(e,t){var s=this.generateTextId(e);this.elementsToRemove[s]=this.elements[s],this.removeStageObject(s,t),delete this.elementsToAdd[s]},Object.defineProperty(e.prototype,"textureId",{get:function(){return this.id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isDirty",{get:function(){return this.dirty},enumerable:!0,configurable:!0}),e.prototype.setDirty=function(){var e=this;this.dirty||(this.dirty=!0,this.frameWorker=this.controller.registerFrameWorker(function(t){return e.run(t)}))},e}()});