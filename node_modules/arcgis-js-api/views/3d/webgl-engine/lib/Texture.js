// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/Logger","../../../3d/support/imageUtils","./DDSUtil","./DefaultVertexBufferLayouts","./gl-matrix","./glUtil3D","./IdGen","./Util","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],function(e,t,i,a,r,n,s,p,h,o,d,m,l){function u(e,t,i,r,n,s,p){p=!1!==p,a.requestImage(t).then(function(t){if(o.assert(t.width>=1&&t.height>=1),i.samplingMode=p?9987:9729,i.hasMipmap=p,!(p||33071!==i.wrapMode)||o.isPowerOfTwo(t.width)&&o.isPowerOfTwo(t.height)){i.width=t.width,i.height=t.height;var a=new m(e,i,t);e.bindTexture(a),s(a)}else{var a=f(e,t,i,r,n);e.bindTexture(a),s(a)}}).catch(function(e){var i=t.length>200?t.slice(0,100)+"..."+t.slice(t.length-100):t;g.error("Failed to load image from uri",i,e),s(null)})}function f(e,t,i,a,r){var s=o.nextHighestPowerOfTwo(t.width),h=o.nextHighestPowerOfTwo(t.height);o.assert(s!==t.width||h!==t.height),i.width=s,i.height=h;var u=new m(e,i),f=d.createWithAttachments(e,u,{colorTarget:0,depthStencilTarget:0}),g=new m(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!!i.flipped,maxAnisotropy:8,preMultiplyAlpha:i.preMultiplyAlpha},t);if(e.bindFramebuffer(f),void 0===r){var c=e.getViewport();r=[c.x,c.y,c.width,c.height]}e.setViewport(0,0,s,h);var x=a.get("texOnly"),T=w.identity();e.bindProgram(x),x.setUniformMatrix4fv("model",T),x.setUniformMatrix4fv("view",T),x.setUniformMatrix4fv("proj",T),x.setUniform4f("color",1,1,1,1),x.setUniform1i("tex",0);var v=p.createQuadVAO(e,n.Pos3Tex);return e.bindTexture(g,0),e.bindVAO(v),e.setDepthTestEnabled(!1),e.setBlendingEnabled(!1),e.drawArrays(5,0,l.vertexCount(v,"geometry")),e.setDepthTestEnabled(!0),e.bindFramebuffer(null),e.setViewport(r[0],r[1],r[2],r[3]),v.dispose(!0),g.dispose(),e.bindFramebuffer(null),f.detachColorTexture(),f.dispose(),i.hasMipmap&&u.generateMipmap(),u}var g=i.getLogger("esri.views.3d.webgl-engine.lib.Texture"),w=s.mat4d;return function(){function e(t,i,a){this.data=t,this.id=e.idGen.gen(i),this.unloadFunc=void 0,this.params=a||{},this.params.wrapClamp=this.params.wrapClamp||!1,this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.estimatedTexMemRequiredMB=e.estimateTexMemRequiredMB(this.data,this.params)}return e.estimateTexMemRequiredMB=function(e,t){return null==e?0:e instanceof ArrayBuffer||e instanceof Uint8Array?e.byteLength/1e6:e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement?(t.mipmap?4/3:1)*e.width*e.height*4/1e6:(t.mipmap?4/3:1)*t.width*t.height*4/1e6||0},e.prototype.getEstimatedTexMemRequiredMB=function(){return this.estimatedTexMemRequiredMB},e.prototype.dispose=function(){this.data=void 0},e.prototype.deferredLoading=function(){return"string"==typeof this.data},e.prototype.getWidth=function(){return this.params.width},e.prototype.getHeight=function(){return this.params.height},e.prototype.initializeThroughUpload=function(t,i,a,n,s){var p=this.data;if(i.flipped=!this.params.noUnpackFlip,i.samplingMode=this.params.mipmap?9987:9729,i.hasMipmap=this.params.mipmap,i.wrapMode=this.params.wrapClamp?33071:10497,i.preMultiplyAlpha=this.params.preMultiplyAlpha,"string"==typeof p)u(t,p,i,a,n,s,this.params.mipmap);else if(p instanceof Image||p instanceof ImageData||p instanceof HTMLCanvasElement){this.params.width=p.width,this.params.height=p.height;var h=this.params.mipmap||!this.params.wrapClamp;if(!h||o.isPowerOfTwo(p.width)&&o.isPowerOfTwo(p.height)){i.width=p.width,i.height=p.height;var d=new m(t,i,p);t.bindTexture(d),s(d)}else{var d=f(t,p,i,a,n);t.bindTexture(d),s(d)}}else if(p instanceof ArrayBuffer&&this.params.encoding===e.DDS_ENCODING){var d=r.createDDSTexture(t,i,p,this.params.mipmap);t.bindTexture(d),s(d)}else if(p instanceof Uint8Array&&this.params.encoding===e.DDS_ENCODING){var d=r.createDDSTexture(t,i,p.buffer,this.params.mipmap);t.bindTexture(d),s(d)}else if(p instanceof Uint8Array){o.assert(this.params.width>0&&this.params.height>0),i.pixelFormat=1===this.params.components?6409:6408,i.width=this.params.width,i.height=this.params.height;var d=new m(t,i,p);t.bindTexture(d),s(d)}else{if(null!==p)throw console.warn("Unsupported image data"),new Error("Unsupported image data");var d=new m(t,i,null);t.bindTexture(d),s(d)}this.data=void 0},e.prototype.setUnloadFunc=function(e){this.unloadFunc=e},e.prototype.unload=function(){void 0!==this.unloadFunc&&(this.unloadFunc(this.id),this.unloadFunc=void 0)},e.createEmpty=function(t){return void 0===t&&(t="emptyTexture"),new e(new Uint8Array([0,0,0,0]),t,{width:1,height:1,wrapClamp:!0})},e.idGen=new h,e.DDS_ENCODING="image/vnd-ms.dds",e}()});