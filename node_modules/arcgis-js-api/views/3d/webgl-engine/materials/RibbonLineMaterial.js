// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/text!./RibbonLineMaterial.xml","../../../../core/Logger","../../support/geometryUtils","../lib/ComponentUtils","../lib/DefaultVertexBufferLayouts","../lib/gl-matrix","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/ShaderVariations","../lib/Util","./internal/MaterialUtil","../../../webgl/Util"],function(e,t,r,i,n,a,o,s,p,l,c,d,f,m,u,g){var h=m.VertexAttrConstants,v="ribbon-line-material-shader-variations",y="ribbon-line-material-highlight-shader-variations",b=n.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial"),L=function(e){function t(t,r){var i=e.call(this,r)||this;return i.params=u.copyParameters(t,B),"miter"!==i.params.join&&(i.params.miterLimit=0),i.numVertsAtJoin="wall"===i.params.type?2:4,i.numVertsAtCap=2,i.canBeMerged="screen"===i.params.type&&null==i.params.stippleLength,i}return r(t,e),t.prototype.setColor=function(e){this.params.color=e,this.notifyDirty("matChanged")},t.prototype.getColor=function(){return this.params.color},t.prototype.dispose=function(){},t.prototype.getParams=function(){return this.params},t.prototype.getParameterValues=function(){var e=this.params;return{color:e.color,width:e.width,type:e.type,join:e.join,polygonOffset:e.polygonOffset,miterLimit:e.miterLimit,stippleLength:e.stippleLength}},t.prototype.setParameterValues=function(e){for(var t in e)m.assert("type"!==t,"RibbonLineMaterial: type cannot be changed after creation"),m.assert("stippleLength"!==t||null!=e[t]==(null!=this.params[t]),"RibbonLineMaterial: stippleLength on/off cannot be changed after creation"),this.params[t]=e[t];"miter"!==this.params.join&&(this.params.miterLimit=0),this.notifyDirty("matChanged")},t.prototype.getOutputAmount=function(e){var t=e/2+1,r=(t-2)*this.numVertsAtJoin+2*this.numVertsAtCap;return this.canBeMerged&&(r+=2),r*g.getStride(F)/4},t.prototype.getInstanceBufferLayout=function(){},t.prototype.getVertexBufferLayout=function(){return"wall"===this.params.type?z:F},t.prototype.fillInterleaved=function(e,t,r,i,n,a){var o=e.vertexAttr[h.POSITION].data,s=e.vertexAttr[h.COLOR]?e.vertexAttr[h.COLOR].data:A,p=e.vertexAttr[h.SIZE]?e.vertexAttr[h.SIZE].data:w,l=e.indices&&e.indices[h.POSITION];l&&l.length!==2*(o.length/3-1)&&console.warn("RibbonLineMaterial does not support indices"),"wall"===this.params.type?this.fillWithoutAuxpos(o,t,n,a):this.fillWithAuxpos(o,s,p,t,n,a)},t.prototype.intersect=function(e,t,r,i,n,s,l,c){if(i.isSelection&&!o.isAllHidden(t.componentVisibilities,e.data.componentOffsets)){if(!m.isTranslationMatrix(r))return void b.error("intersection assumes a translation-only matrix");var d=e.getData(),f=d.getVertexAttr()[h.POSITION].data,u=d.getVertexAttr()[h.SIZE],g=u&&u.data[0],v=i.camera,y=i.point,L=g+this.params.width,P=L/2+4;p.vec3d.set3(y[0]-P,y[1]+P,0,C[0]),p.vec3d.set3(y[0]+P,y[1]+P,0,C[1]),p.vec3d.set3(y[0]+P,y[1]-P,0,C[2]),p.vec3d.set3(y[0]-P,y[1]-P,0,C[3]);for(var S=0;S<4;S++)v.unprojectPoint(C[S],T[S]);a.plane.fromPoints(v.eye,T[0],T[1],j),a.plane.fromPoints(v.eye,T[1],T[2],N),a.plane.fromPoints(v.eye,T[2],T[3],W),a.plane.fromPoints(v.eye,T[3],T[0],_);for(var A=Number.MAX_VALUE,S=0;S<f.length-5;S+=3)if(x[0]=f[S]+r[12],x[1]=f[S+1]+r[13],x[2]=f[S+2]+r[14],O[0]=f[S+3]+r[12],O[1]=f[S+4]+r[13],O[2]=f[S+5]+r[14],!(a.plane.distance(j,x)<0&&a.plane.distance(j,O)<0||a.plane.distance(N,x)<0&&a.plane.distance(N,O)<0||a.plane.distance(W,x)<0&&a.plane.distance(W,O)<0||a.plane.distance(_,x)<0&&a.plane.distance(_,O)<0)){if(v.projectPoint(x,R),v.projectPoint(O,I),R[2]<0&&I[2]>0){p.vec3d.subtract(x,O,E);var w=v.frustumPlanes,B=-a.plane.distance(w[4],x),z=B/p.vec3d.dot(E,w[4]);p.vec3d.scale(E,z,E),p.vec3d.add(x,E,x),v.projectPoint(x,R)}else if(R[2]>0&&I[2]<0){p.vec3d.subtract(O,x,E);var w=v.frustumPlanes,B=-a.plane.distance(w[4],O),z=B/p.vec3d.dot(E,w[4]);p.vec3d.scale(E,z,E),p.vec3d.add(O,E,O),v.projectPoint(O,I)}else if(R[2]<0&&I[2]<0)continue;var F=m.pointLineSegmentDistanceSquared2D(R,I,y);F<A&&(A=F,p.vec3d.set(x,U),p.vec3d.set(O,V))}var H=i.p0,q=i.p1;if(A<P*P){var G=m.lineLineDistanceSquared3D(U,V,H,q,D),Z=Number.MAX_VALUE;if(G.success){p.vec3d.subtract(G.pa,H,M);var J=p.vec3d.length(M);p.vec3d.scale(M,1/J),Z=J/p.vec3d.dist(H,q)}l(Z,M)}}},t.prototype.getGLMaterials=function(){return{color:P,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:S}},t.prototype.getAllTextureIds=function(){return[]},t.prototype.fillWithAuxpos=function(e,t,r,i,n,a){var o=e.length/3,s=e[0],p=e[1],l=e[2],c=0,d=a,f=g.getStride(this.getVertexBufferLayout())/4;this.canBeMerged&&(a+=f),i&&(s=i[0]*s+i[4]*p+i[8]*l+i[12],p=i[1]*s+i[5]*p+i[9]*l+i[13],l=i[2]*s+i[6]*p+i[10]*l+i[14]);var m=s,u=p,h=l,v=e[3],y=e[4],b=e[5];i&&(v=i[0]*v+i[4]*y+i[8]*b+i[12],y=i[1]*v+i[5]*y+i[9]*b+i[13],b=i[2]*v+i[6]*y+i[10]*b+i[14]);for(var L=0;L<o;L++){var P=3*L;L<o-1&&(v=e[P+3],y=e[P+4],b=e[P+5],i&&(v=i[0]*v+i[4]*y+i[8]*b+i[12],y=i[1]*v+i[5]*y+i[9]*b+i[13],b=i[2]*v+i[6]*y+i[10]*b+i[14])),c+=Math.sqrt((m-s)*(m-s)+(u-p)*(u-p)+(h-l)*(h-l)),n[a++]=m,n[a++]=u,n[a++]=h,n[a++]=c,n[a++]=0===L?-1.2:-1,n[a++]=s,n[a++]=p,n[a++]=l,n[a++]=v,n[a++]=y,n[a++]=b,n[a++]=t[0],n[a++]=t[1],n[a++]=t[2],n[a++]=t[3],n[a++]=r[0],n[a++]=m,n[a++]=u,n[a++]=h,n[a++]=c,n[a++]=0===L?1.2:1,n[a++]=s,n[a++]=p,n[a++]=l,n[a++]=v,n[a++]=y,n[a++]=b,n[a++]=t[0],n[a++]=t[1],n[a++]=t[2],n[a++]=t[3],n[a++]=r[0],L>0&&L<o-1&&(n[a++]=m,n[a++]=u,n[a++]=h,n[a++]=c,n[a++]=-1.2,n[a++]=s,n[a++]=p,n[a++]=l,n[a++]=v,n[a++]=y,n[a++]=b,n[a++]=t[0],n[a++]=t[1],n[a++]=t[2],n[a++]=t[3],n[a++]=r[0],n[a++]=m,n[a++]=u,n[a++]=h,n[a++]=c,n[a++]=1.2,n[a++]=s,n[a++]=p,n[a++]=l,n[a++]=v,n[a++]=y,n[a++]=b,n[a++]=t[0],n[a++]=t[1],n[a++]=t[2],n[a++]=t[3],n[a++]=r[0]),s=m,p=u,l=h,m=v,u=y,h=b}if(this.canBeMerged){for(var L=d;L<d+f;L++)n[L]=n[L+f];for(var S=a-f,L=0;L<f;L++)n[a++]=n[S++]}},t.prototype.fillWithoutAuxpos=function(e,t,r,i){for(var n,a,o,s=e.length/3,p=0,l=e[0],c=e[1],d=e[2],f=0;f<s;f++){var m=3*f;n=l,a=c,o=d,l=e[m],c=e[m+1],d=e[m+2],t&&(l=t[0]*l+t[4]*c+t[8]*d+t[12],c=t[1]*l+t[5]*c+t[9]*d+t[13],d=t[2]*l+t[6]*c+t[10]*d+t[14]),p+=Math.sqrt((l-n)*(l-n)+(c-a)*(c-a)+(d-o)*(d-o)),r[i++]=l,r[i++]=c,r[i++]=d,r[i++]=p,r[i++]=-1,r[i++]=l,r[i++]=c,r[i++]=d,r[i++]=p,r[i++]=1}},t.loadShaders=function(e,t,r){e._parse(i);var n=function(e){e.addDefine("Screen","SCREENSCALE"),e.addDefine("Strip","STRIP"),e.addDefine("Wall","WALL"),e.addDefine("Stipple","STIPPLE")},a=new f("ribbon-line",["vsRibbonLine","fsRibbonLine"],null,t,e,r);n(a),t.addShaderVariations(v,a);var o=new f("ribbon-line",["vsRibbonLine","fsRibbonLineHighlight"],null,t,e,r);n(o),t.addShaderVariations(y,o)},t}(c),P=function(e){function t(t,r){var i=e.call(this,t,r)||this;return i.params=u.copyParameters(t.getParams()),delete i.params.join,i.program=r.getShaderVariationsProgram(v,["screen"===i.params.type,"strip"===i.params.type,"wall"===i.params.type,null!=i.params.stippleLength]),i}return r(t,e),t.prototype.updateParameters=function(){var e=this.material.getParams(),t=this.params;t.polygonOffset=e.polygonOffset,t.color=e.color,t.width=e.width,t.miterLimit="miter"===e.join?e.miterLimit:0,t.stippleLength=e.stippleLength},t.prototype.beginSlot=function(e){return e===d.TRANSPARENT_MATERIAL},t.prototype.getProgram=function(){return this.program},t.prototype.bind=function(e,t){var r=this,i=r.program,n=r.params;if(e.bindProgram(i),i.setUniform4fv("eColor",n.color),i.setUniform1f("miterLimit",n.miterLimit),i.setUniform1f("nearPlane",t.nearFar[0]),"screen"===n.type?(i.setUniform2fv("screenSize",[t.viewport[2],t.viewport[3]]),i.setUniform1f("extLineWidth",n.width*t.pixelRatio)):i.setUniform1f("extLineWidth",n.width),null!=n.stippleLength){var a=n.stippleLength?1/(2*n.stippleLength):0;i.setUniform1f("stippleLengthDoubleInv",a)}n.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(0,-4)),e.setFaceCullingEnabled(!1),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(e.gl.SRC_ALPHA,e.gl.ONE_MINUS_SRC_ALPHA,e.gl.ONE,e.gl.ONE_MINUS_SRC_ALPHA),e.setDepthTestEnabled(!0),e.setDepthWriteEnabled(n.color[3]>=1)},t.prototype.release=function(e){this.params.polygonOffset&&e.setPolygonOffsetFillEnabled(!1),e.setBlendingEnabled(!1),e.setDepthWriteEnabled(!0)},t.prototype.bindView=function(e,t){u.bindView(t.origin,t.view,this.program)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(e){return e.gl.TRIANGLE_STRIP},t}(l),S=function(e){function t(t,r){var i=e.call(this,t,r)||this;return i.params=u.copyParameters(t.getParams()),delete i.params.join,i.program=r.getShaderVariationsProgram(y,["screen"===i.params.type,"strip"===i.params.type,"wall"===i.params.type,null!=i.params.stippleLength]),i}return r(t,e),t.prototype.updateParameters=function(){var e=this.material.getParams(),t=this.params;t.polygonOffset=e.polygonOffset,t.color=e.color,t.width=e.width,t.miterLimit="miter"===e.join?e.miterLimit:0,t.stippleLength=e.stippleLength},t.prototype.beginSlot=function(e){return e===d.OPAQUE_MATERIAL},t.prototype.getProgram=function(){return this.program},t.prototype.bind=function(e,t){var r=this,i=r.program,n=r.params;if(e.bindProgram(i),i.setUniform4fv("eColor",n.color),i.setUniform1f("miterLimit",n.miterLimit),i.setUniform1f("nearPlane",t.nearFar[0]),"screen"===n.type?(i.setUniform2fv("screenSize",[t.viewport[2],t.viewport[3]]),i.setUniform1f("extLineWidth",n.width*t.pixelRatio)):i.setUniform1f("extLineWidth",n.width),null!=n.stippleLength){var a=n.stippleLength?1/(2*n.stippleLength):0;i.setUniform1f("stippleLengthDoubleInv",a)}n.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(0,-4)),e.setFaceCullingEnabled(!1),e.setDepthTestEnabled(!0),e.setDepthWriteEnabled(n.color[3]>=1)},t.prototype.release=function(e){this.params.polygonOffset&&e.setPolygonOffsetFillEnabled(!1),e.setDepthWriteEnabled(!0)},t.prototype.bindView=function(e,t){u.bindView(t.origin,t.view,this.program)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(e){return e.gl.TRIANGLE_STRIP},t}(l),A=[255,255,255,255],w=[0,0,0,0],x=p.vec3d.create(),O=p.vec3d.create(),E=p.vec3d.create(),M=p.vec3d.create(),R=p.vec3d.create(),I=p.vec3d.create(),U=p.vec3d.create(),V=p.vec3d.create(),D={success:!1,dist2:0,pa:p.vec3d.create(),pb:p.vec3d.create()},C=[p.vec3d.create(),p.vec3d.create(),p.vec3d.create(),p.vec3d.create()],T=[p.vec3d.create(),p.vec3d.create(),p.vec3d.create(),p.vec3d.create()],j=a.plane.create(),N=a.plane.create(),W=a.plane.create(),_=a.plane.create(),B={color:[1,1,1,1],width:0,type:"screen",join:"miter",miterLimit:5,polygonOffset:!1,stippleLength:null},z=s.Pos3Tex,F=[{name:"position",count:3,type:5126,offset:0,stride:64,normalized:!1},{name:"uv0",count:2,type:5126,offset:12,stride:64,normalized:!1},{name:"auxpos1",count:3,type:5126,offset:20,stride:64,normalized:!1},{name:"auxpos2",count:3,type:5126,offset:32,stride:64,normalized:!1},{name:"color",count:4,type:5126,offset:44,stride:64,normalized:!1},{name:"size",count:1,type:5126,offset:60,stride:64,normalized:!1}];return L});