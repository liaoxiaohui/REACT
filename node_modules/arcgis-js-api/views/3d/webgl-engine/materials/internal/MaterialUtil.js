// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../../geometry/support/aaBoundingBox","../../lib/ComponentUtils","../../lib/doublePrecisionUtils","../../lib/gl-matrix","../../lib/screenSizePerspectiveUtils","../../lib/Util","../../../../webgl/Util"],function(e,r,t,n,i,a,o,f,c){function l(e,r,t,n,i){var a=e[r],o=e[r+1],f=e[r+2];t[n]=i[0]*a+i[4]*o+i[8]*f+i[12],t[n+1]=i[1]*a+i[5]*o+i[9]*f+i[13],t[n+2]=i[2]*a+i[6]*o+i[10]*f+i[14]}function s(e,r,t,n,i,a){if(void 0===i||3!==a)for(var o=0;o<a;++o)t[n+o]=e[r+o];else l(e,r,t,n,i);return a}function v(e,r,t,n,i){for(var a=0;a<i;++a)t[n+a]=e[r+a];return i}function u(e,r,t,n,i,a){for(var o=e.length,f=0;f<o;++f){var c=3*e[f],l=r[c],s=r[c+1],v=r[c+2];n[i]=t[0]*l+t[4]*s+t[8]*v+t[12],n[i+1]=t[1]*l+t[5]*s+t[9]*v+t[13],n[i+2]=t[2]*l+t[6]*s+t[10]*v+t[14],i+=a}}function d(e,r,t,n,i,a){for(var o=e.length,f=0;f<o;++f){for(var c=t*e[f],l=0;l<t;++l)n[i+l]=r[c+l];i+=a}}function m(e,r,t,n,i,a){var o=new Uint8Array(n);i*=4,a*=4;var f=e.length;if(4===t)for(var c=0;c<f;++c){var l=4*e[c];o[i]=r[l],o[i+1]=r[l+1],o[i+2]=r[l+2],o[i+3]=r[l+3],i+=a}else if(3===t)for(var c=0;c<f;++c){var l=3*e[c];o[i]=r[l],o[i+1]=r[l+1],o[i+2]=r[l+2],o[i+3]=255,i+=a}}function g(e,r,t,n,i,a,o){var f=new Uint8Array(i);a*=4,o*=4;var c=e.length;if(4===n)for(var l=0;l<c;++l){var s=4*e[l];f[a]=r[s]*t[0],f[a+1]=r[s+1]*t[1],f[a+2]=r[s+2]*t[2],f[a+3]=r[s+3]*t[3],a+=o}else if(3===n)for(var v=255*t[3],l=0;l<c;++l){var s=3*e[l];f[a]=r[s]*t[0],f[a+1]=r[s+1]*t[1],f[a+2]=r[s+2]*t[2],f[a+3]=v,a+=o}}function h(e,r,t,n,i,a){var o=new Uint16Array(n);i*=2,a*=2;for(var f=e.length,c=0;c<f;++c){for(var l=t*e[c],s=0;s<t;++s)o[i+s]=r[l+s];i+=a}}function p(e,r,t,n,i,a,o,f){for(var l=c.getStride(i)/4,s=0;s<i.length;s++){var v=i[s],p=o+v.offset/4,b=v.name,M=e.vertexAttr[b];if(null!=M&&(null==f||null!=f[b]))switch(b){case"uv0":d(e.indices[b],M.data,M.size,a,p,l);break;case"region":h(e.indices[b],M.data,M.size,a.buffer,p,l);break;case"color":n&&n.color?g(e.indices[b],M.data,n.color,M.size,a.buffer,p,l):m(e.indices[b],M.data,M.size,a.buffer,p,l);break;case"symbolColor":m(e.indices[b],M.data,M.size,a.buffer,p,l);break;default:var x=b===G.POSITION?r:b===G.NORMAL?t:void 0;void 0!==x&&3===M.size?u(e.indices[b],M.data,x,a,p,l):d(e.indices[b],M.data,M.size,a,p,l)}}}function b(e,r,t,n){for(var i=Math.floor(t/3),a=i-1;a>=0;a--){var o=r+3*a*n,f=r+3*a*2*n+5*n;s(e,o,e,f,null,n),f-=n,s(e,o+n,e,f,null,n),f-=n,s(e,o+n,e,f,null,n),f-=n,s(e,o+2*n,e,f,null,n),f-=n,s(e,o+2*n,e,f,null,n),f-=n,s(e,o,e,f,null,n)}}function M(e,r,t,i,a,o,c){f.assert("triangle"===e.data.primitiveType);var l=r&&r.componentVisibilities,s=i.tolerance;e.getComponentCount()>1?y(e,l,a,o,s,c):l&&!n.getVisibility(l,0)||x(e.getBoundingInfo(),a,o,s,c)}function x(e,r,n,i,a){var o=P(r,n,R);if(t.setMin(_,e.getBBMin()),t.setMax(_,e.getBBMax()),O(_,r,o,i)){var f=e.getPrimitiveIndices(),c=e.getIndices(),l=e.getPosition(),s=f?f.length:c.length/3;if(s>ee){var v=e.getChildren();if(void 0!==v){for(var u=0;u<8;++u)void 0!==v[u]&&x(v[u],r,n,i,a);return}}I(r,n,0,s,c,l,f,a)}}function y(e,r,i,a,o,f){var c=P(i,a,R),l=e.getBoundingInfo();if(t.setMin(_,l.getBBMin()),t.setMax(_,l.getBBMax()),O(_,i,c,o))for(var s=e.data,v=e.getComponentCount(),u=s.getIndices(G.POSITION),d=s.getAttribute(G.POSITION),m=s.componentOffsets,g=0;g<v;g++)if(!r||n.getVisibility(r,g)){var h=e.getComponentAABB(g,_);if(O(h,i,c,o)){var p=m[g]/3,b=m[g+1]/3;I(i,a,p,b,u,d,void 0,f)}}}function I(e,r,t,n,i,a,o,f){for(var c=a.data,l=a.offsetIdx,s=a.strideIdx,v=e[0],u=e[1],d=e[2],m=r[0],g=r[1],h=r[2],p=m-v,b=g-u,M=h-d,x=t;x<n;x++){var y=o?o[x]:x,I=l+s*i[3*y],P=l+s*i[3*y+1],O=l+s*i[3*y+2],U=c[I],A=c[I+1],B=c[I+2],w=c[P],z=c[P+1],S=c[P+2],T=c[O],W=c[O+1],C=c[O+2],V=w-U,D=z-A,N=S-B,k=T-U,q=W-A,E=C-B,Y=b*E-q*M,j=M*k-E*p,H=p*q-k*b,_=V*Y+D*j+N*H,G=v-U,R=u-A,K=d-B,Q=R*N-D*K,X=K*V-N*G,Z=G*D-V*R;if(_>F){var $=G*Y+R*j+K*H;if($<0||$>_)continue;var ee=p*Q+b*X+M*Z;if(ee<0||$+ee>_)continue}else{if(!(_<-F))continue;var $=G*Y+R*j+K*H;if($>0||$<_)continue;var ee=p*Q+b*X+M*Z;if(ee>0||$+ee<_)continue}var re=(k*Q+q*X+E*Z)/_;if(re>=0){f(re,L(V,D,N,k,q,E,J),y)}}}function L(e,r,t,n,i,o,f){return a.vec3d.set3(e,r,t,K),a.vec3d.set3(n,i,o,Q),a.vec3d.normalize(a.vec3d.cross(K,Q,f))}function P(e,r,t){return a.vec3d.set3(1/(r[0]-e[0]),1/(r[1]-e[1]),1/(r[2]-e[2]),t)}function O(e,r,t,n){var i=(e[0]-n-r[0])*t[0],a=(e[3]+n-r[0])*t[0],o=Math.min(i,a),f=Math.max(i,a),c=(e[1]-n-r[1])*t[1],l=(e[4]+n-r[1])*t[1];if(o=Math.max(o,Math.min(c,l)),f=Math.min(f,Math.max(c,l)),o>f)return!1;var s=(e[2]-n-r[2])*t[2],v=(e[5]+n-r[2])*t[2];return o=Math.max(o,Math.min(s,v)),f=Math.min(f,Math.max(s,v)),o<=f}function U(e,r,t){return a.vec4d.set4(e[0]-r[0],e[1]-r[1],e[2]-r[2],1,t)}function A(e,r,t,n){return a.mat4d.translate(t,r,H),t=H,a.mat4d.multiplyVec4(t,e,n)}function B(e,r,t,n){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3],a.mat4d.multiplyVec4(r,n)}function w(e,r){return a.vec4d.scale(e,1/Math.abs(e[3]),r)}function z(e,r,t,n,i){return o.scale(e,n,t,i)}function S(e,r,t,n,i){var a=t.screenLength||0;i&&(a=z(a,e,r,n,i));var o=a*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return f.clamp(o*r,t.minWorldLength||0,null!=t.maxWorldLength?t.maxWorldLength:1/0)}function T(e,r,t){if(void 0!==e)return r.aquire(e,t)}function W(e,r){void 0!==e&&r.release(e)}function C(e,r,t){a.mat4d.translate(r,e,X),t.setUniform3fv("localOrigin",e),t.setUniformMatrix4fv("view",X)}function V(e,r,t){t.setUniform3f("camPos",r[3]-e[0],r[7]-e[1],r[11]-e[2])}function D(e,r){i.encodeDoubleArraySplit(e,Z,$,3),r.setUniform3fv("viewOriginHi",Z),r.setUniform3fv("viewOriginLo",$)}function N(e,r,t){if(e){var n=k(e,r.fovY,r.viewport[3]);t.setUniform4f("verticalOffset",n.screenLength,n.perDistance,n.minWorldLength,n.maxWorldLength)}}function k(e,r,t,n){return void 0===n&&(n=re),n.screenLength=e.screenLength,n.perDistance=Math.tan(.5*r)/(.5*t),n.minWorldLength=e.minWorldLength,n.maxWorldLength=e.maxWorldLength,n}function q(e,r,t){if(void 0===t&&(t="screenSizePerspectiveAlignment"),e){var n=e.parameters,i=e.paddingPixelsOverride;r.setUniform4f(t,n.divisor,n.offset,n.minPixelSize,i)}}function E(e,r){var t=r?E(r):{};for(var n in e){var i=e[n];i&&i.forEach&&(i=j(i)),null==i&&n in t||(t[n]=i)}return t}function Y(e,r){var t=!1;for(var n in r){var i=r[n];void 0!==i&&(t=!0,Array.isArray(i)?e[n]=i.slice():e[n]=i)}return t}function j(e){var r=[];return e.forEach(function(e){return r.push(e)}),r}Object.defineProperty(r,"__esModule",{value:!0});var H=a.mat4d.create(),_=t.create(),G=f.VertexAttrConstants;r.IDENTITY=a.mat4d.identity(),r.fill=s,r.fillColor=v,r.fillInterleaved=p,r.triangleVertexArrayToWireframeLines=b,r.intersectTriangleGeometry=M;var R=a.vec3d.create(),F=Math.pow(2,-52),J=a.vec3d.create();r.intersectTriangles=I;var K=a.vec3d.create(),Q=a.vec3d.create();r.computeNormal=L,r.intersectAabbInvDir=O,r.transformToWorld=U,r.transformToView=A,r.transformToProjection=B,r.transformToNDC=w,r.applyScreenSizePerspectiveScale=z,r.verticalOffsetAtDistance=S,r.aquireIfNotUndefined=T,r.releaseIfNotUndefined=W;var X=a.mat4.create();r.bindView=C,r.bindCamPos=V;var Z=a.vec3d.create(),$=a.vec3d.create();r.bindViewOriginDouble=D,r.bindVerticalOffset=N,r.bindScreenSizePerspective=q,r.copyParameters=E,r.updateParameters=Y,r.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var ee=1e3,re={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});