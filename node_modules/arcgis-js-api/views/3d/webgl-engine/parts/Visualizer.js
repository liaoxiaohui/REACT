// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../../core/TimeProfiler","../../support/debugFlags","../lib/depthRange","../lib/depthRangeUtils","../lib/gl-matrix","../lib/HighlightHelper","../lib/OffscreenRenderingHelper","../lib/Renderer","../lib/RenderOccludedHelper","../lib/RenderPass","../lib/ShadowMap","../lib/SSAOHelper","../lib/Util"],function(e,r,s,t,a,i,n,o,d,h,p,l,u,_,c){var g=n.vec3d,R=n.mat4d,f=c.assert;return function(){function e(e,r,s,t,a){this._drawShadowMapDebugQuad=!1,this._drawSSAOMapDebugQuad=!1,this._needsRender=!0,this._content=new Map,this._stage=e,this._rctx=a,this._renderer=new h(r,s,t,this._rctx,!1),this._programRep=r,this._helpers={shadowMap:new u(r,this._rctx),ssao:new _(r,t,this._rctx,this.setNeedsRender.bind(this)),highlight:new o(r,t,this._rctx),renderOccluded:new p(r,t,this._rctx),offscreenRendering:new d(r,this._rctx)}}return Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return this._renderer.isLoadingResources},enumerable:!0,configurable:!0}),e.prototype.getCombinedStats=function(){return this._renderer.getCombinedStats()},e.prototype.dispose=function(){this._renderer.dispose(),this._helpers.shadowMap.enabled=!1,this._helpers.shadowMap.dispose(),this._helpers.ssao.enabled=!1,this._helpers.ssao.dispose(),this._helpers.highlight.enabled=!1,this._helpers.renderOccluded.enabled=!1,this._helpers.offscreenRendering.enabled=!1},e.prototype.setLighting=function(e){this._renderer.setLighting(e)},e.prototype.getViewParams=function(e){var r=e||{};return e&&!e.pixelRatio||(r.pixelRatio=this._renderer.getPixelRatio()),r},e.prototype.setViewParams=function(e){null!=e.pixelRatio&&this._renderer.setPixelRatio(e.pixelRatio)},e.prototype.setRenderParams=function(e){void 0!==e.shadowMapResolution&&!1===this._helpers.shadowMap.enabled&&(this._helpers.shadowMap.textureResolution=e.shadowMapResolution),void 0!==e.shadowMap&&(this._helpers.shadowMap.enabled=e.shadowMap),void 0!==e.shadowMapMaxCascades&&(this._helpers.shadowMap.maxCascades=e.shadowMapMaxCascades),this._helpers.highlight.enabled=!0,void 0!==e.ssao&&(this._helpers.ssao.enabled=e.ssao),void 0!==e.ssaoAttenuation&&(this._helpers.ssao.attenuation=e.ssaoAttenuation),void 0!==e.ssaoRadius&&(this._helpers.ssao.radius=e.ssaoRadius),void 0!==e.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter."),void 0!==e.ssaoSamples&&(this._helpers.ssao.samples=e.ssaoSamples),void 0!==e.drawShadowMapDebugQuad&&(this._drawShadowMapDebugQuad=e.drawShadowMapDebugQuad),void 0!==e.drawSSAODebugQuad&&(this._drawSSAOMapDebugQuad=e.drawSSAODebugQuad),this._renderer.ssaoEnabled=this._helpers.ssao.enabled,void 0!==e.offscreenRendering&&(this._helpers.offscreenRendering.enabled=e.offscreenRendering),e.background&&(this._helpers.offscreenRendering.background=e.background),void 0!==e.antialiasingEnabled&&(this._renderer.renderOptions.antialiasing=e.antialiasingEnabled?"smaa":"none"),void 0!==e.earlyOcclusionPixelDraw&&(this._renderer.renderOptions.earlyOcclusionPixelDraw=e.earlyOcclusionPixelDraw),void 0!==e.defaultHighlightOptions&&this._helpers.highlight.setDefaultOptions(e.defaultHighlightOptions),this._needsRender=!0},e.prototype.getRenderParams=function(){var e={};return this._helpers.shadowMap.isSupported&&(e.shadowMap=this._helpers.shadowMap.enabled,e.shadowMapResolution=this._helpers.shadowMap.textureResolution,e.shadowMapMaxCascades=this._helpers.shadowMap.maxCascades),this._helpers.ssao.isSupported&&(e.ssao=this._helpers.ssao.enabled,e.ssaoAttenuation=this._helpers.ssao.attenuation,e.ssaoRadius=this._helpers.ssao.radius,e.ssaoFilterRadius=this._helpers.ssao.filterRadius,e.ssaoSamples=this._helpers.ssao.samples),e},e.prototype.modify=function(e,r,s,t){this._renderer.modify(e,r,s,t);for(var a=0;a<r.length;++a)this._content.delete(r[a].uniqueName);for(var a=0;a<e.length;++a)this._content.set(e[a].uniqueName,e[a]);for(var a=0;a<s.length;++a)f(this._content.get(s[a].renderGeometry.uniqueName)===s[a].renderGeometry)},e.prototype.getContent=function(){return this._content},e.prototype.getPickRay=function(e,r,s,t,a,i){g.unproject(g.createFrom(e[0],e[1],0),t,s.projectionMatrix,s.fullViewport,a),g.unproject(g.createFrom(e[0],e[1],1),t,s.projectionMatrix,s.fullViewport,i)},e.prototype.getProjectionMatrix=function(e,r,s,t,a){var i=c.fovx2fovy(r,e[2],e[3]);R.perspective(180*i/Math.PI,e[2]/e[3],s,t,a)},e.prototype.addExternalRenderer=function(e,r){return this._renderer.addExternalRenderer(e,r)},e.prototype.removeExternalRenderer=function(e){return this._renderer.removeExternalRenderer(e)},e.prototype.getExternalRenderers=function(){return this._renderer.getExternalRenderers()},e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._renderer.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._renderer.needsRender()},e.prototype.setNeedsRender=function(){this._needsRender=!0},e.prototype.render=function(e,r,a){var i=e.viewport;if(this._renderer.prepareRender(e),this._helpers.shadowMap.enabled){t.ENABLE_PROFILE_DEPTH_RANGE&&s.begin("depthRange");var n=this.computeDepthRange(e);t.ENABLE_PROFILE_DEPTH_RANGE&&s.end("depthRange"),this._helpers.shadowMap.prepare(e,r,this._content,n);for(var o=this._helpers.shadowMap.getCascades(),d=0;d<o.length;++d){var h=o[d];h.camera.setGLViewport(this._rctx),this._renderer.renderGeometryPass(l.MATERIAL_DEPTH_SHADOWMAP,h.camera)}this._helpers.shadowMap.finish(a),e.setGLViewport(this._rctx)}if(this._helpers.shadowMap.bindAll(this._programRep),this._renderer.renderAuxiliaryBuffers(e,a,this._helpers),this._renderer.render(e,a,this._helpers),this._drawShadowMapDebugQuad&&this._helpers.shadowMap.enabled){var p=R.ortho(i[0],i[2],i[1],i[3],-1,1);this._helpers.shadowMap.drawDebugQuad(p)}if(this._drawSSAOMapDebugQuad&&this._helpers.ssao.enabled){var p=R.ortho(i[0],i[2],i[1],i[3],-1,1);this._helpers.ssao.drawQuad(p)}},e.prototype.getEdgeView=function(){return this._renderer.edgeView},e.prototype.computeDepthRange=function(e){var r=i.depthRangeFromScene(e,this._content,this._stage.getLayers());return a.union(r,this.getExternalRenderers().queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r},e}()});