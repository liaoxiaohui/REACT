// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["../core/promiseUtils","dojo/on","dojo/Deferred","../layers/graphics/dehydratedFeatures","../geometry/support/scaleUtils","../geometry/Extent","../tasks/support/Query","../layers/GroupLayer","../core/Accessor"],function(e,t,r,a,n,i,s,u,l){return l.createSubclass({declaredClass:"esri.views.PopupManager",properties:{map:{dependsOn:["view.map"],readOnly:!0}},constructor:function(){this._featureLayersCache={}},destroy:function(){this._featureLayersCache={},this.view=null},_clickHandle:null,_featureLayersCache:null,enabled:!1,_enabledSetter:function(e){this._clickHandle&&(e?this._clickHandle.resume():this._clickHandle.pause()),this._set("enabled",e)},_mapGetter:function(){return this.get("view.map")||null},view:null,_viewSetter:function(e){this._clickHandle&&(this._clickHandle.remove(),this._clickHandle=null),e&&(this._clickHandle=t.pausable(e,"click",this._clickHandler.bind(this)),this.enabled||this._clickHandle.pause()),this._set("view",e)},getMapLayer:function(e){var t;if(e&&(t=e.findLayerById())){var r=t.id;if(this._featureLayersCache[r]){var a=r.lastIndexOf("_");a>-1&&(r=r.substring(0,a),t=this.map.findLayerById(r))}}return t},_closePopup:function(){var e=this.get("view.popup");e&&(e.clear(),e.close())},_showPopup:function(t,l,o){function c(e){return d.allLayerViews.find(function(t){return t.layer===e})}function p(e){if(null==e)return!1;var t=c(e);return null!=t&&(e.loaded&&!t.suspended&&(e.popupEnabled&&e.popupTemplate||"graphics"===e.type||"geo-rss"===e.type||"map-notes"===e.type||"kml"===e.type||t.getPopupData))}function f(e){var t=c(e);return t&&t.hasDraped}var h=this.map,d=this.view,y=d.popup,v=this,m=[],g="3d"===d.type;if(h.layers.toArray().forEach(function(e){e.isInstanceOf(u)?e.layers.toArray().forEach(function(e){!p(e)||g&&!f(e)||m.push(e)}):!p(e)||g&&!f(e)||m.push(e)}),d.graphics.length>0&&m.push(d.graphics),(o&&d.graphics.includes(o)?!o.getEffectivePopupTemplate():o&&!p(o.layer))&&(o=null),!m.length&&!o)return void v._closePopup();var _=[],b=!!o,w=v._calculateClickTolerance(m);if(!l)return void v._closePopup();var x=1;"2d"===d.type&&(x=d.state.resolution);var P=d.basemapTerrain;P&&P.overlayManager&&(x=P.overlayManager.overlayPixelSizeInMapUnits(l));var M=w*x;P&&!P.spatialReference.equals(d.spatialReference)&&(M*=n.getMetersPerUnitForSR(P.spatialReference)/n.getMetersPerUnitForSR(d.spatialReference));var k=l.clone().offset(-M,-M),I=l.clone().offset(M,M),L=new i(Math.min(k.x,I.x),Math.min(k.y,I.y),Math.max(k.x,I.x),Math.max(k.y,I.y),d.spatialReference),F=function(t){var r;if("imagery"===t.type){var n=new s;n.geometry=l;var i=c(t),u={};u.rasterAttributeTableFieldPrefix="Raster.",u.returnDomainValues=!0,u.layerView=i,r=t.queryVisibleRasters(n,u).then(function(e){return b=b||e.length>0,e})}else if("scene"===t.type||!v._featureLayersCache[t.id]&&"function"!=typeof t.queryFeatures){if("map-image"===t.type||"wms"===t.type)return i=c(t),i.getPopupData(L);var p,f,h=[],d=!1;"esri.core.Collection<esri.Graphic>"===t.declaredClass?(p=t,f=!0):"graphics"===t.type?(p=t.graphics,f=!0):(i=c(t),p=i&&i.loadedGraphics,f=!1,d=!0),p&&(h=p.filter(function(e){return e&&(!f||e.getEffectivePopupTemplate())&&e.visible&&L.intersects(e.geometry)}).toArray(),d&&(h=h.map(function(e){return a.hydrateGraphic(e,t)}))),h.length>0&&(b=!0,r="scene"===t.type?v._fetchSceneAttributes(t,h):e.resolve(h))}else{var y=t.createQuery();y.geometry=L,r=t.queryFeatures(y).then(function(e){var r=e.features;if(o&&o.layer===t&&t.objectIdField){var a=t.objectIdField,n=o.attributes[a];r=r.filter(function(e){return e.attributes[a]!==n})}if(!o&&"graphics3DGraphics"in c(t)){var i=[],s=c(t).graphics3DGraphics;for(var u in s)i.push(s[u].graphic.attributes[t.objectIdField]);r=r.filter(function(e){return-1!==i.indexOf(e.attributes[t.objectIdField])})}return b=b||r.length>0,r})}return r};if(g&&!o||!g){_=m.map(F).filter(function(e){return!!e});var A=function(e){return e.reduce(function(e,t){return e.concat(t.items?A(t.items):t)},[])};_=A(_)}if(o)if(o.layer&&"scene"===o.layer.type)_.unshift(this._fetchSceneAttributes(o.layer,[o]));else if(o.getEffectivePopupTemplate()){var C=new r;_.unshift(C.resolve([o]))}if(!_.some(function(e){return!e.isFulfilled()})&&!b)return void v._closePopup();_.length&&y.open({promises:_,location:l})},_fetchSceneAttributes:function(t,r){return this.view.whenLayerView(t).then(function(a){var n=this._getOutFields(t.popupTemplate),i=r.map(function(e){return a.whenGraphicAttributes(e,n).catch(function(){return e})});return e.eachAlways(i)}.bind(this)).then(function(e){return e.map(function(e){return e.value})})},_getOutFields:function(e){var t=["*"];if("esri.PopupTemplate"===e.declaredClass){var r=null==e.content||Array.isArray(e.content)&&e.content.every(function(e){return"attachments"===e.type||"fields"===e.type&&null==e.fieldInfos||"text"===e.type&&-1===e.text.indexOf("{")});e.fieldInfos&&!e.expressionInfos&&r&&(t=[],e.fieldInfos.forEach(function(e){var r=e.fieldName&&e.fieldName.toLowerCase();r&&"shape"!==r&&0!==r.indexOf("relationships/")&&t.push(e.fieldName)}))}return t},_calculateClickTolerance:function(e){var t=6;return e.forEach(function(e){var r=e.renderer;if(r)if("simple"===r.type){var a=r.symbol;a&&a.xoffset&&(t=Math.max(t,Math.abs(a.xoffset))),a&&a.yoffset&&(t=Math.max(t,Math.abs(a.yoffset)))}else"unique-value"!==r.type&&"class-breaks"!==r.type||(r.uniqueValueInfos||r.classBreakInfos).forEach(function(e){var r=e.symbol;r&&r.xoffset&&(t=Math.max(t,Math.abs(r.xoffset))),r&&r.yoffset&&(t=Math.max(t,Math.abs(r.yoffset)))})}),t},_clickHandler:function(e){function t(e){return n.allLayerViews.find(function(t){return t.layer===e})}function r(e){if(null==e)return!1;var r=t(e);return null!=r&&(e.loaded&&!r.suspended&&(e.popupEnabled&&e.popupTemplate||"graphics"===e.type||r.getPopupData))}function a(e){var r=t(e);return r&&r.hasDraped}var n=this.view,i=n.popup,s=n.map,l=e.screenPoint,o=this;if(0===e.button&&i&&n.ready){var c="3d"===n.type,p=s.allLayers.some(function(e){return!e.isInstanceOf(u)&&!(!r(e)||c&&!a(e))});if(null!=l)return void this.view.hitTest(l.x,l.y).then(function(t){if(p||t.results.length>0)if(t.results.length>0){var r=t.results[0];o._showPopup(e,r.mapPoint,r.graphic)}else o._showPopup(e,e.mapPoint,null);else o._closePopup()});o._showPopup(e,e.mapPoint)}}})});