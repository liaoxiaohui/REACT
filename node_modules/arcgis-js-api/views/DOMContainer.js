// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/dom","dojo/dom-construct","dojo/on","../core/Accessor","../core/Evented","../core/Handles","../core/scheduling","../core/watchUtils","../core/accessorSupport/decorators","./PopupManager","./overlay/ViewOverlay","../widgets/Popup"],function(e,t,i,r,o,n,s,a,d,p,u,l,h,c,f,y){function v(e){var t=e.ownerDocument||window.document,i=t.defaultView,r=e.getBoundingClientRect();return _[0]=r.left+i.pageXOffset,_[1]=r.top+i.pageYOffset,_}var _=[0,0],m=16,g=750;return function(e){function t(){var t=e.call(this)||this;return t._domHandles=new p,t._freqInfo={freq:m,time:g},t._overlayRenderTaskHandle=null,t.height=0,t.popup=new y({view:t}),t.position=null,t.resizing=!1,t.root=null,t.surface=null,t.suspended=!0,t.ui=null,t.userContent=null,t.width=0,t.watch("cursor",function(e){var i=t.surface;i&&i.setAttribute("data-cursor",e)}),t.watch("interacting",function(e){var i=t.surface;i&&i.setAttribute("data-interacting",e.toString())}),t._focusEvent=t._focusEvent.bind(t),t._blurEvent=t._blurEvent.bind(t),t}return i(t,e),t.prototype.initialize=function(){this.watch("ui",this._handleUIChange),this._wireUI(this.ui)},t.prototype.destroy=function(){this.ui.destroy(),this.popup&&!this.popup.destroyed&&this.popup.destroy(),this.container=null,this._domHandles.destroy()},Object.defineProperty(t.prototype,"container",{set:function(e){var t=this,i=this._get("container");if(i!==e){if(this._domHandles.remove("dom-size"),this._stopMeasuring(),i){var r=this.surface;r&&(r.removeEventListener("focus",this._focusEvent),r.removeEventListener("blur",this._blurEvent)),i.classList.remove("esri-view"),this.popupManager.destroy(),this._set("popupManager",null),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay.destroy(),this._set("overlay",null),n.destroy(this.root),this._set("root",null),n.destroy(this.userContent),this._set("userContent",null)}if(e){e.classList.add("esri-view");var s=document.createElement("div");for(s.className="esri-view-user-storage";e.hasChildNodes();)s.appendChild(e.firstChild);e.appendChild(s);var a=document.createElement("div");a.className="esri-view-root",e.insertBefore(a,e.firstChild),this._set("root",a);var d=document.createElement("div");d.className="esri-view-surface",d.setAttribute("role","application"),d.tabIndex=0,d.addEventListener("focus",this._focusEvent),d.addEventListener("blur",this._blurEvent),o.setSelectable(d,!1),a.appendChild(d),this._set("surface",d);var p=new f;a.appendChild(p.surface),this._set("overlay",p),p.watch("needsRender",function(e){e&&!t._overlayRenderTaskHandle?t._overlayRenderTaskHandle=u.addFrameTask({render:function(){t.overlay.render()}}):t._overlayRenderTaskHandle&&(t._overlayRenderTaskHandle.remove(),t._overlayRenderTaskHandle=null)}),this._forceReadyCycle(),this._domHandles.add(l.init(this,"size",function(e){var t=e[0],i=e[1],r=t>=document.body.clientWidth||i>=document.body.clientHeight;d.classList.toggle("esri-view-surface--inset-outline",r)}),"dom-size"),this._set("container",e),this._startMeasuring();var h=new c({enabled:!0,view:this});this._set("popupManager",h)}else this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),this._set("container",null)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focused",{get:function(){return document.activeElement===this.surface},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return[this.width,this.height]},enumerable:!0,configurable:!0}),t.prototype.blur=function(){this.surface&&this.surface.blur()},t.prototype.focus=function(){this.surface&&this.surface.focus()},t.prototype.pageToContainer=function(e,t,i){var r=this.position;return e-=r[0],t-=r[1],i?(i[0]=e,i[1]=t):i=[e,t],i},t.prototype.containerToPage=function(e,t,i){var r=this.position;return e+=r[0],t+=r[1],i?(i[0]=e,i[1]=t):i=[e,t],i},t.prototype._handleUIChange=function(e,t){t&&(this._domHandles.remove("ui"),t.destroy()),e&&this._wireUI(e),this._set("ui",e)},t.prototype._wireUI=function(e){this._domHandles.remove("ui"),e&&(e.view=this,this._domHandles.add([l.init(this,"root",function(t){e.container=t?n.create("div",null,t):null}),l.init(this,"popup",function(t,i){i&&(e.remove(i,"popup"),i!==t&&i.destroy()),t&&(t.view=e.view,e.add(t,{key:"popup",position:"manual"}))})],"ui"))},t.prototype._focusEvent=function(e){this.notifyChange("focused"),this.emit("focus",{native:e})},t.prototype._blurEvent=function(e){this.notifyChange("focused"),this.emit("blur",{native:e})},t.prototype._stopMeasuring=function(){this._domHandles.remove("measuring"),this._get("resizing")&&this._set("resizing",!1)},t.prototype._startMeasuring=function(){var e=this,t=this._freqInfo;t.freq=m,t.time=g,this._domHandles.add([s(window,"resize",function(){t.freq=m,t.time=g}),u.addFrameTask({prepare:function(t){var i=e._measure(),r=e._freqInfo;if(r.time+=t.deltaTime,i&&(r.freq=m,e._get("resizing")||e._set("resizing",!0)),!(r.time<r.freq)){r.time=0;var o=e._position();r.freq=o||i?m:Math.min(g,2*r.freq),!i&&r.freq>=512&&e._get("resizing")&&e._set("resizing",!1)}}})],"measuring"),this._measure(),this._position()},t.prototype._measure=function(){var e=this.container,t=e?e.clientWidth:0,i=e?e.clientHeight:0;if(0===t||0===i||"hidden"===window.getComputedStyle(e).visibility)return this.suspended||this._set("suspended",!0),!1;var r=this.width,o=this.height;return t===r&&i===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",t),this._set("height",i),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:r,oldHeight:o,width:t,height:i}),!0)},t.prototype._position=function(){var e=this.container,t=this.position,i=v(e);return(!t||i[0]!==t[0]||i[1]!==t[1])&&(this._set("position",[i[0],i[1]]),!0)},r([h.property({value:null,cast:function(e){return o.byId(e)}})],t.prototype,"container",null),r([h.property({readOnly:!0,dependsOn:["surface"]})],t.prototype,"focused",null),r([h.property({readOnly:!0})],t.prototype,"height",void 0),r([h.property({type:y})],t.prototype,"popup",void 0),r([h.property({type:c})],t.prototype,"popupManager",void 0),r([h.property({type:f})],t.prototype,"overlay",void 0),r([h.property({readOnly:!0})],t.prototype,"position",void 0),r([h.property({readOnly:!0})],t.prototype,"resizing",void 0),r([h.property({readOnly:!0})],t.prototype,"root",void 0),r([h.property({value:null,dependsOn:["width","height"],readOnly:!0})],t.prototype,"size",null),r([h.property({readOnly:!0})],t.prototype,"surface",void 0),r([h.property({readOnly:!0})],t.prototype,"suspended",void 0),r([h.property()],t.prototype,"ui",void 0),r([h.property({readOnly:!0})],t.prototype,"userContent",void 0),r([h.property({readOnly:!0})],t.prototype,"width",void 0),t=r([h.subclass("esri.views.DOMContainer")],t)}(h.declared(a,d))});