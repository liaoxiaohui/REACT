// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

//  copyright

/**
             * The copyright text as defined by the map service.
             *
             * @name copyright
             * @instance
             * @type {string}
             */

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","../Graphic","../PopupTemplate","../renderers","../request","../symbols","../core/Collection","../core/Error","../core/Handles","../core/kebabDictionary","../core/lang","../core/Logger","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators","../geometry/Extent","../geometry/HeightModelInfo","../geometry/SpatialReference","../geometry/support/normalizeUtils","./Layer","./graphics/sources/MemorySource","./mixins/ArcGISService","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./support/arcgisLayerUrl","./support/commonProperties","./support/FeatureIndex","./support/FeatureProcessing","./support/FeatureReduction","./support/FeatureReductionSelection","./support/FeatureTemplate","./support/FeatureType","./support/Field","./support/fieldUtils","./support/LabelClass","./support/labelingInfo","./support/Relationship","../renderers/support/jsonUtils","../renderers/support/styleUtils","../renderers/support/typeUtils","../symbols/support/ElevationInfo","../symbols/support/jsonUtils","../tasks/support/FeatureSet","../tasks/support/Query"],function(e,t,r,i,o,n,s,a,p,l,u,d,y,c,f,h,m,v,g,b,F,I,w,S,D,O,T,x,j,M,R,q,E,_,A,P,C,L,U,Q,V,B,G,k,z,W,N,Z,H,J,$,K){function X(e){return e&&null!=e.applyEdits}function Y(e){return e&&e.isInstanceOf&&e.isInstanceOf(T)}function ee(e){return e&&e.isInstanceOf&&e.isInstanceOf(d)}function te(e,t,r){return!!(e&&e.hasOwnProperty(t)?e[t]:r)}var re=f({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),ie="FeatureLayer",oe=m.getLogger("esri.layers.FeatureLayer");return function(t){function f(e){var r=t.call(this)||this;return r._handles=new c,r.featureReduction=null,r.copyright=null,r.displayField=null,r.definitionExpression=null,r.dynamicDataSource=null,r.editFieldsInfo=null,r.elevationInfo=null,r.fields=null,r.fullExtent=null,r.gdbVersion=null,r.geometryType=null,r.hasM=!1,r.hasZ=!1,r.heightModelInfo=null,r.historicMoment=null,r.isTable=!1,r.labelsVisible=!0,r.labelingInfo=null,r.layerId=void 0,r.legendEnabled=!0,r.maxRecordCount=void 0,r.tileMaxRecordCount=void 0,r.minScale=0,r.maxScale=0,r.objectIdField=null,r.operationalLayerType="ArcGISFeatureLayer",r.popupEnabled=!0,r.popupTemplate=null,r.relationships=null,r.returnM=void 0,r.returnZ=void 0,r.screenSizePerspectiveEnabled=!0,r.serviceDefinitionExpression=null,r.spatialReference=S.WGS84,r.templates=null,r.timeInfo=null,r.title=null,r.sublayerTitleMode="item-title",r.trackIdField=null,r.type="feature",r.typeIdField=null,r.types=null,r.indexes=new(d.ofType(A.FeatureIndex)),r.userIsAdmin=!1,r.version=void 0,r.visible=!0,r}return i(f,t),f.prototype.normalizeCtorArgs=function(e,t){return"string"==typeof e?r({url:e},t):e},f.prototype.load=function(){var e=this,t=this.source&&(Array.isArray(this.source)||Y(this.source));if(this.portalItem&&t)return void this.addResolvingPromise(g.resolve());var r=this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]}).always(function(){if(e.url&&null==e.layerId&&/FeatureServer\/*$/i.test(e.url))return e._fetchFirstLayerId().then(function(t){null!=t&&(e.layerId=t)})}).then(function(){if(!e.url&&!e._hasMemorySource())throw new y("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return e.createGraphicsSource().then(e._initLayerProperties.bind(e))});return this.addResolvingPromise(r),this.when()},Object.defineProperty(f.prototype,"allRenderers",{get:function(){return this._getAllRenderers(this.renderer)},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"capabilities",{get:function(){var e=this._get("capabilities");return e||!this.loaded||this.hasService?e:{data:{supportsAttachment:!1,supportsM:!1,supportsZ:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!0,supportsDelete:!0,supportsEditing:!0,supportsQuery:!0,supportsResizeAttachments:!1,supportsUpdate:!0},query:{supportsStatistics:!1,supportsCentroid:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!0,supportsGeometryProperties:!1,supportsOrderBy:!1,supportsPagination:!1,supportsQuantization:!1,supportsResultType:!1,supportsSqlExpression:!1,supportsStandardizedQueriesOnly:!1,supportsQueryByOthers:!1,supportsHistoricMoment:!1,supportsFormatPBF:!1},queryRelated:{supportsPagination:!1,supportsCount:!1,supportsOrderBy:!1},editing:{supportsGeometryUpdate:!0,supportsGlobalId:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1}}},enumerable:!0,configurable:!0}),f.prototype.readCapabilities=function(e,t){return t=t.layerDefinition||t,{data:this._readDataCapabilities(t),operations:this._readOperationsCapabilities(t.capabilities||e,t),query:this._readQueryCapabilities(t),queryRelated:this._readQueryRelatedCapabilities(t),editing:this._readEditingCapabilities(t)}},Object.defineProperty(f.prototype,"hasAttachments",{get:function(){return this.hasService&&this._get("hasAttachments")||!1},enumerable:!0,configurable:!0}),f.prototype.readIsTable=function(e,t){return t=t&&t.layerDefinition||t,"Table"===t.type},Object.defineProperty(f.prototype,"hasService",{get:function(){return!this._hasMemorySource()},enumerable:!0,configurable:!0}),f.prototype.readMinScale=function(e,t){return t.effectiveMinScale||e||0},f.prototype.readMaxScale=function(e,t){return t.effectiveMaxScale||e||0},f.prototype.readObjectIdFieldFromService=function(e,t){if(t=t.layerDefinition||t,t.objectIdField)return t.objectIdField;if(t.fields)for(var r=0,i=t.fields;r<i.length;r++){var o=i[r];if("esriFieldTypeOID"===o.type)return o.name}},Object.defineProperty(f.prototype,"outFields",{get:function(){var e=this,t=this._userOutFields,r=this.requiredFields;return t=t&&t.slice(0),r=r&&r.slice(0),t?-1===t.indexOf("*")&&r.forEach(function(e){-1===t.indexOf(e)&&t.push(e)}):t=r,-1!==t.indexOf("*")?t=["*"]:this.loaded&&(t=t.filter(function(t){var r=!!e.getField(t);return t&&!r&&oe.error("[outFields] Invalid field: ",t),r},this),t=t.map(function(t){return e.getField(t).name},this),t=t.filter(function(e,t,r){return r.indexOf(e)===t})),t},set:function(e){var t=this,r=this.requiredFields&&this.requiredFields.slice(0);e?-1===e.indexOf("*")&&r.forEach(function(t){-1===e.indexOf(t)&&e.push(t)}):e=r,this.loaded&&(e=e.filter(function(e){var r="*"===e||!!t.getField(e,t.fields);return e&&!r&&oe.error("[outFields] Invalid field: ",e),r},this),e=e.map(function(e){return"*"===e?e:t.getField(e,t.fields).name},this)),this._userOutFields=e},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"parsedUrl",{get:function(){var e=this.url?b.urlToObject(this.url):null;return null!=this.layerId&&null!=e&&(e.path=b.join(e.path,this.layerId.toString())),e},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"renderer",{set:function(e){var t=this._getAllRenderers(e);B.fixRendererFields(t,this.fields),this._set("renderer",e)},enumerable:!0,configurable:!0}),f.prototype.readRenderer=function(e,t,r){t=t.layerDefinition||t;var i,o,n=t.drawingInfo&&t.drawingInfo.renderer||void 0;if(n)(i=W.read(n,t,r)||void 0)||oe.error("Failed to create renderer",{rendererDefinition:t.drawingInfo.renderer,layer:this,context:r});else if(t.defaultSymbol)J.read(t.defaultSymbol,t,r),t.types&&t.types.length?(i=new p.UniqueValueRenderer({defaultSymbol:o,field:t.typeIdField}),t.types.forEach(function(e){n.addUniqueValueInfo(e.id,J.read(e.symbol,e,r))})):i=new p.SimpleRenderer({symbol:o});else if("Table"!==t.type){switch(t.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":o=new u.SimpleMarkerSymbol;break;case"esriGeometryPolyline":o=new u.SimpleLineSymbol;break;case"esriGeometryPolygon":o=new u.SimpleFillSymbol}i=o&&new p.SimpleRenderer({symbol:o})}return i},f.prototype.writeRenderer=function(e,t,r,i){W.writeTarget(e,t,r,i)},Object.defineProperty(f.prototype,"requiredFields",{get:function(){var e=this.timeInfo,t=[],r=[],i=[this.objectIdField,this.typeIdField,this.editFieldsInfo&&this.editFieldsInfo.creatorField,e&&e.startTimeField,e&&e.endTimeField,this.trackIdField];this.allRenderers.forEach(function(e){t=t.concat(e.requiredFields)}),this.labelingInfo&&this.labelingInfo.length&&this.labelingInfo.forEach(function(e){r=r.concat(e.requiredFields)}),r=r.map(function(e){return e.replace(/['"]+/g,"")}),i=i.concat(t),i=i.concat(r);var o=this.elevationInfo&&this.elevationInfo.featureExpressionInfo;return o&&(i=i.concat(o.requiredFields)),this.popupTemplate&&(i=i.concat(this.popupTemplate.requiredFields)),i.filter(function(e,t,r){return!!e&&r.indexOf(e)===t&&"function"!=typeof e})},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"source",{set:function(e){var t=this._get("source");t!==e&&(Y(t)&&this._resetMemorySource(t),Y(e)&&this._initMemorySource(e),this._set("source",e))},enumerable:!0,configurable:!0}),f.prototype.castSource=function(e){return e?Array.isArray(e)||ee(e)?new T({layer:this,items:e}):e:null},f.prototype.readSource=function(e,t){var r=$.fromJSON(t.featureSet);return new T({layer:this,items:r&&r.features||[]})},f.prototype.readTemplates=function(e,t){var r=t.editFieldsInfo,i=r&&r.creatorField,o=r&&r.editorField;return e=e&&e.map(function(e){return U.fromJSON(e)}),this._fixTemplates(e,i),this._fixTemplates(e,o),e},f.prototype.readTitle=function(e,t){var r=t.layerDefinition&&t.layerDefinition.name||t.name,i=t.title||t.layerDefinition&&t.layerDefinition.title;if(r){var o=this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return this.url?E.titleFromUrlAndName(this.url,r):r;var n=r||this.url&&E.parse(this.url).title;if(!n)return;return"item-title-and-service-name"===this.sublayerTitleMode&&o&&(n=o+" - "+n),E.cleanTitle(n)}if("item-title"===this.sublayerTitleMode&&i)return i},f.prototype.readTitleFromWebMap=function(e,t){var r=t.layerDefinition&&t.layerDefinition.name;return r||t.title},f.prototype.readTypeIdField=function(e,t){if(t=t.layerDefinition||t,e=t.typeIdField){var r=this.getField(e,t.fields);r&&(e=r.name)}return e},f.prototype.readTypes=function(e,t){var r=this;t=t.layerDefinition||t,e=t.types;var i=t.editFieldsInfo,o=i&&i.creatorField,n=i&&i.editorField;return e&&e.map(function(e){return e=Q.fromJSON(e),r._fixTemplates(e.templates,o),r._fixTemplates(e.templates,n),e})},Object.defineProperty(f.prototype,"url",{set:function(e){var t=E.sanitizeUrlWithLayerId(this,e,oe);this._set("url",t.url),null!=t.layerId&&this._set("layerId",t.layerId)},enumerable:!0,configurable:!0}),f.prototype.writeUrl=function(e,t,r,i){E.writeUrlWithLayerId(this,e,t)},f.prototype.readVersion=function(e,t){return t=t.layerDefinition||t,t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3},f.prototype.readVisible=function(e,t){return t.layerDefinition&&null!=t.layerDefinition.defaultVisibility?!!t.layerDefinition.defaultVisibility:null!=t.visibility?!!t.visibility:void 0},f.prototype.applyEdits=function(e){var t,r,i=this,o={edits:e,result:g.create(function(e,i){t=e,r=i})};return this.emit("apply-edits",o),this.load().then(function(){return X(i.source)?i._processApplyEditsParams(e):g.reject(new y(ie,"Layer source does not support applyEdits capability"))}).then(function(e){if(X(i.source))return i.source.applyEdits(e).then(function(e){var r=function(e){return e.filter(function(e){return!e.error}).map(h.clone)},o={addedFeatures:r(e.addFeatureResults),updatedFeatures:r(e.updateFeatureResults),deletedFeatures:r(e.deleteFeatureResults)};return(o.addedFeatures.length||o.updatedFeatures.length||o.deletedFeatures.length)&&i.emit("edits",o),t(o),e})}).catch(function(e){throw r(e),e})},f.prototype.on=function(e,t){return this.inherited(arguments)},f.prototype.createGraphicsSource=function(){var t=this;return this._hasMemorySource()?(this.emit("graphics-source-create",{graphicsSource:this.source}),this.source.when()):g.create(function(t){return e(["./graphics/sources/FeatureLayerSource"],t)}).then(function(e){return new e({layer:t})}).then(function(e){return e.when()}).then(function(e){return t.emit("graphics-source-create",{graphicsSource:e}),e})},f.prototype.createGraphicsController=function(t){var i,o=this,n=t.layerView,a=d.ofType(s),p=this.source,l=Y(p),u=r({},t.options,{layer:this,layerView:n,graphics:l?p:new a});return i=l?g.create(function(t){return e(["./graphics/controllers/MemoryController"],t)}):"2d"===n.view.type?g.create(function(t){return e(["./graphics/controllers/AutoController2D"],t)}):g.create(function(t){return e(["./graphics/controllers/SnapshotController"],t)}),i.then(function(e){return new e(u)}).then(function(e){return o.emit("graphics-controller-create",{graphicsController:e}),e.when()})},f.prototype.createQuery=function(){var e=new K,t=this.get("capabilities.data");return e.gdbVersion=this.gdbVersion,e.historicMoment=this.historicMoment,e.returnGeometry=!0,t&&(t.supportsZ&&null!=this.returnZ&&(e.returnZ=this.returnZ),t.supportsM&&null!=this.returnM&&(e.returnM=this.returnM)),e.outFields=this.outFields,e.where=this.definitionExpression||"1=1",e.multipatchOption="multipatch"===this.geometryType?"xyFootprint":null,e},f.prototype.getFeatureType=function(e){var t=this,r=t.typeIdField,i=t.types;if(!r||!e)return null;var o=e.attributes?e.attributes[r]:void 0;if(null==o)return null;var n=null;return i.some(function(e){var t=e.id;return null!=t&&(t.toString()===o.toString()&&(n=e),!!n)}),n},f.prototype.getFieldDomain=function(e,t){var r,i=this,o=!1,n=t&&t.feature,s=n&&n.attributes,a=this.typeIdField&&s&&s[this.typeIdField];return null!=a&&this.types&&(o=this.types.some(function(t){return t.id==a&&(r=t.domains&&t.domains[e],r&&"inherited"===r.type&&(r=i._getLayerDomain(e)),!0)})),o||r||(r=this._getLayerDomain(e)),r},f.prototype.getField=function(e,t){var r=this.processing?this.fields.concat(this.processing.fields):this.fields;return B.getField(e,t||r)},f.prototype.graphicChanged=function(e){this.emit("graphic-update",e)},f.prototype.queryFeatureAttachments=function(e){var t=this;return this.load().then(function(){if(!e)return g.reject(new y(ie,"A feature is required to query attachments"));var i=t,o=i.layerId,n=i.objectIdField,s=i.token,a=i.url;if(!t.get("capabilities.data.supportsAttachment"))return g.reject(new y(ie,"this layer doesn't support attachments"));var p=e.attributes;if(!p)return g.reject(new y(ie,"'attributes' are required on a feature to query attachments"));var u=p[n];if(!u)return g.reject(new y(ie,"feature is missing the identifying attribute "+n));var d=a+"/"+o+"/"+u+"/attachments";return l(d,{query:{f:"json",token:s},callbackParamName:"callback",responseType:"json"}).then(function(e){return e.data.attachmentInfos.map(function(e){var t=e.id;return r({},e,{url:b.addProxy(d+"/"+t+(s?"?token="+s:""))})})})})},f.prototype.queryFeatures=function(e,t){var r=this;return this.load().then(function(){return r.source.queryFeatures(e||r.createQuery(),t)}).then(function(e){if(e&&e.features)for(var t=0,i=e.features;t<i.length;t++){var o=i[t];o.layer=o.sourceLayer=r}return e})},f.prototype.queryFeaturesJSON=function(e,t){var r=this;return this.load().then(function(){if(!r.source.queryFeaturesJSON)return g.reject(new y(ie,"Layer source does not support queryFeaturesJSON capability"))}).then(function(){return r.source.queryFeaturesJSON(e||r.createQuery(),t)})},f.prototype.queryObjectIds=function(e,t){var r=this;return this.load().then(function(){return r.source.queryObjectIds?r.source.queryObjectIds(e||r.createQuery(),t):g.reject(new y(ie,"Layer source does not support queryObjectIds capability"))})},f.prototype.queryFeatureCount=function(e,t){var r=this;return this.load().then(function(){return r.source.queryFeatureCount?r.source.queryFeatureCount(e||r.createQuery(),t):g.reject(new y(ie,"Layer source does not support queryFeatureCount capability"))})},f.prototype.queryExtent=function(e,t){var r=this;return this.load().then(function(){return r.source.queryExtent?r.source.queryExtent(e||r.createQuery(),t):g.reject(new y(ie,"Layer source does not support queryExtent capability"))})},f.prototype.read=function(e,t){var r=e.featureCollection;if(r){var i=r.layers;i&&1===i.length&&(this.inherited(arguments,[i[0],t]),null!=r.showLegend&&this.inherited(arguments,[{showLegend:r.showLegend},t]))}return this.inherited(arguments,[e,t]),this},f.prototype.write=function(e,t){if(t&&"web-scene"===t.origin&&t.messages){if(!this.url)return t.messages.push(new y("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' require a url to a service to be written to web scenes",{layer:this})),null;if(this.isTable)return t.messages.push(new y("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' using a Table source cannot written to web scenes",{layer:this})),null}return this.inherited(arguments)},f.prototype.importLayerViewModule=function(t){switch(t.type){case"2d":return g.create(function(t){return e(["../views/2d/layers/FeatureLayerView2D"],t)});case"3d":return g.create(function(t){return e(["../views/3d/layers/FeatureLayerView3D"],t)})}},f.prototype._getLayerDomain=function(e){if(!this.fields)return null;var t=null;return this.fields.some(function(r){return r.name===e&&(t=r.domain),!!t}),t},f.prototype._fetchFirstLayerId=function(){return l(this.url,{query:{f:"json"},callbackParamName:"callback",responseType:"json"}).then(function(e){var t=e.data;if(t&&Array.isArray(t.layers)&&t.layers.length>0)return t.layers[0].id})},f.prototype._initLayerProperties=function(e){var t=this;return this.source||(this.source=e),e.url&&(this.url=e.url),e.layerDefinition&&this.read(e.layerDefinition,{origin:"service",url:this.parsedUrl}),this._verifySource(),this._verifyFields(),this._addSymbolUrlTokens(),B.fixRendererFields(this._getAllRenderers(this.renderer),this.fields),this.watch("token",function(){t._addSymbolUrlTokens()}),N.loadStyleRenderer(this,{origin:"service"})},f.prototype._findUrlBasedSymbols=function(){var e=this.renderer;if(!e)return[];var t=[];e.symbol&&t.push(e.symbol),e.defaultSymbol&&t.push(e.defaultSymbol);var r=e.classBreakInfos||e.uniqueValueInfos;return r&&r.forEach(function(e){e.symbol&&t.push(e.symbol)}),t.filter(function(e){return!!e.url})},f.prototype._addSymbolUrlTokens=function(){var e=this.token;if(!this._hasMemorySource()&&e){this._findUrlBasedSymbols().forEach(function(t){var r=t.url;if(r&&-1!==r.search(/https?\:/i)&&!/[?&]token=/.test(r)){var i=-1===r.indexOf("?")?"?":"&";t.url=r+i+"token="+e}})}},f.prototype._getAllRenderers=function(e){if(!e)return[];var t=[];return[e,e.trackRenderer,e.observationRenderer,e.latestObservationRenderer].forEach(function(e){e&&(t.push(e),e.rendererInfos&&e.rendererInfos.forEach(function(e){e.renderer&&t.push(e.renderer)}))}),t},f.prototype._verifyFields=function(){var e=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||-1!==e.search(/\/FeatureServer\//i)||this.fields&&this.fields.some(function(e){return"geometry"===e.type})||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")},f.prototype._fixTemplates=function(e,t){e&&e.forEach(function(e){var r=e.prototype&&e.prototype.attributes;r&&t&&delete r[t]})},f.prototype._verifySource=function(){var e=this;if(this._hasMemorySource()){if(this.url)throw new y("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url");var t=["geometryType","fields","objectIdField"];if(!t.every(function(t){return null!=e[t]}))throw new y("feature-layer:missing-property","FeatureLayer created as feature collection requires properties: "+t.join(),{requiredProperties:t})}else{if(this.isTable)throw new y("feature-layer:source-type-not-supported","The table feature service type is not yet supported",{sourceType:"Table"});if(!this.url)throw new y("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}},f.prototype._initMemorySource=function(e){var t=this;e.forEach(function(e){e.layer=t,e.sourceLayer=t}),this._handles.add([e.on("after-add",function(e){e.item.layer=t,e.item.sourceLayer=t}),e.on("after-remove",function(e){e.item.layer=null,e.item.sourceLayer=null})],"fl-source")},f.prototype._resetMemorySource=function(e){e.forEach(function(e){e.layer=null,e.sourceLayer=null}),this._handles.remove("fl-source")},f.prototype._hasMemorySource=function(){return!(this.url||!this.source)},f.prototype._readDataCapabilities=function(e){return{supportsAttachment:te(e,"hasAttachments",!1),supportsM:te(e,"hasM",!1),supportsZ:te(e,"hasZ",!1)}},f.prototype._readOperationsCapabilities=function(e,t){var r=e?e.toLowerCase().split(",").map(function(e){return e.trim()}):[],i=-1!==r.indexOf("editing"),o=i&&-1!==r.indexOf("create"),n=i&&-1!==r.indexOf("delete"),s=i&&-1!==r.indexOf("update");return i&&!(o||n||s)&&(o=n=s=!0),{supportsCalculate:te(t,"supportsCalculate",!1),supportsTruncate:te(t,"supportsTruncate",!1),supportsValidateSql:te(t,"supportsValidateSql",!1),supportsAdd:o,supportsDelete:n,supportsEditing:i,supportsQuery:-1!==r.indexOf("query"),supportsResizeAttachments:te(t,"supportsAttachmentsResizing",!1),supportsUpdate:s}},f.prototype._readQueryCapabilities=function(e){var t=e.advancedQueryCapabilities,r=e.ownershipBasedAccessControlForFeatures,i=e.archivingInfo,o=(e.supportedQueryFormats||"").split(",").reduce(function(e,t){var r=t.toLowerCase().trim();return r&&e.add(r),e},new Set);return{supportsStatistics:te(t,"supportsStatistics",e.supportsStatistics),supportsCentroid:te(t,"supportsReturningGeometryCentroid",!1),supportsDistance:te(t,"supportsQueryWithDistance",!1),supportsDistinct:te(t,"supportsDistinct",e.supportsAdvancedQueries),supportsExtent:te(t,"supportsReturningQueryExtent",!1),supportsGeometryProperties:te(t,"supportsReturningGeometryProperties",!1),supportsOrderBy:te(t,"supportsOrderBy",e.supportsAdvancedQueries),supportsPagination:te(t,"supportsPagination",!1),supportsQuantization:te(e,"supportsCoordinatesQuantization",!1),supportsResultType:te(t,"supportsQueryWithResultType",!1),supportsSqlExpression:te(t,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:te(e,"useStandardizedQueries",!1),supportsQueryByOthers:te(r,"allowOthersToQuery",!0),supportsHistoricMoment:te(i,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:o.has("pbf")}},f.prototype._readQueryRelatedCapabilities=function(e){var t=e.advancedQueryCapabilities,r=te(t,"supportsAdvancedQueryRelated",!1);return{supportsPagination:te(t,"supportsQueryRelatedPagination",!1),supportsCount:r,supportsOrderBy:r}},f.prototype._readEditingCapabilities=function(e){var t=e.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:te(e,"allowGeometryUpdates",!0),supportsGlobalId:te(e,"supportsApplyEditsWithGlobalIds",!1),supportsRollbackOnFailure:te(e,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:te(e,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:te(e,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:te(t,"allowAnonymousToDelete",!0),supportsDeleteByOthers:te(t,"allowOthersToDelete",!0),supportsUpdateByAnonymous:te(t,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:te(t,"allowOthersToUpdate",!0)}},f.prototype._processApplyEditsParams=function(e){var t="'addFeatures', 'updateFeatures' or 'deleteFeatures' parameter is required",i="feature-layer:missing-parameters";if(!e)return g.reject(new y(i,t));if(e=r({},e),e.addFeatures=e.addFeatures||[],e.updateFeatures=e.updateFeatures||[],e.deleteFeatures=e.deleteFeatures||[],e.addFeatures.length||e.updateFeatures.length||e.deleteFeatures.length){var o=function(e){var t=new s;return t.geometry=e.geometry,t.attributes=e.attributes,t};return e.addFeatures=e.addFeatures.map(o),e.updateFeatures=e.updateFeatures.map(o),this._normalizeGeometries(e)}return g.reject(new y(i,t))},f.prototype._normalizeGeometries=function(e){var t=e.addFeatures,r=e.updateFeatures,i=t.concat(r).map(function(e){return e.geometry});return D.normalizeCentralMeridian(i).then(function(i){var o=t.length,n=r.length;return i.slice(0,o).forEach(function(t,r){e.addFeatures[r].geometry=t}),i.slice(o,o+n).forEach(function(t,r){e.updateFeatures[r].geometry=t}),e})},o([F.property({types:{key:"type",base:C.default,typeMap:{selection:L.default}},json:{origins:{"web-scene":{read:{source:"layerDefinition.featureReduction"},write:{target:"layerDefinition.featureReduction"}}}}})],f.prototype,"featureReduction",void 0),o([F.property({readOnly:!0,dependsOn:["loaded","renderer","fields"]})],f.prototype,"allRenderers",null),o([F.property({readOnly:!0,dependsOn:["loaded"]})],f.prototype,"capabilities",null),o([F.reader("capabilities",["layerDefinition.capabilities","layerDefinition.advancedQueryCapabilities","layerDefinition.archivingInfo","layerDefinition.supportsStatistics","layerDefinition.supportsAdvancedQueries","layerDefinition.hasAttachments","layerDefinition.hasM","layerDefinition.hasZ","layerDefinition.supportsCalculate","layerDefinition.supportsTruncate","layerDefinition.supportsValidateSql","layerDefinition.supportsCoordinatesQuantization","layerDefinition.useStandardizedQueries","layerDefinition.ownershipBasedAccessControlForFeatures","layerDefinition.allowGeometryUpdates","layerDefinition.supportsApplyEditsWithGlobalIds","layerDefinition.supportsRollbackOnFailureParameter","layerDefinition.allowUpdateWithoutMValues","layerDefinition.supportsAttachmentsByUploadId","layerDefinition.supportedQueryFormats"]),F.reader("service","capabilities",["advancedQueryCapabilities","archivingInfo","supportsStatistics","supportsAdvancedQueries","hasAttachments","hasM","hasZ","supportsAttachmentsResizing","supportsCalculate","supportsTruncate","supportsValidateSql","supportsCoordinatesQuantization","useStandardizedQueries","ownershipBasedAccessControlForFeatures","allowGeometryUpdates","supportsApplyEditsWithGlobalIds","supportsRollbackOnFailureParameter","allowUpdateWithoutMValues","supportsAttachmentsByUploadId","capabilities","supportedQueryFormats"])],f.prototype,"readCapabilities",null),o([F.property({type:String,json:{read:{source:"layerDefinition.copyrightText"},origins:{service:{read:{source:"copyrightText"}}}}})],f.prototype,"copyright",void 0),o([F.property({type:String,json:{read:{source:"layerDefinition.displayField"},origins:{service:{read:{source:"displayField"}}}}})],f.prototype,"displayField",void 0),o([F.property({type:String,json:{origins:{service:{read:!1,write:!1}},read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression"}}})],f.prototype,"definitionExpression",void 0),o([F.property({readOnly:!0,json:{read:J.read}})],f.prototype,"defaultSymbol",void 0),o([F.property()],f.prototype,"dynamicDataSource",void 0),o([F.property({readOnly:!0})],f.prototype,"editFieldsInfo",void 0),o([F.property({type:H,json:{origins:{service:{read:{source:"elevationInfo"},write:{target:"elevationInfo",enabled:!1}}},read:{source:"layerDefinition.elevationInfo"},write:{target:"layerDefinition.elevationInfo"}}})],f.prototype,"elevationInfo",void 0),o([F.property({type:[V],json:{origins:{service:{read:!0}},read:{source:"layerDefinition.fields"}}})],f.prototype,"fields",void 0),o([F.property({type:I,json:{origins:{service:{read:{source:"extent"}}},read:{source:"layerDefinition.extent"}}})],f.prototype,"fullExtent",void 0),o([F.property()],f.prototype,"gdbVersion",void 0),o([F.property({json:{origins:{service:{read:re.read}},read:{source:"layerDefinition.geometryType",reader:re.read}}})],f.prototype,"geometryType",void 0),o([F.property({readOnly:!0,dependsOn:["loaded"],json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasAttachments"}}})],f.prototype,"hasAttachments",null),o([F.property({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}})],f.prototype,"hasM",void 0),o([F.property({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasZ"}}})],f.prototype,"hasZ",void 0),o([F.property({readOnly:!0,type:w})],f.prototype,"heightModelInfo",void 0),o([F.property({type:Date})],f.prototype,"historicMoment",void 0),o([F.property({json:{origins:{service:{read:!1},"portal-item":{read:!1}}}})],f.prototype,"id",void 0),o([F.property({readOnly:!0})],f.prototype,"isTable",void 0),o([F.reader("service","isTable",["type"]),F.reader("isTable",["layerDefinition.type"])],f.prototype,"readIsTable",null),o([F.property({dependsOn:["loaded","url","source"],readOnly:!0})],f.prototype,"hasService",null),o([F.property(_.labelsVisible)],f.prototype,"labelsVisible",void 0),o([F.property({type:[G],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:k.reader},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:k.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],f.prototype,"labelingInfo",void 0),o([F.property({type:Number,json:{origins:{service:{read:{source:"id"}}},read:!1}})],f.prototype,"layerId",void 0),o([F.property({type:Boolean,json:{read:{source:"showLegend"},write:{target:"showLegend"}}})],f.prototype,"legendEnabled",void 0),o([F.property({type:Number,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.maxRecordCount"}}})],f.prototype,"maxRecordCount",void 0),o([F.property({type:Number,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.tileMaxRecordCount"}}})],f.prototype,"tileMaxRecordCount",void 0),o([F.property({type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}})],f.prototype,"minScale",void 0),o([F.reader("service","minScale",["minScale","effectiveMinScale"])],f.prototype,"readMinScale",null),o([F.property({type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}})],f.prototype,"maxScale",void 0),o([F.reader("service","maxScale",["maxScale","effectiveMaxScale"])],f.prototype,"readMaxScale",null),o([F.property({type:String})],f.prototype,"objectIdField",void 0),o([F.reader("objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"]),F.reader("service","objectIdField",["objectIdField","fields"])],f.prototype,"readObjectIdFieldFromService",null),o([F.property()],f.prototype,"operationalLayerType",void 0),o([F.property({dependsOn:["requiredFields"]})],f.prototype,"outFields",null),o([F.property({readOnly:!0,dependsOn:["layerId"]})],f.prototype,"parsedUrl",null),o([F.property(_.popupEnabled)],f.prototype,"popupEnabled",void 0),o([F.property({type:a,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],f.prototype,"popupTemplate",void 0),o([F.property({type:P})],f.prototype,"processing",void 0),o([F.property({type:[z],readOnly:!0})],f.prototype,"relationships",void 0),o([F.property({types:Z.types,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}}},write:{target:"layerDefinition.drawingInfo.renderer"}}})],f.prototype,"renderer",null),o([F.reader("service","renderer",["drawingInfo.renderer","defaultSymbol","type"]),F.reader("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol","layerDefinition.type"])],f.prototype,"readRenderer",null),
o([F.writer("renderer")],f.prototype,"writeRenderer",null),o([F.property({readOnly:!0,dependsOn:["allRenderers","labelingInfo","elevationInfo.featureExpressionInfo","popupTemplate.requiredFields"]})],f.prototype,"requiredFields",null),o([F.property({type:Boolean})],f.prototype,"returnM",void 0),o([F.property({type:Boolean})],f.prototype,"returnZ",void 0),o([F.property(_.screenSizePerspectiveEnabled)],f.prototype,"screenSizePerspectiveEnabled",void 0),o([F.property()],f.prototype,"source",null),o([F.cast("source")],f.prototype,"castSource",null),o([F.reader("portal-item","source",["featureSet"]),F.reader("web-map","source",["featureSet"])],f.prototype,"readSource",null),o([F.property({readOnly:!0,json:{origins:{service:{read:{source:"definitionExpression"}}}}})],f.prototype,"serviceDefinitionExpression",void 0),o([F.property({type:S,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:{source:"layerDefinition.extent.spatialReference"}}})],f.prototype,"spatialReference",void 0),o([F.property({type:[U]})],f.prototype,"templates",void 0),o([F.reader("templates",["editFieldsInfo","creatorField","editorField","templates"])],f.prototype,"readTemplates",null),o([F.property()],f.prototype,"timeInfo",void 0),o([F.property()],f.prototype,"title",void 0),o([F.reader("service","title",["name"]),F.reader("portal-item","title",["layerDefinition.title","layerDefinition.name","title"])],f.prototype,"readTitle",null),o([F.reader("web-map","title",["layerDefinition.name","title"])],f.prototype,"readTitleFromWebMap",null),o([F.property({type:String})],f.prototype,"sublayerTitleMode",void 0),o([F.property({type:String,readOnly:!0,json:{read:{source:"timeInfo.trackIdField"}}})],f.prototype,"trackIdField",void 0),o([F.property({json:{read:!1}})],f.prototype,"type",void 0),o([F.property({type:String,readOnly:!0})],f.prototype,"typeIdField",void 0),o([F.reader("service","typeIdField"),F.reader("typeIdField",["layerDefinition.typeIdField"])],f.prototype,"readTypeIdField",null),o([F.property({type:[Q]})],f.prototype,"types",void 0),o([F.reader("service","types",["types"]),F.reader("types",["layerDefinition.types"])],f.prototype,"readTypes",null),o([F.property({type:d.ofType(A.FeatureIndex),readOnly:!0})],f.prototype,"indexes",void 0),o([F.property({type:String})],f.prototype,"url",null),o([F.writer("url")],f.prototype,"writeUrl",null),o([F.property({readOnly:!0})],f.prototype,"userIsAdmin",void 0),o([F.property({json:{origins:{"portal-item":{read:!1}}}})],f.prototype,"version",void 0),o([F.reader("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"]),F.reader("version",["layerDefinition.currentVersion","layerDefinition.capabilities","layerDefinition.drawingInfo","layerDefinition.hasAttachments","layerDefinition.htmlPopupType","layerDefinition.typeIdField","layerDefinition.types"])],f.prototype,"readVersion",null),o([F.property({type:Boolean,json:{origins:{"portal-item":{write:{target:"layerDefinition.defaultVisibility"}}}}})],f.prototype,"visible",void 0),o([F.reader("portal-item","visible",["visibility","layerDefinition.defaultVisibility"])],f.prototype,"readVisible",null),o([n(0,F.cast(K))],f.prototype,"queryFeatures",null),o([n(0,F.cast(K))],f.prototype,"queryFeaturesJSON",null),o([n(0,F.cast(K))],f.prototype,"queryObjectIds",null),o([n(0,F.cast(K))],f.prototype,"queryFeatureCount",null),o([n(0,F.cast(K))],f.prototype,"queryExtent",null),f=o([F.subclass("esri.layers.FeatureLayer")],f)}(F.declared(O,j,M,q,R,x,v))});