// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/urlUtils","../../geometry/Extent","../../geometry/SpatialReference"],function(e,t,r,n,a,i){function s(e,t){if(e){if(g=-1,"string"==typeof e){e=(new DOMParser).parseFromString(e,"text/xml")}var n=e.documentElement;if("ServiceExceptionReport"===n.nodeName){var i=Array.prototype.slice.call(n.childNodes),s=i.map(function(e){return e.textContent}),l=s.join("\r\n");throw new r("wmslayer:wms-capabilities-xml-is-not-valid","The server returned errors when the WMS capabilities were requested.",l)}var o=p("Layer",n);if(o){var f="WMS_Capabilities"===n.nodeName||"WMT_MS_Capabilities"===n.nodeName?n.getAttribute("version"):"1.3.0",m=p("Service",n),x=c("Title",m,"")||c("Name",m,""),N=c("AccessConstraints",m,""),b=c("Abstract",m,""),v=parseInt(c("MaxWidth",m,5e3),10),A=parseInt(c("MaxHeight",m,5e3),10),E=p("Capability",n),L=y(n,"GetMap"),w=t&&t.toLowerCase().indexOf("https")>-1,R=d(n,"GetMap");w&&(R=R.replace(/^http:/i,"https:"));var O,M=h(o,f,w),C=0;if(Array.prototype.slice.call(E.childNodes).forEach(function(e){"Layer"===e.nodeName&&(0===C?O=e:1===C?(M.name&&(M.name="",M.sublayers.push(h(O,f,w))),M.sublayers.push(h(e,f,w))):M.sublayers.push(h(e,f,w)),C++)}),!M)return null;var U,F,I=[],B=M.fullExtents;if(I=M.sublayers,I||(I=[]),0===I.length&&I.push(M),!(U=M.extent)){var S=new a(I[0].extent);M.extent=S.toJSON(),U=M.extent}if(F=M.spatialReferences,!F.length&&I.length>0){var _=function(e){var t=[];return e.sublayers.forEach(function(e){!t.length&&e.spatialReferences.length&&(t=e.spatialReferences||_(e))}),t};I.forEach(function(e){F.length||(F=e.spatialReferences||_(e))})}var T,q=d(n,"GetFeatureInfo");if(q){var X=y(n,"GetFeatureInfo");X.indexOf("text/html")>-1?T="text/html":X.indexOf("text/plain")>-1&&(T="text/plain"),w&&(q=q.replace(/^http:/i,"https:"))}if(!T){var V=function(e){e&&(e.queryable=!1,e.sublayers&&e.sublayers.forEach(function(e){V(e)}))};V(M)}return{copyright:N,description:b,extent:U,fullExtents:B,featureInfoFormat:T,featureInfoUrl:q,mapUrl:R,maxImageWidth:v,maxImageHeight:A,layers:u(I),spatialReferences:F,supportedImageFormatTypes:L,title:x,version:f}}}}function l(e){return N.some(function(t){var r=t[0],n=t[1];return e>=r&&e<=n})}function o(e){return e.length?e.filter(function(e){return e.popupEnabled&&e.name&&e.queryable}).map(function(e){return e.name}).join(","):""}function u(e){var t=[];return e.forEach(function(e){t.push(e),e.sublayers&&e.sublayers.length&&(t=t.concat(u(e.sublayers)),delete e.sublayers)}),t}function f(e,t,r,n){var a=p(e,r);return a?a.getAttribute(t):n}function p(e,t){var r=t&&t.getElementsByTagName(e);return r&&r.length>0?r[0]:null}function c(e,t,r){var n=p(e,t);return n?n.textContent:r}function m(e,t,r){if(!e)return null;var n,s,l,o,u=parseFloat(e.getAttribute("minx")),f=parseFloat(e.getAttribute("miny")),p=parseFloat(e.getAttribute("maxx")),c=parseFloat(e.getAttribute("maxy"));r?(n=isNaN(f)?-Number.MAX_VALUE:f,s=isNaN(u)?-Number.MAX_VALUE:u,l=isNaN(c)?Number.MAX_VALUE:c,o=isNaN(p)?Number.MAX_VALUE:p):(n=isNaN(u)?-Number.MAX_VALUE:u,s=isNaN(f)?-Number.MAX_VALUE:f,l=isNaN(p)?Number.MAX_VALUE:p,o=isNaN(c)?Number.MAX_VALUE:c);var m=new i({wkid:t});return new a({xmin:n,ymin:s,xmax:l,ymax:o,spatialReference:m})}function d(e,t){var r=p(t,e),n=p("DCPType",r);if(n){var a=p("HTTP",n);if(a){var i=p("Get",a);if(i){var s=f("OnlineResource","xlink:href",i,null);if(s)return s.indexOf("&")===s.length-1&&(s=s.substring(0,s.length-1)),x(s,["service","request"])}}}return null}function y(e,t){var r=e.getElementsByTagName("Operation");if(r&&r.length){var n=Array.prototype.slice.call(r),a=[];return n.forEach(function(e){if(e.getAttribute("name")===t){var r=e.getElementsByTagName("Format");Array.prototype.slice.call(r).forEach(function(e){a.push(e.textContent)})}}),a}var i=p(t,e),s=i.getElementsByTagName("Format");return Array.prototype.slice.call(s).map(function(e){return e.textContent})}function h(e,t,r){if(!e)return null;var n={id:g++,fullExtents:[],parentLayerId:null,queryable:"1"===e.getAttribute("queryable"),spatialReferences:[],sublayers:null},s=p("LatLonBoundingBox",e),o=p("EX_GeographicBoundingBox",e),u=null;s&&(u=m(s,4326)),o&&(u=new a(0,0,0,0,new i({wkid:4326})),u.xmin=parseFloat(c("westBoundLongitude",o,0)),u.ymin=parseFloat(c("southBoundLatitude",o,0)),u.xmax=parseFloat(c("eastBoundLongitude",o,0)),u.ymax=parseFloat(c("northBoundLatitude",o,0))),s||o||(u=new a(-180,-90,180,90,new i({wkid:4326})));var f=["1.0.0","1.1.0","1.1.1"].indexOf(t)>-1?"SRS":"CRS";return Array.prototype.slice.call(e.childNodes).forEach(function(e){if("Name"===e.nodeName)n.name=e.textContent||"";else if("Title"===e.nodeName)n.title=e.textContent||"";else if("Abstract"===e.nodeName)n.description=e.textContent||"";else if("BoundingBox"===e.nodeName){var a=e.getAttribute(f);if(a&&0===a.indexOf("EPSG:")){var i=parseInt(a.substring(5),10);0===i||isNaN(i)||u||(u="1.3.0"===t?m(e,i,l(i)):m(e,i))}var s=a&&a.indexOf(":");if(s&&s>-1){var i=parseInt(a.substring(s+1,a.length),10);0===i||isNaN(i)||(i=b[i]?b[i]:i);var o="1.3.0"===t?m(e,i,l(i)):m(e,i);n.fullExtents.push(o)}}else if(e.nodeName===f){var c=e.textContent.split(" ");c.forEach(function(e){0===(e=e.indexOf(":")>-1?parseInt(e.split(":")[1],10):parseInt(e,10))||isNaN(e)||(b[e]&&(e=b[e]),-1===n.spatialReferences.indexOf(e)&&n.spatialReferences.push(e))})}else if("Style"!==e.nodeName||n.legendURL){if("Layer"===e.nodeName){var d=h(e,t,r);d&&(d.parentLayerId=n.id,n.sublayers||(n.sublayers=[]),n.sublayers.push(d))}}else{var y=p("LegendURL",e);if(y){var x=p("OnlineResource",y);x&&(n.legendURL=x.getAttribute("xlink:href"),r&&(n.legendURL=n.legendURL.replace(/^http:/i,"https:")))}}}),n.extent=u&&u.toJSON(),n}function x(e,t){var r=[],a=n.urlToObject(e);for(var i in a.query)a.query.hasOwnProperty(i)&&-1===t.indexOf(i.toLowerCase())&&r.push(i+"="+a.query[i]);return a.path+(r.length?"?"+r.join("&"):"")}Object.defineProperty(t,"__esModule",{value:!0});var g,N=[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],b={84:4326,83:4269,27:4267};t.parseCapabilities=s,t.coordsReversed=l,t.getPopupLayers=o});