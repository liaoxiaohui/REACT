// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","@dojo/shim/Set","../../../core/promiseUtils","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","../optimizedFeatures","./AttributesBuilder","./attributeSupport","./FeatureStoreItem","./projectionSupport"],function(e,t,r,i,s,a,n,o,u,l,p){function c(e){return e?JSON.parse(JSON.stringify(e,["latestWkid","wkid","wkt"])):e}Object.defineProperty(t,"__esModule",{value:!0});var f=function(){function e(e,t){this.items=e,this.definitionExpression=t.definitionExpression,this.geometryType=t.geometryType,this.hasM=t.hasM,this.hasZ=t.hasZ,this.objectIdField=t.objectIdField,this.spatialReference=t.spatialReference,this.fieldsMap=t.fieldsMap}return Object.defineProperty(e.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0}),e.prototype.createQueryResponse=function(e){return e.outStatistics?this._createStatisticsQueryResponse(e):this._createFeatureQueryResponse(e)},e.prototype.executeAttributesQuery=function(e){var t=u.getWhereClause(e.where);if(!t)return i.resolve(this);if(t.isStandardized()){for(var r=0,s=[],a=0,n=this.items;a<n.length;a++){var o=n[a];t.testFeature(o.getAttributes())&&(s[r++]=o)}var l=this._createNew(s);return l.definitionExpression=e.where,i.resolve(l)}return i.reject(new TypeError("Where clause is not standardized"))},e.prototype.executeObjectIdsQuery=function(e){if(!e.objectIds||!e.objectIds.length)return i.resolve(this);var t=new r.default(e.objectIds);return i.resolve(this._createNew(this.items.filter(function(e){return t.has(e.oid)})))},e.prototype.project=function(t){var r=this;return!t||a.equals(this.spatialReference,t)?i.resolve(this):p.projectMany(this.items.map(function(e){return e.getGeometry()}),this.spatialReference,t).then(function(i){for(var s=[],a=0;a<r.items.length;a++)s[a]={attributes:r.items[a].getAttributes(),geometry:i[a]};for(var o=[],u=0,p=n.convertFromFeatures(s,r.geometryType,r.hasZ,r.hasM);u<p.length;u++){var c=p[u];o.push(l.default.acquire(c,r))}return new e(o,{definitionExpression:r.definitionExpression,geometryType:r.geometryType,hasM:r.hasM,hasZ:r.hasZ,objectIdField:r.objectIdField,spatialReference:t,fieldsMap:r.fieldsMap})})},e.prototype._createFeatureQueryResponse=function(e){var t=this,r=this.items,i=this,a=i.geometryType,n=i.hasM,o=i.hasZ,u=i.objectIdField,l=i.spatialReference,p=e.outFields,f=e.outSpatialReference,h=e.quantizationParameters,d=!1;if(null!=e.num&&null!=e.start){var g=e.start+e.num;d=r.length>g,r=r.slice(e.start,Math.min(r.length,g))}return{exceededTransferLimit:d,features:this._createFeatures(e,r),fields:p&&p.map(function(e){return t.fieldsMap.get(e)}),geometryType:a,hasM:n,hasZ:o,objectIdFieldName:u,spatialReference:c(f?f.toJSON():l),transform:h&&s.toTransform(h)}},e.prototype._createFeatures=function(e,t){var r=new o.default(e,this.fieldsMap),i=e.quantizationParameters,a=e.returnGeometry,n=e.returnCentroid,u=e.orderByFields,l=[],p=0;if(t.length&&u&&u.length){var c=u[0].split(" "),f=c[0],h="DESC"===c[1];t.sort(function(e,t){var i=r.getFieldAttribute(e,f),s=r.getFieldAttribute(t,f);if("number"==typeof i&&"number"==typeof s)return h?s-i:i-s;if("string"==typeof i&&"string"==typeof s){var a=i.toUpperCase(),n=s.toUpperCase();return(h?a>n:a<n)?-1:(h?a<n:a>n)?1:0}})}if(a||n)if(i){var d=s.toTransform(i);if(a&&!n)for(var g=0,y=t;g<y.length;g++){var m=y[g];l[p++]={attributes:r.getAttributes(m),geometry:m.getGeometryQuantized(d)}}else if(!a&&n)for(var v=0,b=t;v<b.length;v++){var m=b[v];l[p++]={attributes:r.getAttributes(m),centroid:m.getCentroidQuantized(d)}}else for(var F=0,S=t;F<S.length;F++){var m=S[F];l[p++]={attributes:r.getAttributes(m),centroid:m.getCentroidQuantized(d),geometry:m.getGeometryQuantized(d)}}}else if(a&&!n)for(var M=0,I=t;M<I.length;M++){var m=I[M];l[p++]={attributes:r.getAttributes(m),geometry:m.getGeometry()}}else if(!a&&n)for(var T=0,j=t;T<j.length;T++){var m=j[T];l[p++]={attributes:r.getAttributes(m),centroid:m.getCentroid()}}else for(var _=0,A=t;_<A.length;_++){var m=A[_];l[p++]={attributes:r.getAttributes(m),centroid:m.getCentroid(),geometry:m.getGeometry()}}else for(var N=0,w=t;N<w.length;N++){var m=w[N],R=r.getAttributes(m);R&&(l[p++]={attributes:R})}return l},e.prototype._createNew=function(t){return new e(t,this)},e.prototype._createStatisticsQueryResponse=function(e){var t=new o.default(e,this.fieldsMap),r=e.outStatistics,i=[],s=[];if(e.groupByFieldsForStatistics&&e.groupByFieldsForStatistics.length)for(var a={},n=0,u=r;n<u.length;n++){var l=u[n],p=l.onStatisticField,c=l.outStatisticFieldName,f=l.statisticType;if("count"===f){a[p]||(a[p]=this._calculateUniqueValues(t,p));var h=a[p];for(var d in h){var g=h[d],y={attributes:{}};y.attributes[c]=g.count,y.attributes[p]=g.data,i.push(y)}s.push({name:c,alias:c,type:"esriFieldTypeString"})}}else{for(var m={},v={attributes:{}},b=0,F=r;b<F.length;b++){var S=F[b],p=S.onStatisticField,c=S.outStatisticFieldName,f=S.statisticType;m[p]||(m[p]=this._calculateStatistics(t,p));var M=m[p],I="var"===f?"variance":f;v.attributes[c]=M[I],s.push({name:c,alias:c,type:"esriFieldTypeDouble"})}i.push(v)}return{fields:s,features:i}},e.prototype._calculateStatistics=function(e,t){for(var r=this.items,i=r.length,s=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,n=null,o=null,u=null,l=null,p=[],c=0;c<i;c++){var f=p[c]=e.getFieldAttribute(r[c],t);n+=f,s=Math.min(s,f),a=Math.max(a,f)}if(i){o=n/i;for(var h=0,d=0,g=p;d<g.length;d++){var f=g[d];h+=Math.pow(f-o,2)}l=i>1?h/(i-1):0,u=Math.sqrt(l)}else s=null,a=null;return{avg:o,count:i,max:a,min:s,stddev:u,sum:n,variance:l}},e.prototype._calculateUniqueValues=function(e,t){for(var r={},i=0,s=this.items;i<s.length;i++){var a=s[i],n=e.getFieldAttribute(a,t);(null==n||"string"==typeof n&&""===n.trim())&&(n=null),null==r[n]?r[n]={count:1,data:n}:r[n].count++}return r},e}();t.default=f});