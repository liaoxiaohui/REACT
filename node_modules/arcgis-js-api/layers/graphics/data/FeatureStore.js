// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","@dojo/shim/array","@dojo/shim/Map","@dojo/shim/Set","dojo/has","../../../geometry","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../core/libs/rbush/rbush","../../../geometry/projection","../../../geometry/support/aaBoundingRect","../../../geometry/support/normalizeUtils","../../../geometry/support/scaleUtils","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/spatialReferenceUtils","./attributeSupport","./FeatureStoreCapabilities","./FeatureStoreItem","./FeatureStoreResult","./projectionSupport","./SpatialQueryCache","./spatialQuerySupport","../../../tasks/support/Query"],function(e,t,r,i,n,o,a,u,s,c,l,h,f,p,d,y,m,g,v,x,S,_,Q,b,R){function I(e,t){return j.minX=t[0],j.minY=t[1],j.maxX=t[2],j.maxY=t[3],e.search(j)}function w(e){return e?JSON.parse(JSON.stringify(e,["latestWkid","wkid","wkt"])):e}function F(e,t,r,i,n,o){if(n&&!i)for(var a=0,u=r;a<u.length;a++){var s=u[a];e.push({attributes:s.getAttributes(),centroid:s.getCentroidQuantized(o)})}else if(i&&!n)for(var c=0,l=r;c<l.length;c++){var s=l[c];t.add(s.oid),e.push(new N(s.getAttributes(),s.getGeometryQuantized(o)))}else for(var h=0,f=r;h<f.length;h++){var s=f[h];t.add(s.oid),e.push(new N(s.getAttributes(),s.getGeometryQuantized(o),s.getCentroidQuantized(o)))}}Object.defineProperty(t,"__esModule",{value:!0});var M=s.getLogger("esri.layers.graphics.data.FeatureStore"),C=[],j={minX:0,minY:0,maxX:0,maxY:0},N=function(){function e(e,t,r){this.attributes=e,this.geometry=t,this.centroid=r}return e}(),G={},O=new n.default,k=function(){function e(e){var t=this;this._itemsMap=new i.default,this._index=l(9,o("csp-restrictions")?function(e){return{minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.capabilities={query:v.queryCapabilities},this.fieldsMap=new i.default,this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.cacheSpatialQueries=e.cacheSpatialQueries||!1,this.gdbVersion=e.gdbVersion,this.historicMoment=e.historicMoment,this.cacheSpatialQueries&&(this._geometryQueryCache=new Q.default),e.fields.forEach(function(e){t.fieldsMap.set(e.name.trim(),e),t.fieldsMap.set(e.name.trim().toLowerCase(),e)})}return e.prototype.destroy=function(){this.clear(),this.fieldsMap.clear()},e.prototype.clear=function(){this._itemsMap.forEach(function(e){x.default.release(e)}),this._itemsMap.clear(),this._index.clear(),this._clearCache()},Object.defineProperty(e.prototype,"size",{get:function(){return this._itemsMap.size},enumerable:!0,configurable:!0}),e.prototype.load=function(e){var t=y.getInfo(this.spatialReference),r=this._itemsMap,i=this.objectIdField;this._clearCache();for(var n=0,o=e;n<o.length;n++){var a=o[n];if(a.geometry.coords.length){var s=a.attributes[i];if(null!=s){var c=void 0;r.has(s)?(c=r.get(s),this._index.remove(c),c.set(a)):(c=x.default.acquire(a,this),r.set(s,c)),t&&(c.bounds[0]<t.valid[0]||c.bounds[2]>t.valid[1])?M.error(new u("load:invalid-bounds","The feature has bounds outside of the valid coordinate range",{valid:t.valid,feature:a})):C.push(c)}else M.error(new u("featurestore:invalid-feature","feature id is invalid, "+i+" is missing",{feature:a}))}}C.length&&this._index.load(C),C.length=0},e.prototype.delete=function(e){for(var t=this._index,r=this._itemsMap,i=0,n=e;i<n.length;i++){var o=n[i],a=this._itemsMap.get(o);a&&(t.remove(a),r.delete(o),x.default.release(a))}this._clearCache()},e.prototype.searchBounds=function(e){return I(this._index,e)},e.prototype.executeQuery=function(e){var t=this;void 0===e&&(e=new R);var r=e.clone();return this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).catch(function(e){if(e===G)return new S.default([],t);throw e}).then(function(e){return e.createQueryResponse(r)})},e.prototype.executeQueryForCount=function(e){var t=this;void 0===e&&(e=new R);var r=e.clone();return this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){return e.size}).catch(function(e){if(e===G)return 0;throw e})},e.prototype.executeQueryForExtent=function(e){var t=this;void 0===e&&(e=new R);var r=e.clone();return this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){var i=e.size;if(!i)return{count:i,extent:null};for(var n={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:w(t.spatialReference)},o=0,a=e.items;o<a.length;o++){var u=a[o],s=u.bounds;s&&(n.xmin=Math.min(s[0],n.xmin),n.ymin=Math.min(s[1],n.ymin),n.xmax=Math.max(s[2],n.xmax),n.ymax=Math.max(s[3],n.ymax))}var c=_.project(n,e.spatialReference,r.outSpatialReference);if(c.spatialReference=w(r.outSpatialReference&&r.outSpatialReference.toJSON()||t.spatialReference),c.xmax-c.xmin==0){var l=d.getMetersPerUnitForSR(c.spatialReference);c.xmin-=l,c.xmax+=l}if(c.ymax-c.ymin==0){var l=d.getMetersPerUnitForSR(c.spatialReference);c.ymin-=l,c.ymax+=l}return{count:i,extent:c}}).catch(function(e){if(e===G)return{count:0,extent:null};throw e})},e.prototype.executeQueryForIds=function(e){var t=this;void 0===e&&(e=new R);var r=e.clone();return this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){for(var t=e.items,r=[],i=0;i<t.length;i++)r[i]=t[i].oid;return r}).catch(function(e){if(e===G)return[];throw e})},e.prototype.executeTileQuery=function(e,t){var r,i=t.returnGeometry,o=t.returnCentroid,a=t.pixelBuffer,u=new n.default,s=[],c=a*e.resolution,l=f.pad(e.bounds,c,f.create());if(r=I(this._index,l),r.sort(function(e,t){return e.oid-t.oid}),F(s,u,r,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]}),"esriGeometryPoint"===this.geometryType||o){var h=y.getInfo(this.spatialReference);if(h){var p=h.valid,d=p[0],m=p[1];if(l[0]<d){var g=f.fromValues(m-c,l[1],m,l[3]);r=I(this._index,g),r.sort(function(e,t){return e.oid-t.oid}),F(s,u,r,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[m,e.bounds[3]]})}if(l[2]>m){var v=f.fromValues(d,l[1],d+c,l[3]);r=I(this._index,v),r.sort(function(e,t){return e.oid-t.oid}),F(s,u,r,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[d-m+e.bounds[0],e.bounds[3]]})}}}return{features:s,objectIds:u}},e.prototype._clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null},e.prototype._getAll=function(){return this._allItems||(this._allItems=new S.default(r.from(this._itemsMap,function(e){e[0];return e[1]}),this)),this._allItems},e.prototype._normalizeQuery=function(e){var t=this,r=this.definitionExpression,i=e.where,n=e.geometry,o=e.outFields,a=e.orderByFields,u=e.groupByFieldsForStatistics,s=e.outStatistics;if(e.where=i=i&&i.trim(),(!i||/^1 *= *1$/.test(i)||r&&r===i)&&(e.where=null),o)for(var l=0;l<o.length;l++)o[l]=o[l].trim();if(a)for(var l=0;l<a.length;l++)a[l]=a[l].trim();if(u)for(var l=0;l<u.length;l++)u[l]=u[l].trim();if(s)for(var l=0;l<s.length;l++)s[l].onStatisticField=s[l].onStatisticField.trim();return n?(e.outSpatialReference||(e.outSpatialReference=n.spatialReference),this._getInputGeometry(e).then(function(t){return e.geometry=t}).then(function(r){return _.checkProjectionSupport(e,r.spatialReference,t.spatialReference)}).then(function(){return p.normalizeCentralMeridian(e.geometry)}).then(function(e){return _.project(e[0].toJSON(),e[0].spatialReference,t.spatialReference)}).then(function(r){if(!r)throw G;return r.spatialReference=t.spatialReference,e.read({geometry:r})})):c.resolve(e)},e.prototype._executeGeometryQuery=function(e){var t=this,r=e.geometry,i=e.outSpatialReference,n=e.spatialRelationship,o=i&&!m.equals(this.spatialReference,i),a=o?JSON.stringify({geometry:r,spatialRelationship:n,outSpatialReference:i}):JSON.stringify({geometry:r,spatialRelationship:n});if(this.cacheSpatialQueries&&this._geometryQueryCache.size&&this._geometryQueryCache.has(a))return c.resolve(this._geometryQueryCache.get(a));var u=null;if(r){var s=this._searchSpatialIndex(this._getQueryBBoxes(r));if(!s.length){var l=new S.default([],this);return this.cacheSpatialQueries&&this._geometryQueryCache.set(a,l),c.resolve(l)}u="envelope-intersects"===e.spatialRelationship||"esriGeometryPoint"===this.geometryType&&b.canQueryWithRBush(r)?c.resolve(new S.default(s,this)):b.getSpatialQueryOperator(n,r,this.geometryType).then(function(e){if(e){var r=s.filter(function(t){return e(t.getGeometry())});return new S.default(r,t)}})}else u=c.resolve(this._getAll());return u.then(function(r){return o&&(e.returnGeometry||e.returnCentroid)?r.project(i).then(function(e){return t.cacheSpatialQueries&&t._geometryQueryCache.set(a,e),e}):(t.cacheSpatialQueries&&t._geometryQueryCache.set(a,r),r)})},e.prototype._getInputGeometry=function(e){var t=e.geometry,r=e.distance,i=e.units;if(null==r)return c.resolve(t);var n=t.spatialReference,o=i||d.getUnitString(n),u=n&&(n.isGeographic||n.isWebMercator),s=null;return s=u?c.resolve(t):_.checkProjectionSupport(e,n,a.SpatialReference.WGS84).then(function(){return h.project(t,a.SpatialReference.WGS84)}),s.then(function(e){return b.getGeodesicBufferOperator().then(function(t){return t(e,r,o)})})},e.prototype._getQueryBBoxes=function(e){if("point"===e.type)return[f.fromValues(e.x,e.y,e.x,e.y)];var t=b.canQueryWithRBush(e)?e:e.extent;switch(t.type){case"extent":return[f.fromExtent(t)];case"polygon":return t.rings.map(function(e){return f.fromValues(e[0][0],e[0][1],e[2][0],e[2][1])})}},e.prototype._searchSpatialIndex=function(e){for(var t=[],r=0,i=e;r<i.length;r++)for(var n=i[r],o=0,a=I(this._index,n);o<a.length;o++){var u=a[o];O.has(u)||(t.push(u),O.add(u))}return O.clear(),t},e.prototype._checkQuerySupport=function(e){return e.distance<0||null!=e.geometryPrecision||null!=e.maxAllowableOffset||e.multipatchOption||e.pixelSize||e.relationParameter||e.text||e.timeExtent?c.reject(new u("feature-store:unsupported-query","Unsupported query options",{query:e})):c.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),b.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),_.checkProjectionSupport(e,this.spatialReference,e.outSpatialReference)]).then(function(){return e})},e.prototype._checkAttributesQuerySupport=function(e){var t=e.outFields,r=e.orderByFields,i=e.returnDistinctValues;if(r&&r.length>0){var n=r.map(function(e){return e.indexOf(" ASC")>-1?e.split(" ASC")[0]:e.indexOf(" DESC")>-1?e.split(" DESC")[0]:e});g.validateFields(this.fieldsMap,n,"orderByFields contains missing fields",!1)}if(t&&t.length>0)g.validateFields(this.fieldsMap,t,"outFields contains missing fields");else if(i)throw new u("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:e});g.validateWhere(this.fieldsMap,e.where)},e.prototype._checkStatisticsQuerySupport=function(e){var t=e.outStatistics,r=e.groupByFieldsForStatistics;if(t&&t.length){var i=t.map(function(e){return e.onStatisticField.trim()});g.validateFields(this.fieldsMap,i,"onStatisticFields contains missing fields");for(var n=0,o=i;n<o.length;n++){var a=o[n];if(!(r&&r.length)&&g.hasInvalidFieldType(a,this.fieldsMap))return c.reject(new u("feature-store:unsupported-query","outStatistics contains non-numeric fields",{fieldName:a,query:e}))}}},e}();t.default=k});