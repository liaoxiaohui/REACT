// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger"],function(e,r,t,n){function o(e,r){var t=e.scale,n=e.translate;return Math.round((r-n[0])/t[0])}function s(e,r){var t=e.scale,n=e.translate;return Math.round((n[1]-r)/t[1])}function a(e,r){var t=e.scale,n=e.translate;return r*t[0]+n[0]}function i(e,r){var t=e.scale;return e.translate[1]-r*t[1]}function u(e,r,t){return r?t?m(e):c(e):t?f(e):h(e)}function h(e){var r=e.coords;return{x:r[0],y:r[1]}}function l(e){var r=new K;return r.coords[0]=e.x,r.coords[1]=e.y,r}function c(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2]}}function g(e){var r=new K;return r.coords[0]=e.x,r.coords[1]=e.y,r.coords[2]=e.z,r}function f(e){var r=e.coords;return{x:r[0],y:r[1],m:r[2]}}function d(e){var r=new K;return r.coords[0]=e.x,r.coords[1]=e.y,r.coords[2]=e.m,r}function m(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2],m:r[3]}}function v(e){var r=new K;return r.coords[0]=e.x,r.coords[1]=e.y,r.coords[2]=e.z,r.coords[3]=e.m,r}function I(e,r,t){var n=h;t&&r?n=m:t?n=c:r&&(n=f);for(var o=[],s=0,a=e;s<a.length;s++){var i=a[s],u=i.geometry,l=i.attributes,g=u?n(u):null;o.push({attributes:l,geometry:g})}return o}function y(e,r,t){var n=l;t&&r?n=v:t?n=g:r&&(n=d);for(var o=[],s=0,a=e;s<a.length;s++){var i=a[s],u=i.geometry,h=i.attributes,c=u?n(u):void 0;o.push(new W(c,h))}return o}function p(e,r,t){for(var n=[],o=0,s=e;o<s.length;o++){var a=s[o],i=a.geometry,u=a.attributes,h=void 0;i&&(h=N(i,r,t)),n.push({attributes:u,geometry:h})}return n}function N(e,r,t){for(var n=r?t?4:3:t?3:2,o=[],s=0;s<e.coords.length;s+=n){for(var a=[],i=0;i<n;i++)a.push(e.coords[s+i]);o.push(a)}return r?t?{points:o,hasZ:r,hasM:t}:{points:o,hasZ:r}:t?{points:o,hasM:t}:{points:o}}function T(e,r,t){for(var n=r?t?4:3:t?3:2,o=[],s=0,a=e;s<a.length;s++){var i=a[s],u=i.geometry,h=i.attributes,l=void 0;if(u){l=new K,l.lengths[0]=u.points.length;for(var c=l.coords,g=0,f=0,d=u.points;f<d.length;f++)for(var m=d[f],v=0;v<n;v++)c[g++]=m[v]}o.push(new W(l,h))}return o}function b(e,r,t){for(var n=[],o=0,s=e;o<s.length;o++){var a=s[o],i=a.geometry,u=a.attributes,h=void 0;i&&(h=F(i,r,t)),n.push({attributes:u,geometry:h})}return n}function F(e,r,t){for(var n=r?t?4:3:t?3:2,o=e.coords,s=e.lengths,a=[],i=0,u=0,h=s;u<h.length;u++){for(var l=h[u],c=[],g=0;g<l;g++){for(var f=[],d=0;d<n;d++)f.push(o[i++]);c.push(f)}a.push(c)}return r?t?{paths:a,hasZ:r,hasM:t}:{paths:a,hasZ:r}:t?{paths:a,hasM:t}:{paths:a}}function M(e,r,t){for(var n=r?t?4:3:t?3:2,o=[],s=0,a=e;s<a.length;s++){var i=a[s],u=i.geometry,h=i.attributes,l=void 0;if(u){l=new K;for(var c=l.lengths,g=l.coords,f=0,d=0,m=u.paths;d<m.length;d++){for(var v=m[d],I=0,y=v;I<y.length;I++)for(var p=y[I],N=0;N<n;N++)g[f++]=p[N];c.push(v.length)}}o.push(new W(l,h))}return o}function G(e,r,t){for(var n=[],o=0,s=e;o<s.length;o++){var a=s[o],i=a.geometry,u=a.attributes,l=a.centroid,c=void 0;if(i&&(c=E(i,r,t)),l){var g=h(l);n.push({attributes:u,centroid:g,geometry:c})}else n.push({attributes:u,geometry:c})}return n}function E(e,r,t){for(var n=r?t?4:3:t?3:2,o=e.coords,s=e.lengths,a=[],i=0,u=0,h=s;u<h.length;u++){for(var l=h[u],c=[],g=0;g<l;g++){for(var f=[],d=0;d<n;d++)f.push(o[i++]);c.push(f)}a.push(c)}return r?t?{rings:a,hasZ:r,hasM:t}:{rings:a,hasZ:r}:t?{rings:a,hasM:t}:{rings:a}}function w(e,r,t){for(var n=r?t?4:3:t?3:2,o=[],s=0,a=e;s<a.length;s++){var i=a[s],u=i.geometry,h=i.centroid,c=i.attributes,g=void 0;if(u){g=new K;for(var f=g.lengths,d=g.coords,m=0,v=0,I=u.rings;v<I.length;v++){for(var y=I[v],p=0,N=y;p<N.length;p++)for(var T=N[p],b=0;b<n;b++)d[m++]=T[b];f.push(y.length)}}h?o.push(new W(g,c,l(h))):o.push(new W(g,c))}return o}function P(e,r,n,o){if(!r)return[];switch(r){case"esriGeometryPoint":return y(e,n,o);case"esriGeometryMultipoint":return T(e,n,o);case"esriGeometryPolyline":return M(e,n,o);case"esriGeometryPolygon":return w(e,n,o);default:return B.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type "+r)),[]}}function z(e){var r=[],n=e.objectIdFieldName,o=e.spatialReference,s=e.transform,a=e.fields,i=e.hasM,u=e.hasZ,h=e.features,l=e.geometryType,c=e.exceededTransferLimit;switch(l){case"esriGeometryPoint":r=I(h,u,i);break;case"esriGeometryMultipoint":r=p(h,u,i);break;case"esriGeometryPolyline":r=b(h,u,i);break;case"esriGeometryPolygon":r=G(h,u,i);break;default:B.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type "+l))}var g={features:r,fields:a,geometryType:l,objectIdFieldName:n,spatialReference:o};return s&&(g.transform=s),c&&(g.exceededTransferLimit=c),i&&(g.hasM=i),u&&(g.hasZ=u),g}function O(e){var r=new J,t=e.hasM,n=e.hasZ,o=e.features,s=e.objectIdFieldName,a=e.spatialReference,i=e.geometryType,u=e.exceededTransferLimit,h=e.transform;return r.fields=e.fields,r.geometryType=i,r.objectIdFieldName=s,r.spatialReference=a,r.features=P(o,i,n,t),u&&(r.exceededTransferLimit=u),t&&(r.hasM=t),n&&(r.hasZ=n),h&&(r.transform=h),r}function x(e){var r=e.transform,t=e.features,n=e.hasM,o=e.hasZ;if(!r)return e;for(var s=0,a=t;s<a.length;s++){var i=a[s];k(i.geometry,i.geometry,n,o,r),i.centroid&&k(i.centroid,i.centroid,n,o,r)}return e.transform=null,e}function Y(e,r){var n=r.geometryType,o=r.features,s=r.hasM,a=r.hasZ;if("esriGeometryEnvelope"===n)return B.error(new t("optimized-features:invalid-geometry-type",'FeatureSet with geometry type "'+n+'" is not supported')),r;if(!e)return r;for(var i=0;i<o.length;i++){var u=o[i],h=new W(new K,u.attributes);_(h.geometry,u.geometry,s,a,n,e),u.centroid&&(h.centroid=new K,_(h.centroid,u.centroid,s,a,"esriGeometryPoint",e)),o[i]=h}return r.transform=e,r}function _(e,r,t,n,a,i){var u=U[a],h=r.coords,l=r.lengths,c=t?n?4:3:n?3:2,g=t?n?H:Q:n?Q:X;if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!h.length)return e;if(!l.length)return g(e.coords,h,0,0,o(i,h[0]),s(i,h[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=c,e;for(var f,d,m,v,I=0,y=0,p=y,N=0,T=l;N<T.length;N++){var b=T[N];if(!(b<u)){var F=0;y=p,m=f=o(i,h[I]),v=d=s(i,h[I+1]),g(e.coords,h,y,I,m,v),F++,I+=c,y+=c;for(var M=1;M<b;M++,I+=c)m=o(i,h[I]),v=s(i,h[I+1]),m===f&&v===d||(g(e.coords,h,y,I,m-f,v-d),y+=c,F++,f=m,d=v);F>=u&&(e.lengths.push(F),p=y)}}return e.coords.length=p,e.coords.length?e:null}function S(e,r,t,n,a,i){var u=U[a],h=r.coords,l=r.lengths,c=t?n?4:3:n?3:2,g=t?n?H:Q:n?Q:X;if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!h.length)return e;if(!l.length)return g(e.coords,h,0,0,o(i,h[0]),s(i,h[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=c,e;for(var f,d,m,v,I=0,y=0,p=y,N=0,T=l;N<T.length;N++){var b=T[N];if(!(b<u)){var F=0;y=p,m=f=o(i,h[I]),v=d=s(i,h[I+1]),g(e.coords,h,y,I,m,v),F++,I+=c;for(var M=!1,G=0,E=0,w=1;w<b;w++,I+=c)if(m=o(i,h[I]),v=s(i,h[I+1]),m!==f||v!==d){var P=m-f,z=v-d;M&&(0===G&&0===P||0===E&&0===z)?(G+=P,E+=z,g(e.coords,h,y,I,G,E)):(M=!0,G=P,E=z,y+=c,F++,g(e.coords,h,y,I,G,E)),f=m,d=v}M&&(y+=c,g(e.coords,h,y,I,G,E)),F>=u&&(e.lengths.push(F),p=y)}}return e.coords.length!==p&&(e.coords.length=p),e.coords.length?e:null}function V(e,r,t,n){for(var o=t?n?4:3:n?3:2,s=r.coords,a=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,l=0;l<s.length;l+=o){var c=s[l],g=s[l+1];a=Math.min(a,c),u=Math.max(u,c),i=Math.min(i,g),h=Math.max(h,g)}return e[0]=a,e[1]=i,e[2]=u,e[3]=h,e}function Z(e,r,t,n){for(var o=t?n?4:3:n?3:2,s=r.lengths,a=r.coords,i=Number.POSITIVE_INFINITY,u=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY,c=0,g=0,f=s;g<f.length;g++){var d=f[g],m=a[c],v=a[c+1];i=Math.min(m,i),u=Math.min(v,u),h=Math.max(m,h),l=Math.max(v,l),c+=o;for(var I=1;I<d;I++,c+=o){var y=a[c],p=a[c+1];m+=y,v+=p,y<0&&(i=Math.min(i,m)),y>0&&(h=Math.max(h,m)),p<0?u=Math.min(u,v):p>0&&(l=Math.max(l,v))}}return e[0]=i,e[1]=u,e[2]=h,e[3]=l,e}function k(e,r,t,n,o){var s=r.coords,u=r.lengths,h=t?n?H:Q:n?Q:X,l=t?n?4:3:n?3:2;if(!s.length)return e!==r&&(e.lengths.length=0,e.coords.length=0),e;if(!u.length)return h(e.coords,s,0,0,a(o,s[0]),i(o,s[1])),e!==r&&(e.lengths.length=0,e.coords.length=l),e;for(var c=o.scale,g=c[0],f=c[1],d=0,m=0;m<u.length;m++){var v=u[m];e.lengths[m]=v;var I=a(o,s[d]),y=i(o,s[d+1]);h(e.coords,s,d,d,I,y),d+=l;for(var p=1;p<v;p++,d+=l)I+=s[d]*g,y-=s[d+1]*f,h(e.coords,s,d,d,I,y)}return e!==r&&(e.lengths.length=u.length,e.coords.length=s.length),e}function A(e,r,t,n){if(!r||!r.lengths.length)return null;e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0);for(var o=e.coords,s=[],a=t?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],i=r.lengths,u=r.coords,h=t?n?4:3:n?3:2,l=0,c=0,g=i;c<g.length;c++){var f=g[c],d=L(a,u,l,f,t,n);d&&s.push(d),l+=f*h}if(s.sort(function(e,r){var n=e[2]-r[2];return 0===n&&t&&(n=e[4]-r[4]),n}),s.length){var m=6*s[0][2];o[0]=s[0][0]/m,o[1]=s[0][1]/m,t&&(m=6*s[0][4],o[2]=0!==m?s[0][3]/m:0),(o[0]<a[0]||o[0]>a[1]||o[1]<a[2]||o[1]>a[3]||t&&(o[2]<a[4]||o[2]>a[5]))&&(o.length=0)}if(!o.length){var v=r.lengths[0]?q(u,0,i[0],t,n):null;if(!v)return null;o[0]=v[0],o[1]=v[1],t&&v.length>2&&(o[2]=v[2])}return e}function L(e,r,t,n,o,s){for(var a=o?s?4:3:s?3:2,i=t,u=t+a,h=0,l=0,c=0,g=0,f=0,d=0,m=n-1;d<m;d++,i+=a,u+=a){var v=r[i],I=r[i+1],y=r[i+2],p=r[u],N=r[u+1],T=r[u+2],b=v*N-p*I;g+=b,h+=(v+p)*b,l+=(I+N)*b,o&&(b=v*T-p*y,c+=(y+T)*b,f+=b),v<e[0]&&(e[0]=v),v>e[1]&&(e[1]=v),I<e[2]&&(e[2]=I),I>e[3]&&(e[3]=I),o&&(y<e[4]&&(e[4]=y),y>e[5]&&(e[5]=y))}if(g>0&&(g*=-1),f>0&&(f*=-1),!g)return null;var F=[h,l,.5*g];return o&&(F[3]=c,F[4]=.5*f),F}function q(e,r,t,n,o){for(var s=n?o?4:3:o?3:2,a=r,i=r+s,u=0,h=0,l=0,c=0,g=0,f=t-1;g<f;g++,a+=s,i+=s){var d=e[a],m=e[a+1],v=e[a+2],I=e[i],y=e[i+1],p=e[i+2],N=n?R(d,m,v,I,y,p):j(d,m,I,y);if(N)if(u+=N,n){var T=C(d,m,v,I,y,p);h+=N*T[0],l+=N*T[1],c+=N*T[2]}else{var T=D(d,m,I,y);h+=N*T[0],l+=N*T[1]}}return u>0?n?[h/u,l/u,c/u]:[h/u,l/u]:t>0?n?[e[r],e[r+1],e[r+2]]:[e[r],e[r+1]]:null}function j(e,r,t,n){var o=t-e,s=n-r;return Math.sqrt(o*o+s*s)}function R(e,r,t,n,o,s){var a=n-e,i=o-r,u=s-t;return Math.sqrt(a*a+i*i+u*u)}function D(e,r,t,n){return[e+.5*(t-e),r+.5*(n-r)]}function C(e,r,t,n,o,s){return[e+.5*(n-e),r+.5*(o-r),t+.5*(s-t)]}Object.defineProperty(r,"__esModule",{value:!0});var B=n.getLogger("esri.tasks.support.optimizedFeatureSet"),U={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},X=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s},Q=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s,e[t+2]=r[n+2]},H=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s,e[t+2]=r[n+2],e[t+3]=r[n+3]};r.quantizeX=o,r.quantizeY=s,r.hydrateX=a,r.hydrateY=i;var J=function(){function e(){this.objectIdFieldName=null,this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1}return e}();r.OptimizedFeatureSet=J;var K=function(){function e(e,r){void 0===e&&(e=[]),void 0===r&&(r=[]),this.lengths=e,this.coords=r}return e}();r.OptimizedGeometry=K;var W=function(){function e(e,r,t){void 0===e&&(e=null),void 0===r&&(r={}),this.geometry=e,this.attributes=r,t&&(this.centroid=t)}return e}();r.OptimizedFeature=W,r.convertToPoint=u,r.convertToMultipoint=N,r.convertToPolyline=F,r.convertToPolygon=E,r.convertFromFeatures=P,r.convertToFeatureSet=z,r.convertFromFeatureSet=O,r.hydrateOptimizedFeatureSet=x,r.quantizeOptimizedFeatureSet=Y,r.quantizeOptimizedGeometry=_,r.quantizeOptimizedGeometryRemoveCollinear=S,r.getBoundsOptimizedGeometry=V,r.getQuantizedBoundsOptimizedGeometry=Z,r.hydrateOptimizedGeometry=k,r.getCentroidOptimizedGeometry=A,r.lineCentroid=q,r.getLength2D=j,r.getLength3D=R,r.getMidpoint2D=D,r.getMidpoint3D=C});