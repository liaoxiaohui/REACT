// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/assignHelper","../../../core/Accessor","../../../core/Collection","../../../core/Error","../../../core/Handles","../../../core/lang","../../../core/Logger","../../../core/Promise","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../support/arcgisLayerUrl","../../../portal/support/geometryServiceUtils","../../../views/3d/layers/graphics/Graphics3DVerticalScale","../../../views/3d/layers/support/FeatureTileFetcher3D","../../../views/3d/layers/support/FeatureTileFetcher3DDebugger","../../../views/3d/support/debugFlags"],function(e,t,r,i,n,a,s,o,c,l,u,p,h,d,f,y,v,E,D,F,g){var m=u.getLogger("esri.layers.graphics.controllers.FeatureTileController3D"),x=function(e){function t(t){var r=e.call(this)||this;return r.type="feature-tile-3d",r.serviceDataExtent=null,r.serviceDataExtentIsAccurate=!1,r.serviceDataCount=a.constants.NO_SERVICE_DATA_COUNT,r.suspended=!1,r.tileFetcher=null,r.handles=new c,r.fetchDataInfoPromise=null,r}r(t,e),a=t,Object.defineProperty(t.prototype,"extent",{set:function(e){if(e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void m.error("#extent=","extent needs to be in the same spatial reference as the view");var t=this._get("extent");if(t!==e&&!(t&&e&&t.equals(e))){var r=e?e.clone():null;this._set("extent",r)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.tileFetcher&&this.tileFetcher.updating||this.fetchDataInfoPromise)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"displayLimitExceeded",{get:function(){return!(!this.tileFetcher||!this.tileFetcher.displayLimitExceeded)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filteredDataExtent",{get:function(){var e=this.serviceDataExtentIsAccurate?this.serviceDataExtent:null;return this.extent?e?e.clone().intersection(this.extent):this.extent:e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"displayFeatureLimit",{set:function(e){this._set("displayFeatureLimit",e),"snapshot"===this.mode&&this._set("displayFeatureLimit",n({},e,{perTile:e.max})),this.tileFetcher&&(this.tileFetcher.displayFeatureLimit=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){return this.serviceDataCount!==a.constants.NO_SERVICE_DATA_COUNT&&this.displayFeatureLimit&&this.displayFeatureLimit.min&&this.serviceDataCount<=this.displayFeatureLimit.min?"snapshot":"tiles"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tileDescriptors",{get:function(){return"snapshot"===this.mode?new s([{id:"dummy-tile-full-extent"}]):this.layerView.view.featureTiles.tiles},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"suspendResumeExtentMode",{get:function(){return"snapshot"===this.mode?"computed":"data"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{fetchDataInfoPromise:this.fetchDataInfoPromise}},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this,t=h.resolve().then(function(){return e.verifyCapabilities()}).then(function(){return e.fetchServiceDataInfo()}).then(function(){return e.initializeTileFetcher()});this.addResolvingPromise(t)},t.prototype.verifyCapabilities=function(){var e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery"))throw new o("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})},t.prototype.destroy=function(){this.cancelFetchServiceDataInfo(),this.tileFetcher&&(this.tileFetcher.destroy(),this.tileFetcher=null),this.handles&&(this.handles.destroy(),this.handles=null)},t.prototype.suspend=function(){this.suspended||(this.suspended=!0,this.tileFetcher&&this.tileFetcher.suspend())},t.prototype.resume=function(){this.suspended&&(this.suspended=!1,this.tileFetcher&&this.tileFetcher.resume())},t.prototype.refresh=function(){var e=this,t=function(){e.tileFetcher&&e.tileFetcher.filtersChanged()};this.fetchServiceDataInfo().then(t,t)},t.prototype.initializeTileFetcher=function(){var e=this,t=this.layerView.view,r=this.layerView.layer;this.handles.add(d.whenOnce(t.featureTiles,"tilingScheme",function(){e.handles.add(t.featureTiles.addClient()),e.tileFetcher=new D.FeatureTileFetcher3D({layer:r,filterExtent:e.filteredDataExtent,tilingScheme:t.featureTiles.tilingScheme,tileDescriptors:e.tileDescriptors,features:e.graphics,displayFeatureLimit:e.displayFeatureLimit,verticalScale:new E({sourceSpatialReference:r.spatialReference,destSpatialReference:t.spatialReference})}),e.suspended?e.tileFetcher.suspend():e.tileFetcher.resume(),e.handles.add([r.watch("definitionExpression",function(){return e.definitionExpressionChanged()}),r.watch("outFields",function(t,r){return e.attributesChanged(t,r)}),r.on("apply-edits",function(t){return e.tileFetcher.applyEdits(t)}),e.watch("filteredDataExtent",function(t){return e.tileFetcher.filterExtent=t},!0),e.watch("tileDescriptors",function(t){return e.tileFetcher.tileDescriptors=t},!0)],"layer"),e.handles.add(d.init(g,"FEATURE_TILE_FETCH_SHOW_TILES",function(r){r&&e.tileFetcher&&!e.tileFetcher.debugger?(e.tileFetcher.debugger=new F.FeatureTileFetcher3DDebugger(e.tileFetcher,t.featureTiles.tilingScheme.toTileInfo(),t),e.tileFetcher.debugger.update()):!r&&e.tileFetcher&&e.tileFetcher.debugger&&(e.tileFetcher.debugger.destroy(),e.tileFetcher.debugger=null)}))}))},t.prototype.definitionExpressionChanged=function(){this.refresh()},t.prototype.attributesChanged=function(e,t){if(!e||-1===e.indexOf("*"))if(e&&t)for(var r=new Set(e),i=0,n=t;i<n.length;i++){var a=n[i];if(!r.has(a))return void this.refresh()}else this.refresh()},t.prototype.createDataInfoQuery=function(){var e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsResultType&&(t.resultType="tile"),t},t.prototype.fullExtentIsAccurate=function(){var e=this.layerView,t=e.layer;if(t.definitionExpression)return!1;switch(t.type){case"feature":return y.isHostedAgolService(t.url);case"csv":return!0}},t.prototype.fetchServiceDataExtent=function(){var e=this,t=this.layerView,r=t.layer,i=r.capabilities.query.supportsExtent,n=l.clone(t.fullExtentInLocalViewSpatialReference),s=r.fullExtent,o=this.fullExtentIsAccurate(),c=this.serviceDataCount,u=i&&c<=a.constants.MAX_FEATURE_COUNT_FOR_EXTENT&&(!n||!o),p=null;if(u){var h=this.createDataInfoQuery();p=r.queryExtent(h,{timeout:a.constants.QUERY_EXTENT_TIMEOUT}).then(function(t){e._set("serviceDataExtentIsAccurate",!0),e._set("serviceDataExtent",t.extent)})}else n?(this._set("serviceDataExtentIsAccurate",o),this._set("serviceDataExtent",n)):s?p=v.projectGeometry(s,t.view.spatialReference,r.portalItem).then(function(t){e._set("serviceDataExtentIsAccurate",o),e._set("serviceDataExtent",t)}):(this._set("serviceDataExtentIsAccurate",!1),this._set("serviceDataExtent",null));return p&&(p=p.catch(function(t){t&&"cancel"===t.dojoType||(e._set("serviceDataExtentIsAccurate",!!n&&o),e._set("serviceDataExtent",n))})),p},t.prototype.fetchServiceDataInfo=function(){var e=this;this.cancelFetchServiceDataInfo();var t=this.layerView.layer,r=t.queryFeatureCount(this.createDataInfoQuery(),{timeout:a.constants.QUERY_COUNT_TIMEOUT}).then(function(t){return e._set("serviceDataCount",t),t}).catch(function(t){if(t&&"cancel"===t.dojoType)throw t;var r=a.constants.NO_SERVICE_DATA_COUNT;return e._set("serviceDataCount",r),r}),i=r.then(function(){return e.fetchServiceDataExtent()}).catch(function(e){console.error(e)}).then(function(){i===e.fetchDataInfoPromise&&(e.fetchDataInfoPromise=null)});return i.isFulfilled()||(this.fetchDataInfoPromise=i),r.catch(function(){})},t.prototype.cancelFetchServiceDataInfo=function(){var e=this.fetchDataInfoPromise;e&&(this.fetchDataInfoPromise=null,e.cancel())};var a;return i([f.property({readOnly:!0})],t.prototype,"type",void 0),i([f.property({constructOnly:!0})],t.prototype,"graphics",void 0),i([f.property({constructOnly:!0})],t.prototype,"layerView",void 0),i([f.property()],t.prototype,"extent",null),i([f.property({dependsOn:["tileFetcher.updating","fetchDataInfoPromise"]})],t.prototype,"updating",null),i([f.property({dependsOn:["tileFetcher.displayLimitExceeded"]})],t.prototype,"displayLimitExceeded",null),i([f.property({readOnly:!0})],t.prototype,"serviceDataExtent",void 0),i([f.property({readOnly:!0})],t.prototype,"serviceDataExtentIsAccurate",void 0),i([f.property({readOnly:!0})],t.prototype,"serviceDataCount",void 0),i([f.property({readOnly:!0,dependsOn:["extent","serviceDataExtent","serviceDataExtentIsAccurate"]})],t.prototype,"filteredDataExtent",null),i([f.property()],t.prototype,"displayFeatureLimit",null),i([f.property({readOnly:!0,dependsOn:["serviceDataCount","displayFeatureLimit"]})],t.prototype,"mode",null),i([f.property({readOnly:!0,dependsOn:["mode"]})],t.prototype,"tileDescriptors",null),i([f.property({readOnly:!0,dependsOn:["mode"]})],t.prototype,"suspendResumeExtentMode",null),i([f.property()],t.prototype,"tileFetcher",void 0),i([f.property()],t.prototype,"fetchDataInfoPromise",void 0),t=a=i([f.subclass("esri.layers.graphics.controllers.FeatureTileController3D")],t)}(f.declared(a,p));return function(e){!function(t){function r(){e.constants.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,e.constants.QUERY_COUNT_TIMEOUT=6e3,e.constants.QUERY_EXTENT_TIMEOUT=1e4}t.NO_SERVICE_DATA_COUNT=1/0,t.reset=r}(e.constants||(e.constants={}))}(x||(x={})),x.constants.reset(),x});