// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

//  copyright

/**
       * The copyright text as defined by the image service.
       *
       * @type {string}
       */

// We expose "copyrightText" as "copyright" in the SDK.

define(["./ArcGISService","../support/Field","../support/Raster","../support/PixelBlock","../support/MosaicRule","../support/RasterFunction","../support/DimensionalDefinition","../../geometry/Extent","../../geometry/Point","../../geometry/SpatialReference","../../tasks/QueryTask","../../tasks/ImageServiceIdentifyTask","../../tasks/support/ImageServiceIdentifyParameters","../../request","../../Graphic","../../PopupTemplate","../../core/lang","../../core/Accessor","../../core/kebabDictionary","../../core/promiseUtils","../../core/Logger"],function(e,t,i,r,a,n,s,o,l,u,c,d,p,f,h,m,y,g,v,b,x){var I=v({S8:"s8",S16:"s16",S32:"s32",U8:"u8",U16:"u16",U32:"u32",F32:"f32",F64:"f64"}),R=x.getLogger("esri.layers.mixins.ArcGISImageService"),D=g.createSubclass({properties:{layer:{},mosaicRule:{dependsOn:["layer.mosaicRule"],get:function(){return this.get("layer.mosaicRule")||null}},version:{value:0,dependsOn:["layer.bandIds","layer.format","layer.compressionQuality","layer.compressionTolerance","layer.interpolation","layer.noData","layer.noDataInterpretation","layer.mosaicRule","layer.renderingRule","layer.adjustAspectRatio"],get:function(){var e=this.layer;return e.bandIds,e.format,e.compressionQuality,e.compressionTolerance,e.interpolation,e.noData,e.noDataInterpretation,e.mosaicRule,e.renderingRule,e.adjustAspectRatio,this._get("version")+1}}},toJSON:function(){var e=this.layer;return{bandIds:e.bandIds?e.bandIds.join(","):null,format:e.format,compressionQuality:e.compressionQuality,compressionTolerance:e.compressionTolerance,interpolation:e.interpolation,noData:e.noData,noDataInterpretation:e.noDataInterpretation,mosaicRule:this.mosaicRule?JSON.stringify(this.mosaicRule.toJSON()):null,renderingRule:e.renderingRule?JSON.stringify(e.renderingRule.toJSON()):null,adjustAspectRatio:e.adjustAspectRatio}}});return e.createSubclass({declaredClass:"esri.layers.mixins.ArcGISImageService",getDefaults:function(){return y.mixin(this.inherited(arguments),{exportImageServiceParameters:{layer:this}})},_raster:null,properties:{adjustAspectRatio:{},bandCount:{},bandIds:{type:[Number],json:{write:!0}},capabilities:{json:{read:function(e){return e&&e.split(",").map(function(e){return e.trim()})}}},compressionQuality:{type:Number,json:{write:!0}},compressionTolerance:.01,copyright:{json:{read:{source:["copyrightText"],reader:function(e,t){return t.copyrightText}}}},definitionExpression:{get:function(){return this.mosaicRule?this.mosaicRule.where:null},set:function(e){var t=this.mosaicRule||new a;t.where=e,this._set("mosaicRule",t)},json:{read:{source:["definitionExpression","layerDefinition.definitionExpression"],reader:function(e,t){return e||t.layerDefinition&&t.layerDefinition.definitionExpression||void 0}}}},domainFields:{value:null,type:[t],dependsOn:["fields"],get:function(){return this.fields&&this.fields.filter(function(e){return null!=e.domain})||[]}},exportImageServiceParameters:{readOnly:!0,type:D},fields:{type:[t]},fullExtent:{type:o,json:{read:{source:["extent"],reader:function(e,t){return o.fromJSON(t.extent)}}}},format:{type:String,dependsOn:["pixelFilter"],get:function(){return null!=this.pixelFilter?"lerc":"jpgpng"},json:{write:!0}},hasRasterAttributeTable:{},hasMultidimensions:{},imageMaxHeight:{value:4100,json:{origins:{service:{read:{source:"maxImageHeight"}}}}},imageMaxWidth:{value:15e3,json:{origins:{service:{read:{source:"maxImageWidth"}}}}},interpolation:{type:String,json:{write:!0}},mosaicRule:{value:null,type:a,json:{origins:{service:{read:{source:["defaultMosaicMethod"],reader:function(e,t){return a.fromJSON(t)}}}},write:!0}},multidimensionalInfo:null,noData:{type:Number,json:{write:!0}},noDataInterpretation:{type:String,json:{write:!0}},objectIdField:{json:{read:{source:["fields"],reader:function(e,t){return!e&&t.fields&&t.fields.some(function(t){return"esriFieldTypeOID"===t.type&&(e=t.name),!!e}),e}}}},pixelFilter:{},pixelType:{type:String,value:null,json:{read:I.fromJSON,write:I.write}},pixelSizeX:{value:0},pixelSizeY:{value:0},popupTemplate:{value:null,type:m,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}},queryTask:{readOnly:!0,dependsOn:["url"],get:function(){return new c({url:this.url})}},renderer:{json:{origins:{service:{read:!1}},read:{source:"layerDefinition.drawingInfo.renderer",reader:function(){R.warn("Client side renderer configuration on ImageryLayer (id: "+this.id+", title: "+this.title+") is not yet supported. Visualization of the layer data may differ from what is expected.")}},write:!1}},rasterAttributeTable:null,rasterAttributeTableFieldPrefix:"Raster.",rasterFields:{value:null,dependsOn:["fields","rasterAttributeTable","rasterAttributeTableFieldPrefix"],get:function(){var e=this.rasterAttributeTableFieldPrefix,t={name:"Raster.ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:"string"},i={name:"Raster.ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:"string"},r=this.fields?y.clone(this.fields):[],a=r.length;if(r[a]=i,(this.capabilities&&this.capabilities.indexOf("Catalog")>-1||this.fields&&this.fields.length>0)&&(r[a+1]=t),y.isDefined(this.pixelFilter)&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)){var n={name:"Raster.Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"double"},s={name:"Raster.Direction",alias:"Direction",domain:null,editable:!1,type:"double"};r[a+2]=n,r[a+3]=s}var o=this.rasterAttributeTable&&this.rasterAttributeTable.fields||null;if(o&&o.length>0){var l=o.filter(function(e){return"esriFieldTypeOID"!==e.type&&"value"!==e.name.toLowerCase()}),u=l.map(function(t){var i=y.clone(t);return i.name=e+t.name,i});r=r.concat(u)}return r}},renderingRule:{value:null,type:n,json:{origins:{service:{read:{source:["rasterFunctionInfos"],reader:function(e,t){var i=t.rasterFunctionInfos;return t.renderingRule||i&&i.length&&"None"!==i[0].name?n.fromJSON(t.renderingRule||{rasterFunctionInfos:t.rasterFunctionInfos}):null}}}},write:!0}},serviceDataType:{},spatialReference:{value:null,readOnly:!0,json:{read:{source:["extent"],reader:function(e,t){return(e=t.extent&&t.extent.spatialReference)&&u.fromJSON(e)}}}},url:{},version:{value:null,readOnly:!0,json:{read:{source:["currentVersion","fields","timeInfo"],reader:function(e,t){return e=t.currentVersion,e||(e=t.hasOwnProperty("fields")||t.hasOwnProperty("objectIdField")||t.hasOwnProperty("timeInfo")?10:9.3),e}}}}},applyFilter:function(e){var t=this._clonePixelData(e);return this.pixelFilter&&this.pixelFilter(t),t},fetchImage:function(e,t,i,r){if(!(y.isDefined(this._raster)&&y.isDefined(e)&&y.isDefined(t)&&y.isDefined(i)))return b.reject(new Error("Insufficient parameters for requesting an image. A valid extent, width and height values are required."));var a=this.getExportImageServiceParameters(e,t,i,r),n={imageServiceParameters:a,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType};return this._raster.read(n)},fetchKeyProperties:function(){return f(this.parsedUrl.path+"/keyProperties",{query:y.mixin({f:"json"}),responseType:"json",callbackParamName:"callback"}).then(function(e){return e.data})},getExportImageServiceParameters:function(e,t,i,r){var e=e.clone().shiftCentralMeridian(),a=e&&e.spatialReference;return a=a&&(a.wkid||JSON.stringify(a.toJSON())),y.mixin({bbox:e&&e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,bboxSR:a,imageSR:a,size:t+","+i},this.exportImageServiceParameters.toJSON())},queryRasters:function(e){return this.queryTask.execute(e)},queryVisibleRasters:function(e,t){this._visibleRasters=[];var i=!1,r=this.popupTemplate;r&&r.fieldInfos&&r.fieldInfos.length>0&&(i=r.fieldInfos.length>1||"raster.servicepixelvalue"!==r.fieldInfos[0].toLowerCase()),r&&!i&&this.rasterFields&&(i=this.rasterFields.some(function(e){var t=e&&e.name?e.name.toLowerCase():null;return t&&"raster.servicepixelvalue"!==t&&(r.title&&r.title.toLowerCase().indexOf(t)>-1||r.content&&r.content.toLowerCase().indexOf(t)>-1)}));var a,n,s,o;if(t.layerView&&t.layerView.view){var u=t.layerView.view;if("2d"===u.type){var c=u.state;a=c.spatialReference.clone(),n=c.resolution}else a=u.spatialReference.clone(),n=u.resolution;n&&(s=new l(.5*n,.5*n,a)),o=a.equals(this.spatialReference)}var f=new p({geometry:e.geometry,returnCatalogItems:i,timeExtent:e.timeExtent,mosaicRule:this.mosaicRule||null,renderingRule:this.renderingRule||null,returnGeometry:o,outSpatialReference:a,pixelSize:s});return new d({url:this.url}).execute(f).then(function(e){return this._processVisibleRastersResponse(e,t)}.bind(this)).catch(function(e){throw new Error("Error querying for visible rasters")})},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType},_fetchService:function(){return b.resolve().then(function(){return this.resourceInfo||f(this.parsedUrl.path,{query:y.mixin({f:"json"},this.parsedUrl.query),responseType:"json",callbackParamName:"callback"})}.bind(this)).then(function(e){e.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),this.read(e.data,{origin:"service",url:this.parsedUrl}),this._raster=new i({url:this.url})}.bind(this)).then(function(){if(this.version>10&&this.hasRasterAttributeTable)return f(this.parsedUrl.path+"/rasterAttributeTable",{query:{f:"json"},responseType:"json"}).then(function(e){var t=e.data;t&&t.features&&t.fields&&this.read({rasterAttributeTable:t},{origin:"service",url:this.parsedUrl})}.bind(this))}.bind(this)).then(function(){if(this.version>=10.3&&this._isScientificData()&&this.hasMultidimensions)return f(this.parsedUrl.path+"/multiDimensionalInfo",{query:{f:"json"},responseType:"json"}).then(function(e){var t=e.data;t&&t.multidimensionalInfo&&(this._updateMultidimensionalDefinition(t.multidimensionalInfo),this.multidimensionalInfo=t.multidimensionalInfo)}.bind(this))}.bind(this))},_updateMultidimensionalDefinition:function(e){var t,i=e.variables[0].dimensions,r=[];for(t in i)if(i.hasOwnProperty(t)){var n=i[t],o=!0,l=n.extent,u=[l[0]];n.hasRanges&&!0===n.hasRanges?(o=!1,u=[n.values[0]]):"stdz"===n.name.toLowerCase()&&Math.abs(l[1])<=Math.abs(l[0])&&(u=[l[1]]),r.push(new s({variableName:"",dimensionName:i[t].name,isSlice:o,values:u}))}if(r.length>0){this.mosaicRule=this.mosaicRule||new a;var c=this.mosaicRule.multidimensionalDefinition;(!c||c&&c.length<=0)&&(this.mosaicRule.multidimensionalDefinition=r)}},_clonePixelData:function(e){if(null===e||void 0===e)return e;var t={};e.extent&&(t.extent=e.extent.clone());var i=e.pixelBlock;return null===i||void 0===i?t:(t.pixelBlock=i.clone(),t)},_processVisibleRastersResponse:function(e,t){var i,r,a,n,s=e.value,l=0,u=this.objectIdField,c=e.catalogItems&&e.catalogItems.features&&e.catalogItems.features.length||0;if(c){var d,p,f=0,m=0;for(r=[c],i=[c],n=[c],l=0;l<c;l++)e.properties.Values[l].toLowerCase().indexOf("nodata")>-1&&m++;for(d=c-m,l=0;l<c;l++)p=e.properties.Values[l].toLowerCase().indexOf("nodata")>-1?d++:f++,r[p]=e.catalogItems.features[l],i[p]=e.properties.Values[l],n[p]=r[p].attributes[u]}this._visibleRasters=[];var y,g=s.toLowerCase().indexOf("nodata")>-1;if(s&&!r&&!g){u="ObjectId",r=[];var v={};v.ObjectId=0,y=new h(new o(this.fullExtent),null,v),y.sourceLayer=this,r.push(y)}var b=[];if(!r)return b;var x,I,R=t&&t.returnDomainValues||!1;for(l=0,a=r.length;l<a;l++)y=r[l],y.sourceLayer=this,s&&(x=s,i&&i.length>=l&&(I=i[l],x=I.replace(/ /gi,", ")),y.attributes["Raster.ItemPixelValue"]=x,y.attributes["Raster.ServicePixelValue"]=s,this._updateFeatureWithMagDirValues(y,x),this._updateFeatureWithRasterAttributeTableValues(y,x)),R&&this._updateFeatureWithDomainValues(y),b.push(y);return b},_updateFeatureWithRasterAttributeTableValues:function(e,t){var i=this.rasterAttributeTable&&this.rasterAttributeTable.features;if(i&&!(i.length<1)&&this.rasterAttributeTableFieldPrefix){var r=null;if(i.forEach(function(e){e&&e.attributes&&(e.attributes.Value!=t&&e.attributes.VALUE!=t||(r=e))}),r){var a,n,s={};for(a in r.attributes)r.attributes.hasOwnProperty(a)&&(n=this.rasterAttributeTableFieldPrefix+a,s[n]=r.attributes[a]);e.attributes=y.mixin(e.attributes,s)}}},_updateFeatureWithMagDirValues:function(e,t){if(this.pixelFilter&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)){var i=t.replace(" ","").split(","),a=new r({height:1,width:1,pixelType:"f32",pixels:[],statistics:[]});i.forEach(function(e){a.addData({pixels:[e],statistics:{minValue:e,maxValue:e,noDataValue:null}})}),this.pixelFilter({pixelBlock:a,extent:new o(0,0,0,0,this.spatialReference)}),e.attributes["Raster.Magnitude"]=a.pixels[0][0],e.attributes["Raster.Direction"]=a.pixels[1][0]}},_updateFeatureWithDomainValues:function(e){var t=this.domainFields;y.isDefined(t)&&t.forEach(function(t){if(t){var i=e.attributes[t.name];if(y.isDefined(i)){var r=this._findMatchingDomainValue(t.domain,i);y.isDefined(r)&&(e.attributes[t.name]=r)}}},this)},_findMatchingDomainValue:function(e,t){var i=e&&e.codedValues;if(i){var r;return i.some(function(e){return e.code===t&&(r=e.name,!0)}),r}}})});