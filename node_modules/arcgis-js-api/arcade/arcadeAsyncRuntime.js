// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","dojo/Deferred","dojo/promise/all","dojo/promise/Promise","./Dictionary","./Feature","./FunctionWrapper","./ImmutablePathArray","./ImmutablePointArray","./kernel","./languageUtils","./treeAnalysis","./functions/date","./functions/geomasync","./functions/geometry","./functions/maths","./functions/stats","./functions/string","../geometry/Extent","../geometry/Geometry","../geometry/Multipoint","../geometry/Point","../geometry/Polygon","../geometry/Polyline","../geometry/SpatialReference"],function(e,r,n,t,o,a,c,i,l,s,u,f,v,p,d,h,m,b,g,E,k,w,N,y,I,O){function R(e){var r=new n;return e instanceof Error?r.reject(e):r.reject(new Error(e)),r.promise}function T(e){var r=new n;return r.resolve(e),r.promise}function S(e,r){for(var o=new n,a=[],c=0;c<r.arguments.length;c++)a.push(A(e,r.arguments[c]));return t(a).then(u.callback(function(e){o.resolve(e)},o),u.errback(o)),o.promise}function M(e,r,t){var o=new n;try{return S(e,r).then(u.callback(function(n){o.resolve(t(e,r,n))},o),u.errback(o)),o.promise}catch(e){return R(e)}}function C(e,r,t){var a=new n;try{return S(e,r).then(u.callback(function(n){var c=t(e,r,n);c instanceof o?c.then(u.callback(function(e){a.resolve(e)},a),u.errback(a)):a.resolve(c)},a),u.errback(a)),a.promise}catch(e){return R(e)}}function A(e,r){try{switch(r.type){case"VariableDeclarator":return re(e,r);case"VariableDeclaration":return ee(e,r,0);case"BlockStatement":return X(e,r);case"FunctionDeclaration":return $(e,r);case"ReturnStatement":return Q(e,r);case"IfStatement":return K(e,r);case"ExpressionStatement":return W(e,r);case"UpdateExpression":return z(e,r);case"AssignmentExpression":return Z(e,r);case"ForStatement":return D(e,r);case"ForInStatement":return q(e,r);case"BreakStatement":var t=new n;return t.resolve(f.breakResult),t.promise;case"EmptyStatement":var o=new n;return o.resolve(f.voidOperation),o.promise;case"ContinueStatement":var a=new n;return a.resolve(f.continueResult),a.promise;case"Identifier":return le(e,r);case"MemberExpression":return te(e,r);case"Literal":return T(r.value);case"ThisExpression":return R(v.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"CallExpression":return se(e,r);case"UnaryExpression":return oe(e,r);case"BinaryExpression":return ce(e,r);case"LogicalExpression":return ie(e,r);case"ConditionalExpression":return R(v.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"ArrayExpression":return ae(e,r);case"ObjectExpression":return F(e,r);case"Property":return U(e,r);case"Array":return R(v.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));default:return R(v.nodeErrorMessage(r,"RUNTIME","UNREOGNISED"))}}catch(e){return R(e)}}function F(e,r){try{for(var o=new n,c=[],i=0;i<r.properties.length;i++)c.push(A(e,r.properties[i]));return t(c).then(u.callback(function(e){for(var r={},n=0;n<e.length;n++){var t=e[n];if(f.isFunctionParameter(t.value))throw new Error("Illegal Argument");if(!1===f.isString(t.key))throw new Error("Illegal Argument");t.value===f.voidOperation?r[t.key.toString()]=null:r[t.key.toString()]=t.value}var c=new a(r);c.immutable=!1,o.resolve(c)},o),u.errback(o)),o.promise}catch(e){return R(e)}}function U(e,r){var t=new n;try{A(e,r.value).then(u.callback(function(e){t.resolve({key:"Identifier"===r.key.type?r.key.name:r.key.value,value:e})},t),u.errback(t))}catch(e){t.reject(e)}return t.promise}function j(e,r,t){var o=new n;try{A(e,r.body).then(u.callback(function(n){return t.lastAction=n,t.lastAction===f.breakResult?(t.testResult=!1,void o.resolve(t)):t.lastAction instanceof f.ReturnResult?(t.testResult=!1,void o.resolve(t)):void(null!==r.update?A(e,r.update).then(u.callback(function(e){o.resolve(t)},o),u.errback(o)):o.resolve(t))},o),u.errback(o))}catch(e){o.reject(e)}return o.promise}function x(e,r,t){var o=new n;try{return null!==r.test?(A(e,r.test).then(u.callback(function(n){return!0===e.progressTracker.isCanceled()?void o.reject(new Error("Cancelled")):(t.testResult=n,!1===t.testResult?void o.resolve(t):!0!==t.testResult?void o.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))):void j(e,r,t).then(u.callback(function(e){o.resolve(e)},o),u.errback(o)))},o),u.errback(o)),o.promise):j(e,r,t)}catch(e){o.reject(e)}return o.promise}function P(e,r,n,t,o,a){try{x(e,r,n).then(function(){try{!0===n.testResult?(a++,a>Me?(a=0,setTimeout(function(){P(e,r,n,function(e){t(e)},function(e){o(e)},a)})):P(e,r,n,function(e){t(e)},function(e){o(e)},a)):t(n.lastAction instanceof f.ReturnResult?n.lastAction:f.voidOperation)}catch(e){o(e)}},function(e){o(e)})}catch(e){o(e)}}function D(e,r){var t=new n;try{if(null!==r.init)A(e,r.init).then(u.callback(function(){var n={testResult:!0,lastAction:f.voidOperation};P(e,r,n,function(e){t.resolve(e)},function(e){t.reject(e)},0)},t),u.errback(t));else{var o={testResult:!0,lastAction:f.voidOperation};P(e,r,o,function(e){t.resolve(e)},function(e){t.reject(e)},0)}}catch(e){t.reject(e)}return t.promise}function L(e,r,n,t,o,a,c,i,l,s){try{if(t<=a)return void i(f.voidOperation);o.value="k"===c?n[a]:a,A(e,r.body).then(function(u){try{u instanceof f.ReturnResult?i(u):u===f.breakResult?i(f.voidOperation):(s++,s>Me?(s=0,setTimeout(function(){L(e,r,n,t,o,a+1,c,function(e){i(e)},function(e){l(e)},s)})):L(e,r,n,t,o,a+1,c,function(e){i(e)},function(e){l(e)},s))}catch(e){l(e)}},function(e){l(e)})}catch(e){l(e)}}function _(e,r,n,t,o,a,c,i,l){try{if(n.length()<=o)return void c(f.voidOperation);t.value="k"===a?n.get(o):o,A(e,r.body).then(function(s){s instanceof f.ReturnResult?c(s):s===f.breakResult?c(f.voidOperation):(l++,l>Me?(l=0,setTimeout(function(){_(e,r,n,t,o+1,a,function(e){c(e)},function(e){i(e)},l)})):_(e,r,n,t,o+1,a,function(e){c(e)},function(e){i(e)},l))},function(e){i(e)})}catch(e){i(e)}}function V(e,r,n,t,o,a){try{if(void 0===a&&(a="i"),0===n.length)return void t.resolve(f.voidOperation);L(e,r,n,n.length,o,0,a,function(e){t.resolve(e)},function(e){t.reject(e)},0)}catch(e){t.reject(e)}}function B(e,r,n,t,o,a){try{if(void 0===a&&(a="i"),0===n.length)return void t.resolve(f.voidOperation);_(e,r,n,o,0,a,function(e){t.resolve(e)},function(e){t.reject(e)},0)}catch(e){t.reject(e)}}function Y(e,r,n,t,o){try{V(e,r,n.keys(),t,o,"k")}catch(e){t.reject(e)}}function G(e,r,n,t,o,a,i,l){try{e.next().then(function(s){try{if(null===s)a(f.voidOperation);else{var u=c.createFromGraphicLikeObject(s.geometry,s.attributes,t);u._underlyingGraphic=s,o.value=u;A(r,n.body).then(function(c){try{c===f.breakResult?a(f.voidOperation):c instanceof f.ReturnResult?a(c):(l++,l>Me?(l=0,setTimeout(function(){G(e,r,n,t,o,function(e){a(e)},function(e){i(e)},l)})):G(e,r,n,t,o,function(e){a(e)},function(e){i(e)},l))}catch(e){i(e)}},function(e){i(e)})}}catch(e){i(e)}},function(e){i(e)})}catch(e){i(e)}}function q(e,r){var t=new n;try{A(e,r.right).then(u.callback(function(o){var i=null;"VariableDeclaration"===r.left.type?i=A(e,r.left):(i=new n,i.resolve(),i=i.promise),i.then(u.callback(function(){var n="VariableDeclaration"===r.left.type?r.left.declarations[0].id.name:r.left.name,i=null;if(null!==e.localScope&&void 0!==e.localScope[n]&&(i=e.localScope[n]),null===i&&void 0!==e.globalScope[n]&&(i=e.globalScope[n]),null===i)return void t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","VARIABLENOTDECLARED")));f.isArray(o)||f.isString(o)?V(e,r,o,t,i):f.isImmutableArray(o)?B(e,r,o,t,i):o instanceof a||o instanceof c?Y(e,r,o,t,i):f.isFeatureCursor(o)?G(o.iterator(e.progressTracker),e,r,o,i,function(e){t.resolve(e)},function(e){t.reject(e)},0):V(e,r,[],t,i)},t),u.errback(t))},t),u.errback(t))}catch(e){t.reject(e)}return t.promise}function z(e,r){var t=new n;try{if("MemberExpression"!==r.argument.type){var o=r.argument.name.toLowerCase(),i=void 0;if(null!==e.localScope&&void 0!==e.localScope[o])return i=f.toNumber(e.localScope[o].value),e.localScope[o]={value:"++"===r.operator?i+1:i-1,valueset:!0,node:r},!1===r.prefix?t.resolve(i):t.resolve("++"===r.operator?i+1:i-1),t.promise;throw void 0!==e.globalScope[o]&&(i=f.toNumber(e.globalScope[o].value),e.globalScope[o]={value:"++"===r.operator?i+1:i-1,valueset:!0,node:r},!1===r.prefix?t.resolve(i):t.resolve("++"===r.operator?i+1:i-1)),new Error("Variable not recognised")}A(e,r.argument.object).then(u.callback(function(o){var i=null,l=null;!0===r.argument.computed?l=A(e,r.argument.property):(i=new n,i.resolve(r.argument.property.name),l=i.promise),l.then(u.callback(function(e){var n;if(f.isArray(o)){if(!f.isNumber(e))throw new Error("Invalid Parameter");if(e<0&&(e=o.length+e),e<0||e>=o.length)throw new Error("Assignment outside of array bounds");n=f.toNumber(o[e]),o[e]="++"===r.operator?n+1:n-1}else if(o instanceof a){if(!1===f.isString(e))throw new Error("Dictionary accessor must be a string");if(!0!==o.hasField(e))throw new Error("Invalid Parameter");n=f.toNumber(o.field(e)),o.setField(e,"++"===r.operator?n+1:n-1)}else{if(!(o instanceof c))throw f.isImmutableArray(o)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===f.isString(e))throw new Error("Feature accessor must be a string");if(!0!==o.hasField(e))throw new Error("Invalid Parameter");n=f.toNumber(o.field(e)),o.setField(e,"++"===r.operator?n+1:n-1)}!1===r.prefix?t.resolve(n):t.resolve("++"===r.operator?n+1:n-1)},t),u.errback(t))},t),u.errback(t))}catch(e){t.reject(e)}return t.promise}function H(e,r,n,t){switch(r){case"=":return e===f.voidOperation?null:e;case"/=":return f.toNumber(n)/f.toNumber(e);case"*=":return f.toNumber(n)*f.toNumber(e);case"-=":return f.toNumber(n)-f.toNumber(e);case"+=":return f.isString(n)||f.isString(e)?f.toString(n)+f.toString(e):f.toNumber(n)+f.toNumber(e);case"%=":return f.toNumber(n)%f.toNumber(e);default:throw new Error(v.nodeErrorMessage(t,"RUNTIME","OPERATORNOTRECOGNISED"))}}function Z(e,r){var t=new n;try{if("MemberExpression"===r.left.type)A(e,r.right).then(u.callback(function(o){A(e,r.left.object).then(u.callback(function(i){var l=null,s=null;!0===r.left.computed?s=A(e,r.left.property):(l=new n,l.resolve(r.left.property.name),s=l.promise),s.then(u.callback(function(e){if(f.isArray(i)){if(!f.isNumber(e))throw new Error("Invalid Parameter");if(e<0&&(e=i.length+e),e<0||e>i.length)throw new Error("Assignment outside of array bounds");if(e===i.length){if("="!==r.operator)throw new Error("Invalid Parameter");i[e]=H(o,r.operator,i[e],r)}else i[e]=H(o,r.operator,i[e],r)}else if(i instanceof a){if(!1===f.isString(e))throw new Error("Dictionary accessor must be a string");if(!0===i.hasField(e))i.setField(e,H(o,r.operator,i.field(e),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");i.setField(e,H(o,r.operator,null,r))}}else{if(!(i instanceof c))throw f.isImmutableArray(i)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===f.isString(e))throw new Error("Feature accessor must be a string");if(!0===i.hasField(e))i.setField(e,H(o,r.operator,i.field(e),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");i.setField(e,H(o,r.operator,null,r))}}t.resolve(f.voidOperation)},t),u.errback(t))},t),u.errback(t))},t),u.errback(t));else{var o=r.left.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[o])return A(e,r.right).then(u.callback(function(n){e.localScope[o]={value:H(n,r.operator,e.localScope[o].value,r),valueset:!0,node:r.right},t.resolve(f.voidOperation)},t),u.errback(t)),t.promise;if(void 0!==e.globalScope[o])return A(e,r.right).then(u.callback(function(n){e.globalScope[o]={value:H(n,r.operator,e.globalScope[o].value,r),valueset:!0,node:r.right},t.resolve(f.voidOperation)},t),u.errback(t)),t.promise;t.reject(new Error("Cannot assign undeclared variable"))}}catch(e){t.reject(e)}return t.promise}function W(e,r){var t=new n;try{"AssignmentExpression"===r.expression.type?A(e,r.expression).then(u.callback(function(e){t.resolve(e)},t),u.errback(t)):(r.expression.type,A(e,r.expression).then(u.callback(function(e){if(e===f.voidOperation)return void t.resolve(f.voidOperation);t.resolve(new f.ImplicitResult(e))},t),u.errback(t)))}catch(e){t.reject(e)}return t.promise}function K(e,r){var t=new n;try{if("AssignmentExpression"===r.test.type||"UpdateExpression"===r.test.type)return t.reject(new Error(v.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),t.promise;A(e,r.test).then(u.callback(function(n){!0===n?A(e,r.consequent).then(u.callback(function(e){t.resolve(e)},t),u.errback(t)):!1===n?null!==r.alternate?A(e,r.alternate).then(u.callback(function(e){t.resolve(e)},t),u.errback(t)):t.resolve(f.voidOperation):t.reject(new Error(v.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION")))},t),u.errback(t))}catch(e){t.reject(e)}return t.promise}function X(e,r){var t=new n;try{J(e,r,0).then(u.callback(function(e){t.resolve(e)},t),u.errback(t))}catch(e){t.reject(e)}return t.promise}function J(e,r,t){var o=new n;try{t>=r.body.length?o.resolve(f.voidOperation):A(e,r.body[t]).then(u.callback(function(n){n instanceof f.ReturnResult||n===f.breakResult||n===f.continueResult?o.resolve(n):t===r.body.length-1?o.resolve(n):J(e,r,t+1).then(u.callback(function(e){o.resolve(e)},o),u.errback(o))},o),u.errback(o))}catch(e){o.reject(e)}return o.promise}function Q(e,r){var t=new n;try{null===r.argument?t.resolve(new f.ReturnResult(f.voidOperation)):A(e,r.argument).then(u.callback(function(e){t.resolve(new f.ReturnResult(e))},t),u.errback(t))}catch(e){t.reject(e)}return t.promise}function $(e,r){var t=new n;try{var o=r.id.name.toLowerCase();e.globalScope[o]={valueset:!0,node:null,value:new i(r,e)},t.resolve(f.voidOperation)}catch(e){t.reject(e)}return t.promise}function ee(e,r,t){var o=new n;try{if(t>=r.declarations.length)return o.resolve(f.voidOperation),o.promise;A(e,r.declarations[t]).then(u.callback(function(n){t===r.declarations.length-1?o.resolve(f.voidOperation):ee(e,r,t+1).then(u.callback(function(e){o.resolve(f.voidOperation)},o),u.errback(o))},o),u.errback(o))}catch(e){o.reject(e)}return o.promise}function re(e,r){var t=new n;try{var o=null;null===r.init?(o=new n,o.resolve(null),o=o.promise):o=A(e,r.init),null!==e.localScope?o.then(u.callback(function(n){n===f.voidOperation&&(n=null);var o=r.id.name.toLowerCase();e.localScope[o]={value:n,valueset:!0,node:r.init},t.resolve(f.voidOperation)},t),u.errback(t)):o.then(u.callback(function(n){var o=r.id.name.toLowerCase();n===f.voidOperation&&(n=null),e.globalScope[o]={value:n,valueset:!0,node:r.init},t.resolve(f.voidOperation)},t),u.errback(t))}catch(e){t.reject(e)}return t.promise}function ne(e,r,n,t){var o;switch(r=r.toLowerCase()){case"hasz":var c=e.hasZ;return void 0!==c&&c;case"hasm":var i=e.hasM;return void 0!==i&&i;case"spatialreference":var u=e.spatialReference._arcadeCacheId;if(void 0===u){var p=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(p=!1),p&&(Ce++,e.spatialReference._arcadeCacheId=Ce,u=Ce)}var d=new a({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==u&&(d._arcadeCacheId="SPREF"+u.toString()),d}switch(e.type){case"extent":switch(r){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":var h=e[r];return void 0!==h?h:null;case"type":return"Extent"}break;case"polygon":switch(r){case"rings":o=f.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===o&&(Ce++,o=Ce,f.isVersion4?e.cache._arcadeCacheId=o:e.setCacheValue("_arcadeCacheId",o));var m=new l(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,o);return m;case"type":return"Polygon"}break;case"point":switch(r){case"x":case"y":case"z":case"m":return void 0!==e[r]?e[r]:null;case"type":return"Point"}break;case"polyline":switch(r){case"paths":o=f.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===o&&(Ce++,o=Ce,f.isVersion4?e.cache._arcadeCacheId=o:e.setCacheValue("_arcadeCacheId",o));var m=new l(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,o);return m;case"type":return"Polyline"}break;case"multipoint":switch(r){case"points":o=f.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===o&&(Ce++,o=Ce,f.isVersion4?e.cache._arcadeCacheId=o:e.setCacheValue("_arcadeCacheId",o));var m=new s(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,o,1);return m;case"type":return"Multipoint"}}throw new Error(v.nodeErrorMessage(t,"RUNTIME","PROPERTYNOTFOUND"))}function te(e,r){try{var t=new n;return A(e,r.object).then(u.callback(function(n){if(null===n)return void t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","NOTFOUND")));!1===r.computed?n instanceof a||n instanceof c?t.resolve(n.field(r.property.name)):n instanceof k?t.resolve(ne(n,r.property.name,e,r)):t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))):A(e,r.property).then(u.callback(function(o){if(n instanceof a||n instanceof c)f.isString(o)?t.resolve(n.field(o)):t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(n instanceof k)f.isString(o)?t.resolve(ne(n,o,e,r)):t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(f.isArray(n))if(f.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=n.length+o),o>=n.length||o<0)throw new Error(v.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(n[o])}else t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(f.isImmutableArray(n))if(f.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=n.length()+o),o>=n.length()||o<0)throw new Error(v.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(n.get(o))}else t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(f.isString(n))if(f.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=n.length+o),o>=n.length||o<0)throw new Error(v.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(n[o])}else t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")))},t),u.errback(t))},t),u.errback(t)),t.promise}catch(e){return R(e)}}function oe(e,r){try{var t=new n;return A(e,r.argument).then(u.callback(function(e){f.isBoolean(e)&&"!"===r.operator?t.resolve(!e):"-"===r.operator?t.resolve(-1*f.toNumber(e)):"+"===r.operator?t.resolve(1*f.toNumber(e)):t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR")))},t),u.errback(t)),t.promise}catch(e){return R(e)}}function ae(e,r){try{for(var o=new n,a=[],c=0;c<r.elements.length;c++)a.push(A(e,r.elements[c]));return t(a).then(u.callback(function(e){for(var n=0;n<e.length;n++){if(f.isFunctionParameter(e[n]))return void o.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","FUNCTIONCONTEXTILLEGAL")));e[n]===f.voidOperation&&(e[n]=null)}o.resolve(e)},o),u.errback(o)),o.promise}catch(e){return R(e)}}function ce(e,r){try{var o=new n;return t([A(e,r.left),A(e,r.right)]).then(u.callback(function(e){var n=e[0],t=e[1];switch(r.operator){case"==":case"=":o.resolve(f.equalityTest(n,t));break;case"!=":o.resolve(!f.equalityTest(n,t));break;case"<":case">":case"<=":case">=":o.resolve(f.greaterThanLessThan(n,t,r.operator));break;case"+":f.isString(n)||f.isString(t)?o.resolve(f.toString(n)+f.toString(t)):o.resolve(f.toNumber(n)+f.toNumber(t));break;case"-":o.resolve(f.toNumber(n)-f.toNumber(t));break;case"*":o.resolve(f.toNumber(n)*f.toNumber(t));break;case"/":o.resolve(f.toNumber(n)/f.toNumber(t));break;case"%":o.resolve(f.toNumber(n)%f.toNumber(t));break;default:o.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","OPERATORNOTRECOGNISED")))}},o),u.errback(o)),o.promise}catch(e){return R(e)}}function ie(e,r){try{var t=new n;return"AssignmentExpression"===r.left.type||"UpdateExpression"===r.left.type?(t.reject(new Error(v.nodeErrorMessage(r.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),t.promise):"AssignmentExpression"===r.right.type||"UpdateExpression"===r.right.type?(t.reject(new Error(v.nodeErrorMessage(r.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),t.promise):(A(e,r.left).then(u.callback(function(n){if(!f.isBoolean(n))throw new Error(v.nodeErrorMessage(r,"RUNTIME","ONLYBOOLEAN"));switch(r.operator){case"||":!0===n?t.resolve(n):A(e,r.right).then(u.callback(function(e){if(!f.isBoolean(e))throw new Error(v.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));t.resolve(e)},t),u.errback(t));break;case"&&":!1===n?t.resolve(n):A(e,r.right).then(u.callback(function(e){if(!f.isBoolean(e))throw new Error(v.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));t.resolve(e)},t),u.errback(t));break;default:throw new Error(v.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"))}},t),u.errback(t)),t.promise)}catch(e){return R(e)}}function le(e,r){try{var t=new n,o=r.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[o]){var a=e.localScope[o];return!0===a.valueset?t.resolve(a.value):null!==a.d?a.d.then(u.callback(function(e){t.resolve(e)},t),u.errback(t)):(a.d=A(e,a.node),a.d.then(u.callback(function(e){a.value=e,a.valueset=!0,t.resolve(e)},t),u.errback(t))),t.promise}if(void 0!==e.globalScope[o]){var c=e.globalScope[o];return!0===c.valueset?t.resolve(c.value):null!==c.d?c.d.then(u.callback(function(e){t.resolve(e)},t),u.errback(t)):(c.d=A(e,c.node),c.d.then(u.callback(function(e){c.value=e,c.valueset=!0,t.resolve(e)},t),u.errback(t))),t.promise}return t.reject(new Error(v.nodeErrorMessage(r,"RUNTIME","VARIABLENOTFOUND"))),t.promise}catch(e){return R(e)}}function se(e,r){try{if("Identifier"!==r.callee.type)return R(v.nodeErrorMessage(r,"RUNTIME","ONLYNODESSUPPORTED"));if(null!==e.localScope&&void 0!==e.localScope[r.callee.name.toLowerCase()]){var n=e.localScope[r.callee.name.toLowerCase()];return n.value instanceof f.NativeFunction?n.value.fn(e,r):n.value instanceof i?ge(e,r,n.value.definition):R(v.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}if(void 0!==e.globalScope[r.callee.name.toLowerCase()]){var n=e.globalScope[r.callee.name.toLowerCase()];return n.value instanceof f.NativeFunction?n.value.fn(e,r):n.value instanceof i?ge(e,r,n.value.definition):R(v.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}return R(v.nodeErrorMessage(r,"RUNTIME","NOTFOUND"))}catch(e){return R(e)}}function ue(e){return null===e?"":f.isArray(e)?"Array":f.isImmutableArray(e)?"Array":f.isDate(e)?"Date":f.isString(e)?"String":f.isBoolean(e)?"Boolean":f.isNumber(e)?"Number":e instanceof a?"Dictionary":e instanceof c?"Feature":e instanceof N?"Point":e instanceof y?"Polygon":e instanceof I?"Polyline":e instanceof w?"Multipoint":e instanceof E?"Extent":f.isFunctionParameter(e)?"Function":e===f.voidOperation?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function fe(e,r,t,o){try{var a=new n;return A(e,r.arguments[t]).then(u.callback(function(n){if(f.equalityTest(n,o))A(e,r.arguments[t+1]).then(u.callback(function(e){a.resolve(e)},a),u.errback(a));else{var c=r.arguments.length-t;1===c?A(e,r.arguments[t]).then(u.callback(function(e){a.resolve(e)},a),u.errback(a)):2===c&&a.resolve(null),3===c?A(e,r.arguments[t+2]).then(u.callback(function(e){a.resolve(e)},a),u.errback(a)):fe(e,r,t+2,o).then(u.callback(function(e){a.resolve(e)},a),u.errback(a))}},a),u.errback(a)),a.promise}catch(e){return R(e)}}function ve(e,r,t,o){try{var a=new n;if(!0===o)A(e,r.arguments[t+1]).then(u.callback(function(e){a.resolve(e)},a),u.errback(a));else{3===r.arguments.length-t?A(e,r.arguments[t+2]).then(u.callback(function(e){a.resolve(e)},a),u.errback(a)):A(e,r.arguments[t+2]).then(u.callback(function(n){if(!1===f.isBoolean(n))return void a.reject(new Error("WHEN needs boolean test conditions"));ve(e,r,t+2,n).then(u.callback(function(e){a.resolve(e)},a),u.errback(a))},a),u.errback(a))}return a.promise}catch(e){return R(e)}}function pe(e,r){var o=new n;try{var a=e.length,c=Math.floor(a/2);if(0===a)return o.resolve([]),o.promise;if(1===a)return o.resolve([e[0]]),o.promise;var i=[pe(e.slice(0,c),r),pe(e.slice(c,a),r)];t(i).then(u.callback(function(e){de(e[0],e[1],r,[]).then(u.callback(function(e){o.resolve(e)},o),u.errback(o))},o),u.errback(o))}catch(e){o.reject(e)}return o.promise}function de(e,r,t,o){var a=new n;try{var c=o;e.length>0||r.length>0?e.length>0&&r.length>0?t(e[0],r[0]).then(u.callback(function(n){isNaN(n)&&(n=1),n<=0?(c.push(e[0]),e=e.slice(1)):(c.push(r[0]),r=r.slice(1)),de(e,r,t,o).then(u.callback(function(e){a.resolve(e)},a),u.errback(a))},a),u.errback(a)):e.length>0?(c.push(e[0]),e=e.slice(1),de(e,r,t,o).then(u.callback(function(e){a.resolve(e)},a),u.errback(a))):r.length>0&&(c.push(r[0]),r=r.slice(1),de(e,r,t,o).then(u.callback(function(e){a.resolve(e)},a),u.errback(a))):a.resolve(o)}catch(e){a.reject(e)}return a.promise}function he(e,r){var n=e.length,t=Math.floor(n/2);return r||(r=function(e,r){return e<r?-1:e===r?0:1}),0===n?[]:1===n?[e[0]]:me(he(e.slice(0,t),r),he(e.slice(t,n),r),r)}function me(e,r,n){for(var t=[];e.length>0||r.length>0;)if(e.length>0&&r.length>0){var o=n(e[0],r[0]);isNaN(o)&&(o=1),o<=0?(t.push(e[0]),e=e.slice(1)):(t.push(r[0]),r=r.slice(1))}else e.length>0?(t.push(e[0]),e=e.slice(1)):r.length>0&&(t.push(r[0]),r=r.slice(1));return t}function be(e,r,t){var o=new n;try{var a=e.body;if(t.length!==e.params.length)return R(new Error("Invalid Parameter calls to function."));for(var c=0;c<t.length;c++)r.localScope[e.params[c].name.toLowerCase()]={d:null,value:t[c],valueset:!0,node:null};A(r,a).then(u.callback(function(e){return e instanceof f.ReturnResult?void o.resolve(e.value):e===f.breakResult?void o.reject(new Error("Cannot Break from a Function")):e===f.continueResult?void o.reject(new Error("Cannot Continue from a Function")):e instanceof f.ImplicitResult?void o.resolve(e.value):void o.resolve(e)},o),u.errback(o))}catch(e){o.reject(e)}return o.promise}function ge(e,r,n){return C(e,r,function(r,t,o){var a={spatialReference:e.spatialReference,services:e.services,console:e.console,localScope:{},progressTracker:e.progressTracker,globalScope:e.globalScope,depthCounter:e.depthCounter+1};if(a.depthCounter>64)throw new Error("Exceeded maximum function depth");return be(n,a,o)})}function Ee(e){return function(){var r={applicationCache:void 0===e.context.applicationCache?null:e.context.applicationCache,progressTracker:e.context.progressTracker,spatialReference:e.context.spatialReference,console:e.context.console,services:e.context.services,localScope:{},globalScope:e.context.globalScope,depthCounter:e.context.depthCounter+1};if(r.depthCounter>64)throw new Error("Exceeded maximum function depth");return be(e.definition,r,arguments)}}function ke(e,r){var n=new je;void 0!==e&&null!==e||(e={}),void 0!==r&&null!==r||(r={});var t=new a({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});t.immutable=!1,n.textformatting={value:t,valueset:!0,node:null};for(var o in r)n[o]={value:new f.NativeFunction(r[o]),native:!0,valueset:!0,node:null};for(var o in e)e[o]&&"esri.Graphic"===e[o].declaredClass?n[o]={value:c.createFromGraphic(e[o]),valueset:!0,node:null}:n[o]={value:e[o],valueset:!0,node:null};return n}function we(e){console.log(e)}function Ne(e){for(var r={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:M,standardFunctionAsync:C,failDefferred:R,evaluateIdentifier:le,arcadeCustomFunctionHandler:Ee},n=0;n<e.length;n++)e[n].registerFunctions(r);for(var t in r.functions)Ae[t]={value:new f.NativeFunction(r.functions[t]),valueset:!0,node:null},je.prototype[t]=Ae[t];for(var n=0;n<r.signatures.length;n++)v.addFunctionDeclaration(r.signatures[n],"f")}function ye(e,r,t){var o=new n;null!==t&&void 0!==t||(t=new O({wkid:102100}));var a=ke(r.vars,r.customfunctions);return A({spatialReference:t,services:r.services,progressTracker:void 0===r.progressTracker||null===r.progressTracker?o.promise:r.progressTracker,globalScope:a,console:r.console?r.console:we,localScope:null,depthCounter:1},e.body[0].body).then(u.callback(function(e){return e instanceof f.ReturnResult&&(e=e.value),e instanceof f.ImplicitResult&&(e=e.value),e===f.voidOperation&&(e=null),e===f.breakResult?void o.reject(new Error("Cannot return BREAK")):e===f.continueResult?void o.reject(new Error("Cannot return CONTINUE")):e instanceof f.NativeFunction?void o.reject(new Error("Cannot return FUNCTION")):e instanceof i?void o.reject(new Error("Cannot return FUNCTION")):void o.resolve(e)},o),u.errback(o)),o.promise}function Ie(e,r){return void 0===r&&(r=!1),v.findFieldLiterals(e,r)}function Oe(e,r){return v.validateScript(e,r,"full")}function Re(e,r){return v.referencesMember(e,r)}function Te(e,r){return v.referencesFunction(e,r)}function Se(e){return v.findFunctionCalls(e,!1)}Object.defineProperty(r,"__esModule",{value:!0});var Me=100,Ce=0,Ae={};p.registerFunctions(Ae,M),g.registerFunctions(Ae,M),m.registerFunctions(Ae,M),h.registerFunctions(Ae,M),b.registerFunctions(Ae,M),d.registerFunctions(Ae,M,C),Ae.typeof=function(e,r){return M(e,r,function(e,r,n){f.pcCheck(n,1,1);var t=ue(n[0]);if("Unrecognised Type"===t)throw new Error("Unrecognised Type");return t})},Ae.iif=function(e,r){try{var t=new n;return f.pcCheck(null===r.arguments?[]:r.arguments,3,3),A(e,r.arguments[0]).then(u.callback(function(n){if(!1===f.isBoolean(n))return void t.reject(new Error("IF Function must have a boolean test condition"));!0===n?A(e,r.arguments[1]).then(u.callback(function(e){t.resolve(e)},t),u.errback(t)):A(e,r.arguments[2]).then(u.callback(function(e){t.resolve(e)},t),u.errback(t))},t),u.errback(t)),t.promise}catch(e){return R(e)}},Ae.decode=function(e,r){try{var t=new n;if(r.arguments.length<2)return R("Missing Parameters");if(2===r.arguments.length)A(e,r.arguments[1]).then(u.callback(function(e){t.resolve(e)},t),u.errback(t));else{if((r.arguments.length-1)%2==0)return R("Must have a default value result.");A(e,r.arguments[0]).then(u.callback(function(n){fe(e,r,1,n).then(u.callback(function(e){t.resolve(e)},t),u.errback(t))},t),u.errback(t))}return t.promise}catch(e){return R(e)}},Ae.when=function(e,r){try{var t=new n;return r.arguments.length<3?R("Missing Parameters"):r.arguments.length%2==0?R("Must have a default value result."):(A(e,r.arguments[0]).then(u.callback(function(n){if(!1===f.isBoolean(n))return void t.reject(new Error("WHEN needs boolean test conditions"));ve(e,r,0,n).then(u.callback(function(e){t.resolve(e)},t),u.errback(t))},t),u.errback(t)),t.promise)}catch(e){return R(e)}},Ae.sort=function(e,r){return C(e,r,function(e,r,t){var o=new n;f.pcCheck(t,1,2);var a=t[0];if(f.isImmutableArray(a)&&(a=a.toArray()),!1===f.isArray(a))return R(Error("Illegal Argument"));if(t.length>1){if(!1===f.isFunctionParameter(t[1]))return R(Error("Illegal Argument"));var c=a;return pe(c,Ee(t[1])).then(u.callback(function(e){o.resolve(e)},o),u.errback(o)),o.promise}var c=a;if(0===c.length)return o.resolve([]),o.promise;for(var i={},l=0;l<c.length;l++){var s=ue(c[l]);""!==s&&(i[s]=!0)}if(!0===i.Array||!0===i.Dictionary||!0===i.Feature||!0===i.Point||!0===i.Polygon||!0===i.Polyline||!0===i.Multipoint||!0===i.Extent||!0===i.Function)return o.resolve(c.slice(0)),o.promise;var v=0,p="";for(var d in i)v++,p=d;return v>1||"String"===p?c=he(c,function(e,r){if(null===e||void 0===e||e===f.voidOperation)return null===r||void 0===r||r===f.voidOperation?0:1;if(null===r||void 0===r||r===f.voidOperation)return-1;var n=f.toString(e),t=f.toString(r);return n<t?-1:n===t?0:1}):"Number"===p?c=he(c,function(e,r){return e-r}):"Boolean"===p?c=he(c,function(e,r){return e===r?0:r?-1:1}):"Date"===p&&(c=he(c,function(e,r){return r-e})),o.resolve(c),o.promise})};var Fe={failDefferred:R,resolveDeffered:T,fixSpatialReference:f.fixSpatialReference,parseArguments:S,standardFunction:M,standardFunctionAsync:C,evaluateIdentifier:le,arcadeCustomFunction:Ee};for(var Ue in Ae)Ae[Ue]={value:new f.NativeFunction(Ae[Ue]),valueset:!0,node:null};var je=function(){};je.prototype=Ae,je.prototype.infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},je.prototype.pi={value:Math.PI,valueset:!0,node:null},r.functionHelper=Fe,r.extend=Ne,r.executeScript=ye,r.extractFieldLiterals=Ie,r.validateScript=Oe,r.referencesMember=Re,r.referencesFunction=Te,r.findFunctionCalls=Se});