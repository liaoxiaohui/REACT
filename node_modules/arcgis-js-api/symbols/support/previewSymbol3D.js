// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.8/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","../../core/promiseUtils","../../core/screenUtils","./gfxUtils","./previewUtils","./renderUtils","./styleUtils","./symbolUtils"],function(e,a,r,t,l,s,i,o,n,h,p){function u(e){var a=e.outline,r=e.get("material.color"),t=r&&r.toRgba().toString();if(!a)return"fill"===e.type&&"255,255,255,1"===t?{color:"#bdc3c7",width:.75}:null;var l=s.pt2px(a.size)||0;return{color:"rgba("+(null!=a.color?a.color.toRgba():"255,255,255,1")+")",width:Math.min(l,j)}}function c(e,a){var r=a&&a.resource,t=r&&r.href;return e.thumbnail&&e.thumbnail.url?l.resolve(e.thumbnail.url):t&&"object"!==a.type?l.resolve(p.getIconHref(e,a)):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?h.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal}).always(function(e){return e&&e.thumbnail&&e.thumbnail.url||z}):l.resolve(z)}function m(e,a){return Math.min(Math.max(e+255*a*.75,0),255)}function f(e,a){if(void 0===a&&(a=0),!e.material||!e.material.color){var r=i.defaultThematicColor.r,t=m(r,a);return[t,t,t,100]}for(var l=e.material.color.toRgb(),s=0;s<3;s++)l[s]=m(l[s],a);return l.push(e.material.color.a),l}function v(e){return e.outline?u(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function d(e,a){if(!e.material)return{};for(var r=e.material.color.toRgb(),t="rgba(",l=0;l<3;l++)t+=m(r[l],a)+",";t+=e.material.color.a+");";var i=e.size?s.pt2px(e.size):.75;return{color:t,width:Math.min(i,j)}}function y(e,a,r){var t=.75*r;return{type:"linear",x1:t?.25*t:0,y1:t?.5*t:0,x2:t||4,y2:t?.5*t:4,colors:[{color:e,offset:0},{color:a,offset:1}]}}function b(e){var a=e.depth,r=e.height,t=e.width;return t&&a&&r&&t===a&&t<r}function g(e,a,r,t){var l=e&&e.type,s="icon"===l,i="object"===l,n=[];if(s){var h=e,p=r,c=r;switch(a){case"circle":n.push({shape:{type:"circle",cx:0,cy:0,r:.5*r},fill:f(h,0),stroke:u(h)});break;case"square":n.push({shape:{type:"path",path:[{command:"M",values:[0,c]},{command:"L",values:[0,0]},{command:"L",values:[p,0]},{command:"L",values:[p,c]},{command:"Z",values:[]}]},fill:f(h,0),stroke:u(h)});break;case"cross":n.push({shape:{type:"path",path:[{command:"M",values:[.5*p,0]},{command:"L",values:[.5*p,c]},{command:"M",values:[0,.5*c]},{command:"L",values:[p,.5*c]},{command:"E",values:[]}]},stroke:v(h)});break;case"x":n.push({shape:{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[p,c]},{command:"M",values:[p,0]},{command:"L",values:[0,c]},{command:"E",values:[]}]},stroke:v(h)});break;case"kite":n.push({shape:{type:"path",path:[{command:"M",values:[0,.5*c]},{command:"L",values:[.5*p,0]},{command:"L",values:[p,.5*c]},{command:"L",values:[.5*p,c]},{command:"Z",values:[]}]},fill:f(h,0),stroke:u(h)})}}else if(i){var m=e;switch(a){case"cone":var d=f(m,0),b=f(m,-.6),g=t?D:r,x=y(d,b,g),w=o.getConeShapes(r,t);n.push({shape:w[0],fill:x}),n.push({shape:w[1],fill:x});break;case"inverted-cone":var M=f(m,0),k=f(m,-.6),S=y(M,k,r),L=o.getInvertedConeShapes(r);n.push({shape:L[0],fill:S}),n.push({shape:L[1],fill:M});break;case"cube":var z=o.getCubeShapes(r,t);n.push({shape:z[0],fill:f(m,0)}),n.push({shape:z[1],fill:f(m,-.3)}),n.push({shape:z[2],fill:f(m,-.5)});break;case"cylinder":var U=f(m,0),E=f(m,-.6),j=t?D:r,C=y(U,E,j),I=o.getCylinderShapes(r,t);n.push({shape:I[0],fill:C}),n.push({shape:I[1],fill:C}),n.push({shape:I[2],fill:f(m,0)});break;case"diamond":var O=o.getDiamondShapes(r);n.push({shape:O[0],fill:f(m,-.3)}),n.push({shape:O[1],fill:f(m,0)}),n.push({shape:O[2],fill:f(m,-.3)}),n.push({shape:O[3],fill:f(m,-.7)});break;case"sphere":var P=f(m,0),R=f(m,-.6),A=y(P,R);A.x1=0,A.y1=0,A.x2=.25*r,A.y2=.25*r,n.push({shape:{type:"circle",cx:0,cy:0,r:.5*r},fill:A});break;case"tetrahedron":var T=o.getTetrahedronShapes(r);n.push({shape:T[0],fill:f(m,-.3)}),n.push({shape:T[1],fill:f(m,0)}),n.push({shape:T[2],fill:f(m,-.6)})}}return n}function x(e){return"icon"===e.type?"multiply":"tint"}function w(e){return"icon"===e.type?"circle":"sphere"}function M(e,a){var r,t=a&&a.size?s.pt2px(a.size):null,i=a&&a.maxSize?s.pt2px(a.maxSize):null,o=a&&a.disableUpsampling,h=e.symbolLayers,p=[],m=0,f=0,v=h.getItemAt(h.length-1);return v&&"icon"===v.type&&(r=v.size&&s.pt2px(v.size)),h.forEach(function(h,v){if("icon"===h.type||"object"===h.type){var d="icon"===h.type?h.size&&s.pt2px(h.size):0,y=t||d?Math.ceil(Math.min(t||d,i||E)):U,M=u(h),k=M?M.width:0;if(h&&h.resource&&h.resource.href){var S=c(e,h).then(function(e){var a=h.get("material.color"),r=x(h);return n.tintImageWithColor(e,y,a,r,o)}).then(function(e){var a=e.width,r=e.height;return m=Math.max(m,a+2*k),f=Math.max(f,r+2*k),[{shape:{type:"image",width:a,height:r,src:e.url},fill:null,stroke:null}]});p.unshift(S)}else{var L=h.get("resource.primitive"),z=L||w(h),j=y;"icon"===h.type&&r&&t&&(j=y*(d/r));var C=a&&"tall"===a.symbolConfig||"object"===h.type&&b(h);m=Math.max(m,C?D:j+2*k),f=Math.max(f,j+2*k),p.unshift(l.resolve(g(h,z,j,C)))}}}),l.eachAlways(p).then(function(e){var r=[];return e.forEach(function(e){e.value?r.push(e.value):e.error&&I.warn("error while building swatchInfo!",e.error)}),n.renderSymbol(r,[m,f],{node:a&&a.node,scale:!1})})}function k(e,a){var r,t=e.symbolLayers,i=[],h=p.isVolumetricSymbol(e),u=a&&a.size?s.pt2px(a.size):null,c=a&&a.maxSize?s.pt2px(a.maxSize):null,m=c||j,v=0,y=0;return t.forEach(function(e,a){var t=e&&e.type,l="line"===t,s="path"===t;if(l||s){var n=d(e,0),h=n&&n.width||0,p=[];if(l){0===a&&(r=h);var c=Math.min(u||h,m),b=0===a?c:u?c*(h/r):c,g=b>U?2*b:C;y=Math.max(y,b),v=Math.max(v,g),n.width=b,p.push({shape:{type:"path",path:[{command:"M",values:[0,.5*y]},{command:"L",values:[v,.5*y]},{command:"E",values:[]}]},stroke:n})}else{var x=Math.min(u||U,m),w=f(e,0),M=f(e,-.2),k=d(e,-.4);k.width=1,p.push({shape:o.shapes.pathSymbol3DLayer[0],fill:M,stroke:k}),p.push({shape:o.shapes.pathSymbol3DLayer[1],fill:w,stroke:k}),y=Math.max(y,x+2),v=y}i.push(p)}}),l.resolve(n.renderSymbol(i,[v,y],{node:a&&a.node,scale:h}))}function S(e,a){for(var r=e.type,t="mesh-3d"===r,i=e.symbolLayers,h=a&&a.size?s.pt2px(a.size):null,p=a&&a.maxSize?s.pt2px(a.maxSize):null,c=h||U,m=[],v=0,y=0,b=0;b<i.length;b++){var g=i.getItemAt(b),x=g.type,w="fill"===x,M="line"===x,k="extrude"===g.type,S=[];if(t&&!w)return;var L=o.shapes.fill[0];if(w){var z=u(g),j=z&&z.width||0;v=Math.max(v,U+j),y=Math.max(y,U+j),S.push({shape:L,fill:f(g,0),stroke:z})}else if(M){var C=d(g,0),D=C&&C.width||0,I={stroke:C,shape:L};v=Math.max(v,U+D),y=Math.max(y,U+D),S.push(I)}else if(k){var O=d(g,-.4),P=f(g,0),R=f(g,-.2),A=Math.min(c,p||E),T=o.getExtrudeSymbolShapes(A);O.width=1,S.push({shape:T[0],fill:R,stroke:O}),S.push({shape:T[1],fill:R,stroke:O}),S.push({shape:T[2],fill:P,stroke:O});var q=U,H=.7*U+.5*A;v=Math.max(v,q+2*O.width),y=Math.max(y,H+2*O.width)}m.push(S)}return l.resolve(n.renderSymbol(m,[v,y],{node:a&&a.node,scale:!1}))}function L(e,a){if(0===e.symbolLayers.length)return l.reject(new r("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));var t=null;switch(e.type){case"point-3d":t=M(e,a);break;case"line-3d":t=k(e,a);break;case"polygon-3d":case"mesh-3d":t=S(e,a)}return t||l.reject(new r("symbolPreview: swatchInfo3D","symbol not supported."))}Object.defineProperty(a,"__esModule",{value:!0});var z=e.toUrl("../../images/Legend/legend3dsymboldefault.png"),U=22,E=120,j=80,C=40,D=20,I=t.getLogger("esri.symbols.support.previewSymbol3D");a.getSymbolLayerFill=f,a.previewSymbol3D=L});